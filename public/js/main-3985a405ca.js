"use strict";function _toArray(t){return _arrayWithHoles(t)||_iterableToArray(t)||_unsupportedIterableToArray(t)||_nonIterableRest()}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}function _createForOfIteratorHelper(t){if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(t=_unsupportedIterableToArray(t))){var e=0,n=function(){};return{s:n,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a,o=!0,i=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return o=t.done,t},e:function(t){i=!0,a=t},f:function(){try{o||null==r["return"]||r["return"]()}finally{if(i)throw a}}}}function _typeof(t){"@babel/helpers - typeof";return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _objectWithoutProperties(t,e){if(null==t)return{};var n,r,a=_objectWithoutPropertiesLoose(t,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);for(r=0;r<o.length;r++)n=o[r],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(a[n]=t[n])}return a}function _objectWithoutPropertiesLoose(t,e){if(null==t)return{};var n,r,a={},o=Object.keys(t);for(r=0;r<o.length;r++)n=o[r],e.indexOf(n)>=0||(a[n]=t[n]);return a}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_unsupportedIterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(t){return"undefined"!=typeof Symbol&&Symbol.iterator in Object(t)?Array.from(t):void 0}function _arrayWithoutHoles(t){return Array.isArray(t)?_arrayLikeToArray(t):void 0}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);e>n;n++)r[n]=t[n];return r}function _iterableToArrayLimit(t,e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t)){var n=[],r=!0,a=!1,o=void 0;try{for(var i,c=t[Symbol.iterator]();!(r=(i=c.next()).done)&&(n.push(i.value),!e||n.length!==e);r=!0);}catch(s){a=!0,o=s}finally{try{r||null==c["return"]||c["return"]()}finally{if(a)throw o}}return n}}function _arrayWithHoles(t){return Array.isArray(t)?t:void 0}function asyncGeneratorStep(t,e,n,r,a,o,i){try{var c=t[o](i),s=c.value}catch(u){return void n(u)}c.done?e(s):Promise.resolve(s).then(r,a)}function _asyncToGenerator(t){return function(){var e=this,n=arguments;return new Promise(function(r,a){function o(t){asyncGeneratorStep(c,r,a,o,i,"next",t)}function i(t){asyncGeneratorStep(c,r,a,o,i,"throw",t)}var c=t.apply(e,n);o(void 0)})}}function ownKeys(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)}return n}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function decimalAdjust(t,e,n){return"undefined"==typeof n||0===+n?Math[t](e):(e=+e,n=+n,isNaN(e)||"number"!=typeof n||n%1!==0?NaN:(e=e.toString().split("e"),e=Math[t](+(e[0]+"e"+(e[1]?+e[1]-n:-n))),e=e.toString().split("e"),+(e[0]+"e"+(e[1]?+e[1]+n:n))))}function capitalizeFirstLetter(t){return t.charAt(0).toUpperCase()+t.slice(1)}function pluCode(t,e){if(0===e.indexOf(t)){var n=e.slice(2,7),r=Number(e.slice(7,12))/1e3;return{pref:t,code:n,weight:r,barcode:e}}return{}}function dom(t,e,n){n="string"==typeof n?{className:n}:n||{};var r=document.createElement(t);return n&&Object.keys(n).forEach(function(t){r.setAttribute("className"===t?"class":t,n[t])}),e.appendChild(r),r}function insertJS(t,e,n){var r=document.createElement("script"),a=document.getElementsByTagName("script")[0];r.src=-1===t.indexOf("//")?"//"+t:t,r.crossorigin="anonymous",e&&r.addEventListener("load",function(t){e(null,t)},!1),n&&r.addEventListener("error",n),a.parentNode.insertBefore(r,a)}function LightenDarkenColor(t,e){var n=!1;"#"==t[0]&&(t=t.slice(1),n=!0);var r=parseInt(t,16),a=(r>>16)+e;a>255?a=255:0>a&&(a=0);var o=(r>>8&255)+e;o>255?o=255:0>o&&(o=0);var i=(255&r)+e;return i>255?i=255:0>i&&(i=0),(n?"#":"")+(i|o<<8|a<<16).toString(16)}var _this57=void 0;angular.module("cloudshop.documents",[]).config(["$stateProvider",function(t){t.state("authenticated.card.doc",{url:"/doc",template:"<ui-view></ui-view>","abstract":!0,controller:"documentCtrl",data:{pageTitle:"DOCUMENTS"}}).state("authenticated.card.doc.edit",{url:"/show/:id",templateUrl:"js/pages/card/documents/_view.html",controller:"documentsEditCtrl",data:{pageTitle:"DOCUMENT_EDITING"}}).state("authenticated.card.doc_create",{url:"/docs",template:"<ui-view></ui-view>","abstract":!0,controller:"documentCtrl",data:{pageTitle:"CREATING_DOCUMENT"}}).state("authenticated.card.doc_create.sell",{url:"/sell",templateUrl:"js/pages/card/documents/_view.html",controller:"documentsSellCtrl",data:{pageTitle:"SALE",type:"sales",permission:"sales",method:"POST"}}).state("authenticated.card.doc_create.purchase",{url:"/purchase",templateUrl:"js/pages/card/documents/_view.html",controller:"documentsPurchaseCtrl",data:{pageTitle:"PURCHASE",type:"purchases",permission:"purchases",method:"POST"}}).state("authenticated.card.doc_create.return_sell",{url:"/return-sell?fromDoc",templateUrl:"js/pages/card/documents/_view.html",controller:"documentsReturnSellCtrl",data:{pageTitle:"RETURN_SALE",type:"return_sales",permission:"return_sales",method:"POST"}}).state("authenticated.card.doc_create.return_purchase",{url:"/return-purchase?fromDoc",templateUrl:"js/pages/card/documents/_view.html",controller:"documentsReturnPurchaseCtrl",data:{pageTitle:"RETURN_PURCHASE",type:"return_purchases",permission:"return_purchases",method:"POST"}}).state("authenticated.card.doc_create.changes",{url:"/changes",templateUrl:"js/pages/card/documents/_view.html",controller:"documentsChangesCtrl",data:{pageTitle:"ADJUSTMENT",type:"changes",permission:"changes",method:"POST"}}).state("authenticated.card.doc_create.changes_inventory",{url:"/changes-inventory",templateUrl:"js/pages/card/documents/_view.html",controller:"documentsChangesCtrl",data:{pageTitle:"STOCKTAKE",type:"changes",sub_type:"inventory",permission:"changes",method:"POST"}}).state("authenticated.card.doc_create.changes_in",{url:"/changes-in",templateUrl:"js/pages/card/documents/_view.html",controller:"documentsChangesCtrl",data:{pageTitle:"STOCK_ADJUSTMENT",type:"changes",sub_type:"in",permission:"changes",method:"POST"}}).state("authenticated.card.doc_create.changes_out",{url:"/changes-out",templateUrl:"js/pages/card/documents/_view.html",controller:"documentsChangesCtrl",data:{pageTitle:"WRITEOFF",type:"changes",sub_type:"out",permission:"changes",method:"POST"}}).state("authenticated.card.doc_create.moving",{url:"/moving",templateUrl:"js/pages/card/documents/_view.html",controller:"documentsMovingCtrl",data:{pageTitle:"MOVEMENT",type:"movements",permission:"movements",method:"POST"}})}]),angular.module("cloudshop.documents").controller("documentsSellCtrl",["$scope","$state",function(t,e){var n=e.current.data;t.$parent.init(n),t.$parent.productFilter=function(){return!0}}]),angular.module("cloudshop.documents").controller("documentsReturnSellCtrl",["$scope","$state",function(t,e){var n=e.current.data;t.$parent.init(n),t.$parent.productFilter=function(){return!0}}]),angular.module("cloudshop.documents").controller("documentsReturnPurchaseCtrl",["$scope","$state",function(t,e){var n=e.current.data;t.$parent.init(n),t.$parent.paidEditShow=!0,t.$parent.productFilter=function(t){return"inventory"==t.type}}]),angular.module("cloudshop.documents").controller("documentsPurchaseCtrl",["$scope","$state",function(t,e){var n=e.current.data;t.$parent.init(n),t.$parent.paidEditShow=!0,t.$parent.productFilter=function(t){return"inventory"==t.type}}]),angular.module("cloudshop.documents").controller("documentsMovingCtrl",["$scope","$state",function(t,e){var n=e.current.data;t.$parent.init(n),t.$parent.productFilter=function(t){return"inventory"==t.type}}]),angular.module("cloudshop.documents").controller("documentsChangesCtrl",["$scope","$state","docService",function(t,e,n){var r=e.current.data;t.doc=n.doc,t.$parent.init(r),t.doc.data.status="inventory"===r.sub_type==!1,t.$on("$destroy",function(){t.doc.data.status=!0})}]),angular.module("cloudshop.catalog",["cloudshop.import"]),angular.module("cloudshop.catalog").controller("catalogPageHistoryCtrl",["$scope","modalService","$state","docService","api","db","$rootScope",function(t,e,n,r,a,o,i){function c(t){return _.map(t,function(t){var e=moment(1e3*t.doc.date);return t.date=e.format("DD MMM").replace(".","").split(" "),e.format("YYYY")!==moment().format("YYYY")&&t.date.push(e.format("YY")),t.doc_=r.types[t.doc.type+(t.doc.sub_type||"")],t.author=o.storage.staff.data.find(function(e){return e._id===t._user}),t})}var s=n.params.productId,u={};t.product=null,t.filter={name:"_product_history",onChange:function(e){u=_.clone(e,!0),u.type&&(u.type.split("|")[1]?(u.sub_type=u.type.split("|")[1],u.type=u.type.split("|")[0]):delete u.sub_type),t.replaceHistory()},fields:[{_id:"date",name:"DATE",type:"date",defaultValue:[+moment().subtract(1,"year").startOf("day").format("X"),+moment().endOf("day").format("X")],show:!0,required:!0,settings:{}},{_id:"store_id",name:"STORE",type:"dropdown",show:!0,settings:{name:"stores",limit:10,search:!0}},{_id:"type",name:"TYPE",type:"dropdown",show:!0,settings:{name:_.map(r.types,function(t,e){return _objectSpread({},t,{name:t.title,_id:"".concat(t.type||e).concat(t.sub_type?"|"+t.sub_type:"")})}),limit:10,search:!0}}]},t.historySettings={offset:0,limit:20,total:0,loaded:!1,error:!1,loadedCount:0,load:!1},t.historyData=[],t.$on("$destroy",function(){}),t.loadHistory=_asyncToGenerator(regeneratorRuntime.mark(function l(){var e,n,r;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return t.historySettings.load=!0,t.historySettings.error=!1,e={product_id:s,limit:t.historySettings.limit,offset:t.historySettings.offset},o.prev=3,o.next=6,a.data.get("/moves/:client?".concat($.param(_objectSpread({},u,{},e))),{v:"v3"});case 6:n=o.sent,r=n.data,i.$broadcast("CATALOG_MOVES_FETCH_SUCCESS",r),t.historyData=t.historyData.concat(c(r.data)),t.historySettings.offset+=t.historySettings.limit,t.historySettings.loadedCount+=r.data.length,t.historySettings.total=r.total,o.next=18;break;case 15:o.prev=15,o.t0=o["catch"](3),t.historySettings.error=!0;case 18:return o.prev=18,t.historySettings.loaded=!0,t.historySettings.load=!1,t.$apply(),o.finish(18);case 23:case"end":return o.stop()}},l,null,[[3,15,18,23]])})),t.replaceHistory=_asyncToGenerator(regeneratorRuntime.mark(function p(){var e,n,r,o;return regeneratorRuntime.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:return t.historySettings.load=!0,t.historySettings.loaded=!1,t.historySettings.error=!1,t.historySettings.offset=0,t.historyData=[],e={product_id:s,limit:t.historySettings.limit,offset:t.historySettings.offset},n=$.param(_objectSpread({},u,{},e)),d.prev=7,d.next=10,a.data.get("/moves/:client?".concat(n),{v:"v3"});case 10:r=d.sent,o=r.data,i.$broadcast("CATALOG_MOVES_FETCH_SUCCESS",o),t.historyData=c(o.data),t.historySettings.offset=t.historySettings.limit,t.historySettings.loadedCount=o.data.length,t.historySettings.total=o.total,d.next=23;break;case 19:d.prev=19,d.t0=d["catch"](7),t.historySettings.error=!0,console.warn(d.t0);case 23:return d.prev=23,t.historySettings.loaded=!0,t.historySettings.load=!1,t.$apply(),d.finish(23);case 28:case"end":return d.stop()}},p,null,[[7,19,23,28]])}));var d=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(){var e,r,a;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,o.method.init("catalog");case 2:e=n.sent,r=_slicedToArray(e,1),a=r[0],t.product=a.find(function(t){return t._id===s})||{};case 6:case"end":return n.stop()}},n)}));return function(){return e.apply(this,arguments)}}();d()}]),angular.module("cloudshop.catalog").directive("catalogFormModification",[function(){return{restrict:"A",link:function(t,e){$("table[properties]",e).on("click","td > a",function(){$(this).closest("tr").toggleClass("active")})}}}]),angular.module("cloudshop",["ui.router","LocalStorageModule","sticky","angular-loading-bar","angularLoad","angularUtils.directives.dirPagination","environment","ui.mask","cloudshop","cloudshop.journal","cloudshop.money","cloudshop.catalog","cloudshop.profile","cloudshop.company","cloudshop.ecommerce","cloudshop.reports","cloudshop.clients","cloudshop.supplier","cloudshop.dashboard","cloudshop.account","cloudshop.documents","cloudshop.stores","cloudshop.notifications","cloudshop.websocket","cloudshop.updater","cloudshop.trash","cloudshop.support","cloudshop.plugin","cloudshop.register","cloudshop.gift","cloudshop.start","cloudshop.translate","marketplace","social.vk","cloudshop.yandex"]).constant("URL","/proxy/?path=").constant("LOGIN_URL","/auth").constant("LOGOUT_URL","/logout").constant("REGISTER_URL","/register").constant("RESET_URL","/reset").constant("IMAGE_UPLOAD_URL","/upload_image").config(["$provide","envServiceProvider","$compileProvider",function(t,e,n){e.config({domains:{development:["localhost","192.168.10.249"],production:["web.*"]}}),e.check(),t.constant("DEV",e.is("development")),e.is("production")&&(n.commentDirectivesEnabled(!1),n.debugInfoEnabled(!1))}]).config(["$httpProvider",function(t){t.interceptors.push(function(){return{request:function(t){return t.url.includes(".html")&&(t.url=t.url+"?v="+window.APP_HASH),t}}})}]).config(["$provide",function(t){function e(){try{var t=new CustomEvent("appEvent",{detail:arguments});document.dispatchEvent(t)}catch(e){}}t.decorator("$rootScope",["$delegate",function(t){var n=t.constructor,r=n.prototype.$broadcast;return n.prototype.$broadcast=function(){return(0===arguments[0].indexOf("DB.")||0===arguments[0].indexOf("AUTH."))&&e.apply(this,arguments),r.apply(this,arguments)},t}])}]).run(["$rootScope","$state","localStorageService",function(t,e,n){t.body_smallMenu=n.cookie.get("smallMenu")}]),angular.module("cloudshop").directive("d3StackedBar",["$filter",function(t){return{restrict:"E",replace:!0,scope:{data:"=d3Data"},template:'<div class="d3-chart-graph"></div>',link:function(e,n){function r(){a&&$(n).html("");var t={top:80,right:40,bottom:120,left:60},r=$(n).width()-t.left-t.right,u=.5*$(n).width()-t.top-t.bottom,d=_.clone(e.data,!0),l=$(n).width()/d.length<120;d.forEach(function(t){var e=0;t.values=t.filter(function(e,n){return"bar"==t[n].type}).map(function(t){return{name:t.text,y0:e,y1:e+=+t.y}}),t.line=t.filter(function(e,n){return"line"==t[n].type}).map(function(t){return{name:t.text,x:t.x,y:t.y}}),t.total=t.values[t.values.length-1].y1}),d[0].values.forEach(function(t){c(t.name)});var p=d3.min(d,function(t){return t.total});o.domain(d.map(function(t){return t[0].x})).range([0,r]),i.domain([p>0?0:p,1.35*d3.max(d,function(t){return t.total})]).range([u,0]);var m=d3.axisBottom().scale(o).tickSize(-u,0,0),f=d3.axisLeft().scale(i).tickSize(-r,0,0),h=d3.line().x(function(t){return o(t[0].x)+o.bandwidth()/2}).y(function(t){return i(t[0].y)}).curve(d3.curveBasis);a=d3.select(n[0]).append("svg").attr("width",r+t.left+t.right).attr("height",u+t.top+t.bottom).append("g").attr("transform","translate("+t.left+","+t.top+")"),a.append("g").attr("class","x axis").attr("transform","translate(0, "+u+")").call(m),l&&d3.selectAll(".x.axis").selectAll("text").style("text-anchor","end").attr("transform","rotate(-65)"),a.append("g").attr("class","y axis").call(f);var g=a.selectAll(".rgroups").data(d).enter().append("g").attr("class","rgroups").attr("transform",function(t){return"translate("+o(t[0].x)+",0)"}).on("mouseover",s.show).on("mouseout",s.hide);g.selectAll("rect").data(function(t){return t.values}).enter().append("rect").attr("y",function(t){return i(t.y1)}).attr("width",o.bandwidth()).attr("height",function(t){return Math.abs(i(t.y0)-i(t.y1))}).attr("rel",function(t){return t.y}).style("fill",function(t){return c(t.name)}).style("fill-opacity",.6),g.selectAll(".shadow").data(function(t){return t.values}).enter().append("rect").attr("class","shadow").attr("y",function(t){return i(t.y1)}).attr("x",o.bandwidth()).attr("width",4).attr("height",function(t){return Math.abs(i(t.y0)-i(t.y1))}).style("fill",function(t){return c(t.name)}).style("fill-opacity",.9),a.append("path").datum(d.map(function(t){return t.line})).attr("class","line avg").style("stroke",function(t){return c(t[0][0].name)}).attr("d",h);var v=d3.select(n[0]).append("div").attr("class","legend");c.domain().slice().forEach(function(t){v.append("p").style("background-color",c(t)).text(t)})}var a,o=d3.scaleBand(),i=d3.scaleLinear(),c=d3.scaleOrdinal().range(["#7EB53F","#656E8A","#FF6D00","#9E4364","#BAB18A"]),s={d:null,tooltip:null,t:function(){var e=s.d.filter(function(t){return"undefined"!=typeof t.y}).map(function(e){return"<div><strong>"+e.text+"</strong> <span>"+t("curr")(e.y)+"</span></div>"});return e.unshift("<h4>"+s.d[0].x+"</h4>"),e.join("")},init:function(){s.tooltip=d3.select("body").append("div").attr("class","d3-tip animated")},show:function(t){var e=this.getBoundingClientRect();s.d=t,s.tooltip.classed("zoomOut",!1).classed("zoomIn",!0).style("display","block").html(s.t()),s.tooltip.style("top",e.top-s.tooltip.node().getBoundingClientRect().height-15+"px").style("left",e.left+e.width/2-s.tooltip.node().getBoundingClientRect().width/2+"px")},hide:function(){},destroy:function(){s.tooltip.remove()}};s.init(),e.$watch("data",function(){r()}),$(window).bind("resize",function(){r()}),e.$on("$destroy",function(){s.destroy()})}}}]),angular.module("cloudshop").directive("d3FinanceChart",["$filter",function(t){return{restrict:"E",replace:!0,scope:{data:"=d3Data"},template:['<div class="row">','<div class="col-lg-14">','<div class="d3-chart-graph">',"</div>","</div>",'<div class="col-lg-10">','<div class="d3-chart-graph">',"</div>","</div>","</div>"].join(""),link:function(e,n){function r(){a&&(d.html(""),u.html(""));var r=moment.monthsShort(),p={top:80,right:40,bottom:30,left:60},m=d.width()-p.left-p.right,f=u.width()-p.left-p.right,h=.5*u.width()-p.top-p.bottom,g=_.clone(e.data,!0),v=[],y=$(n).width()/r.length<120;g.debit.forEach(function(e,n){v[n]=v[n]||{values:[]},v[n].values.push({name:t("translate")("INCOME"),y0:0,y1:e.sort,x:r[n],y:e.sort})}),g.credit.forEach(function(e,n){var a=-1*e.sort;v[n].values.push({name:t("translate")("EXPENSE"),y0:a,y1:0,x:r[n],y:a}),v[n].total=a+v[n].values[0].y1}),g.balanceInHand.forEach(function(e,n){v[n].line=v[n].line||[],v[n].line.push({name:t("translate")("NET"),x:r[n],y:e.sort})}),g.accumulation.forEach(function(e,n){v[n].line2=v[n].line2||[],v[n].line2.push({name:t("translate")("ACCUMULATED_BALANCE"),x:r[n],y:e.sort})}),g=v,g[0].values.forEach(function(t){c(t.name)}),o.domain(g.map(function(t){return t.values[0].x})).range([0,f]);var b=d3.min(g,function(t){return d3.min(t.values,function(t){return t.y0})}),E=d3.max(g,function(t){return d3.max(t.values,function(t){return t.y1})});Math.abs(b)>E?E=Math.abs(b):b=-E,i.domain([1.1*b,1.1*E]).range([h,0]);var S=d3.axisBottom().scale(o).tickSize(-h,0,0),T=d3.axisLeft().scale(i).tickSize(-f,0,0),w=d3.line().x(function(t){return o(t[0].x)+o.bandwidth()/2}).y(function(t){return i(t[0].y)}).curve(d3.curveBasis);a=d3.select(u[0]).append("svg").attr("width",f+p.left+p.right).attr("height",h+p.top+p.bottom).append("g").attr("transform","translate("+p.left+","+p.top+")"),a.append("g").attr("class","x axis").attr("transform","translate(0,"+h+")").call(S),y&&d3.selectAll(".x.axis").selectAll("text").style("text-anchor","end").attr("transform","rotate(-65)"),a.append("g").attr("class","y axis").call(T),a.append("g").attr("class","tick").attr("transform","translate(0,"+i(0)+")").append("line").attr("y2",0).attr("x2",f);var k=a.selectAll(".rgroups").data(g).enter().append("g").attr("class","rgroups").attr("transform",function(t){return"translate("+o(t.values[0].x)+",0)"}).on("mouseover",l.show);k.selectAll("rect").data(function(t){return t.values}).enter().append("rect").attr("y",function(t){return i(t.y1)}).attr("width",o.bandwidth()).attr("height",function(t){return Math.abs(i(t.y0)-i(t.y1))}).attr("rel",function(t){return t.y}).style("fill",function(t){return c(t.name)}).style("fill-opacity",.6),k.selectAll(".shadow").data(function(t){return t.values}).enter().append("rect").attr("class","shadow").attr("y",function(t){return i(t.y1)}).attr("x",o.bandwidth()).attr("width",4).attr("height",function(t){return Math.abs(i(t.y0)-i(t.y1))}).style("fill",function(t){return c(t.name)}).style("fill-opacity",.9),a.append("path").data([g.map(function(t){return t.line})]).attr("class","line avg").style("stroke",function(t){return c(t[0][0].name)}).attr("d",w);var x=d3.select(u[0]).append("div").attr("class","legend");c.domain().slice().forEach(function(t){x.append("p").style("background-color",c(t)).text(t)}),o.domain(g.map(function(t){return t.line2[0].x})).range([0,m]),b=d3.min(g,function(t){return d3.min(t.line2,function(t){return t.y})}),E=d3.max(g,function(t){return d3.max(t.line2,function(t){return t.y})}),i.domain([b-.1*b,1.1*E]).range([h,0]),S=d3.axisBottom().scale(o).tickSize(-h,0,0),T=d3.axisLeft().scale(i).tickSize(-m,0,0),w=d3.line().x(function(t){return o(t[0].x)+o.bandwidth()/2}).y(function(t){return i(t[0].y)}).curve(d3.curveBasis);var R=d3.select(d[0]).append("svg").attr("width",m+p.left+p.right).attr("height",h+p.top+p.bottom).append("g").attr("transform","translate("+p.left+","+p.top+")");R.append("g").attr("class","x axis").attr("transform","translate(0,"+h+")").call(S).selectAll("text").style("text-anchor","end").attr("transform","rotate(-65)"),R.append("g").attr("class","y axis").call(T),R.append("path").data([g.map(function(t){return t.line2})]).attr("class","line").style("stroke",function(t){return s(t[0][0].name)}).attr("d",w),x=d3.select(d[0]).append("div").attr("class","legend"),s.domain().slice().forEach(function(t){x.append("p").style("background-color",s(t)).text(t)})}var a,o=d3.scaleBand(),i=d3.scaleLinear(),c=d3.scaleOrdinal().range(["#5BAAEC","#FF5144","#FF6D00","#9E4364","#BAB18A"]),s=d3.scaleOrdinal().range(["#9E4364","#BAB18A"]),u=$(".d3-chart-graph:eq(0)",n),d=$(".d3-chart-graph:eq(1)",n),l={d:null,tooltip:null,t:function(){var e=l.d.values.concat(l.d.line).map(function(e){return"<div><strong>"+e.name+"</strong> <span>"+t("curr")(e.y)+"</span></div>"});return e.unshift("<h4>"+l.d.values[0].x+"</h4>"),e.join("")},init:function(){l.tooltip=d3.select("body").append("div").attr("class","d3-tip animated")},show:function(t){var e=this.getBoundingClientRect();l.d=t,l.tooltip.classed("zoomOut",!1).classed("zoomIn",!0).style("display","block").html(l.t()),l.tooltip.style("top",e.top-l.tooltip.node().getBoundingClientRect().height-15+"px").style("left",e.left+e.width/2-l.tooltip.node().getBoundingClientRect().width/2+"px")},hide:function(){l.tooltip.classed("zoomOut",!0).style("display","none")},destroy:function(){l.tooltip.remove()}};l.init(),e.$watch("data",r),$(window).bind("resize",r),$(".my.sidebar").bind("scroll",l.hide),e.$on("$destroy",function(){l.destroy(),$(window).unbind("resize",r),$(".my.sidebar").unbind("scroll")})}}}]),angular.module("cloudshop.register",[]).config(["$stateProvider",function(t){t.state("authenticated.card.register",{"abstract":!0,url:"/register",templateUrl:"js/pages/register/index.html",data:{pageTitle:"REGISTERS_BLOCK"}}).state("authenticated.card.register.cash",{url:"/cash",templateUrl:"js/pages/register/register/view.html",controller:"registerCashCtrl",data:{pageTitle:"REGISTERS"}}).state("authenticated.card.register.download",{url:"/download",templateUrl:"js/pages/register/download/view.html",data:{pageTitle:"APP_DOWNLOAD"}}).state("authenticated.card.register.addBox",{url:"/add",templateUrl:"js/pages/register/register/add.html",controller:"registerAddCashCtrl",data:{pageTitle:"NEW_REGISTER"}}).state("authenticated.card.register.editBox",{url:"/edit/:register_id",templateUrl:"js/pages/register/register/add.html",controller:"registerAddCashCtrl",data:{pageTitle:"EDIT_REGISTER"}}).state("authenticated.card.register.showBox",{url:"/show/:register_id",templateUrl:"js/pages/register/register/show.html",controller:"registerShowCashCtrl",data:{pageTitle:"VIEW_REGISTER"}}).state("authenticated.card.register.shift",{url:"/shift",templateUrl:"js/pages/register/shift/view.html",controller:"shiftCtrl",data:{pageTitle:"SHIFTS"}}).state("authenticated.card.register.showShift",{url:"/show-shift/:shift_id",templateUrl:"js/pages/register/shift/show.html",controller:"shiftShowCtrl",data:{pageTitle:"VIEW_SHIFT"}})}]),angular.module("cloudshop.register").constant("SHIFT_REPORT",{sales:{name:"SALE_OF_GOODS",fields:{count:"COUNT_OF_GOODS",revenue:"SALES_SUM",profit:"GROSS_PROFIT"}},return_sales:{name:"RETURN_OF_GOODS",fields:{count:"COUNT_OF_GOODS",revenue:"REFUND_SUM"}}}),angular.module("cloudshop.register").controller("shiftProductsReport",["$scope","api","$state","SHIFT_REPORT","$filter",function(t,e,n,r,a){t.loading=!0,t._sum=_.sum,t.empty=!1,t.data={},t.settings=r,t.activeField={sales:"product.name",return_sales:"product.name"},t.fields={sales:{"product.name":!1},return_sales:{"product.name":!1}},t.order=function(e,n){t.activeField[n]=e,t.fields[n][e]=!t.fields[n][e];var r="product.name"===e?!t.fields[n][e]:t.fields[n][e];t.data[n]=a("orderBy")(t.data[n],e,r)};var o=function(){return e.data.post("/report/:client/".concat(n.params.shift_id,"/products"),{v:"v3"}).then(function(e){var n=e.data;t.data=n.data,Object.keys(n.data).map(function(e){t.order(t.activeField[e],e)}),t.empty=0===_.sum(Object.keys(n.data).map(function(t){return n.data[t].length})),t.loading=!1,t.$apply()})};o()}]),angular.module("cloudshop.register").directive("receiptLocal",[function(){return{restrict:"E",replace:!0,scope:!0,templateUrl:"js/pages/register/register/receipt-local/mainDirective.html",link:function(t){t.checkText=[{name:"sales",value:"SALE",hidden:!0},{name:"return_sales",value:"RETURN_SALE",hidden:!0},{name:"date",value:"DATE"},{name:"client",value:"CLIENT"},{name:"cashier",value:"CASHIER"},{name:"store",value:"STORE"},{name:"register",value:"REGISTER"},{name:"shift",value:"SHIFT"},{name:"subtotal",value:"SUBTOTAL"},{name:"discount",value:"DISCOUNT"},{name:"payment",value:"PAYMENT"},{name:"cash",value:"IN_CASH"},{name:"cashless",value:"CARD"},{name:"total",value:"TOTAL"}],t.onChange=function(e,n,r){t.$parent.data.design[r][n]=e},t.onRemove=function(e,n){t.$parent.data.design[n].splice(e,1)}}}}]),angular.module("cloudshop.register").directive("receiptDesign",[function(){return{restrict:"E",replace:!0,scope:!0,templateUrl:"js/pages/register/register/receipt-design/mainDirective.html",link:function(t){var e={image:{type:"image",url:null},text:{type:"text",size:1,align:"center",text:null}},n={before:[_objectSpread({},e.image),_objectSpread({},e.text),_objectSpread({},e.text),_objectSpread({},e.text),_objectSpread({},e.text)],after:[_objectSpread({},e.text),_objectSpread({},e.text),_objectSpread({},e.text),_objectSpread({},e.text),_objectSpread({},e.image)]};t.onChange=function(e,n,r){t.$parent.data.design[r][n]=e},t.onRemove=function(e,n){t.$parent.data.design[n].splice(e,1)},t.select=function(n,r){t.$parent.data.design[r].push(_objectSpread({},e[n]))},t.$watch("$parent.data",function(){t.data.design||(t.$parent.data.design=_objectSpread({},n))})}}}]),angular.module("cloudshop.register").directive("receiptDesignItem",["$timeout",function(t){return{restrict:"A",scope:{onchange:"=",remove:"=",item:"=",index:"=",place:"@"},templateUrl:"js/pages/register/register/receipt-design/itemDirective.html",link:function(e,n){e.image=e.item.url,e.imageChange=function(t){var n=new FileReader;n.onload=function(n){e.image=n.target.result,e.item.image=t,e.$apply()},n.readAsDataURL(t)},e.textPropsChange=function(t){e.onchange(_objectSpread({},e.item,{},t),e.index,e.place)},e.onChangeText=function(){for(var t=arguments.length,e=new Array(t),n=0;t>n;n++)e[n]=arguments[n];console.warn("props",e)},t(function(){"text"===e.item.type&&(e.text=e.item.text,$('input[type="text"]',n).popup({on:"hover",transition:"vertical flip",hoverable:!0,position:"top left",delay:{show:500,hide:200}}))})}}}]),angular.module("marketplace",[]).config(["$stateProvider",function(t){t.state("authenticated.card.marketplace",{url:"",template:"<ui-view></ui-view>","abstract":!0,data:{pageTitle:"INTEGRATION",permission:"integrations",method:"GET"}}).state("authenticated.card.marketplace.list",{url:"/marketplace/",templateUrl:"js/pages/marketplace/list.html",controller:"marketplaceListCtrl",data:{pageTitle:"INTEGRATION"}}).state("authenticated.card.marketplace.item",{url:"/marketplace/:pluginName?tab",templateUrl:"js/pages/marketplace/item-settings.html",controller:"marketplaceItemCtrl",data:{pageTitle:"SETTINGS"}}).state("authenticated.card.marketplace.installedItem",{url:"/marketplace/installed/:pluginId",templateUrl:"js/pages/marketplace/item-settings.html",controller:"marketplaceItemCtrl",data:{pageTitle:"SETTINGS"}}).state("authenticated.card.marketplace.log",{url:"/marketplace/log/:pluginId",templateUrl:"js/pages/marketplace/log-view.html",controller:"marketplaceLogCtrl",data:{pageTitle:"ACTION_LOG"}})}]),angular.module("marketplace").controller("marketplaceFormWoo",["$scope","modalService","$timeout","api","$state","db",function(t,e,n,r,a,o){}]).controller("marketPlaceWooInstallForm",["$scope","api","$rootScope","$state","db","modalService","safeApply",function(t,e,n,r,a,o,i){function c(){o.method.add([{title:"REFRESH_SETTINGS",className:"green",active:!0,action:function(){return t.request("save")},visible:!0},{title:t.settings.active?"DISABLE":"ENABLE",className:t.settings.active?"red":"green","float":"right",active:!0,visible:!0,action:function(){return t.request("toggle")}}])}t.id=r.params.pluginId,t.loading=!1,t.settings={active:!0,type:"woocommerce-2",settings:{"new":!0,url:null,type:"woocommerce",env:"production",consumerKey:null,consumerSecret:null,store:{id:null,name:null}}},t.dropdown={stores:{title:"STORE",name:"stores","class":"floating fluid button",icon:"dropdown",search:!0,onChange:function(e,n){var r=n.name;
t.settings.settings.store.name=r}},account:{name:"accounts",icon:"dropdown",placeholder:"SELECT_ACCOUNT","class":"basic large floating fluid button",cancel:!0,limit:999,filterFunc:function(t){return"register"!==t.type}}},t.sync={loading:!1,loadingCatalogIn:function(){return this.fetch("export")},loadingCatalogOut:function(){return this.fetch("import")},fetch:function(n){var r=this;return _asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return r.loading=!0,a.prev=1,a.next=4,e.data.get("/integration/woocommerce/:client/".concat(t.id,"/products/").concat(n),{v:"v3"});case 4:a.next=9;break;case 6:a.prev=6,a.t0=a["catch"](1),console.warn(a.t0);case 9:return a.prev=9,i(t),r.loading=!1,a.finish(9);case 13:case"end":return a.stop()}},a,null,[[1,6,9,13]])}))()}};var s={install:function(){return t.loading=!0,e.data.post("/:client/integrations",_objectSpread({},t.settings,{v:"v3"})).then(function(){t.loading=!1,n.$broadcast("WS_UPDATE_INTEGRATIONS"),t.$apply(),o.method.back()})},save:function(){return _asyncToGenerator(regeneratorRuntime.mark(function r(){var a;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return a=t.settings,r.prev=1,r.next=4,e.data.put("/:client/integrations/".concat(a._id),_objectSpread({},a,{v:"v3"}));case 4:n.$broadcast("WS_UPDATE_INTEGRATIONS"),r.next=9;break;case 7:r.prev=7,r.t0=r["catch"](1);case 9:return r.prev=9,i(t),r.finish(9);case 12:case"end":return r.stop()}},r,null,[[1,7,9,12]])}))()},toggle:function(){var r=t.settings;return e.data.put("/:client/integrations/".concat(r._id),{_id:r._id,active:!r.active,v:"v3"}).then(function(){t.settings.active=!r.active,n.$broadcast("WS_UPDATE_INTEGRATIONS"),t.$apply()})["catch"]().then(function(){o.method.remove(),c()})}};t.request=function(e){t.loading=!0,s[e]().then(function(){t.loading=!1})},t.$on("$destroy",function(){o.init.remove()}),t.id&&(t.loading=!0,a.method.init("integrations").then(function(e){return e[0].find(function(e){var n=e._id;return n===t.id})}).then(function(e){t.settings=_objectSpread({payment_mapping:{}},_.clone(e,!0)),t.loading=!1,c()}))}]),angular.module("marketplace").controller("marketplaceFormUDSGAME",["$scope","modalService","$timeout","api","$state","db",function(t,e,n,r,a,o){}]).controller("marketPlaceUDSGAMEInstallForm",["$scope","api","$rootScope","$state","db","modalService",function(t,e,n,r,a,o){function i(){o.method.add([{title:"SAVE",className:"green",active:!0,action:function(){return t.request("save")},visible:!0},{title:t.settings.active?"DISABLE":"ENABLE",className:t.settings.active?"red":"green","float":"right",active:!0,visible:!0,action:function(){return t.request("toggle")}}])}t.id=r.params.pluginId,t.loading=!1,t.settings={active:!0,type:"uds",settings:{api_key:null,company_id:null}};var c={install:function(){return t.loading=!0,e.data.post("/:client/integrations",_objectSpread({},t.settings,{v:"v3"})).then(function(){t.loading=!1,n.$broadcast("WS_UPDATE_INTEGRATIONS"),t.$apply(),o.method.back()})},save:function(){var r=t.settings;return e.data.put("/:client/integrations/".concat(r._id),_objectSpread({},r,{v:"v3"})).then(function(){n.$broadcast("WS_UPDATE_INTEGRATIONS"),o.method.back()})},toggle:function(){var r=t.settings;return e.data.put("/:client/integrations/".concat(r._id),{_id:r._id,active:!r.active,v:"v3"}).then(function(){t.settings.active=!r.active,n.$broadcast("WS_UPDATE_INTEGRATIONS"),t.$apply()})["catch"]().then(function(){o.method.remove(),i()})}};t.request=function(e){t.loading=!0,c[e]().then(function(){t.loading=!1})},t.$on("$destroy",function(){o.init.remove()}),t.id&&(t.loading=!0,a.method.init("integrations").then(function(e){return e[0].find(function(e){var n=e._id;return n===t.id})}).then(function(e){t.settings=_.clone(e,!0),t.loading=!1,i(),t.$apply()}))}]),angular.module("marketplace").controller("marketPlaceTaxnetList",["$scope","api","$state","alertModal",function(t,e,n,r){var a=0;t.loading=!1,t.loaded=!1,t.last=!1,t.data=[],t.id=n.params.pluginId,t.loadingItem=null,t.errorItem=null,t.fetchImport=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function a(n){var o,i;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return t.loadingItem=n.Id,t.errorItem=null,a.prev=2,a.next=5,e.data.get("/integration/:client/taxnet/".concat(t.id,"/doc/").concat(n.Id),{v:"v3"});case 5:if(o=a.sent,i=o.data,!i.error&&i.status){a.next=9;break}throw new Error("Произошла ошибка");case 9:n.cloudshop_imported=i.data,a.next=16;break;case 12:a.prev=12,a.t0=a["catch"](2),t.errorItem=n.Id,r("Произошла ошибка");case 16:return a.prev=16,t.loadingItem=null,t.$apply(),a.finish(16);case 20:case"end":return a.stop()}},a,null,[[2,12,16,20]])}));return function(t){return n.apply(this,arguments)}}(),t.fetchData=_asyncToGenerator(regeneratorRuntime.mark(function o(){var n,r,i=arguments;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return n=i.length>0&&void 0!==i[0]?i[0]:!1,o.prev=1,a=n?0:a+1,t.loading=!0,o.next=6,e.data.get("/integration/:client/taxnet/".concat(t.id,"/docs/").concat(a),{v:"v3"});case 6:if(r=o.sent,!r.data.error){o.next=9;break}throw new Error("Произошла ошибка");case 9:t.loaded=!0,t.data=[].concat(_toConsumableArray(t.data),_toConsumableArray(r.data.data)),t.last=10!==r.data.data.length,o.next=17;break;case 14:o.prev=14,o.t0=o["catch"](1),t.error=!0;case 17:return o.prev=17,t.loading=!1,t.$apply(),o.finish(17);case 21:case"end":return o.stop()}},o,null,[[1,14,17,21]])})),t.$on("$destroy",function(){}),t.id&&t.fetchData(!0)}]),angular.module("marketplace").controller("marketPlaceTaxnetInstallForm",["$scope","api","$rootScope","$state","db","modalService",function(t,e,n,r,a,o){function i(){o.method.add([{title:t.settings.active?"DISABLE":"ENABLE",className:t.settings.active?"red":"green","float":"right",active:!0,visible:!0,action:function(){return t.request("toggle")}}])}t.loading=!1,t.id=r.params.pluginId,t.settings={type:"taxnet",access:{login:null,password:null},settings:{}};var c={install:function(){return t.loading=!0,e.data.post("/:client/integrations",_objectSpread({},t.settings,{v:"v3"})).then(function(){t.loading=!1,n.$broadcast("WS_UPDATE_INTEGRATIONS"),t.$apply(),o.method.back()})},toggle:function(){var r=t.settings;return e.data.put("/:client/integrations/".concat(r._id),{_id:r._id,active:!r.active,v:"v3"}).then(function(){t.settings.active=!r.active,n.$broadcast("WS_UPDATE_INTEGRATIONS"),t.$apply()})["catch"]().then(function(){o.method.remove(),i()})}};t.request=function(e){t.loading=!0,c[e]().then(function(){t.loading=!1})},t.$on("$destroy",function(){o.init.remove()});var s=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(){var e,r,o,c;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,t.loading=!0,n.next=4,a.method.init("integrations");case 4:e=n.sent,r=_slicedToArray(e,1),o=r[0],c=o.find(function(e){var n=e._id;return n===t.id}),t.settings=_.clone(c,!0),n.next=14;break;case 11:n.prev=11,n.t0=n["catch"](0),console.warn(n.t0);case 14:return n.prev=14,i(),t.loading=!1,t.$apply(),n.finish(14);case 19:case"end":return n.stop()}},n,null,[[0,11,14,19]])}));return function(){return e.apply(this,arguments)}}();t.id&&s()}]),angular.module("marketplace").controller("marketplaceFormEvotor",["$scope","modalService","$timeout","api","$state","db",function(t,e,n,r,a,o){function i(){var t=o.storage.integrations.data.find(function(t){return t._id===c});e.method.add([{title:"SAVE",className:"green",active:!0,action:p,visible:!0},{title:t.active?"DISABLE":"ENABLE",className:t.active?"red":"green","float":"right",active:!0,visible:!0,action:m}])}var c=a.params.pluginId,s={};t.errors={},t.settings={stores:{},employees:{},register:{}};var u=function(e){var n=_slicedToArray(e,1),r=n[0];t.current=_.clone(r.find(function(t){return t._id===c}),!0),Array.isArray(t.current.settings.mappings.stores)&&(t.current.settings.mappings.stores={});var a=_objectSpread({},t.current,{settings:_objectSpread({mappings:{}},t.current.settings)});s=a.settings;var o=["devices","staff","stores"];o.forEach(function(t){Array.isArray(s.mappings[t])&&(s.mappings[t]={})}),t.data=s,t.$apply()};t.iconClass=function(e,n){return t.errors[e.uuid]?"red exclamation triangle":t.data.mappings[n.toModel]&&t.data.mappings[n.toModel][e.uuid]?"blue check":"yellow exclamation triangle"},t.sync={loading:!1,loadingCatalogIn:function(){return this.fetch("products-evotor")},loadingCatalogOut:function(){return this.fetch("products-cloudshop")},fetch:function(e){var n=this;return this.loading=!0,r.data.get("/:client/integrations/sync/".concat(c,"/").concat(e),{v:"v3"})["catch"]().then(function(){n.loading=!1,t.$apply()})}},t.formScheme=[{label:"MATCH_STORES",from:"Магазин в Эвотор",to:"Магазин в CloudShop",toModel:"stores",toDropdown:"store",data:"stores"},{label:"MATCH_REGISTERS",from:"Касса в Эвотор",to:"Касса в CloudShop",toModel:"devices",toDropdown:"register",data:"devices"},{label:"COMPARE_EMPLOYEES",from:"Сотрудник в Эвотор",to:"Сотрудник в CloudShop",toModel:"staff",toDropdown:"staff",data:"employees"}],t.dropdown={store:{name:"stores",icon:"dropdown",placeholder:"SELECT_STORE","class":"basic large floating fluid button",cancel:!0,limit:999,onChange:function(){for(var t=arguments.length,e=new Array(t),r=0;t>r;r++)e[r]=arguments[r];n(function(){return d.apply(void 0,e)})}},staff:{name:"staff",icon:"dropdown",placeholder:"SELECT_EMPLOYEE","class":"basic large floating fluid light button",cancel:!0,limit:999,onChange:function(){for(var t=arguments.length,e=new Array(t),r=0;t>r;r++)e[r]=arguments[r];n(function(){return d.apply(void 0,e)})}},register:{name:"register",icon:"dropdown",placeholder:"SELECT_REGISTER","class":"basic large floating fluid light button",cancel:!0,limit:999,onChange:function(){for(var t=arguments.length,e=new Array(t),r=0;t>r;r++)e[r]=arguments[r];n(function(){return d.apply(void 0,e)})}}};var d=function(){var e=arguments.length<=3?void 0:arguments[3];t.errors={},_.map(s.mappings,function(t,n){_.map(t,function(t,r){var a=_.filter(s.mappings[n],function(e,n){return e===t&&n!==r});0!==a.length&&r!==e&&delete s.mappings[n][r]})})},l=function(t){return Object.keys(t).forEach(function(e){Object.keys(t[e]).forEach(function(n){t[e][n]||delete t[e][n]})}),t},p=function(){e.init.toggle(0,!1);var n=l(s.mappings);r.data.put("/:client/integrations/".concat(t.current.type,"/").concat(c),{_id:c,mappings:n,v:"v3"}).then(function(){var t=o.storage.integrations.data.find(function(t){return t._id===c});t.settings.mappings=n})["catch"](function(){}).then(function(){e.init.toggle(0,!0)})},m=function(){var t=o.storage.integrations.data.find(function(t){return t._id===c}),n=!t.active;r.data.put("/:client/integrations/".concat(t.type,"/").concat(t._id),{_id:c,active:n,v:"v3"}).then(function(){t.active=n})["catch"](function(){}).then(function(){e.init.remove(),i()})};i(),t.$watch("errors",function(t){e.init.toggle(0,0===Object.keys(t).length)}),t.$on("$destroy",function(){e.init.remove()}),o.method.init("integrations").then(u)}]),angular.module("cloudshop.documents").config(["$stateProvider",function(t){t.state("authenticated.card.doc_print_templates",{url:"/print-templates",templateUrl:"js/pages/card/documents/print-templates/_view.html",data:{pageTitle:"PRINT_TEMPLATES"}})}]),angular.module("cloudshop.documents").directive("iframePrintTemplates",["$rootScope","api","translateService",function(t,e,n){return{restrict:"C",link:function(t){t.url="/plugins/print-templates/?lang=".concat(n.get()),window.addEventListener("message",function(t){switch(t.data.type){case"update":e.user.updatePrintTemplates(t.data.payload)}},!1)}}}]),angular.module("cloudshop.documents").directive("documentProductsSort",["$filter",function(t){return{restrict:"A",link:function(t,e){t.filter={reverse:{name:!1,sku:!1},sortField:null,sort:function(e){this.sortField=e,console.warn(t.$parent.$parent.doc.data.products),t.$parent.$parent.doc.data.products=_.sortByOrder(t.$parent.$parent.doc.data.products,function(t){return t.product[e]||""},this.reverse[e]),this.reverse[e]=!this.reverse[e]}}}}}]),angular.module("cloudshop.documents").directive("documentProductsTotal",[function(){return{restrict:"A",replace:!0,scope:{doc:"="},template:'\n    <tr class="document-products-total">\n      <td class="mini"></td>\n      <td class="name"></td>\n      <td class="full-table-td"></td>\n      <td class="full-table-td"></td>\n      <td></td>\n      <td class="table-changes-td"></td>\n      <td ng-if="doc.type === \'movements\' && doc.from._id"></td>\n      <td ng-if="doc.type === \'movements\' && doc.to._id"></td>\n      <td class="right aligned">{{qty}}</td>\n      <td ng-if="[\'movements\', \'purchases\', \'return_sales\',\'return_purchases\'].indexOf(doc.type) === -1"></td>\n      <td ng-if="[\'movements\', \'changes\'].indexOf(doc.type) === -1"></td>\n      <td ng-if="doc.type !== \'movements\'"></td>\n      <td class="delete"></td>\n    </tr>\n    ',link:function(t){t.qty=0,t.sum=0,t.$watchCollection("doc.products",function(e){t.qty=_.sum(e,"qty"),console.warn("scope.qty",t.qty)})}}}]),angular.module("cloudshop.documents").directive("documentProductSum",["db","safeApply","docService",function(t,e,n){var r=n.doc;return{restrict:"A",scope:{item:"="},link:function(t,n){var a=!1,o=t.$watch("item",function(n,o){if(!n||a)return void(a=!1);try{(null===n.sum||n.price!==o.price||n.qty!==o.qty||n.discount_percent!==o.discount_percent)&&(t.item.sum=r.product.totalItemPrice(n),e(t))}catch(i){console.log(i)}},!0);t.$on("$destroy",function(){o()});var i=function(){r.data._id||(t.item.sum=r.product.totalItemPrice(t.item)),n.on("change",function(n){var r=n.target;try{var o=parseFloat(r.value);a=!0,t.item.price=o/t.item.qty,t.item.discount_percent=0,t.item.discount_sum=0,e(t)}catch(i){console.log(i)}})};i()}}}]),angular.module("cloudshop.documents").directive("docPropductItem2",[function(){return{restrict:"E",replace:!0,template:'\n    <tr class="right aligned"\n      dir-paginate="(key, item) in doc.data.products | filter:helpers.productsFilter | filter:searchProducts | itemsPerPage: pageSize"\n      current-page="currentPage">\n      <td class="mini center">{{(key + 1) + (currentPage - 1) * pageSize}}</td>\n      <td class="left aligned name">\n        <span ng-bind="::item.product.name"></span>\n      </td>\n      <td class="left aligned full-table-td" style="white-space: nowrap" ng-bind="::item.product.sku"></td>\n      <td class="left aligned full-table-td" style="white-space: nowrap" ng-bind="::item.product.barcode"></td>\n      <td class="table-changes-td" ng-bind="item.stock.current[doc.data.from._id] | num"></td>\n      <td ng-if="!doc.data._id && doc.data.type == \'movements\' && doc.data.from._id" class="document-highlight-input" ng-bind="item.stock.current[doc.data.from._id] - item.qty"></td>\n      <td ng-if="!doc.data._id && doc.data.type == \'movements\' && doc.data.to._id" class="document-highlight-input" ng-bind="item.stock.current[doc.data.to._id] + item.qty"></td>\n      <td\n        ng-if="::doc.data.sub_type !== \'inventory\'"\n        class="full document-highlight-input">\n        <input select-text type="number" ng-change="helpers.updateStocks(item, \'qty\')" ng-model="item.qty" ng-model-options="{debounce:{\'default\': 200}}"/>\n      </td>\n      <td\n        class="full document-highlight-input table-changes-td">\n        <input select-text type="number" ng-change="helpers.updateStocks(item, \'new\')" ng-model="item.stock.new_stock" ng-model-options="{debounce:{\'default\': 200}}"/>\n      </td>\n      <td\n        ng-if="::params.price"\n        class="full">\n        <input\n          select-text\n          type="number"\n          ng-readonly="user.positions().type == \'cashier\'"\n          ng-model="item.price"\n          ng-model-options="{debounce:{\'default\': 200}}"/>\n      </td>\n      <td\n        ng-if="::(params.price && params.discount)"\n        class="full">\n        <input\n          select-tex\n          type="number"\n          ng-model="item.discount_percent"\n          ng-model-options="{debounce:{\'default\': 200}}"/>\n      </td>\n      <td\n        ng-if="::params.price"\n        class="full">\n        <input\n          type="text"\n          disabled\n          class="text-right"\n          ng-value="doc.product.totalItemPrice(item) | price"/>\n      </td>\n\n      <td class="table-changes-td">{{item.qty | num}}</td>\n      <td ng-if="::doc.data.sub_type == \'inventory\'" class="full-table-td">{{item.prices[doc.data.price] | price}}</td>\n      <td ng-if="::doc.data.sub_type == \'inventory\'">{{helpers.diffPrice(item)}}</td>\n\n      <td class="delete" ng-click="productRemove(item)"><i class="delete icon"></i></td>\n    </tr>\n    ',link:function(t,e){}}}]),angular.module("cloudshop.documents").controller("documentCtrlPrintDropDown",["$scope","docService","api","CONFIG",function(t,e,n,r){t.doc=e.doc,t.list=[],t.active=!1;var a=r.docServer,o=function(t){var e=$('<iframe src="'.concat(t,'" />'));$(e).css({width:1,height:1,position:"absolute",top:-999}),$("body").append(e)};t.onChange=function(e){t.doc.data._id?o(e.url(t.doc.data)):t.$parent.$parent.$parent.item.action().then(function(t){return t?o(e.url(t)):void 0})},t.$watch("doc.data",function(e){if(t.active=t.$parent.$parent.$parent.item.active,e.type&&(t.list=n.user.positions().settings.print_templates.filter(function(t){return t.document==="".concat(e.type).concat(e.sub_type?"_".concat(e.sub_type):"")&&t.active}).map(function(t){return _objectSpread({},t,{url:function(e){var r=e._id;return"https://".concat(a,"/template/print/").concat(r,"/").concat(n.user.clientID(),"/").concat(t._id,".html")}})}),"sales"===e.type)){var r="/print/bso/invoice/:id";t.bank_account_pay={label:"PAYMENT_INVOICE",url:function(t){var e=t.orders,o=void 0===e?[{}]:e;return"https://".concat(a).concat(r.replace(":id",o[0]._id),".html?company=").concat(n.user.clientID())}}}},!0)}]),angular.module("cloudshop.documents").directive("documentInputQty",["safeApply",function(t){return{restrict:"E",replace:!0,scope:{item:"="},template:'\n    <input\n      select-text\n      document-input-enter\n      type="number"\n      id="input-qty"\n      ng-value="{{item.stock.new_stock}}"\n    />\n    ',link:function(e,n){var r,a=$(n).parents("tr"),o=_.debounce(function(){var a=$(n).val();r!==a&&(r=a,e.item.stock.new_stock=a,e.item.counted=!0,e.$parent.helpers.updateStocks(e.item,"new"),t(e))},50),i=_.debounce(function(t){var e=t.keyCode;13!==e&&o()},200);$(n).on("keydown",i).on("change",o);var c=e.$watch("item.counted",function(t,e){t!==e&&a.toggleClass("counted",t)}),s=e.$watch("item.stock.new_stock",function(t,e){t!==e&&$(n).val(t)});e.$destroy=function(){c(),s(),$(n).off("keydown",i).off("change",o)};var u=function(){e.item.counted&&a.addClass("counted")};u()}}}]),angular.module("cloudshop.documents").directive("documentPacks",["db","safeApply","$rootScope","docService",function(t,e,n,r){var a=r.doc;return{restrict:"E",replace:!0,scope:{item:"="},template:"\n      <div>\n        <select></select>\n        <span ng-bind=\"item.product.unit || '-'\"></span>\n      </div>\n    ",link:function(r,o){var i,c=[],s=$("select",o),u=$("span",o);r.item.pack||(r.item.pack={});var d=function(){r.product=t.storage.catalog.formatted.find(function(t){return t._id===r.item._id})||[];var e=(r.product.packs||[]).map(function(t){return{name:t.name,qty:t.qty}});return[{name:r.item.product.unit||"-",qty:1}].concat(_toConsumableArray(e))},l=function(){var t;r.product={},$(o).on("change","select",function(t){var n=t.target.value,a=c.find(function(t,e){return e===+n});0===+n?r.item.pack={}:r.item.pack=_objectSpread({},a),i.val((r.item.qty/(r.item.pack.qty||1)).floor(-4)),e(r)}),setTimeout(function(){i=$(o).parent().next().next().next().find("input");var n=i.clone();i.after(n),i.remove(),i=n,i.val(i.val()/r.item.pack.qty||1),i.on("change",function(n){var a=n.target.value*(+r.item.pack.qty||1);r.item.qty!==a&&(t&&clearTimeout(t),t=setTimeout(function(){t=void 0},400),r.item.qty=a,e(r))}),s.change()});var a=function(){s.empty(),c.forEach(function(t,e){var n="".concat(t.name).concat(0!==e?" ("+t.qty+")":"");s.append('<option value="'.concat(e,'">').concat(n,"</option>"))});var t=r.item.pack&&r.item.pack.name?r.item.pack.name:void 0,e=t?c.findIndex(function(e){return e.name===t}):0;-1===e&&(e=0),s.val(e)};a();var u=n.$on("WS_UPDATE",function(t,e){try{"catalog"!=e.meta.type||e.meta["import"]||e.meta.data._id===r.item._id&&(c=d(),a(),s.change())}catch(n){console.log("error",n)}}),l=r.$watch("item.qty",function(e,n){e-n!==1||t||i.val((parseFloat(i.val())+1).floor(-4)).change()});r.$on("$destroy",function(){u(),l()})},p=function(){c=d(),1===c.length||"inventory"===a.data.sub_type?(s.hide(),u.show()):(s.show(),u.hide(),l())};p()}}}]),angular.module("cloudshop.documents").directive("documentInputsEnter",[function(){return{restrict:"A",link:function(t,e){var n=function(){var t=$(this).parents("tr");t.addClass("focused")},r=function(){var t=$(this).parents("tr");t.removeClass("focused")};$(e).on("keydown","[document-input-enter]",function(t){var e=t.keyCode,n=$(this).parents("td").index(),r=$(this).parents("tr");try{if(13===e){var a=r.next().children()[n];$(a).find("input").focus()}}catch(o){console.warn(o)}}).on("focus","[document-input-enter]",n).on("blur","[document-input-enter]",r)}}}]),angular.module("cloudshop.documents").directive("docExcel",["db","apiRouteService","safeApply",function(t,e,n){return{restrict:"E",replace:!0,templateUrl:"/js/pages/card/documents/directives/doc-excel.html",link:function(r){function a(t){return t=t||0,"number"==typeof t?t:(t=t.replace(/\s|\$/g,""),t=t.replace(",","."),parseFloat(t))}function o(t){var e,n=t.trim().replace(/\'/g,'"');n=n.replace(/\"/g,'\\"');var r=Papa.parse(n,{skipEmptyLines:!0,delimiter:"	",linebreak:"↵",truncated:!1});e=r.data;var a=e.reduce(function(t,e){return e.forEach(function(e,n){return t[n]=t[n]||e}),t},[]);return e=e.map(function(t){return t.filter(function(t,e){return a[e]})}),e=e.map(function(t){return t.map(function(t){return t.replace(/\\"/g,'"')})})}function i(t){return t.map(function(t){var e={};return t.forEach(function(t,n){var a=r.select[n],o=r.fields.filter(function(t){return t.name==a})[0]||{};a&&(e[a]=o.format?o.format(t):t)}),e.type="inventory",e.price=e.price||0,e.qty=e.qty||1,e.barcode=(e.barcode||"").trim(),e})}function c(t){r.start!=t&&(r.start=t,r.$parent.$parent.showProductPanel=!t)}r.start=!1,r.data=[],r.select=[];var s=[];r.match="auto",r.dropdown={match:{name:[{name:"Автоматически",_id:"auto"},{name:"По наименованию",_id:"name"},{name:"По артикулу",_id:"sku"},{name:"По штрих-коду",_id:"barcode"}],"class":"basic floating fluid button",icon:"dropdown",limit:10,onChange:function(t,e){r.match=e._id,m()}}};var u=r.dropdown.match.name.map(function(t){return t._id});r.fields=[{title:"NAME",name:"name",filter:!0},{title:"BARCODE",name:"barcode",filter:!0,test:function(t){return/^\d+$/.test(t)&&t.toString().length>10}},{title:"SKU",name:"sku",filter:!0},{title:"UNIT",name:"unit"},{title:"PRICE_SALE",name:"price",format:a},{title:"PRICE_PURCHASE",name:"purchase",format:a},{title:"QUANTITY",name:"qty",format:a}],r.$watch("data",function(t){0==t.length&&c(!1)}),r.$watch("select",function(t,e){for(var n=_.difference(t,e),r=_.difference(e,t),a=0;a<u.length;a++)if(n.includes(u[a])||r.includes(u[a]))return void m()},!0),r["delete"]=function(){var t=this;r.data=r.data.filter(function(e,n){return t.$index!=n})},r.filterSelect=function(t,e){return t.filter(function(t){return-1!=[-1,e].indexOf(r.select.indexOf(t.name))})};var d=function(){var t=[],e=_.clone(r.select,!0),n=r.fields.find(function(t){return"barcode"===t.name}).test;r.data.forEach(function(e,r){t[r]=[],e.values.forEach(function(e,a){t[r].push(e?n(e):null)})}),_.zip.apply(_,t).forEach(function(t,n){var r=t.filter(function(t){return t===!0}).length,a=t.filter(function(t){return t===!1}).length;!a&&r&&(e[n]="barcode")}),r.select=e,m()},l=function(t){r.$parent.doc.pastedExcel=!0;var e=o(t);e[0]&&"undefined"!=typeof e[0][1]&&(r.select=_.range(e[0].length).map(function(){return""}),r.data=e.map(function(t){var e=t.map(function(t){return String(t).trim()});return{values:e,product:{}}}),d(),c(!0),r.$apply())},p=function(t){["input","textarea"].indexOf(t.srcElement.localName)<0&&(l(t.clipboardData.getData("text/plain")),t.preventDefault())};document.addEventListener("paste",p),r.$on("$destroy",function(){document.removeEventListener("paste",p)}),r.trClass=function(){return{positive:this.tr.product._id,negative:!this.tr.product._id&&0!=r.select.filter(function(t){return!!t})}},r.cancel=function(){c(),r.data=[],r.select=[]},r.go=_asyncToGenerator(regeneratorRuntime.mark(function h(){var t,o,c,s,u;return regeneratorRuntime.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(t=r.data.filter(function(t){return!!t.product._id}).map(function(t){var e=t.values;if(t=t.product,_.forEach(t,function(n,a){var o=r.select.indexOf(a),i=r.fields.filter(function(t){return t.name==a})[0]||{};o>-1&&(n=i.format?i.format(e[o]):e[o]),t[a]=n}),"undefined"==typeof t.qty){var n=e[r.select.indexOf("qty")]||1;t.qty=a(n)}return t}),o=r.data.filter(function(t){return!t.product._id}).map(function(t){return t.values}),o=i(o),d.prev=3,r.$parent.$parent.docExcelLoading=!0,c=_.clone(o,!0).map(function(t){var e=(t.qty,_objectWithoutProperties(t,["qty"]));return e}),!o.length){d.next=12;break}return d.next=9,e.catalog()["import"](c);case 9:d.t0=d.sent,d.next=13;break;case 12:d.t0=[];case 13:for(s=d.t0,u=0;u<s.length;u++)s[u].qty=o[u].qty;[].concat(_toConsumableArray(s),_toConsumableArray(t)).forEach(function(t){r.$parent.doc.product.add(t,t.qty,{from:"excel"})}),d.next=21;break;case 18:d.prev=18,d.t1=d["catch"](3),console.warn(d.t1);case 21:return d.prev=21,setTimeout(function(){r.$parent.$parent.docExcelLoading=!1},200),d.finish(21);case 24:r.cancel(),n(r);case 26:case"end":return d.stop()}},h,null,[[3,18,21,24]])}));var m=function(){return 0==r.select.filter(function(t){return!!t}).length?!1:void(r.data=r.data.map(function(t){return t.product=_.clone(s.formatted.find(function(e){for(var n=!1,a="auto"===r.match?u:[r.match],o=0;o<a.length;o++){var i=r.select.indexOf(a[o]),c=t.values[i];if(-1!==i&&c&&(n=String(e[a[o]])===String(c)),n)return!0}return n})||{},!0),t}))},f=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.method.init("catalog");case 2:s=t.storage.catalog;case 3:case"end":return e.stop()}},n)}));return function(){return e.apply(this,arguments)}}();f()}}}]),angular.module("cloudshop.documents").directive("catalogFilterDocument",[function(){return{restrict:"C",link:function(t,e){$(e).on("click",".showCatalogFilter",function(){$(e).hasClass("active")?$(document).click():($(e).addClass("active"),$(".catalog-filter",e).show(),$(e).closest(".block").css({zIndex:200}))}),$(e).on("click",function(t){t.stopPropagation()}),$(document).on("click",function(){$(e).removeClass("active"),$(".catalog-filter",e).hide(),$(e).closest(".block").css({zIndex:1})});var n=function(){var t=e[0].getElementsByClassName("catalog-filter");if(t[0]){var n=t[0].dataset.params;return Number(n)}return 0};t.$watch(n,function(t,n){var r=$(".showCatalogFilter",e);t?r.addClass("blue"):n&&r.removeClass("blue")})}}}]).directive("documentProductStock",["db","$filter",function(t,e){var n=t.storage.catalog;return{restrict:"A",scope:{document:"="},link:function(t,r){t.item=t.$parent.$parent.item;var a=n.formatted.find(function(e){return e._id===t.item._id}),o=t.document,i=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!1;$(r).parent().toggleClass("error",t),t?$(r).popup({on:"hover",delay:{show:50,hide:0},exclusive:!0,hideOnScroll:!0,content:e("translate")("QUANTITY_ENTERED_IS_MORE_THAN_AVAILABILI"),position:"top center"}):$(r).popup("destroy")},c=function(){var t=parseFloat($(r).val());i(!(a.stock[o.from._id]>=t))},s=function(){setTimeout(c),r.on("change",function(){c()}),t.$watch("document",function(t,e){t.from._id!==e.from._id&&c()},!0),t.$watch("item",function(t,e){t.qty!==e.qty&&c()},!0)},u=["sales","return_purchases","movements"];void 0!==o._id||!u.includes(o.type)&&"out"!==o.sub_type||"service"!==t.item.product.type&&s()}}}]),angular.module("cloudshop").directive("changesTotal",["docService",function(t){var e;return e={restrict:"E",replace:!0,scope:!1,template:"\n      <div class=\"docsTotal\">\n        <div ng-if=\"!short\" ng-style=\"{marginBottom: 40}\">\n          <h2 translate>TOTAL</h2>\n          <h3 ng-style=\"{display: 'flex'}\">\n            {{'TOTAL_ITEMS' | translate}} <div></div> <span>{{count().total[0]}}</span>\n          </h3>\n          <h3 ng-style=\"{display: 'flex'}\">\n            {{'Не подсчитано позиций' | translate}} <div></div> <span>{{count().total[5]}}</span>\n          </h3>\n          <h3>\n            {{'NUMBER_OF_ITEMS_IN_WHICH_STOCK_IS_DIFFER' | translate}} <div></div> <span>{{count().total[1]}}</span>\n          </h3>\n          <h3>\n            {{'ESTIMATED_AMOUNT' | translate}} <div></div> <span>{{count().total[2] | curr}}</span>\n          </h3>\n          <h3>\n            {{'ACTUAL_TOTAL' | translate}} <div></div> <span>{{count().total[3] | curr}}</span>\n          </h3>\n          <h3>\n            {{'SUM_OF_DISCREPANCY' | translate}} <div></div> <span>{{count().total[4] | curr}}</span>\n          </h3>\n        </div>\n\n        <div class=\"row\">\n          <div class=\"col-xs-11\">\n            <h2 translate>SHORTFALL</h2>\n            <h3>\n              {{'NUMBER_OF_ITEMS' | translate}} <div></div> <span>{{count().minus[0] | num}}</span>\n            </h3>\n            <h3>\n              {{'SUM_OF_DISCREPANCY' | translate}} <div></div> <span>{{count().minus[1] | curr}}</span>\n            </h3>\n          </div>\n\n          <div class=\"col-xs-offset-2 col-xs-11\">\n            <h2 translate>SURPLUS</h2>\n            <h3>\n              {{'NUMBER_OF_ITEMS' | translate}} <div></div> <span>{{count().plus[0] | num}}</span>\n            </h3>\n            <h3>\n              {{'SUM_OF_DISCREPANCY' | translate}} <div></div> <span>{{count().plus[1] | curr}}</span>\n            </h3>\n          </div>\n        </div>\n      </div>\n      "},_defineProperty(e,"scope",{doc:"="}),_defineProperty(e,"link",function(t,e,n){var r=t.doc;t["short"]="undefined"!=typeof n["short"],t.count=function(){var e,n=r.from._id,a=r.products.map(function(t){return _objectSpread({},t,{prices:t.prices?t.prices:_defineProperty({},r.price,t.price)})}),o=a.filter(function(t){return t.qty<0}),i=a.filter(function(t){return t.qty>0});if(!t["short"]){var c=_.sum(a.map(function(t){return t.stock.current?t.stock.current[n]*t.prices[r.price]:0})),s=_.sum(a.map(function(t){return t.stock.new_stock*t.prices[r.price]}));e=[a.length,a.filter(function(t){return 0!=t.qty}).length,c,s,s-c,a.filter(function(t){return!t.counted}).length]}return{total:e,minus:[_.sum(o.map(function(t){return t.qty})),_.sum(o.map(function(t){return t.qty*t.prices[r.price]}))],plus:[_.sum(i.map(function(t){return t.qty})),_.sum(i.map(function(t){return t.qty*t.prices[r.price]}))]}}}),e}]),angular.module("cloudshop.documents").controller("documentsEditCtrl",["$scope","$state","db","docService","cardService","alertModal",function(t,e,n,r,a,o){var i=e.params.id,c=t.$parent,s=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function s(){var e,u,d,l,p;return regeneratorRuntime.wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(!i){s.next=41;break}return c.loading=!0,s.prev=2,s.next=5,n.method.query.get("/docs/:client/"+i,{v:"v3"});case 5:return e=s.sent,u=_slicedToArray(e.data,1),d=u[0],s.next=10,n.method.init("catalog");case 10:if(c.loading=!1,d){s.next=15;break}return c.no_data=!0,c.$apply(),s.abrupt("return",!1);case 15:
Number.isInteger(parseInt(d.state))&&(c.stateToggle=!0),"inventory"!==d.sub_type&&(d.qty=Math.abs(d.qty),d.products=d.products.filter(function(t){return!t.product.id_parent}).map(function(t){return _objectSpread({},t,{qty:Math.abs(t.qty)})})),l=r.types[d.type],c.doc.data=Object.assign({},c.doc.data,d),c.oldQty=c.doc.data.qty,c.doc.data.products=c.doc.product.addFromJson(c.doc.data.products),c.setting={type:c.doc.data.type,price:["purchases","return_purchases"].indexOf(c.doc.data.type)>=0?"purchase":"price"},c.doc.paid.data=d.orders,c.init({type:d.type,id:d._id,sub_type:d.sub_type}),c.showProductPanel=!1,a.method.append([{title:"DELETE",className:"red","float":"right",active:!0,visible:!0,action:c.remove,perm:[c.setting.permission,"DELETE"]}]),d._shift&&(a.method.update({className:"green labeled icon",icon:"warning sign"},0),a.method.update({icon:"warning sign"},2)),t.$watch("showProductPanel",function(t){a.method.data.className=t?"documents-expand":"documents-compress"}),n.method.get(l.from).then(function(t){_.where(t,{_id:c.doc.data.from._id})[0]||(c.doc.data.from.deleted=!0,n.storage[l.from].data.push(_.clone(c.doc.data.from,!0)),c.$apply())}),l.to&&n.method.get(l.to).then(function(t){_.where(t,{_id:c.doc.data.to._id})[0]||(c.doc.data.to.deleted=!0,n.storage[l.to].data.push(_.clone(c.doc.data.to,!0)),c.$apply())}),p=r.doc.data.type,t.productFilter=function(t){return["sales","return_sales"].indexOf(p)>=0?!0:"set"!=t.type},c.doc.data.products=c.doc.data.products.map(function(t){var e=_.where(n.storage.catalog.data,{_id:t._id})[0];return e&&(t.product.pic=e.pic,t.product.sku=e.sku,t.product.barcode=e.barcode),t}),s.next=39;break;case 35:s.prev=35,s.t0=s["catch"](2),console.log(s.t0),o("INTERNAL_ERROR_PLEASE_TRY_LATER");case 39:return s.prev=39,s.finish(39);case 41:case"end":return s.stop()}},s,null,[[2,35,39,41]])}));return function(){return e.apply(this,arguments)}}();s()}]),angular.module("cloudshop.catalog").service("catalogStockTotalService",["db",function(t){var e=this;return this.data=[],this.getStocks=function(t){var n={qty:0,price:0,cost:0,emptyCost:[],expirationDate:[]};return e.data.filter(function(e){return!t||void 0!==e.stock[t]}).forEach(function(e){if(e.expiration_date&&e.expiration_date<+moment().format("X")&&n.expirationDate.push(e._id),"inventory"===e.type){var r=t?e.stock[t]:e.stockCount;0===e.cost&&n.emptyCost.push(e._id),n.qty+=r,n.price+=(e.store_prices[t]||e.price)*r,n.cost+=e.cost*r}}),n},this.init=function(n){var r=0,a=0,o=0;return n&&(e.data=n),t.method.init(["catalog","stores"]).then(function(){e.data.forEach(function(t){"inventory"===t.type&&(0===t.cost&&r++,t.stockCount<0&&a++),t.expiration_date&&t.expiration_date<+moment().format("X")&&o++});var n=[];return t.storage.stores.data.sort(function(t,e){return t.name.toLowerCase()<e.name.toLowerCase()?-1:1}).map(function(t){n.push(_objectSpread({store:t},e.getStocks(t._id)))}),n.unshift(_objectSpread({},e.getStocks())),{data:n,emptyCost:r,emptyStock:a,expirationDate:o}})},this.$destroy=function(){e.data=[]},this}]).run(["catalogStockTotalService","$rootScope","$state",function(t,e,n){e.$on("pushProductStockTotal",function(e,r){t.data=r,n.go("authenticated.card.catalog.stock")})}]),angular.module("cloudshop.catalog").controller("catalogStockTotalCtrl",["$scope","catalogStockTotalService","catalogFilterS","$state","safeApply",function(t,e,n,r,a){t.data=[],t.service=e,t.openCost=function(){n.query={types:["inventory"],prices:[{_id:"cost",type:"cost",values:{from:0,to:0}}]},r.go("authenticated.card.catalog.list")},t.openStock=function(){n.query={types:["inventory"],stocks:[{_id:"main",name:"GENERAL",type:"main",values:{symbol:"<",value:0}}]},r.go("authenticated.card.catalog.list")},t.openExpired=function(){n.query={expiration:{value:null,type:2}},r.go("authenticated.card.catalog.list")},t.$on("$destroy",function(){e.$destroy()});var o=function(){e.init().then(function(e){var n=e.data,r=e.emptyCost,o=e.emptyStock,i=e.expirationDate;t.data=n,t.emptyCost=r,t.emptyStock=o,t.expirationDate=i,a(t)})};o()}]),angular.module("cloudshop.catalog").controller("showCtrl",["$scope","db","catalogService","modalService","$state","docService","$rootScope","imageUpload","profile","$filter","apiRouteService",function(t,e,n,r,a,o,i,c,s,u,d){function l(t){return _.map(t,function(t){return t.doc.date=moment(1e3*t.doc.date).format("DD MMMM YYYY"),t.doc_=o.types[t.doc.type+(t.doc.sub_type||"")],t})}function p(t){return t.fn=function(t){return this.cost?t?+((this.price-this.cost)/t*100):0:100},t}function m(){return f.apply(this,arguments)}function f(){return f=_asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,n.method.remove();case 3:r.method.close(),t.next=9;break;case 6:t.prev=6,t.t0=t["catch"](0),console.warn(t.t0);case 9:case"end":return t.stop()}},t,null,[[0,6]])})),f.apply(this,arguments)}function h(){r.method.add([{title:"EDIT",className:"green",active:!0,action:{url:"authenticated.card.catalog.update",param:{productId:v}},visible:!0,perm:["catalog","PUT"]},{icon:"copy",className:"icon basic",active:!0,action:E,visible:!0,perm:["catalog","POST"],popup:"CLONE_PRODUCT"},{title:"DELETE",className:"red","float":"right",active:!0,action:m,visible:!0,perm:["catalog","DELETE"]}])}t.db=e.storage,t.method=n.method,t.types=n.types,t.modalService=r.init.data,t.store_prices=[];var g=!0;t.now=+moment().format("X"),t.meta={supplier:{},stocksTotal:{stock:0,cost:0,price:0}};var v=a.params.productId;t.historySettings={offset:0,limit:5,total:0,loaded:!1,loadedCount:0,load:!1},t.historyData=[],t.$watch("store_id",function(e){e&&t.loadHistory()});var y=i.$on("updater",function(t,e){"catalog"==e.type&&b()});t.$on("$destroy",function(){r.init.remove(),r.init.data.loading=!1,y(),g&&n.method.clear()}),n.method.error=null;var b=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function o(){var a;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,e.method.init("catalog");case 2:if(a=e.storage.catalog.formatted.find(function(t){return t._id===v}),n.method.data=e.storage.catalog.proto(_.clone(a,!0)),n.method.data._id?(t.data=p(n.method.data),t.typeName=(n.types.find(function(e){return e.value===t.data.type})||{}).title):n.method.error=404,r.init.data.loading=!1,n.method.data.store_prices&&_.map(n.method.data.store_prices,function(n,r){var a=e.storage.stores.data.filter(function(t){return t._id==r})[0];a&&n&&t.store_prices.push("".concat(u("curr")(n)," - ").concat(a.name))}),t.$apply(),!n.method.data._id){o.next=12;break}return o.abrupt("return",n.method.data);case 12:return o.abrupt("return",Promise.reject());case 13:case"end":return o.stop()}},o)}));return function(){return a.apply(this,arguments)}}();t.store_id=0,t.loadHistory=function(){return t.historySettings.load=!0,e.method.query.get("/movs/:client/".concat(v,"/").concat(t.store_id,"/").concat(t.historySettings.offset,"/").concat(t.historySettings.limit)).then(function(e){t.historyData=t.historyData.concat(l(e.data)),t.historySettings.offset+=t.historySettings.limit,t.historySettings.loaded=!0,t.historySettings.loadedCount+=e.data.length,t.historySettings.total=e.total,t.historySettings.load=!1,t.$apply()})},t.uploadPic=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(e){var r;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return t.loadingImage=!0,n.prev=1,n.next=4,c.save(e);case 4:r=n.sent,t.data.pic=[].concat(_toConsumableArray(t.data.pic),[r]),d.catalog().edit({_id:t.data._id,name:t.data.name,pic:t.data.pic}),n.next=12;break;case 9:n.prev=9,n.t0=n["catch"](1),alert("ERROR_LOADING_PICTURE");case 12:return n.prev=12,t.loadingImage=!1,n.finish(12);case 15:case"end":return n.stop()}},n,null,[[1,9,12,15]])}));return function(t){return e.apply(this,arguments)}}(),t.getProdIcon=function(t){return n.types.find(function(e){return e.value===t.type}).icon};var E=function(){g=!1,i.$broadcast("EVENT_CATALOG_DUPLICATE",t.data)},S=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function a(){var n,o,i,c,u,d,l,p,m,f,g,y,E;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return r.init.data.loading=!0,a.prev=1,n=[],a.next=5,e.method.init(["stores","catalog","countries"]);case 5:if(o=a.sent,i=_slicedToArray(o,3),c=i[0],u=i[1],d=i[2],!s.permission(["suppliers","GET"])){a.next=16;break}return a.next=13,e.method.init("suppliers");case 13:l=a.sent,p=_slicedToArray(l,1),n=p[0];case 16:if(t.stores=c,!v){a.next=25;break}return a.next=20,b();case 20:t.meta.supplier=_.clone(n.find(function(e){return e._id===t.data.supplier})||{}),t.meta.group=u.find(function(e){return e._id===t.data.id_group}),m=t.data,f=m.stock,g=m.cost,y=m.store_prices,E=m.price,c.forEach(function(e){var n=f[e._id]||0;t.meta.stocksTotal.stock+=n,t.meta.stocksTotal.cost+=n*g,t.meta.stocksTotal.price+=n*(y[e._id]||E)}),t.meta.country=_.clone(d.find(function(e){return e.name==t.data.country}));case 25:h(),a.next=30;break;case 28:a.prev=28,a.t0=a["catch"](1);case 30:return a.prev=30,t.$apply(),a.finish(30);case 33:case"end":return a.stop()}},a,null,[[1,28,30,33]])}));return function(){return n.apply(this,arguments)}}();S()}]),angular.module("cloudshop.catalog").directive("catalogCard",["$rootScope",function(t){return{restrict:"A",link:function(e,n){e.tabHistary=!1,n.on("click",".divider .button",function(r){var a=$(this).index(),o=$(this).closest(".divider");switch(o.find(".active").removeClass("active"),$(this).addClass("active"),a){case 0:o.next().show(),o.next().next().hide();break;case 1:o.next().hide(),o.next().next().show();var i=function(){var t=o.position().top+10;$(".cs_container > .content").stop().animate({scrollTop:t},200)};if($(".catalog_page_history",n).length)i();else var c=t.$on("CATALOG_MOVES_FETCH_SUCCESS",function(){setTimeout(i),c()});try{e.tabHistary=!0,e.$apply()}catch(r){}}})}}}]),angular.module("cloudshop.catalog").service("scannerService",["$rootScope","db","$state","$http","apiRouteService","filterCatalogService","fn","$timeout","docService","api","profile",function(t,e,n,r,a,o,i,c,s,u,d){function l(t){return angular.extend(this,t)}var p=[],m="authenticated.card.catalog.scanner",f=function(t){return r.get("/barcode/".concat(t)).then(function(t){return t.data}).then(function(t){return 0==t.status?{}:t}).then(function(t){return delete t.status,t})},h=function(t){return new Promise(function(e,n){var a=[];t.forEach(function(t){a.push(r.get("/barcode/".concat(t.barcode,"/image/")))}),Promise.all(a).then(function(e){for(var n in t){var r=e[n].data.url;r&&(t[n].pic=[r])}return t}).then(function(t){return _.clone(t,!0).map(function(t){return delete t.qty,t})}).then(e)["catch"](function(t){return n(t)})})},g=function(t){var e=Number(t.slice(0,2)),n=t.slice(2,7),r=Number(t.slice(7,12))/1e3;return{pref:e,code:n,weight:r}};l.prototype.barcode_service=!0;var v={scan:function(t){if(y.loading=!1,t){var r,a=g(t),o=u.user.company(),i=o.plu_pref;a.pref===Number(i)?r=e.storage.catalog.data.find(function(t){return t.PLU_code===a.code}):(r=e.storage.catalog.data.find(function(e){return String(e.barcode).includes(t)}),a.weight=null),r||(r={barcode:t},f(t).then(function(t){for(var e in p)t.barcode===p[e].barcode&&(p[e]=new l(_objectSpread({},p[e],{},t)))}));var c=p.filter(function(t){return t.barcode===r.barcode})[0];if(c){if(!c._id&&r._id)for(var s in p)r.barcode===p[s].barcode&&(p[s]=r)}else p.push(_objectSpread({},r,{qty:a.weight||1}));if(c)for(var d in p)c.barcode===p[d].barcode&&(p[d].qty+=a.weight||1);n.current.name!==m&&n.go(m)}},"delete":function(t){for(var e in p)t.barcode===p[e].barcode&&p.splice(e,1)},save:function(){return _asyncToGenerator(regeneratorRuntime.mark(function e(){var n,r,o,c,s,l,m,f,g;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(d.permission(["catalog","POST"])){e.next=3;break}return p=p.filter(function(t){return t._id}),e.abrupt("return",!1);case 3:y.loading=!0;for(n in p)p[n]._id||(p[n].uuid=i.guid(),p[n].type="inventory");return r=p.filter(function(t){return!t._id&&t.name}),e.prev=6,e.next=9,h(r);case 9:return o=e.sent,e.next=12,a.catalog()["import"](o);case 12:c=e.sent,s=[],l=function(e){var n=p[e],r=c.filter(function(t){return t.uuid==n.uuid})[0];r&&(p[e]._id=r._id,s.push(u.data.get("/data/:client/catalog/".concat(p[e]._id),{v:"v3"})),t.$broadcast("catalog.create",{type:"inventory",hasBarcode:!0,hasCategories:p[e].categories&&!!p[e].categories.length,byBarcode:!0,barcodeService:!!p[e].__proto__.barcode_service}))};for(m in p)l(m);return e.next=18,Promise.all(s);case 18:return f=e.sent,f=f.map(function(t){var e=t.data.data;return e}),p.forEach(function(t,e){if(!t.created){var n=f.find(function(e){return e._id===t._id});p[e]=_objectSpread({stock:{}},t,{},n)}}),e.next=23,new Promise(function(t){setTimeout(function(){return t(p)},500)});case 23:return g=e.sent,y.loading=!1,e.abrupt("return",g);case 28:if(e.prev=28,e.t0=e["catch"](6),"no data"===e.t0){e.next=32;break}return e.abrupt("return",Promise.reject(e.t0));case 32:case"end":return e.stop()}},e,null,[[6,28]])}))()},addToDoc:function(t){n.go(t);var e=_.clone(p,!0);c(function(){e.forEach(function(t){t.qty=t.qty||1,s.doc.product.add(t,t.qty,{from:"scanner-page",counted:!0})})},100)},destroy:function(){p.splice(0,p.length)}},y={loading:!1};return t.$on("BARCODE_SCAN",function(t,e){n.current.name.includes("authenticated.card.doc_create")||n.current.name.includes("authenticated.card.doc.edit")||v.scan(e)}),{data:p,methods:v,state:y}}]).run(["scannerService",function(t){}]),angular.module("cloudshop.catalog").directive("scanItemImage",[function(){return{restrict:"E",template:'\n        <a href="">\n          <img src="/images/px.gif" width="45" height="45" />\n        </a>\n      ',replace:!0,link:function(t,e){var n=$("img",e),r=function(){var e="http://www.ean13.info/pimages/original/"+t.item.barcode+".jpg";n.css({backgroundImage:'url("/images/placeholder.png")',backgroundSize:"cover",backgroundRepeat:"no-repeat",backgroundPosition:"50% 50%",display:"block"});var r=new Image;r.onload=function(){n.css({backgroundImage:"url(".concat(e,")")})},r.src=e};r()}}}]).directive("body",["$rootScope","$state",function(t,e){return{restrict:"E",link:function(e){var n="",r=function(t){return-1===["INPUT","TEXTAREA"].indexOf(t.target.nodeName)&&void 0===t.target.attributes["inline-edit"]},a=function(e){if(r(e)){var a=e.key,o=!((e.which<48||e.which>57)&&8!==e.which)&&0!==e.which;1===a.length&&/\d/.test(a)&&(o=!0),o&&(n+=a),13==e.keyCode&&(n&&(t.$broadcast("BARCODE_SCAN",n),e.preventDefault()),n="")}};document.body.addEventListener("keydown",a),e.$on("$destroy",function(){document.body.removeEventListener("keydown",a)})}}}]),angular.module("cloudshop.catalog").controller("scannerCtrl",["$scope","scannerService","modalService","docService","db",function(t,e,n,r,a){function o(){n.method.add([{visible:!0,template:"/js/pages/card/catalog/scanner/_dropdown.html"}])}t.doc=r,t.service=e;var i=t.$watch("service.data",function(t){n.init.toggle(0,!!t.length)},!0);t.$on("BARCODE_SCAN",function(){t.$apply()}),t.$on("$destroy",function(){n.init.remove(),i()});var c=function(){o(),a.storage.catalog.data.length||a.method.init("catalog").then(function(){e.data.forEach(function(t){e.methods.scan(null,t.barcode)})})};c()}]).controller("scannerDropdownCtrl",["$scope","$state","docService","scannerService","profile",function(t,e,n,r,a){t.loading=r.state.loading,t.types=Object.keys(n.types).map(function(t){return n.types[t]}).filter(function(t){return t.active}).filter(function(t){return a.permission(e.get(t.url).data)}),t.check=function(){return!(r.data.length>0&&0==r.data.filter(function(t){return!t.name}).length)},t.add=function(t){r.methods.save().then(function(){return r.methods.addToDoc(t)}).then(function(){return setTimeout(r.methods.destroy)})["catch"](console.warn)}}]),angular.module("cloudshop.catalog").service("catalogPriceChangeService",[function(){return this.data=[],this}]).run(["catalogPriceChangeService","$rootScope","$state",function(t,e,n){e.$on("pushProductToPriceChange",function(e,r){t.data=r,n.go("authenticated.card.catalog.changePrices")})}]),angular.module("cloudshop.catalog").controller("catalogPriceChangeCtrl",["$state","catalogPriceChangeService","$scope","apiRouteService","db","safeApply",function(t,e,n,r,a,o){n.loading=!0,n.catalog=[],n.activeButtonSave=!1;var i=[];n.currentPage=1,n.pageSize=50,n.onChange=function(t,e,r){if(n.activeButtonSave=!0,i.find(function(t){return t._id===r._id})){for(var a in i)if(i[a]._id===r._id){var o="store_prices"===e?{store_prices:_objectSpread({},i[a].store_prices,{},t)}:_objectSpread({},i[a],_defineProperty({},e,t));i[a]=_objectSpread({},i[a],{},o)}}else{var c=_defineProperty({},e,t);"store_prices"===e&&(c={store_prices:_objectSpread({},r.store_prices,{},t)}),i.push(_objectSpread({},r,{},c))}};var c=function(t){return e.data.indexOf(t._id)>-1},s=function(t){return{_id:t._id,name:t.name,store_prices:_objectSpread({},t.store_prices||{}),price:t.price,purchase:t.purchase,sku:t.sku||null,barcode:t.barcode||null,cost:t.cost}},u=function(t){return t.map(function(t){return Object.keys(t.store_prices).forEach(function(e){null===t.store_prices[e]&&delete t.store_prices[e]}),t})};n.save=_asyncToGenerator(regeneratorRuntime.mark(function l(){var t,e;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return t=u(i),a.prev=1,n.loading=!0,a.next=5,r.catalog()["import"](t,"put");case 5:n.loading=!1,n.activeButtonSave=!1;for(e in i)i.splice(e,1);a.next=13;break;case 10:a.prev=10,a.t0=a["catch"](1),alert("AN_ERROR_HAS_OCCURRED");case 13:case"end":return a.stop()}},l,null,[[1,10]])})),n.$on("$destroy",function(){e.data=[]});var d=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,i,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,a.method.init(["catalog","stores"]);case 3:t=e.sent,r=_slicedToArray(t,2),i=r[0],u=r[1],n.catalog=i.filter(c).map(s),n.stores=u,e.next=14;break;case 11:e.prev=11,e.t0=e["catch"](0),console.log(e.t0);case 14:return e.prev=14,n.loading=!1,o(n),e.finish(14);case 18:case"end":return e.stop()}},e,null,[[0,11,14,18]])}));return function(){return t.apply(this,arguments)}}();d()}]),angular.module("cloudshop.import",[]).config(["$stateProvider",function(t){t.state("authenticated.card.catalog.import",{url:"/import",templateUrl:"js/pages/card/catalog/import/_view.html",data:{pageTitle:"IMPORT_CATALOG",permission:"catalog",method:"POST"}})}]),angular.module("cloudshop.import").directive("iframeCatalogImport",["$rootScope",function(t){return{restrict:"C",link:function(e){function n(e){var n=e.data,r=n.type,a=n.payload;"importMsg"===r&&(t.$broadcast("catalog.import",a),t.$broadcast("catalog.update",[].concat(_toConsumableArray(a.created),_toConsumableArray(a.updated))))}window.addEventListener("message",n,!1),e.$on("$destroy",function(){window.removeEventListener("importMsg",n)})}}}]),angular.module("cloudshop.catalog").service("catalogGroupService",["api","apiRouteService","translateService","db","paginator","$rootScope","fn","$filter","alertModal","profile",function(t,e,n,r,a,o,i,c,s,u){var d=this,l=this;l.opened=!1,l.method={send:function(){function t(t){return n.apply(this,arguments)}var n=_asyncToGenerator(regeneratorRuntime.mark(function r(t){var n;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(0!=t.length){r.next=2;break}return r.abrupt("return",!1);case 2:return r.prev=2,r.next=5,e.catalog()["import"](t,"put");case 5:return n=r.sent,o.$broadcast("NOTIFY",{title:"ACTIONS_ON_A_GROUP_OF_PRODUCTS",subtitle:"CHANGES_SAVED"}),r.abrupt("return",n);case 10:return r.prev=10,r.t0=r["catch"](2),r.next=14,s("AN_ERROR_HAS_OCCURRED");case 14:case"end":return r.stop()}},r,null,[[2,10]])}));return t}()},l.selected=[],l.selectedFirstLvl=[];var p=function(){var t=l.selected.map(function(t){var e=t._id;return e}),e=r.storage.catalog.data.filter(function(e){var n=e._id;return t.includes(n)});return e};l.data={price:{title:"PRICES_AND_DISCOUNTS",permission:u.permission(["catalog","put"]),store_prices:{value:["price"]},absolute:{value:null,init:function(){l.data.price.store_prices.value[0]||(l.data.price.store_prices.value=["price"]);var t=p().map(function(t){var e={_id:t._id,name:t.name,store_prices:t.store_prices};return l.data.price.store_prices.value.forEach(function(t){var n=+l.data.price.absolute.value.toFixed(2);if("price"===t)e.price=n;else{var r=_defineProperty({},t,n);e.store_prices=e.store_prices?_objectSpread({},e.store_prices,{},r):r}}),e});l.method.send(t),l.data.price.absolute.value=null}},relative:{value:null,round:{value:null,data:[.1,.5,1,5,10,50,100]},direction:0,type:0,init:function(){var t=this;l.data.price.store_prices.value[0]||(l.data.price.store_prices.value=["price"]);var e=p().map(function(e){var n={_id:e._id,name:e.name,store_prices:e.store_prices,uuid:e.uuid};return l.data.price.store_prices.value.sort(function(t,e){return"price"===t?1:-1}).forEach(function(r){var a,o=e.price,i=t.value;if("price"!==r&&(o=!isNaN(parseFloat(e.store_prices[r]))&&isFinite(e.store_prices[r])?e.store_prices[r]:o),1===t.type&&(i=o*(i/100)),1===t.direction&&(i=-1*i),a=o+i,t.round.value&&0!==a&&a%t.round.value!==0&&(a+=t.round.value-a%t.round.value),"price"===r)n.price=a;else{var c=_defineProperty({},r,a);n.store_prices=n.store_prices?_objectSpread({},n.store_prices,{},c):c}}),n});l.method.send(e),l.data.price.relative.value=null}},markup:{value:null,round:{value:null,data:[.1,.5,1,5,10,50,100]},type:0,init:function(){var t=this;l.data.price.store_prices.value[0]||(l.data.price.store_prices.value=["price"]);var e=p().map(function(e){var n,r={_id:e._id,name:e.name,store_prices:e.store_prices},a=t.value,o=Number.parseFloat(e.purchase);return 1===t.type&&(a=o*(a/100)),n=o+a,t.round.value&&0!==n&&n%t.round.value!==0?n+=t.round.value-n%t.round.value:n=+n.toFixed(2),l.data.price.store_prices.value.sort(function(t,e){return"price"===t?1:-1}).forEach(function(t){if("price"===t)r.price=n;else{var e=_defineProperty({},t,n);r.store_prices=r.store_prices?_objectSpread({},r.store_prices,{},e):e}}),r});l.method.send(e),this.value=null}},margin:{value:null,round:{value:null,data:[.1,.5,1,5,10,50,100]},onChange:function(){this.value<0?this.value=0:this.value>99&&(this.value=99)},init:function(){var t=this;l.data.price.store_prices.value[0]||(l.data.price.store_prices.value=["price"]);var e=p().map(function(e){var n,r={_id:e._id,name:e.name,store_prices:e.store_prices},a=t.value,o=+e.purchase;return a=o/(100*(1/a-.01)),n=o+a,t.round.value&&0!==n&&n%t.round.value!==0?n+=t.round.value-n%t.round.value:n=+n.toFixed(2),l.data.price.store_prices.value.sort(function(t,e){return"price"===t?1:-1}).forEach(function(t){if("price"===t)r.price=n;else{var e=_defineProperty({},t,n);r.store_prices=r.store_prices?_objectSpread({},r.store_prices,{},e):e}}),r});l.method.send(e),this.value=null}},discount:{value:null,discounts:t.user.company().discounts,init:function(){l.method.send(_.map(p(),function(t){return{_id:t._id,name:t.name,discount:+l.data.price.discount.value}})),l.data.price.discount.value=null}},vat:{value:null,vats:[null,0,10,18,20],init:function(){l.method.send(p().map(function(t){var e=null===l.data.price.vat.value?l.data.price.vat.value:Math.abs(l.data.price.vat.value);return{_id:t._id,name:t.name,vat:e}})),l.data.price.value=null}}},group_and_categories:{title:"CATEGORIES_ANG_GROUPS",permission:u.permission(["catalog","put"]),categories:{add:function(){this.data.push({title:this.search,selected:!0,behavior:"set checked"})},init:function(){l.method.send(_.map(p(),function(t){return{_id:t._id,name:t.name,categories:l.data.group_and_categories.categories.merge(t.categories)}})),this.search=""},merge:function(t){t=_.compact(t)||[];var e=_.where(this.data,{selected:!1,behavior:!1}),n=_.where(this.data,{selected:!0});return e=_.map(e,function(t){return t.title}),n=_.map(n,function(t){return t.title}),_.forEach(t,function(n,r){e.indexOf(n)>-1&&delete t[r]}),_.compact(_.union(t,n))},load:function(){var t=this;return _asyncToGenerator(regeneratorRuntime.mark(function e(){var n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t,e.next=4,r.method.init("categories");case 4:n.data=_.clone(r.storage.categories.data,!0),a=p(),n.data.map(function(t){return t.count=0,_.forEach(a,function(e){e.categories&&e.categories.indexOf(t.title)>-1&&t.count++}),delete t.$$hashKey,0===t.count?(t.behavior="set unchecked",t.selected=!1):t.count!==a.length?(t.behavior="set indeterminate",t.selected=!1):(t.behavior="set checked",t.selected=!0),t}),e.next=11;break;case 9:e.prev=9,e.t0=e["catch"](0);case 11:case"end":return e.stop()}},e,null,[[0,9]])}))()}},group:{value:{},dontshow:[],onChange:function(t){l.data.group_and_categories.group.value=t},init:function(){var t=l.data.group_and_categories.group.value._id,e=p().filter(function(e){return e._id!==t}).map(function(e){return{_id:e._id,name:e.name,id_group:t}});d.method.send(e)}}},price_table:{title:"PRICE_TAGS",permission:u.permission(["catalog","price_labels"]),value:{},store:null,extend:!1,label_per_page:!1,doc:null,docQty:!1,fileType:"pdf",parseDoc:function(t){l.selected=t.products.map(function(e){var n=_.clone(r.storage.catalog.formatted.find(function(t){return t._id==e._id})||{},!0);return n.qty="inventory"===t.sub_type?e.qty_after:e.qty,n}).filter(function(t){return t._id}),l.data.price_table.doc=t},dropdown:{text:"IN_ALL_STORES",name:"stores",limit:999},generate:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!1,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!1,n=arguments.length>2?arguments[2]:void 0,r=_.clone(l.selected,!0).map(function(t){delete t.repeat;try{t.price=(+t.price||0).toFixed(2)}catch(e){console.warn(t)}return t.barcode=(t.barcode||"").trim(),t});return n&&l.data.price_table.store&&(r=_.clone(l.selected,!0).map(function(t){var e=l.data.price_table.store,n=t.store_prices[e];return t.price=(void 0!==n?+n:t.price).toFixed(2),t.barcode=(t.barcode||"").trim(),t})),e?r=r.map(function(t){return t.repeat=t.qty,t}):t&&(r=r.map(function(t){var e=t.stockCount||0;return l.data.price_table.store&&(e=t.stock[l.data.price_table.store]||0),t.repeat=e,t}).filter(function(t){return!!t.repeat})),r},init:function(){return{list:l.data.price_table.generate(l.data.price_table.extend,l.data.price_table.docQty,l.data.price_table.store_prices),label:l.data.price_table.value,label_per_page:l.data.price_table.label_per_page}},downloadFile:function(){var t=this.init(),e=new Blob([JSON.stringify(t)],{type:"application/json;charset=utf-8"});saveAs(e,"CloudShop pricetags - ".concat(moment().format("DD.MM.YYYY HH:mm"),".csl"))}},other:{title:"OTHER",permission:u.permission(["catalog","put"]),load:function(){return _asyncToGenerator(regeneratorRuntime.mark(function t(){var e;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:try{e="ru"===n.get()?"nameRU":"name",l.data.other.country.dropdown.nameField=e,l.data.other.country.dropdown.valueField=e}catch(r){}case 1:case"end":return t.stop()}},t)}))()},is_weighed:{value:!1,init:function(){l.method.send(p().map(function(t){return{_id:t._id,name:t.name,is_weighed:l.data.other.is_weighed.value}})),l.data.other.is_weighed.value=!1}},free_price:{value:!1,init:function(){l.method.send(p().map(function(t){return{_id:t._id,name:t.name,free_price:l.data.other.free_price.value}})),l.data.other.free_price.value=!1}},barcode:{init:function(){var t=p().filter(function(t){return!t.barcode||!t.barcode.replace(/\s/g,"")}).map(function(t){return{_id:t._id,name:t.name,barcode:i.barcodeByCode(t)}});l.method.send(t)}},expiration_date:{value:null,init:function(){l.method.send(p().map(function(t){return{_id:t._id,name:t.name,expiration_date:l.data.other.expiration_date.value}})),l.data.other.expiration_date.value=null},clear:function(){l.method.send(p().map(function(t){return{_id:t._id,name:t.name,expiration_date:null}})),l.data.other.expiration_date.value=null}},min_qty:{value:null,init:function(){l.method.send(p().map(function(t){return{_id:t._id,name:t.name,min_qty:l.data.other.min_qty.value}})),l.data.other.min_qty.value=null}},country:{value:null,dropdown:{placeholder:"SEARCH",name:"countries","class":"basic",limit:300,search:!0,icon:"dropdown"},init:function(){l.method.send(p().map(function(t){return{_id:t._id,name:t.name,country:l.data.other.country.value}})),l.data.other.country.value=null}},supplier:{value:null,dropdown:{placeholder:c("translate")("SEARCH"),name:"suppliers","class":"basic",limit:10,search:!0},init:function(){l.method.send(p().map(function(t){return{_id:t._id,name:t.name,supplier:l.data.other.supplier.value}})),l.data.other.supplier.value=null}},marking_type:{value:null,dropdown:{placeholder:c("translate")("SEARCH"),name:"marking_types","class":"basic",limit:99,search:!0},init:function(){l.method.send(p().map(function(t){return{_id:t._id,name:t.name,marking_type:l.data.other.marking_type.value}})),l.data.other.marking_type.value=null}},kz_marking_type:{value:null,dropdown:{placeholder:c("translate")("SEARCH"),name:"marking_types","class":"basic",limit:99,search:!0},init:function(){l.method.send(p().map(function(t){return{_id:t._id,name:t.name,kz_marking_type:l.data.other.kz_marking_type.value}})),l.data.other.kz_marking_type.value=null}},ua2_marking_type:{value:null,dropdown:{placeholder:c("translate")("SEARCH"),name:"marking_types","class":"basic",limit:99,search:!0},init:function(){l.method.send(p().map(function(t){return{_id:t._id,name:t.name,ua2_marking_type:l.data.other.ua2_marking_type.value}})),l.data.other.ua2_marking_type.value=null}},ru_tax_system:{value:null,dropdown:{placeholder:c("translate")("SEARCH"),name:"ru_tax_system","class":"basic",limit:99,search:!0},init:function(){l.method.send(p().map(function(t){return{_id:t._id,name:t.name,ru_tax_system:l.data.other.ru_tax_system.value}})),l.data.other.ru_tax_system.value=null}},ua_marking_type:{value:null,init:function(){l.method.send(p().map(function(t){return{_id:t._id,name:t.name,ua_marking_type:l.data.other.ua_marking_type.value}})),l.data.other.ua_marking_type.value=null}},ua_enterprise_id:{value:null,init:function(){l.method.send(p().map(function(t){return{_id:t._id,name:t.name,ua_enterprise_id:l.data.other.ua_enterprise_id.value}})),l.data.other.ua_enterprise_id.value=null}},ua_checkbox_taxcode:{value:[],init:function(){l.method.send(p().map(function(t){return{_id:t._id,name:t.name,ua_checkbox_taxcode:l.data.other.ua_checkbox_taxcode.value}})),l.data.other.ua_checkbox_taxcode.value=[]}},nsp:{value:[],init:function(){l.method.send(p().map(function(t){return{_id:t._id,name:t.name,nsp:l.data.other.nsp.value}})),l.data.other.nsp.value=null}}}},l.set_active=function(t){_.forEach(l.data,function(e,n){l.data[n].active=t==n})},l.init=function(){l.data.group_and_categories.categories.load(),l.data.price.store_prices.value=["price"],l.data.other.load(),l.data.group_and_categories.group.dontshow=l.selectedFirstLvl.filter(function(t){return"group"===t.type}).map(function(t){return t._id})},l.clear=function(){l.data.price_table.doc=null,l.data.price_table.docQty=!1,l.data.price_table.extend=!1,l.data.price_table.value={}}}]),angular.module("cloudshop.catalog").controller("catalogGroupCtrl",["$state","$timeout","catalogGroupService","$scope","api","db","$filter",function(t,e,n,r,a,o,i){r.db=o.storage,r.country=a.user.company().country,r.prices=[{_id:"price",name:i("translate")("BASIC")}].concat(_toConsumableArray(o.storage.stores.data)),r.group=n,r.tab=t.params.tab||"price",r.labels=[{preview:"https://pic.cloudshop.ru/v1/yon91btl98daqbtsxkcn.jpg",_id:"57c7e1b73ce7d5b9118b4870",name:"Простой ценник",size:{width:"55",height:"40"},contents:[{type:"text",template:"%name%",view:{top:30,left:0,width:207.859375,height:64},content:{text:"Text",style:{fontSize:"19",
bold:!1,italic:!1,underline:!1,align:"center",zIndex:1,strike:!1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!1},{type:"text",template:null,view:{top:100,left:.140625,width:96.859375,height:29},content:{text:"Цена",style:{fontSize:14,bold:!1,italic:!1,underline:!1,align:"left",zIndex:1,strike:!1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!1},{type:"text",template:" %price%",view:{top:96,left:96.140625,width:111.859375,height:33},content:{text:"Text",style:{fontSize:"17",bold:!1,italic:!1,underline:!1,align:"right",zIndex:1,strike:!1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!1}]},{preview:"https://pic.cloudshop.ru/v1/jvi5m9d0vjjw6k1w0090.jpg",_id:"57c7e5353ce7d5f10c8b4b4b",name:"Полный ценник",size:{width:"70",height:60},contents:[{type:"text",template:null,view:{top:0,left:0,width:264.5625,height:20},content:{text:"Мой магазин",style:{fontSize:14,bold:!1,italic:!1,underline:!1,align:"center",zIndex:1,strike:!1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!1},{type:"text",template:"%name%",view:{top:20,left:6,width:247.5625,height:64},content:{text:"Text",style:{fontSize:"20",bold:!0,italic:!1,underline:!1,align:"center",zIndex:1,strike:!1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!1},{type:"text",template:"Артикул: %sku%",view:{top:87,left:1.4375,width:141.5625,height:20},content:{text:"Text",style:{fontSize:14,bold:!1,italic:!1,underline:!1,align:"left",zIndex:1,strike:!1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!0},{type:"barcode",view:{top:87,left:143,width:121.5625,height:59},content:{url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGcAAAAnCAMAAAAlx6anAAAAHnRFW…fR3in7FFLPXiQX3mmOKrEc1z7zzCn/9+WX7fSvAe37f+L/ANeslGJa+j5jAAAAAElFTkSuQmCC",show_nums:1,style:{zIndex:1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!1},{type:"text",template:null,view:{top:144,left:2.4375,width:83.5625,height:22},content:{text:"Цена",style:{fontSize:"20",bold:!1,italic:!1,underline:!1,align:"left",zIndex:1,strike:!1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!1},{type:"text",template:" %price%",view:{top:183,left:121.890625,width:139.109375,height:21},content:{text:"Text",style:{fontSize:"12",bold:!1,italic:!1,underline:!1,align:"right",zIndex:1,strike:!1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!1},{type:"text",template:null,view:{top:168,left:3,width:120.5625,height:17},content:{text:"Скидка",style:{fontSize:"12",bold:!1,italic:!1,underline:!1,align:"left",zIndex:1,strike:!1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!1},{type:"text",template:" %discount%%",view:{top:167,left:133.4375,width:127.109375,height:15},content:{text:"Text",style:{fontSize:"12",bold:!1,italic:!1,underline:!1,align:"right",zIndex:1,strike:!1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!1},{type:"text",template:null,view:{top:187,left:2,width:123.5625,height:18},content:{text:"Цена без скидки",style:{fontSize:"12",bold:!1,italic:!1,underline:!1,align:"left",zIndex:1,strike:!1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!1},{type:"text",template:"Дата печати %print_date%",view:{top:212.46875,left:1,width:137.5625,height:13.531625},content:{text:"Text",style:{fontSize:"10",bold:!1,italic:!1,underline:!1,align:"left",zIndex:1,strike:!1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!1},{type:"text",template:null,view:{top:212,left:131,width:52.5625,height:13},content:{text:"Подпись",style:{fontSize:"10",bold:!1,italic:!1,underline:!1,align:"left",zIndex:1,strike:!1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!1},{type:"text",template:"%price_d%",view:{top:144,left:79.4375,width:180.125,height:24},content:{text:"Text",style:{fontSize:"17",bold:!0,italic:!1,underline:!1,align:"right",zIndex:1,strike:!1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!1}]},{preview:"https://pic.cloudshop.ru/v1/tpt9zgfr3phwxa98sek8.jpg",_id:"57c7f0573ce7d5f10c8b4c4c",name:"Ценник 3х2 см",size:{width:"30",height:"20"},contents:[{type:"barcode",view:{top:35.421875,left:.625,width:113.375,height:39.578125},content:{url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGcAAAAnCAMAAAAlx6anAAAAHnRFW…fR3in7FFLPXiQX3mmOKrEc1z7zzCn/9+WX7fSvAe37f+L/ANeslGJa+j5jAAAAAElFTkSuQmCC",show_nums:1,style:{zIndex:1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!1},{type:"text",template:" %price%",view:{top:0,left:0,width:113.375,height:15},content:{text:"Text",style:{fontSize:"12",bold:!0,italic:!1,underline:!1,align:"center",zIndex:1,strike:!1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!1},{type:"text",template:"%name%",view:{top:15,left:.625,width:112.75,height:23},content:{text:"Text",style:{fontSize:"10",bold:!1,italic:!1,underline:!1,align:"center",zIndex:1,strike:!1,borders:{left:!1,right:!1,top:!1,bottom:!1}}},selected:!1}]}],r.$on("$destroy",n.clear),r.dataLength=o.storage.catalog.data.filter(function(t){return"group"!==t.type}).length;var c=function(){var o=_asyncToGenerator(regeneratorRuntime.mark(function c(){var o;return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return n.set_active(r.tab),0===n.selected.length&&0===n.selectedFirstLvl.length&&e(function(){alert(i("translate")("EXISTING_PRODUCTS_IN_THIS_DOCUMENT_NOT_F")),t.go(t.$current.parent.parent.name,{})}),c.prev=2,c.next=5,a.data.post("/search/data/:client/settings_store/0/100",{type:"labels"});case 5:o=c.sent,r.labels=r.labels.concat(o.data.data),n.init(),c.next=12;break;case 10:c.prev=10,c.t0=c["catch"](2);case 12:case"end":return c.stop()}},c,null,[[2,10]])}));return function(){return o.apply(this,arguments)}}();c()}]),angular.module("cloudshop.catalog").service("catalogGroupsService",["db","apiRouteService",function(t,e){var n={name:"",type:"group",id_group:0},r=function(){},a=function(t){var n=t._id?"edit":"add";return e.catalog()[n](t)},o=function(t){var n=t.map(function(t){return{_id:t._id,name:t.name,deleted:!0}});return e.catalog()["import"](n,"delete")};return{get:r,save:a,remove:o,data:n}}]),angular.module("cloudshop.catalog").directive("catalogGroupModal",["$rootScope","db","$sce","$filter",function(t,e,n,r){return{restrict:"C",templateUrl:"/js/pages/card/catalog/group/modal.html",scope:{buttonLabel:"@",onchange:"=",selected:"=",dontshow:"="},controller:["$scope",function(t){this.safeApply=function(e){var n=t.$root.$$phase;"$apply"==n||"$digest"==n?e&&"function"==typeof e&&e():t.$apply(e)}}],replace:!0,link:function(a,o,i,c){var s=$(".overlay",o),u={name:r("translate")("ROOT"),_id:"0"};a.groups=e.storage.catalog.getGroup();var d=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!0;s.toggleClass("active",t),t&&(p(),$(o).find('div[data-id="0"]').prev().click()),c.safeApply(function(){a.show=t})},l=function f(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1,r=arguments.length>1?arguments[1]:void 0;if(t=-1===e?[u]:(r||a.groups).filter(function(t){return t.id_group===e&&!(a.dontshow||[]).includes(t._id)}),t.length){var o="";return _.sortBy(t,"name").forEach(function(t){var e=a.groups.filter(function(e){return e.id_group===t._id});o+='\n                <div class="groups-list-item">\n                  <div class="groups-list-header">\n                    <a href="" class="toggle">'.concat(e.length?'<i class="icon caret right"></i>':"",'</a>\n                    <div data-id="').concat(t._id,'" class="groups-list-header--title">\n                      <i class="icon outline folder"></i>\n                      <div class="label">').concat(t.name,'</div>\n                    </div>\n                  </div>\n                  <div class="content">\n                    ').concat(f(t._id,e),"\n                  </div>\n                </div>\n              ")}),n.trustAsHtml(o)}return""},p=function(){e.method.init("catalog").then(function(){a.groups=e.storage.catalog.getGroup(),a.selectedName=(a.groups.find(function(t){return t._id===a.selected})||{}).name,a.$apply()}).then(function(){$(o).find('.groups-list-header--title[data-id="0"]').prev().click()})};t.$on("updater",function(t,n){"catalog"==n.type&&(a.groups=e.storage.catalog.getGroup(),a.$apply())});var m=function(t){return null===t||"undefined"==typeof t};a.$watch("selected",function(t,e){if(t!==e){var n=a.groups.find(function(e){return e._id===t})||{};a.selectedName=m(t)?"":n.name||u.name}}),a.onshow=d,a.render=l,a.buttonLabel=a.buttonLabel||"SELECT",$(o).on("click",".toggle",function(t){t.preventDefault(),$(this).parent().next().toggle(),$("i",this).toggleClass("right").toggleClass("down")}),$(o).on("click",".groups-list-header--title",function(t){t.preventDefault();var e=$(this).data("id"),n=0===e?u:a.groups.find(function(t){return t._id===e})||{};a.onchange(n),d(!1),a.$apply()}),p()}}}]),angular.module("cloudshop.catalog").controller("catalogGroupformCtrl",["$scope","db","catalogGroupsService","modalService","$state","filterCatalogService","catalogService",function(t,e,n,r,a,o,i){function c(){return t.loading=!0,r.method.disable(0),n.save(t.data).then(r.method.close)}var s=a.params.group_id;t.dontshow=[s],t.$watch("form.$valid",function(t){r.method.toggle([0],t)}),t.onChange=function(e){var n=e._id;t.data.id_group=n},t.$on("$destroy",function(){r.init.remove()});var u=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function a(){var e,o;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return t.loading=!0,r.method.disable(1),a.next=4,i.method.groups.extractWithGroup([t.data]);case 4:if(e=a.sent,!e.length){a.next=9;break}if(o="Вместе с группой будет удалено ".concat(e.length," поз. групп и товаров \n Удалить?"),confirm(o)){a.next=9;break}return a.abrupt("return",!1);case 9:return a.abrupt("return",n.remove(e).then(r.method.close));case 10:case"end":return a.stop()}},a)}));return function(){return e.apply(this,arguments)}}();r.method.add([{title:"SAVE",className:"green",active:!0,action:c,visible:!0},{title:"DELETE",className:"red","float":"right",active:!0,action:u,visible:!!s,perm:["catalog","DELETE"]}]);var d=function(){e.method.init(["catalog"]).then(function(){s?t.data=e.storage.catalog.getGroup().find(function(t){return t._id===s}):t.data=_objectSpread({},n.data,{id_group:o.f.group.value}),t.$apply()})};d()}]),angular.module("cloudshop.catalog").controller("formCtrl",["$scope","translateService","db","catalogService","$state","$stateParams","fn","modalService","$rootScope","filterCatalogService","$http","api","$filter","safeApply","alertModal",function(t,e,n,r,a,o,i,c,s,u,d,l,p,m,f){function h(){return g.apply(this,arguments)}function g(){return g=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(c.init.disable(0),t.meta.store_prices||(t.data.store_prices={}),e.prev=2,t.plu_code.checkUniqCode()){e.next=5;break}throw new Error("PLU код уже используется в другом товаре");case 5:return e.next=7,r.method.save();case 7:c.method.close(),e.next=14;break;case 10:e.prev=10,e.t0=e["catch"](2),c.init.enable(0),f("\n					".concat(p("translate")("ERROR_CREATING_NEW_PRODUCT"),"\n					").concat((null===e.t0||void 0===e.t0?void 0:e.t0.message)?"<br />(".concat(e.t0.message,")"):"","\n				"));case 14:return e.prev=14,m(t),e.finish(14);case 17:case"end":return e.stop()}},e,null,[[2,10,14,17]])})),g.apply(this,arguments)}function v(){c.init.data.buttons=[{title:"SAVE",className:"green",active:!!y,visible:!0,action:h,perm:["catalog","POST"]}]}t.type=o.type,t.db=n.storage,t.method=r.method,t.country=l.user.company().country,t.types={inventory:{id:"inventory",label:"PRODUCT",description:"PRODUCT_THAT_HAS_STOCK_STOCK_NEED_REPLEN"},service:{id:"service",label:"SERVICE",description:"PRODUCT_WITHOUT_STOCK_IN_THE_STORE_EG_DE"},set:{id:"set",label:"SET",description:"PRODUCT_THAT_INCLUDED_OTHER_PRODUCTS_OR_"}},t.page=a.current.data,t.fn=i,t.markup={price:0,prices:{},priceChange:function(e){var n=t.data,r=n.price,a=n.purchase;switch(e){case"price":case"purchase":if("price"===e&&t.method.complect.changePrice(),r&&a){var o=(r-a)/a*100;this.price=+(o>0?o.toFixed(2):0)}else this.price=0;break;case"markup":t.data.price=+(this.price/100*t.data.purchase+t.data.purchase).toFixed(2)}},pricesChange:function(e,n){switch(e){case"price":var r=(t.data.store_prices[n]-t.data.purchase)/t.data.purchase*100;this.prices[n]=+(r>0?r.toFixed(2):0);break;case"markup":t.data.store_prices[n]=+((this.prices[n]||0)/100*t.data.purchase+t.data.purchase).toFixed(2)}},init:function(){var e=this,n=t.data;this.priceChange("purchase"),Object.keys(n.store_prices||{}).length>0&&(Object.keys(n.store_prices||{}).forEach(function(t){return e.pricesChange("price",t)}),t.meta.store_prices=!0)}},t.plu_code={helpText:"\n				PLU код применяется в весах с печатью этикетки содержащей информацию о весе товара.\n				Формат штрих-кода для настройки весов:<br />\n				<b>".concat(l.user.company().plu_pref," PPPPP WWWWW S</b> где:<br />\n				PPPPP - PLU код товара;<br />\n				WWWWW - вес товара в тысячных единицах;<br />\n				S - контрольная сумма\n			"),add:function(){t.meta.plu_code=!0,t.data.PLU_code=String(t.data.code).slice(0,5)},clear:function(){t.data.PLU_code=null,t.meta.plu_code=!1},checkUniqCode:function(){var e=n.storage.catalog.data,r=t.data,a=r.PLU_code,o=r._id;return a?!e.find(function(t){return t.PLU_code===a&&t._id!==o}):!0},init:function(){t.meta.plu_code=!!t.data.PLU_code}},t.meta={store_prices:!1,stocks:!1,modification:!1,open_modification:0,loadingCode:!1};var y=a.params.productId||null;y?t.isEdit=!0:(t.loading=!1,t.isAdd=!0);var b="ru"===e.get()?"nameRU":"name";t.dropdown={suppliers:{title:"SUPPLIER",name:"suppliers","class":"floating fluid button",icon:"dropdown",search:!0},country:{placeholder:"SEARCH",name:"countries",nameField:b,valueField:b,"class":"basic",limit:300,search:!0,icon:"dropdown"},marking_type:{name:[],"class":"basic",cancel:!0,limit:99,icon:"dropdown"},kz_marking_type:{name:[],"class":"basic",cancel:!0,limit:99,icon:"dropdown"},ua2_marking_type:{name:[],"class":"basic",cancel:!0,limit:99,icon:"dropdown"},ru_tax_system:{name:[],"class":"basic",cancel:!0,limit:99,icon:"dropdown"}},t.complect={data:[],view:{search:"",toggle:!1,limit:30}},t.$watch("data.type",function(e,n){t.data.unit=t.data.unit||p("translate")("PC"),e&&e!==n&&("inventory"!==e?t.meta.plu_code=!1:t.meta.plu_code=!!t.data.PLU_code,"service"===e?t.data.unit=null:t.data.packs=t.data.packs||[],"set"===e&&(t.meta.modification=!1),"set"===n&&(t.data.container=[],t.data.price=null))}),t.$watch("meta.modification",function(e){e===!1?(t.method.properties.data=[],t.method.properties.props=[],t.method.data.properties=[{key:"",values:[]}]):e===!0&&(t.method.stock={},t.meta.stocks=!1)}),t.$watch("meta.stocks",function(e){e===!0&&(t.meta.modification=!1)}),t.$watch("data.store_prices",function(e){if(e)for(var n in t.data.store_prices)"number"!=typeof t.data.store_prices[n]&&delete t.data.store_prices[n]},!0),t.$watch("method.data.properties",function(e){return e?(t.method.properties.data=t.method.properties.split(),void(t.method.properties.props=t.method.properties.data.map(function(e,n){return{code:"".concat(t.data.code,"-").concat(n+1)}}))):!1},!0),t.$watch("data.name",function(t){t?c.init.enable([0,1]):c.init.disable([0,1])}),t.$watch("expiration_date",function(e){e&&(t.data.expiration_date=moment(t.expiration_date).format("X"))}),t.selectGroup=function(e){var n=e._id;t.data.id_group=n},t.$on("$destroy",function(){c.init.remove(),c.init.data.loading=!1,r.method.clear()}),t.complectFilter=function(e){return"group"!==e.type&&y!=e._id&&!_.where(t.data.container,{_id:e._id}).length};var E=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function a(){var e,o,i,s,u;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return e=null,o=_.where(n.storage.catalog.data,{_id:y}),e=o[0]?Promise.resolve({data:{data:o}}):r.method.getOne(y),t.loading=!0,a.prev=3,a.next=6,Promise.all([e]);case 6:return i=a.sent,s=_slicedToArray(i,1),u=s[0],t.data=r.method.format(_.clone(u.data.data[0],!0)),t.typeName=r.types.filter(function(e){return e.value==t.data.type})[0].add,t.loading=!1,c.init.enable(0),t.$apply(),a.abrupt("return",u.data.data[0]);case 17:a.prev=17,a.t0=a["catch"](3);case 19:case"end":return a.stop()}},a,null,[[3,17]])}));return function(){return e.apply(this,arguments)}}(),S=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(){var e,r;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return t.meta.loadingCode=!0,n.prev=1,n.next=4,l.data.get("/code/last/:client",{v:"v3"});case 4:e=n.sent,r=e.data.data,t.data.code=r.lastCode,n.next=12;break;case 9:n.prev=9,n.t0=n["catch"](1),console.warn("LOAD_CODE ERROR: ",n.t0);case 12:return n.prev=12,t.meta.loadingCode=!1,n.finish(12);case 15:case"end":return n.stop()}},n,null,[[1,9,12,15]])}));return function(){return e.apply(this,arguments)}}(),T=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function a(){var e;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(t.data=r.method.data,n.method.init(["categories","stores","suppliers","catalog","countries","marking_types","ru_tax_system"]).then(function(e){t.categories=e[0].map(function(t){return{label:t.title,value:t.title}}),t.dropdown.ua2_marking_type.name=e[5],t.dropdown.kz_marking_type.name=e[5],t.dropdown.marking_type.name=e[5],t.dropdown.ru_tax_system.name=e[6],!y&&_.where(e[2],{"default":!0}).length&&(t.data.supplier=_.where(e[2],{"default":!0})[0]._id)}),!y){a.next=13;break}return a.next=5,E();case 5:e=a.sent,t.method.stock=_.clone(e.stock,!0),"set"===e.type&&t.method.complect.updateWeight(),t.data.code||S(),t.markup.init(),t.plu_code.init(),a.next=15;break;case 13:t.data.id_group=o.group_id||u.f.group.value,S();case 15:t.ua_checkbox_taxcodes=(t.data.ua_checkbox_taxcode||[]).map(function(t){return{label:t,value:t}}),v();case 17:case"end":return a.stop()}},a)}));return function(){return e.apply(this,arguments)}}();T()}]),angular.module("cloudshop.catalog").directive("formSecond",[function(){return{restrict:"C",scope:!0,link:function(t,e,n){var r=this;t.active=!1;var a=function(){$(e).css({height:$(window).height()-$(".form-first").innerHeight()-100}).addClass("disabled")};$(".show-more a",e).bind("click",function(){t.active=!0,$(r).hide(),$(e).removeClass("disabled")}),t.$parent.db.catalog.data.length||t.$parent.isEdit||setTimeout(a,100)}}}]),angular.module("cloudshop.notifications",[]).directive("notifications",["$timeout","$filter","safeApply","localStorageService","api",function(t,e,n,r,a){return{restrict:"E",replace:!0,templateUrl:"/js/pages/authenticated/header/notifications/message.html",link:function(t,e){var o=7e3,i={},c=!0;t.items=[],$(e).on("mousedown",".message",function(){var e=$(this).index();u(t.items[e].id)});var s=function(e){t.items=t.items.filter(function(t,n){return n!==e}),n(t)},u=function(t){i[t]&&(clearTimeout(i[t]),delete i[t])},d=function(n){var r=t.items.findIndex(function(t){return t.id===n});if(r>-1){var a=$(e).children().eq(r);a.addClass("closed"),setTimeout(function(){return s(r)},380)}},l=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r.get("notify.settings");case 3:return t=e.sent,n=t.notify,e.abrupt("return",n);case 8:return e.prev=8,e.t0=e["catch"](0),e.abrupt("return",!0);case 11:case"end":return e.stop()}},e,null,[[0,8]])}));return function(){return t.apply(this,arguments)}}();t.deleteMessage=d,t.$on("NOTIFY_UPDATE_SETTINGS",function(t,e){c=e.notify}),t.$on("NOTIFY",function(e,r){if(c&&"owner"===a.user.positions().type){t.$broadcast("NOTIFY_UPDATE_LIST"),r.author||(r.author={name:a.user.data.name,pic:a.user.data.pic});var s=_objectSpread({},r,{id:Math.random()});t.items.unshift(s),i[s.id]=setTimeout(function(){return d(s.id)},o),setTimeout(p),n(t)}});var p=function(){var t=$(e)[0];new Slip(t),t.addEventListener("slip:swipe",function(t){var e=$(t.target).index();s(e)})},m=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,l();case 2:c=t.sent;case 3:case"end":return t.stop()}},e)}));return function(){return t.apply(this,arguments)}}();m()}}}]),angular.module("cloudshop.notifications").service("notificationTextService",["$rootScope","docService","$filter","db",function(t,e,n,r){this.parse=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function o(a){var i,c,s,u,d,l,p,m,f,h,g,v;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return i=t.pluralForm,o.next=3,r.method.init("staff");case 3:c=o.sent,s=_slicedToArray(c,1),u=s[0],d=u.find(function(t){return t._id===a._user}),l={author:d,_id:a._id,date:a.date},o.t0=a.resource,o.next="sales"===o.t0?11:"return_sales"===o.t0?11:"purchases"===o.t0?11:"return_purchases"===o.t0?11:"changes"===o.t0?11:"movements"===o.t0?11:"catalog"===o.t0?23:"clients"===o.t0?47:"suppliers"===o.t0?57:"stores"===o.t0?67:"accounts"===o.t0?77:"register"===o.t0?87:"shift"===o.t0?97:112;break;case 11:p=e.types[a.data.type+(a.data.sub_type||"")]||{},o.t1=a.method,o.next="POST"===o.t1?15:"PUT"===o.t1?17:"DELETE"===o.t1?19:21;break;case 15:return l.title="Создан документ «".concat(n("translate")(p.title)," №").concat(a.data.number,"»"),o.abrupt("break",21);case 17:return l.title="Изменён документ «".concat(n("translate")(p.title)," №").concat(a.data.number,"»"),o.abrupt("break",21);case 19:return l.title="Удалён документ «".concat(n("translate")(p.title)," №").concat(a.data.number,"»"),o.abrupt("break",21);case 21:return l.subtitle=n("curr")(a.data.sum),o.abrupt("break",112);case 23:if(a.data._id){o.next=37;break}m=Object.keys(a.data).map(function(t){return{name:t,value:a.data[t]}}).filter(function(t){return t.value})[0],m||(m={name:"updated",value:0}),o.t2=m.name,o.next="created"===o.t2?29:"deleted"===o.t2?31:"updated"===o.t2?33:35;break;case 29:return l.title=i(m.value,"Создан ".concat(m.value," товар"),"Создано ".concat(m.value," товара"),"Создано ".concat(m.value," товаров")),o.abrupt("break",35);case 31:return l.title=i(m.value,"Удалён ".concat(m.value," товар"),"Удалено ".concat(m.value," товара"),"Удалено ".concat(m.value," товаров")),o.abrupt("break",35);case 33:return l.title=i(m.value,"Изменён ".concat(m.value," товар"),"Изменено ".concat(m.value," товара"),"Изменено ".concat(m.value," товаров")),o.abrupt("break",35);case 35:o.next=46;break;case 37:o.t3=a.method,o.next="POST"===o.t3?40:"PUT"===o.t3?42:"DELETE"===o.t3?44:46;break;case 40:return l.title="Создан товар «".concat(a.data.name,"»"),o.abrupt("break",46);case 42:return l.title="Изменён товар «".concat(a.data.name,"»"),o.abrupt("break",46);case 44:return l.title="Удалён товар «".concat(a.data.name,"»"),o.abrupt("break",46);case 46:return o.abrupt("break",112);case 47:o.t4=a.method,o.next="POST"===o.t4?50:"PUT"===o.t4?52:"DELETE"===o.t4?54:56;break;case 50:return l.title="Создан клиент «".concat(a.data.name,"»"),o.abrupt("break",56);case 52:return l.title="Изменён клиент «".concat(a.data.name,"»"),o.abrupt("break",56);case 54:return l.title="Удалён клиент «".concat(a.data.name,"»"),o.abrupt("break",56);case 56:return o.abrupt("break",112);case 57:o.t5=a.method,o.next="POST"===o.t5?60:"PUT"===o.t5?62:"DELETE"===o.t5?64:66;break;case 60:return l.title="Создан поставщик «".concat(a.data.name,"»"),o.abrupt("break",66);case 62:return l.title="Изменён поставщик «".concat(a.data.name,"»"),o.abrupt("break",66);case 64:return l.title="Удалён поставщик «".concat(a.data.name,"»"),o.abrupt("break",66);case 66:return o.abrupt("break",112);case 67:o.t6=a.method,o.next="POST"===o.t6?70:"PUT"===o.t6?72:"DELETE"===o.t6?74:76;break;case 70:return l.title="Создан магазин «".concat(a.data.name,"»"),o.abrupt("break",76);case 72:return l.title="Изменён магазин «".concat(a.data.name,"»"),o.abrupt("break",76);case 74:return l.title="Удалён магазин «".concat(a.data.name,"»"),o.abrupt("break",76);case 76:return o.abrupt("break",112);case 77:o.t7=a.method,o.next="POST"===o.t7?80:"PUT"===o.t7?82:"DELETE"===o.t7?84:86;break;case 80:return l.title="Создан счёт «".concat(a.data.name,"»"),o.abrupt("break",86);case 82:return l.title="Изменён счёт «".concat(a.data.name,"»"),o.abrupt("break",86);case 84:return l.title="Удалён счёт «".concat(a.data.name,"»"),o.abrupt("break",86);case 86:return o.abrupt("break",112);case 87:o.t8=a.method,o.next="POST"===o.t8?90:"PUT"===o.t8?92:"DELETE"===o.t8?94:96;break;case 90:return l.title="Создана касса «".concat(a.data.name,"»"),o.abrupt("break",96);case 92:return l.title="Изменена касса «".concat(a.data.name,"»"),o.abrupt("break",96);case 94:return l.title="Удалена касса «".concat(a.data.name,"»"),o.abrupt("break",96);case 96:return o.abrupt("break",112);case 97:o.t9=a.method,o.next="opened"===o.t9?100:"closed"===o.t9?102:104;break;case 100:return l.title="Открыта смена №".concat(a.data.number),o.abrupt("break",104);case 102:return l.title="Закрыта смена №".concat(a.data.number),o.abrupt("break",104);case 104:return o.next=106,r.method.init("stores");case 106:return f=o.sent,h=_slicedToArray(f,1),g=h[0],v=g.find(function(t){return t._id===a.data._store})||{},l.subtitle=v.name,o.abrupt("break",112);case 112:return o.abrupt("return",l);case 113:case"end":return o.stop()}},o)}));return function(t){return a.apply(this,arguments)}}()}]),angular.module("cloudshop.notifications").service("notificationService",["$rootScope","notificationTextService","api",function(t,e,n){var r={created:"POST",updated:"PUT",deleted:"DELETE"},a=function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function a(r){var o;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,e.parse(r);case 2:o=a.sent,o.author&&o.author._id&&o.author._id!==n.user.data._id&&t.$broadcast("NOTIFY",o);case 4:case"end":return a.stop()}},a)}));return function(t){return r.apply(this,arguments)}}(),o=function(t,e){var n={id:null,_user:e._user,resource:e.meta.type,method:r[e.meta.method],data:e.meta.data};switch(e.type){case"doc":case"data":case"catalog":"catalog"===e.meta.type&&e.meta.data.deleted&&(n.method="DELETE"),a(n);break;case"shift":n.method=e.meta.method,a(n)}};t.$on("WS_UPDATE",o),t.$on("WS_UPDATE_SHIFT",o)}]).run(["notificationService",function(){}]),angular.module("cloudshop.notifications").directive("notificationsList",["$filter","api","db","safeApply","notificationTextService","localStorageService","$rootScope",function(t,e,n,r,a,o,i){return{restrict:"C",templateUrl:"/js/pages/authenticated/header/notifications/list.html",link:function(t,c){function s(){return u.apply(this,arguments)}function u(){return u=_asyncToGenerator(regeneratorRuntime.mark(function e(){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.loading=!0,m.offset+=m.limit,e.next=4,E();case 4:n=e.sent,0===n.length?t.allLoaded=!0:t.data=[].concat(_toConsumableArray(t.data),_toConsumableArray(n)),t.loading=!1,r(t);case 8:case"end":return e.stop()}},e)})),u.apply(this,arguments)}function d(){return l.apply(this,arguments)}function l(){return l=_asyncToGenerator(regeneratorRuntime.mark(function e(){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v();case 2:return t.settings=e.sent,e.next=5,E();case 5:return n=e.sent,e.next=8,y(n);case 8:t.unread=e.sent,t.data=n.map(function(e){return _objectSpread({},e,{unread:!!t.unread.find(function(t){return t._id===e._id})})}),r(t);case 11:case"end":return e.stop()}},e)})),l.apply(this,arguments)}t.limit=999,t.unread=[],t.open=!1;var p={bubble:!0,notify:!0},m={limit:50,offset:0},f=$(".header",c),h=$(".notify-menu",c);$(c).bind("click",function(e){e.stopPropagation();var n=$(c).hasClass("active");$(c).toggleClass("active",!n),t.open=!n,t.open||(h.removeClass("open-settings"),b()),r(t)}),$(document).bind("click",function(){$(c).hasClass("active")&&($(c).removeClass("active"),t.open=!1,h.removeClass("open-settings"),r(t),b())}),$(".settings",f).bind("click",function(t){t.stopPropagation(),h.toggleClass("open-settings")}),$(".back",f).bind("click",function(){$(".settings",f).click()}),h.bind("click",function(t){t.stopPropagation()}),t.$watch("settings",function(t,e){e&&deepEqual(e,t)===!1&&g(t)},!0),t.loadMore=s;var g=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(e){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,o.set("notify.settings",e);case 3:i.$broadcast("NOTIFY_UPDATE_SETTINGS",e),n.next=9;break;case 6:throw n.prev=6,n.t0=n["catch"](0),new Error("NOTIFY_UPDATE_SETTINGS_ERROR");case 9:return n.prev=9,r(t),n.finish(9);case 12:case"end":return n.stop()}},n,null,[[0,6,9,12]])}));return function(t){return e.apply(this,arguments)}}(),v=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,o.get("notify.settings");case 3:if(t=e.sent){e.next=6;break}throw"not found";case 6:return e.abrupt("return",t);case 9:return e.prev=9,e.t0=e["catch"](0),e.abrupt("return",p);case 12:case"end":return e.stop()}},e,null,[[0,9]])}));return function(){return t.apply(this,arguments)}}(),y=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function n(t){var r;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,o.get("lastTime");case 3:if(r=n.sent){n.next=6;break}return n.abrupt("return",t.filter(function(t){return t._user!==e.user.data._id}));case 6:return n.abrupt("return",t.filter(function(t){return t.date>parseInt(r)}));case 9:n.prev=9,n.t0=n["catch"](0);case 11:return n.abrupt("return",[]);case 12:case"end":return n.stop()}},n,null,[[0,9]])}));return function(e){return t.apply(this,arguments)}}(),b=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.set("lastTime",moment().format("X"));case 2:t.unread.length>0&&(t.unread=[],t.data=t.data.map(function(t){return _objectSpread({},t,{unread:!1})}),r(t));case 3:case"end":return e.stop()}},n)}));return function(){return e.apply(this,arguments)}}(),E=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function r(){var t,o,i,c,s,u,d;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,n.method.init("staff");case 3:return t=r.sent,o=_slicedToArray(t,1),i=o[0],r.next=8,e.data.get("/:client/notifications/".concat(m.offset,"/").concat(m.limit),{v:"v3"});case 8:return c=r.sent,s=c.data.data,u=s.map(function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.parse(t,i);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}()),r.next=13,Promise.all(u);case 13:return d=r.sent,r.abrupt("return",d.filter(function(t){return t.author&&t.author._id}));case 17:r.prev=17,r.t0=r["catch"](0),console.warn(r.t0);case 20:return r.abrupt("return",[]);case 21:case"end":return r.stop()}},r,null,[[0,17]])}));return function(){return t.apply(this,arguments)}}();"owner"===e.user.positions().type?d():$(c).hide(),t.$on("NOTIFY_UPDATE_LIST",_.debounce(d,1e3))}}}]),angular.module("cloudshop").service("eventsService",["api","profile",function(t,e){var n=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(e){var r,a;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.data.post("/search/docs/:client/0/1",e);case 2:return r=n.sent,a=r.data,n.abrupt("return",a.total);case 5:case"end":return n.stop()}},n)}));return function(t){return e.apply(this,arguments)}}(),r=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function r(n){
var a,o;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(!e.permission(["money","GET"])){r.next=6;break}return r.next=3,t.data.post("/search/money/:client/0/1",_objectSpread({},n,{v:"v3"}));case 3:return a=r.sent,o=a.data,r.abrupt("return",o.total);case 6:return r.abrupt("return",0);case 7:case"end":return r.stop()}},r)}));return function(t){return n.apply(this,arguments)}}(),a=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t={start:+moment().format("X"),end:+moment().add(10,"years").format("X")},e.prev=1,e.next=4,Promise.all([n(t),r(t)]);case 4:return a=e.sent,e.abrupt("return",a);case 8:e.prev=8,e.t0=e["catch"](1),console.warn(e.t0);case 11:case"end":return e.stop()}},e,null,[[1,8]])}));return function(){return t.apply(this,arguments)}}();return{init:a}}]),angular.module("cloudshop").config(["$stateProvider",function(t){t.state("authenticated.card.events",{url:"/events",templateUrl:"js/pages/authenticated/header/events/index.html",controller:"eventsCtrl",data:{pageTitle:"UPCOMING_EVENTS",sidebar:!0}})}]),angular.module("cloudshop").controller("eventsCtrl",["$scope",function(t){t.historyTab=1,t.history={query:{start:+moment().format("X"),end:+moment().add(10,"years").format("X")}}}]).controller("eventsItemCtrl",["$scope","eventsService",function(t,e){var n=function(){e.init().then(function(e){_.sum(e)>0&&(t.completed=!0,t.$apply())})};n()}]),angular.module("cloudshop.reports",[]).config(["$stateProvider",function(t){t.state("authenticated.card.reports",{url:"/reports",templateUrl:"js/pages/reports/_index.html",controller:"reportsIndexCtrl",data:{pageTitle:"REPORTS",permission:"reports"}}).state("authenticated.card.reports_product",{url:"/reports/product",templateUrl:"js/pages/reports/_inner.html",controller:"reportsInnerCtrl",data:{pageTitle:"REPORTS",permission:"reports"}}).state("authenticated.card.reports_categories",{url:"/reports/categories",templateUrl:"js/pages/reports/_inner.html",controller:"reportsInnerCtrl",data:{pageTitle:"REPORTS",permission:"reports"}}).state("authenticated.card.reports_set",{url:"/reports/set",templateUrl:"js/pages/reports/_inner.html",controller:"reportsInnerCtrl",data:{pageTitle:"REPORTS",permission:"reports"}}).state("authenticated.card.reports_day",{url:"/reports/day",templateUrl:"js/pages/reports/_inner.html",controller:"reportsInnerCtrl",data:{pageTitle:"REPORTS",permission:"reports"}}).state("authenticated.card.reports_week",{url:"/reports/week",templateUrl:"js/pages/reports/_inner.html",controller:"reportsInnerCtrl",data:{pageTitle:"REPORTS",permission:"reports"}}).state("authenticated.card.reports_month",{url:"/reports/month",templateUrl:"js/pages/reports/_inner.html",controller:"reportsInnerCtrl",data:{pageTitle:"REPORTS",permission:"reports"}}).state("authenticated.card.reports_motion",{url:"/reports/motion",templateUrl:"js/pages/reports/_inner.html",controller:"reportsInnerCtrl",data:{pageTitle:"REPORTS",permission:"reports"}}).state("authenticated.card.reports_agent",{url:"/reports/agent",templateUrl:"js/pages/reports/_inner.html",controller:"reportsInnerCtrl",data:{pageTitle:"REPORTS",permission:"reports"}}).state("authenticated.card.reports_finance",{url:"/reports/finance",templateUrl:"js/pages/reports/_inner.html",controller:"reportsInnerCtrl",data:{pageTitle:"REPORTS",permission:"reports"}}).state("authenticated.card.reports_staff",{url:"/reports/staff",templateUrl:"js/pages/reports/_inner.html",controller:"reportsInnerCtrl",data:{pageTitle:"REPORTS",permission:"reports"}}).state("authenticated.card.reports_stock",{url:"/reports/stock",templateUrl:"js/pages/reports/_inner.html",controller:"reportsInnerCtrl",data:{pageTitle:"REPORTS",permission:"reports"}})}]),angular.module("cloudshop.reports").config(["$stateProvider",function(t){t.state("authenticated.card.report_constructor",{url:"/report-constructor",templateUrl:"js/pages/reports/report-constructor/_view.html",data:{pageTitle:"REPORT_CONSTRUCTOR"}}).state("authenticated.card.report_constructor.history",{url:"/report-constructor/history",controller:"reportConstructorCtrl",templateUrl:"js/pages/reports/report-constructor/docs-history.html",data:{pageTitle:"VIEW_DOCUMENTS"}})}]),angular.module("cloudshop.reports").controller("reportConstructorCtrl",["$scope","reportConstructorService","docService","db",function(t,e,n,r){t.history={query:e.docHistory}}]),angular.module("cloudshop.reports").service("reportConstructorService",[function(){this.docHistory={}}]).directive("iframeReportConstructor",["$state","api","$sce","reportConstructorService","translateService",function(t,e,n,r,a){return{restrict:"C",link:function(o){o.url=n.trustAsResourceUrl("/plugins/report-constructor/?company=".concat(e.user.clientID(),"&lang=").concat(a.get())),window.addEventListener("message",function(e){switch(e.data.type){case"openSidebar":var n=e.data.payload;switch(n.group){case"stores":t.go("authenticated.card.store_show",{stores_id:n._id});break;case"products":t.go("authenticated.card.catalog.get",{productId:n._id});break;case"customers":t.go("authenticated.card.client_show",{clients_id:n._id});break;case"docs":t.go("authenticated.card.journal.item",{document_id:n._id});break;case"authors":t.go("authenticated.card.profile",{staff_id:n._id})}break;case"openSidebarHistory":var a=e.data.payload;r.docHistory=a,t.go("authenticated.card.report_constructor.history")}},!1)}}}]),angular.module("cloudshop.supplier",["ngSanitize"]).config(["$stateProvider",function(t){t.state("authenticated.card.supplier",{url:"/supplier",templateUrl:"js/pages/supplier/_list.html",controller:"suppliersCtrl",data:{pageTitle:"SUPPLIERS",permission:"suppliers"}}).state("authenticated.card.supplier_add",{url:"/suppliers/add",templateUrl:"js/pages/supplier/card/_form.html",controller:"supplierCtrl",data:{pageTitle:"NEW_SUPPLIER",permission:"suppliers",method:"POST"}}).state("authenticated.card.supplier_show",{url:"/suppliers/show/:suppliers_id",templateUrl:"js/pages/supplier/card/_view.html",controller:"supplierShowCtrl",data:{pageTitle:"SUPPLIER_PROFILE",permission:"suppliers",sidebar:!0}}).state("authenticated.card.supplier_edit",{url:"/suppliers/edit/:suppliers_id",templateUrl:"js/pages/supplier/card/_form.html",controller:"supplierCtrl",data:{pageTitle:"SUPPLIER_EDIT",permission:"suppliers",method:"PUT",sidebar:!0}})}]),angular.module("cloudshop.supplier").controller("supplierShowCtrl",["$scope","db","modalService","supplierService","$state",function(t,e,n,r,a){function o(){return i.apply(this,arguments)}function i(){return i=_asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,r.method.remove();case 3:n.method.close(),t.next=9;break;case 6:t.prev=6,t.t0=t["catch"](0),console.warn(t.t0);case 9:case"end":return t.stop()}},t,null,[[0,6]])})),i.apply(this,arguments)}function c(){n.method.add([{title:"EDIT",className:"green",active:!0,action:{url:"authenticated.card.supplier_edit",param:{suppliers_id:u}},visible:!0},{title:"DELETE",className:"red","float":"right",active:!0,action:o,visible:!!u,perm:["suppliers","DELETE"]}])}function s(){c()}var u=a.params.suppliers_id;if(t.id=u,t.historyTab=1,t.data=r.method.data,t.method=r.method,t.modalService=n.init.data,t.history={query:{contractor:u},config:{client:"suppliers"}},t.statsQuery={type:"suppliers",contragent_id:u},u){t.modalService.loading=!0;var d=null,l=_.where(e.storage.suppliers.data,{_id:u});d=l[0]?new Promise(function(t){t({data:_.clone(l,!0)})}):e.method.query.get("/data/:client/suppliers/".concat(u),{v:"v3"}),t.page={title:"SUPPLIER_EDIT"},Promise.all([d]).then(function(n){t.modalService.loading=!1;var a=r.method.un_format(e.storage.suppliers.f(n[0])[0]);t.data=e.storage.suppliers.proto(Object.assign(r.method.data,a)),s(),t.$apply()})}t.$on("$destroy",function(){n.init.remove(),n.init.data.loading=!1,r.method.clear()})}]),angular.module("cloudshop.supplier").service("supplierService",["apiRouteService",function(t){var e={template:function(){return{name:"",emails:[],phones:[],site:"",address:{actual:"",legal:""},bank_details:[],details:[],description:"","default":!1}},data:{},format:function(){var t=_.clone(this.data,!0);return t.phones=_.map(t.phones,function(t){return t.value}),t.emails=_.map(t.emails,function(t){return t.value}),t},un_format:function(t){return t.created=moment(1e3*t.created).format("DD MMMM YYYY"),t.phones=_.map(t.phones,function(t){return{value:t}}),t.emails=_.map(t.emails,function(t){return{value:t}}),t.details=_.filter(t.details,function(t){return t.key&&t.value}),t.bank_details=_.filter(t.bank_details,function(t){return t.key&&t.value}),t},save:function(){return e.data._id?e.edit():e.add()},add:function(){return t.suppliers().add(e.format()).then(function(t){return e.clear(),t})},edit:function(){return t.suppliers().edit(e.format()).then(function(t){return e.clear(),t})},remove:function(){return t.suppliers()["delete"](e.data)},clear:function(){e.data=e.template()}};return e.clear(),{method:e}}]),angular.module("cloudshop.supplier").controller("supplierCtrl",["$scope","db","modalService","supplierService","$state","$rootScope",function(t,e,n,r,a,o){function i(){return c.apply(this,arguments)}function c(){return c=_asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,r.method.remove();case 3:n.method.close(),t.next=8;break;case 6:t.prev=6,t.t0=t["catch"](0);case 8:case"end":return t.stop()}},t,null,[[0,6]])})),c.apply(this,arguments)}function s(){var t=r.method.save();o.$broadcast("notify.loading2",{title:"SAVING",promise:t}),n.method.close()}function u(){n.method.add([{title:"SAVE",className:"green",active:!1,action:s,visible:!0,perm:["suppliers","POST"]},{title:"DELETE",className:"red","float":"right",active:!0,action:i,visible:!!l,perm:["suppliers","DELETE"]}])}function d(){u(),t.data=Object.assign(t.data,{emails:[{value:""}],phones:[{value:""}],bank_details:[{key:"",value:""}],details:[{key:"",value:""}]})}t.data=r.method.data,t.method=r.method,t.loading=!1;var l=a.params.suppliers_id;if(l){var p=null,m=_.where(e.storage.suppliers.data,{_id:l});p=m[0]?new Promise(function(t){t({data:_.clone(m,!0)})}):e.method.query.get("/data/:client/suppliers/".concat(l),{v:"v3"}),t.page={title:"SUPPLIER_EDIT"},Promise.all([p]).then(function(n){var a=r.method.un_format(e.storage.suppliers.f(n[0])[0]);d(),t.data=_.merge(t.data,a),t.$apply()})}t.$watch("data",function(t){t.name?n.init.enable([0,1]):n.init.disable([0,1])},!0),t.$on("$destroy",function(){n.init.remove(),r.method.clear()}),l||(t.page={title:"ADDING_SUPPLIER"},d())}]),angular.module("cloudshop.supplier").directive("suggestions",["$filter",function(t){return{restrict:"A",scope:!0,link:function(e,n){var r={inn:"ITN",kpp:"IEC",ogrn:"PSRN",okpo:"OKPO",okved:"OKVED"};$(n).suggestions({serviceUrl:"https://suggestions.dadata.ru/suggestions/api/4_1/rs",token:"14d6e13f159121acbe72e6afbbf93c05f7e55e57",type:"PARTY",count:5,onSelect:function(n){var a=n.data,o=n.value,i=[];Object.keys(r).forEach(function(e){a[e]&&i.push({key:t("translate")(r[e]),value:a[e]})}),e.suggestions&&e.suggestions.onChange?e.suggestions.onChange(_objectSpread({},a,{detailsData:i})):(e.data.details=i,0==e.data.details.length&&e.data.details.push({key:null,value:null}),e.data.name=o,e.data.address.legal=a.address.unrestricted_value),e.$apply()}}),setTimeout(function(){return $(n).focus()})}}}]).directive("suggestionsBank",["$filter",function(t){return{restrict:"A",scope:!0,link:function(e,n){var r={name:t("translate")("NAME"),bic:t("translate")("BIK"),address:t("translate")("ADDRESS"),correspondent_account:"Кор/Сч",cain:"Кор/Сч в",ra:"Р/Сч"};$(n).suggestions({serviceUrl:"https://suggestions.dadata.ru/suggestions/api/4_1/rs",token:"14d6e13f159121acbe72e6afbbf93c05f7e55e57",type:"BANK",count:5,scrollOnFocus:!1,onSelect:function(t){var a=t.data;a.name=a.name["short"]||a.name.payment,a.address=a.address.unrestricted_value,a.cain=a.rkc?a.rkc.name.payment:null,e.data.bank_details=[],Object.keys(r).forEach(function(t){a[t]&&e.data.bank_details.push({key:r[t],value:a[t]})}),e.data.bank_details.push({key:"Р/Сч",value:null}),setTimeout(function(){$(n).parent().parent().find(".two.fields:last").find("input:last").focus()}),e.$apply()}})}}}]),angular.module("cloudshop.register").directive("shiftStats",["db",function(t){return{restrict:"E",replace:!0,scope:!0,templateUrl:"js/pages/register/shift/stats.html",link:function(e){e.data=e.$parent.data;var n=function(){e.data=e.$parent.data,e.sales=_.filter(e.data.docs,{type:"sales"})[0]||{sum:0,count:0},e.return_sales=_.filter(e.data.docs,{type:"return_sales"})[0]||{sum:0,count:0},t.method.init("register").then(function(t){e.register=t[0].find(function(t){return t._id==e.data._register})||{},e.$apply()})};e.get=function(t,n){return"object"!==_typeof(n)&&(n={type:n}),_.sum(_.filter(e.data[t],n),"sum")||0},e.$watch("$parent.data",n)}}}]),angular.module("cloudshop.register").controller("shiftCtrl",["$scope","$rootScope","api","db","apiRouteService","$filter",function(t,e,n,r,a,o){t.load=!1,t.loaded=!1,t.data=[],t.offset=0,t.limit=30,t.total=0;var i=0,c={};t.columnSettings={save:function(){console.warn("save")},list:{open:{label:"OPEN",active:!0,sorting:!1},closed:{label:"SHIFT_CLOSED",active:!0,sorting:!1},cashier:{label:"CASHIER",active:!0,sorting:!1},register:{label:"REGISTER",active:!0,sorting:!1},store:{label:"STORE",active:!0,sorting:!1},receipts:{label:"".concat(o("translate")("REVENUE"),", ").concat(o("cur")()),active:!0,sorting:!1},"stats.sales":{label:"SALES",active:!0,sorting:!1},"stats.sales_sum":{label:"SALES_SUM",active:!0,sorting:!1},"stats.cash":{label:"CASH",active:!0,sorting:!1},"stats.cashless":{label:"NONCASH",active:!0,sorting:!1},"stats.return_sales":{label:"RETURNS",active:!0,sorting:!1},"stats.return_sales_sum":{label:"REFUND_SUM",active:!0,sorting:!1},open_money:{label:"".concat(o("translate")("START_OF_SHIFT"),", ").concat(o("cur")()),active:!0,sorting:!1},"stats.debit":{label:"INCOME_SUM",active:!0,sorting:!1},"stats.credit":{label:"EXPENSES_SUM",active:!0,sorting:!1},close_money:{label:"".concat(o("translate")("END_OF_SHIFT"),", ").concat(o("cur")()),active:!0,sorting:!1}}},t.filter={name:"shiftFilter",onChange:function(e){t.load=!0,t.data=[],c=e,u(e)},fields:[{_id:"date",name:"OPEN_DATE",type:"date",show:!0,value:[+moment().subtract(4,"months").startOf("day").format("X"),+moment().endOf("day").format("X")],required:!0},{_id:"_user",name:"CASHIER",type:"dropdown",show:!0,settings:{name:"staff",search:!0}},{_id:"_store",name:"STORE",type:"dropdown",show:!0,settings:{name:"stores",search:!0}},{_id:"_register",name:"REGISTER",type:"dropdown",show:!0,settings:{name:"register",search:!0}}]};var s=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=t.offset,o=t.limit;return t.load=!0,r.method.init(["stores","register"]).then(function(){return n.data.post("/shift/:client/".concat(a,"/").concat(o),_objectSpread({v:"v3"},e))}).then(function(e){var n=e.data,r=n.data,a=n.total;return i+=r.length,t.offset+=r.length,t.limit!==r.length?t.total=i:t.total=a,r}).then(function(t){return t.map(p)}).then(function(e){t.data=t.data.concat(e),t.load=!1,t.loaded=!0,t.$apply()})};t.stats=function(t,e){return"object"!==_typeof(e)&&(e={type:e}),_.sum(_.filter(this.item[t],e),"sum")||0},t.getYet=function(){return s(c)};var u=function(e){t.data=[],t.offset=0,t.total=0,s(e)},d=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.shift().close({_id:t});case 2:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}();t.get=s,t.close=d;var l=function(t,e,n){return"object"!==_typeof(n)&&(n={type:n}),_.sum(_.filter(t[e],n),"sum")||0},p=function(t){return _objectSpread({},t,{user:r.storage.staff.data.find(function(e){return e._id==t._user}),register:r.storage.register.data.find(function(e){return e._id==t._register}),receipts:l(t,"orders",{source:100})-l(t,"orders",{source:201}),sales:_.filter(t.docs,{type:"sales"})[0]||{sum:0,count:0},return_sales:_.filter(t.docs,{type:"return_sales"})[0]||{sum:0,count:0}})},m=function(e,n){var r=n.meta;switch(r.method){case"opened":t.data.unshift(p(r.data));break;case"closed":for(var a in t.data)t.data[a]._id==r.data._id&&(t.data[a].closed=r.data.closed)}t.$apply()},f=function(){};e.$on("WS_UPDATE_SHIFT",m),f()}]).controller("shiftShowCtrl",["$scope","api","db","$state","modalService","apiRouteService",function(t,e,n,r,a,o){var i=r.params.shift_id;t.id=i,t.historyTab=1,t.loading=!1,t.loaded=!1,t.data={},t.history={query:{_shift:i}};var c=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function r(){var t,a;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,n.method.init(["stores","register"]);case 2:return r.next=4,e.data.get("/shift/:client/".concat(i),{v:"v3"});case 4:return t=r.sent,a=t.data,r.abrupt("return",a.data);case 7:case"end":return r.stop()}},r)}));return function(){return t.apply(this,arguments)}}(),s=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a.method.disable(0),e.next=4,o.shift().close(t.data);case 4:a.method.remove(0),e.next=10;break;case 7:e.prev=7,e.t0=e["catch"](0),alert($filter("translate")("AN_ERROR_HAS_OCCURRED"));case 10:case"end":return e.stop()}},n,null,[[0,7]])}));return function(){return e.apply(this,arguments)}}(),u=function(){a.method.add([{title:"CLOSE_SHIFT",className:"red","float":"right",active:!1,action:s,visible:!!i,perm:["suppliers","DELETE"]}])};t.$watch("data",function(t){t&&t.closed&&a.method.remove(0)});var d=function(){t.loading=!0,c().then(function(e){var r;try{r=[e.device.location.lat,e.device.location.lng]}catch(o){r=[0,0]}t.data=e,t._data={user:n.storage.staff.data.find(function(t){return t._id==e._user}),register:n.storage.register.data.find(function(t){return t._id==e._register}),store:n.storage.stores.data.find(function(t){return t._id==e._store}),map:r[0]?"https://www.google.com/maps/place/".concat(r.join("+"),"/@").concat(r.join(","),",12z"):null},t.loading=!1,t.loaded=!0,a.method.enable([0,1],!0),t.$apply()}),u()};d()}]),angular.module("cloudshop.register").controller("registerDownloadCtrl",["$scope","$rootScope","db",function(t,e,n){}]),angular.module("cloudshop.register").service("registerService",["api","$http","IMAGE_UPLOAD_URL","apiRouteService",function(t,e,n,r){var a={save:function(t){var e=this;return _asyncToGenerator(regeneratorRuntime.mark(function n(){var a,o,i,c,s,u,d,l,p;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:for(a=t._id?"edit":"add",o=[],i=0,c=["after","before"];i<c.length;i++){s=c[i],t.design[s]=t.design[s].filter(function(t){return"text"===t.type?!!t.text:!(!t.url&&!t.image)}),u=_createForOfIteratorHelper(t.design[s]);try{for(l=function(){var t=d.value;if("image"===t.type&&t.image){var n=e.saveImage(t.image).then(function(e){t.url=e});o.push(n),delete t.image}},u.s();!(d=u.n()).done;)l()}catch(m){u.e(m)}finally{u.f()}}return n.next=5,Promise.all(o);case 5:return n.next=7,r.register()[a](e.format(t));case 7:return p=n.sent,n.abrupt("return",p);case 9:case"end":return n.stop()}},n)}))()},format:function(t){var e=t;return e.users=(e.users||[]).filter(function(t){return!!t}),e},saveImage:function(t){return _asyncToGenerator(regeneratorRuntime.mark(function r(){var a,o,i;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return a=new FormData,a.append("upfile",t),r.next=4,e.post(n,a,{transformRequest:angular.identity,headers:{"Content-Type":void 0}});case 4:return o=r.sent,i=o.data,r.abrupt("return",i.url);case 7:case"end":return r.stop()}},r)}))()}};return _objectSpread({},a)}]),angular.module("cloudshop.register").controller("registerCashCtrl",["$scope","$rootScope","db",function(t,e,n){t.load=!1,t.loaded=!1,t.data=[],t.message="Для добавления новой кассы<br> нажмите «создать кассу";var r=function(){return n.method.init(["register","stores","accounts"]).then(function(e){t.data=e[0],t.total=_.sum(t.data,"money")})},a=function(){t.load=!0,r().then(function(){t.load=!1,t.loaded=!0,t.$apply()})};e.$on("WS_UPDATE_REGISTER",a),a()}]).controller("registerAddCashCtrl",["$scope","$state","modalService","registerService","db",function(t,e,n,r,a){function o(){return i.apply(this,arguments)}function i(){return i=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.loading=!0,n.method.disable(0),e.prev=2,e.next=5,r.save(t.data);case 5:n.method.close(),e.next=12;break;case 8:e.prev=8,e.t0=e["catch"](2),t.loading=!1,n.method.enable(0);case 12:case"end":return e.stop()}},e,null,[[2,8]])})),i.apply(this,arguments)}var c=e.params.register_id;t.tab=1,t.loading=!1,t.data={name:null},t.dropdown={_store:{title:"STORE",name:"stores","class":"floating fluid button",icon:"dropdown",search:!0}},t.page=e.current.data,t.$watch("form.$valid",function(e){n.method.toggle([0],e&&!!t.data._store)}),t.$watch("data._store",function(e){n.method.toggle([0],t.form.$valid&&!!e)}),t.$on("$destroy",function(){n.init.remove()});var s=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function r(){var e,i,s,u,d,l,p;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(n.method.add([{title:"SAVE",className:"green",active:!0,action:o,visible:!0,perm:["stores","POST"]}]),!c){r.next=8;break}return t.loading=!0,r.next=5,a.method.init("register");case 5:e=r.sent,t.loading=!1,t.data=_.clone(_.where(e[0],{_id:c})[0],!0);case 8:return r.next=10,a.method.init("accounts");case 10:return i=r.sent,s=_slicedToArray(i,1),u=s[0],t.terminals=u.filter(function(t){return t.use_terminal}),r.next=16,a.method.init("staff");case 16:d=r.sent,l=_slicedToArray(d,1),p=l[0],t.staff=p.filter(function(t){return!t.deleted}),c&&(t.data.users=t.data.users.filter(function(e){return t.staff.find(function(t){return t._id===e})})),t.$apply();case 22:case"end":return r.stop()}},r)}));return function(){return e.apply(this,arguments)}}();s()}]).controller("registerShowCashCtrl",["$scope","db","$state","modalService","api","$rootScope","apiRouteService",function(t,e,n,r,a,o,i){var c=n.params.register_id;t.id=c,t.loading=!1,t.loaded=!1,t.data={},t.history={query:{_register:c}};var s=function(){return e.method.get("register").then(function(t){return t.filter(function(t){return t._id==c})[0]})},u=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,i.register()["delete"](t.data);case 3:r.method.close(),e.next=8;break;case 6:e.prev=6,e.t0=e["catch"](0);case 8:return e.prev=8,e.finish(8);case 10:case"end":return e.stop()}},n,null,[[0,6,8,10]])}));return function(){return e.apply(this,arguments)}}(),d=function(){r.method.add([{title:"EDIT",className:"green",active:!1,action:{url:"authenticated.card.register.editBox",param:{register_id:c}},visible:!!c},{title:"DELETE",className:"red","float":"right",active:!1,action:u,visible:!!c,perm:["suppliers","DELETE"]}])},l=function(){t.loading=!0,s().then(function(e){t.data=e,t.loading=!1,t.loaded=!0,r.method.enable([0,1],!0),t.$apply()}),d()};l()}]),angular.module("cloudshop.documents").service("payService",["api","$rootScope","$filter","apiRouteService","db",function(t,e,n,r,a){var o={data:{},template:{date:+moment().format("X"),type:null,source:0,store:null,number:null,sum:0,comment:null,doc_id:null,status:!0,contragent:{_id:"",name:"",type:""}},save:function(){function t(t,n){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function n(t,e){var a;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(t=t||{},t.source=+t.source,t=Object.assign(t,{date:+(t.date||moment().format("X"))}),e=Object.assign({method:"add"},e||{}),!t.type||!t.source){n.next=11;break}return n.next=7,r.order()[e.method](t,e.forse);case 7:if(a=n.sent,!a.data.error){n.next=10;break}throw a.data.error;case 10:return n.abrupt("return",a);case 11:case"end":return n.stop()}},n)}));return t}(),create:function(t,e){return this.save(t,{forse:e})},update:function(t,e){return this.save(t,{method:"edit",forse:e})},remove:function(t,e){return r.order()["delete"](t,e)},init:function(){o.data=_.clone(o.template,!0)}};o.source=[];var i=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(e,r){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:a=r,t.user.company().user_order_category&&(a=a.concat(_.map(t.user.company().user_order_category,function(t,e){return{id:+e,title:t,type:+e>=2e3?"credit":"debit"}}))),o.source=a;case 3:case"end":return e.stop()}},n)}));return function(t,n){return e.apply(this,arguments)}}();return e.$on("DB.SOURCES.SUCCEEDED",i),o.types={debit:{title:n("translate")("INCOME")},credit:{title:n("translate")("EXPENSE")}},{pay:o}}]).run(["payService",function(){}]),angular.module("cloudshop.documents").controller("payTransferCtrl",["$filter","$scope","api","db","docService","modalService","payService","$state","$rootScope",function(t,e,n,r,a,o,i,c,s){function u(){return d.apply(this,arguments)}function d(){return d=_asyncToGenerator(regeneratorRuntime.mark(function t(){var n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e.loading=!0,o.method.disable(0),n=Object.assign({},e.data),t.prev=3,t.next=6,e.pay.create(Object.assign({},n,{type:"credit",source:301}));case 6:return t.next=8,e.pay.create(Object.assign({},n,{store:n.contragent._id,storeName:n.contragent.name,contragent:{_id:n.store,type:"accounts",name:n.storeName},type:"debit",source:301}));case 8:o.init.back(),t.next=13;break;case 11:t.prev=11,t.t0=t["catch"](3);case 13:return t.prev=13,t.finish(13);case 15:case"end":return t.stop()}},t,null,[[3,11,13,15]])})),d.apply(this,arguments)}function l(){o.method.add([{title:"SAVE",className:"green",active:!1,visible:!0,action:u,arguments:[!0],perm:[e.setting.permission,"POST"]}])}function p(){e.dropdown={store:{name:"accounts",filter:m?{}:{type:"!register"},"class":"floating fluid large light button",search:!0,onChange:function(t,n){e.data.storeName=n.name}},contragent:{name:"accounts",filter:m?{}:{type:"!register"},create:"authenticated.card.account_add","class":"floating fluid large light button",search:!0,onChange:function(t,n){e.data.contragent.name=n.name,e.data.contragent.type=t}}},l(),r.method.init(["accounts"]).then(function(){if(!c.params.id){var t=_.where(r.storage.accounts.data,{"default":!0});e.data.store=t[0]?t[0]._id:"",e.data.storeName=t[0]?t[0].name:""}e.$apply()})}var m=c.params.id;e.db=r.storage,e.setting=c.current.data,e.pay=i.pay,e.data={status:!0,date:+moment().format("X"),contragent:{},sum:0},e.$watch("form.$valid",function(t){o.method.toggle([0],t)}),e.$watch("data.contragent._id",function(t){o.method.toggle([0],t)}),e.$on("$destroy",function(){o.init.remove(),o.init.data.loading=!1,e.pay.init(),f()});var f=e.$on("updater",function(t,r){n.user.data._id==r.data._user&&["accounts"].indexOf(r.type)>-1&&(e.data.contragent._id=r.data._id,e.data.contragent.name=r.data.name,e.data.contragent.type=r.type),e.$apply()});p()}]),angular.module("cloudshop.documents").controller("payCtrl",["$filter","$scope","api","db","modalService","payService","$state","promptModal","apiRouteService","safeApply","$rootScope",function(t,e,n,r,a,o,i,c,s,u,d){function l(t){return t?((void 0===_typeof(t.contragent)||Array.isArray(t.contragent))&&(t.contragent={}),t):t}function p(){a.method.add([{title:"SAVE",className:"green",active:!0,visible:!e.data.deleted,action:b,arguments:[!0],perm:[e.setting.permission,"POST"]}]),e.data.deleted?a.method.append([{title:"RESTORE",className:"red","float":"right",active:!0,visible:!0,action:k}]):a.method.append([T])}function m(){return f.apply(this,arguments)}function f(){return f=_asyncToGenerator(regeneratorRuntime.mark(function t(){var n,a,o,i,c,s,u;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return p(),e.dropdown={store:{name:"accounts",filter:e.data._id&&e.data._register?{}:{type:"!register"},create:"authenticated.card.account_add","class":"floating fluid large basic button",search:!0,limit:99},contragent:{name:"accounts"===e.data.contragent.type?"accounts":"suppliers,clients,staff",limit:3,"class":"floating fluid large basic button",search:!0,onChange:function(t,n){e.data.contragent.name=n.name,e.data.contragent.type=t}},sources:{limit:999,create:v,createText:"CREATE_NEW_CATEGORY","class":"fluid selection",search:!0,onChange:function(t,e){console.warn({type:t,item:e})},renderItemButtons:function(t){return t._id>1e3&&!t.deprecated?[{icon:"pencil",onPress:function(e){e.preventDefault(),e.stopPropagation(),_(t)}},{icon:"trash alternate outline",onPress:function(e){e.preventDefault(),e.stopPropagation(),y(t)}}]:void 0}}},t.prev=2,t.next=5,r.method.init(["accounts"]);case 5:n=t.sent,a=_slicedToArray(n,1),o=a[0],h||(i=o.find(function(t){return t["default"]}),e.data.store=i?i._id:null),c=h?[]:[102,103,104,105,202,203,204,205],s=r.storage.sources.data,h&&(u=r.storage.sources.deprecated.find(function(t){return t.id===e.data.source}),u&&s.push(u)),e.dropdown.sources.name=s.filter(function(t){return t.type===e.data.type||h&&301===t.id}).filter(function(t){return c.includes(t.id)===!1}).map(function(t){return{_id:t.id,name:t.title,deprecated:!!t.deprecated}}),e.dropdown.sources.name.find(function(t){return t._id===e.data.source})||(e.data.source=null),t.next=18;break;case 16:t.prev=16,t.t0=t["catch"](2);case 18:return t.prev=18,e.$apply(),t.finish(18);case 21:case"end":return t.stop()}},t,null,[[2,16,18,21]])})),f.apply(this,arguments)}var h=i.params.orderId;e.id=h,e.db=r.storage,console.log("payService.types",o),e.setting=i.current.data,e.title=e.setting.title,e.pay=o.pay,e.data={status:!0,date:+moment().format("X"),contragent:{},sum:0},e.$watch("form.$valid",function(t){a.method.toggle([0,1],t)}),e.$on("$destroy",function(){a.init.remove(),a.init.data.loading=!1,e.pay.init()});var g=function(t){var e={debit:1e3,credit:2e3},n=e[t],a=_toConsumableArray(r.storage.sources.data.map(function(t){return t.id})).map(function(t){return+t}).filter(function(n){return n>e[t]&&n<e[t]+1e3}).sort(function(t,e){return t>e?-1:t===e?0:1});return a[0]&&(n=a[0]),n+1},v=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function n(){var t,a,o,i,d;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,c({title:"NEW_PAYMENT_CATEGORY",placeholder:"ENTER_CATEGORY_NAME"});case 3:return t=n.sent,a=g(e.data.type),o={title:t.trim(),type:e.data.type,id:a},n.next=8,s.sources().add(o);case 8:return i=n.sent,d=i.data.data,o._id=d,e.dropdown.sources.name.push({_id:a,name:o.title}),e.data.source=a,n.next=15,r.method.reload("sources");case 15:n.next=20;break;case 17:n.prev=17,n.t0=n["catch"](0),console.warn({e:n.t0});case 20:return n.prev=20,u(e),n.finish(20);case 23:case"end":return n.stop()}},n,null,[[0,17,20,23]])}));return function(){return t.apply(this,arguments)}}(),_=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function n(t){var a,o,i,d,l;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return a=t._id,o=t.name,n.prev=1,n.next=4,c({title:"EDIT_PAYMENT_CATEGORY",placeholder:"ENTER_CATEGORY_NAME",successText:"CHANGE",value:o});case 4:return i=n.sent,d=i.trim(),l={title:d,id:a},n.next=9,s.sources().edit(l);case 9:return e.dropdown.sources.name.forEach(function(t){t._id===a&&(t.name=d)}),e.data.source=a,n.next=13,r.method.reload("sources");
case 13:n.next=18;break;case 15:n.prev=15,n.t0=n["catch"](1),console.warn({e:n.t0});case 18:return n.prev=18,u(e),n.finish(18);case 21:case"end":return n.stop()}},n,null,[[1,15,18,21]])}));return function(e){return t.apply(this,arguments)}}(),y=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function n(t){var a,o,i;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return a=t._id,o=t.name,n.prev=1,n.next=4,s.sources()["delete"]({id:a,name:o});case 4:return i=e.dropdown.sources.name.findIndex(function(t){return t._id===a}),e.dropdown.sources.name.splice(i,1),e.data.source=null,n.next=9,r.method.reload("sources");case 9:n.next=14;break;case 11:n.prev=11,n.t0=n["catch"](1),console.warn({e:n.t0});case 14:return n.prev=14,u(e),n.finish(14);case 17:case"end":return n.stop()}},n,null,[[1,11,14,17]])}));return function(e){return t.apply(this,arguments)}}(),b=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function n(){var t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return e.loading=!0,t=h?"update":"create",a.method.disable(0),n.prev=3,n.next=6,e.pay[t](e.data);case 6:a.method.close(),n.next=13;break;case 9:n.prev=9,n.t0=n["catch"](3),e.loading=!1,a.method.enable(0);case 13:return n.prev=13,u(e),n.finish(13);case 16:case"end":return n.stop()}},n,null,[[3,9,13,16]])}));return function(){return t.apply(this,arguments)}}(),E=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function n(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.pay.remove(e.data);case 3:a.method.close(),t.next=8;break;case 6:t.prev=6,t.t0=t["catch"](0);case 8:case"end":return t.stop()}},n,null,[[0,6]])}));return function(){return t.apply(this,arguments)}}(),S=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function n(){var t,i,c,d,p;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return e.loading=!0,n.prev=1,n.next=4,s.order().get(h);case 4:return t=n.sent,i=t.data.data,e.data=l(i),e.title=o.pay.types[e.data.type].title,m(),e.data._shift&&a.method.update({icon:"warning sign"},[0,1]),n.next=12,r.method.init("accounts");case 12:c=n.sent,d=_slicedToArray(c,1),p=d[0],e.account=p.find(function(t){return t._id==e.data.store}),n.next=21;break;case 18:n.prev=18,n.t0=n["catch"](1),console.warn(n.t0);case 21:return n.prev=21,e.loading=!1,u(e),n.finish(21);case 25:case"end":return n.stop()}},n,null,[[1,18,21,25]])}));return function(){return t.apply(this,arguments)}}(),T={title:"DELETE",className:"red","float":"right",active:!0,visible:!!h,action:E,perm:[e.setting.permission,"DELETE"]},w=function(){var n={date:moment().format("X"),title:"Восстановлен ордер #".concat(e.data.number),subtitle:t("curr")(e.data.sum)};d.$broadcast("NOTIFY",n)},k=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function n(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,a.method.update({active:!1},1),t.next=4,s.order().restore(e.data);case 4:a.method.update({visible:!1},[0,1]),a.method.append([T]),w(),t.next=13;break;case 9:t.prev=9,t.t0=t["catch"](0),a.method.update({active:!0},1),console.warn(t.t0);case 13:case"end":return t.stop()}},n,null,[[0,9]])}));return function(){return t.apply(this,arguments)}}();h?S():(m(),e.loading=!1,e.data.type=e.setting.type)}]),angular.module("cloudshop.journal",[]).config(["$stateProvider",function(t){t.state("authenticated.card.journal",{url:"/journal",templateUrl:"js/pages/journal/index.html",controller:"journalCtrl",data:{pageTitle:"OPERATIONS"}}).state("authenticated.card.journal.item",{url:"/journal/:document_id",templateUrl:"js/pages/journal/page/index.html",controller:"journalItemCtrl",data:{pageTitle:"VIEW_DOCUMENT",sidebar:!0,sidebarSize:"xl"}})}]),angular.module("cloudshop.journal").controller("journalItemCtrl",["$scope","$state","modalService","api","docTimeLineService","$rootScope","journalItemService","apiRouteService","safeApply","$filter",function(t,e,n,r,a,o,i,c,s,u){function d(){n.method.add([{title:"EDIT",className:"green",action:{url:"authenticated.card.doc.edit",param:{id:l}},visible:!0,active:!0},{visible:!0,template:"/js/pages/journal/page/actions-print.html"},{visible:!0,template:"/js/pages/journal/page/actions-download.html"},{visible:!0,template:"/js/pages/journal/page/actions-return.html"}]),t.item&&t.item.deleted?n.method.append([{title:"RESTORE",className:"red","float":"right",active:!0,action:h,visible:!!l}]):n.method.append([m]),t.item&&t.item._shift&&n.method.update({icon:"warning sign"},[0,4]),s(t)}var l=e.params.document_id;t.loading=!0,t.currentPage=1,t.pageSize=100,t.total={sub:0,discount:0,qty:0};var p=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function r(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,c.document()["delete"](t.item);case 3:n.method.close(),e.next=9;break;case 6:e.prev=6,e.t0=e["catch"](0),console.warn(e.t0);case 9:case"end":return e.stop()}},r,null,[[0,6]])}));return function(){return e.apply(this,arguments)}}(),m={title:"DELETE",className:"red","float":"right",active:!0,action:p,visible:!!l},f=function(){var e={date:moment().format("X"),title:"Восстановлен документ «".concat(u("translate")(t.item.doc.title)," №").concat(t.item.number,"»"),subtitle:u("curr")(t.item.sum)};o.$broadcast("NOTIFY",e)},h=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function r(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n.method.update({visible:!1},4),e.next=4,c.document().restore(t.item);case 4:n.method.append([m]),f(),e.next=11;break;case 8:e.prev=8,e.t0=e["catch"](0),console.warn(e.t0);case 11:case"end":return e.stop()}},r,null,[[0,8]])}));return function(){return e.apply(this,arguments)}}();t.$on("$destroy",function(){n.init.remove()});var g=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(){var e,o;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,r.data.get("/docs/:client/".concat(l),{v:"v3"});case 3:if(e=n.sent,o=e.data.data,!(o.length>0)){n.next=15;break}t.item=a.method.format(o)[0],t.item.orders_total=_.sum(t.item.orders.filter(function(t){return t.status}),"sum"),t.total.qty=_.sum(t.item.products,"qty"),t.total.discount=_.sum(t.item.products,"discount_sum"),t.total.sub=_.sum(t.item.products,"sub"),t.total.sum=_.sum(t.item.products,"sum"),i.item=t.item,n.next=16;break;case 15:throw"not found";case 16:d(),n.next=22;break;case 19:n.prev=19,n.t0=n["catch"](0),t.error=!0;case 22:return n.prev=22,t.loading=!1,s(t),n.finish(22);case 26:case"end":return n.stop()}},n,null,[[0,19,22,26]])}));return function(){return e.apply(this,arguments)}}(),v=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,g();case 2:case"end":return t.stop()}},e)}));return function(){return t.apply(this,arguments)}}();v()}]).controller("journalItemDropdownCtrl",["$scope","journalItemService","docService","$rootScope","$filter","api","CONFIG","$state",function(t,e,n,r,a,o,i,c){t.data=e,t.list=[];var s=i.docServer;t.onCreate=function(){c.go("authenticated.card.doc_print_templates")},t.$watch("data",function(e){if(!e.item)return!1;if(t.item=e.item,t.list=o.user.positions().settings.print_templates.filter(function(e){return e.document==="".concat(t.item.type).concat(t.item.sub_type?"_".concat(t.item.sub_type):"")&&e.active}).map(function(e){return _objectSpread({},e,{url:function(n){return"https://".concat(s,"/template/print/").concat(t.item._id,"/").concat(o.user.clientID(),"/").concat(e._id,".").concat(n)}})}),"sales"===e.item.type){var n="/print/bso/invoice/:id";t.bank_account_pay={label:"PAYMENT_INVOICE",url:function(e){return"https://".concat(s).concat(n.replace(":id",t.item.orders[0]._id),".").concat(e,"?company=").concat(o.user.clientID())}}}},!0),t.changePrices=function(){r.$broadcast("pushProductToPriceChange",e.item.products.map(function(t){return t._id}))},t.openCatalog=function(){var t=e.item,n=t.products.filter(function(t){return!t.product.id_parent}).map(function(t){return t._id}),o=t._getType(),i=o.title;i="".concat(a("translate")(i)," #").concat(t.number),r.$broadcast("CATALOG_FILTER_REPLACE",{ids:{title:i,value:n}})}}]).service("journalItemService",[function(){return{item:null}}]),angular.module("cloudshop.documents").service("holdDocService",["confirmModal","localStorageService","$state",function(t,e,n){var r=this,a="holddocuments",o=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function n(t){var r;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e.get(a);case 2:if(n.t0=n.sent,n.t0){n.next=5;break}n.t0=[];case 5:return r=n.t0,r.unshift(t),n.next=9,e.set(a,r);case 9:case"end":return n.stop()}},n)}));return function(e){return t.apply(this,arguments)}}();this.clearData=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function n(t){var r;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(!t){n.next=9;break}return n.next=3,e.get(a);case 3:if(n.t1=n.sent,n.t1){n.next=6;break}n.t1=[];case 6:n.t0=n.t1.filter(function(e){return e.uuid!==t.uuid}),n.next=10;break;case 9:n.t0=[];case 10:return r=n.t0,n.next=13,e.set(a,r);case 13:case"end":return n.stop()}},n)}));return function(e){return t.apply(this,arguments)}}(),this.getData=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function n(t){var r;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e.get(a);case 2:return r=n.sent,n.abrupt("return",(r||[]).filter(function(e){return t?t.uuid===e.uuid:!0}));case 4:case"end":return n.stop()}},n)}));return function(e){return t.apply(this,arguments)}}(),this.buildOrder=function(t){},this.save=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function r(e){var a;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return a="\n        При создании документа произошла ошибка<br />\n        Документ добавлен в непроведенные\n      ",r.prev=1,r.next=4,o(e);case 4:return r.next=6,t(a,!1,{successText:"GO_TO_THE_PAUSED_DOCUMENTS",cancelText:"CREATE_NEW_DOCUMENT",size:"small"});case 6:n.go("authenticated.card.holddocs"),r.next=16;break;case 9:r.prev=9,r.t0=r["catch"](1),r.t1=r.t0,r.next="cancel"===r.t1?14:16;break;case 14:return n.go(n.current,{},{reload:!0}),r.abrupt("break",16);case 16:return r.prev=16,r.finish(16);case 18:case"end":return r.stop()}},r,null,[[1,9,16,18]])}));return function(t){return e.apply(this,arguments)}}(),this.download=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r.getData(t);case 3:n=e.sent,a=new Blob([JSON.stringify(n)],{type:"application/json;charset=utf-8"}),saveAs(a,"Непроведенные-документы.json"),setTimeout(function(){},1e3),e.next=11;break;case 9:e.prev=9,e.t0=e["catch"](0);case 11:return e.prev=11,e.finish(11);case 13:case"end":return e.stop()}},e,null,[[0,9,11,13]])}));return function(e){return t.apply(this,arguments)}}(),this["delete"]=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(e){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,t("Вы действительно хотите удалить документ".concat(e?"":"journal.I","?"));case 3:return n.next=5,r.clearData(e);case 5:n.next=9;break;case 7:n.prev=7,n.t0=n["catch"](0);case 9:return n.prev=9,n.finish(9);case 11:case"end":return n.stop()}},n,null,[[0,7,9,11]])}));return function(t){return e.apply(this,arguments)}}()}]),angular.module("cloudshop.documents").config(["$stateProvider",function(t){t.state("authenticated.card.holddocs",{url:"/holddocs",templateUrl:"js/pages/journal/holddocs/index.html",controller:"holdDocCtrl",data:{pageTitle:"PAUSED_DOCUMENTS",sidebar:!0}})}]),angular.module("cloudshop.documents").controller("holdDocCtrl",["$scope","holdDocService","safeApply","docService","apiRouteService","modalService",function(t,e,n,r,a,o){function i(){o.method.add([{title:"SEND_ALL_DOCUMENTS",className:"green",active:!0,action:c,visible:!0},{title:"CLEAR",className:"red","float":"right",active:!0,action:t["delete"],visible:!0}])}t.data=[],t.loading=!1,t.loadings=[],t.errors=[],t.download=e.download,t.getType=function(){return r.types[this.item.type]},t.send=function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function o(r){return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(t.loadings.push(r.uuid),t.errors=t.errors.filter(function(t){return r.uuid!==t}),n(t),o.prev=3,!r._id){o.next=9;break}return o.next=7,a.document().edit(r);case 7:o.next=11;break;case 9:return o.next=11,a.document().add(r);case 11:return o.next=13,e.clearData(r);case 13:return o.next=15,s();case 15:o.next=20;break;case 17:o.prev=17,o.t0=o["catch"](3),t.errors.push(r.uuid);case 20:return o.prev=20,t.loadings=t.loadings.filter(function(t){return r.uuid!==t}),n(t),o.finish(20);case 24:case"end":return o.stop()}},o,null,[[3,17,20,24]])}));return function(t){return r.apply(this,arguments)}}(),t["delete"]=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function n(t){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e["delete"](t);case 2:return n.next=4,s();case 4:case"end":return n.stop()}},n)}));return function(e){return t.apply(this,arguments)}}();var c=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function r(){var e,a,o;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:t.errors=[],n(t),r.prev=2,t.loading=!0,e=_createForOfIteratorHelper(t.data),r.prev=5,e.s();case 7:if((a=e.n()).done){r.next=13;break}return o=a.value,r.next=11,t.send(o);case 11:r.next=7;break;case 13:r.next=18;break;case 15:r.prev=15,r.t0=r["catch"](5),e.e(r.t0);case 18:return r.prev=18,e.f(),r.finish(18);case 21:r.next=25;break;case 23:r.prev=23,r.t1=r["catch"](2);case 25:return r.prev=25,t.loading=!1,setTimeout(function(){t.errors=[],n(t)},3e3),n(t),r.finish(25);case 30:case"end":return r.stop()}},r,null,[[2,23,25,30],[5,15,18,21]])}));return function(){return e.apply(this,arguments)}}();t.$watch("loading",function(t){t?o.method.disableAll():o.method.enableAll()}),t.$watchCollection("data",function(e){e&&0===e.length?o.method.disableAll():t.loading===!1&&o.method.enableAll()});var s=function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.getData();case 2:t.data=r.sent,n(t);case 4:case"end":return r.stop()}},a)}));return function(){return r.apply(this,arguments)}}();i(),s()}]),angular.module("cloudshop").service("chartService",["db","$timeout","$rootScope",function(t,e,n){function r(t){return Object.assign({start:+i[s].range()[0].format("X"),end:+i[s].range()[1].format("X"),v:"v2"},t)}function a(t){u=t||u;var e=d.result();n.$broadcast("chartLoad",{show:!0,type:u,period:s,title:c[u].title,group:c[u].group,data:e})}function o(a){return n.$broadcast("chartLoad",{show:!1}),new Promise(function(o,l){if(d.inited)var p=e(function(){d.data.length&&(e.cancel(p),o(d.result()))},50);else{var m={},f=[],h="/report/:client/sales/date/0/1000/";s=a.type,m.group=i[a.type].group,d.inited=!0,a.store_id.length&&a.store_id[0]?a.store_id.forEach(function(e){m.store_id=e,f.push(t.method.query.post(h,r(m)).then(function(t){return t.store_id=e,t}))}):f.push(t.method.query.post(h,r(m))),Promise.all([t.method.get("stores")].concat(f)).then(function(t){var r={datasets:[],labels:[]};d.data=[],d.inited=!1;for(var l=1;l<t.length;l++)d.data.push(t[l]);e(function(){n.$broadcast("chartLoad",{show:!0,type:u,period:s,group:i[a.type].group,title:c[u].title,data:d.result()}),o(r)},50)})["catch"](function(t){l(t)})}})}var i={today:{title:"TODAY",group:"day",format:"DD MMM",range:function(){return[moment().add(-1,"days").startOf("day"),moment().endOf("day")]},range2:function(){return[moment().startOf("day"),moment().endOf("day")]}},week:{title:"WEEK",group:"day",format:"dddd",range:function(){return[moment().startOf("week").startOf("day"),moment().endOf("week").endOf("day")]}},month:{title:"MONTH",group:"day",format:"D",range:function(){return[moment().startOf("month").startOf("day"),moment().endOf("month").endOf("day")]}},quarter:{title:"QUARTER",group:"week",format:"DD MMM",range:function(){return[moment().startOf("quarter").startOf("day"),moment().endOf("quarter").endOf("day")]}},year:{title:"YEAR",group:"month",format:"MMMM",range:function(){return[moment().startOf("year").startOf("day"),moment().endOf("year").endOf("day")]}}},c={revenue:{title:"REVENUE",value:0,visible:!0},cost:{title:"COST_OF_SALES",value:0,visible:!0},profit:{title:"GROSS_PROFIT",value:0,visible:!0},avg:{title:"AVERAGE_TICKET",value:0,visible:!0},sales:{title:"COUNT_OF_SALES",value:0,visible:!1}},s="month",u="revenue",d={data:[],inited:!1,result:function(){c.revenue.value=0,c.cost.value=0,c.profit.value=0,c.avg.value=0,c.sales.value=0;var e=this,n={labels:[],datasets:[]},r=_.clone(this.data,!0);return r.forEach(function(r){e.data=r.data,e.format(),n.labels=e.labels();var a=e.datasets()[0];a.label=r.store_id?_.where(t.storage.stores.data,{_id:r.store_id})[0].name:null,n.datasets.push(a),"today"===s&&(e.data=e.data.filter(function(t){return"".concat(t._id.day,"-").concat(t._id.month,"-").concat(t._id.year)===moment().format("D-M-YYYY")})),c.revenue.value+=_.sum(e.data,"revenue"),c.cost.value+=_.sum(e.data,"sales.cost")-_.sum(e.data,"return_sales.cost"),c.profit.value+=_.sum(e.data,"profit"),c.sales.value+=_.sum(e.data,"sales.count")}),c.avg.value=c.revenue.value/c.sales.value,e.data=r,n},range:function(){var t=i[s],e="week"===t.group?7:1;if("month"===t.group)return Array.apply(0,Array(12)).map(function(t,e){return moment().month(e).startOf("month").format("X")});var n=_.range(t.range()[0].format("X"),t.range()[1].format("X"),24*e*60*60).map(function(t){return+moment(t,"X").startOf("day").format("X")}).map(function(e){return"week"===t.group&&(e=moment(e,"X").startOf("week").startOf("day").format("X")),e});return n},labels:function(){var t=[];return _.forEach(this.range(),function(e){t.push(moment(e,"X").format(i[s].format))}),t},datasets:function(){var t=[];return _.forEach(this.formated,function(e){var n={label:e.name,data:[]};d.range().forEach(function(t){e[t]?n.data.push(e[t]):n.data.push(0)}),t.push(n)}),t},format:function(){var t={data:{}};return _.forEach(this.data,function(e){var n=moment("".concat(e._id.year,"/").concat(e._id.month,"/").concat(e._id.day?e._id.day:"01"),"YYYY/MM/DD").format("X"),r=e[u];void 0!==e._id.week&&(n=moment().year(e._id.year).week(e._id.week).startOf("week").format("X")),"cost"===u&&(r=e.sales.cost-e.return_sales.cost),"avg"===u&&(r=e.revenue/e.sales.count,isFinite(r)===!1&&(r=0)),t.data[n]=+r.toFixed(2)}),this.formated=t,this.formated}};return{type:s,types:i,field:u,fields:c,init:o,rebuild:a}}]),angular.module("cloudshop").directive("dashboardChart",["$rootScope","$filter",function(t,e){return{restrict:"E",replace:!0,scope:{data:"=data",id:"@"},template:'\n				<div id="dashboard-chart">\n					<div class="loading-text"><p>{{\'LOADING\' | translate}}...</p></div>\n					<div class="segment">\n						<div class="pie">\n							<div class="chart-placeholder"></div>\n							<svg width="60" height="60"><g></g></svg>\n						</div>\n						<div class="text"></div>\n					</div>\n				</div>\n			',link:function(n,r){var a,o,i,c,s,u,d,l,p=$(r),m=0,f=!1,h=60,g=30,v=488-g,y={duration:600},b=d3.area().x(function(t){return d(t.x)}).y0(v).y1(function(t){return l(t.y)}).curve(d3.curveCatmullRom.alpha(.5)),E=d3.scaleOrdinal(["#39A0ED","#4C6085","#FFEE78","#FE8EE2","#59D4F6"]),S=d3.line().x(function(t){return d(t.x)}).y(function(t){return l(t.y)}).curve(d3.curveCatmullRom.alpha(.5)),T=function(t){t="boolean"==typeof t?t:!1,m++;var e=u,n=$(r).width()-h,c=!1,s=d3.min(o,function(t){return t.y}),p=d3.max(o,function(t){return t.y}),f="month"===i?1.5:1.2;d=O(n),l=d3.scaleLinear().domain([s-.1*p,p*f]).range([v,0]),a=I(n),U(t),P(t),N(n,!0),j(e),L(n,c),M()},w=function(t){var e=[],n=t.datasets,r=t.labels;return n.forEach(function(t){t.data.forEach(function(n,a){var o={label:t.label,value:n};e[a]?(e[a].y+=n,e[a].stores.push(o)):e.push({x:r[a],y:n,stores:[o]})})}),"today"===i&&e.push(_objectSpread({},e[1],{x:"."})),"avg"===s&&f&&e.forEach(function(t){t.y=0===t.stores.length?0:t.y/t.stores.length}),e},k=function(){var t=[],e=_.clone(o,!0);return"today"===i&&(e=e.filter(function(t,e){return 1===e})),e.forEach(function(e){e.stores.forEach(function(e){var n=t.findIndex(function(t){return t.label===e.label});n>=0?t[n].value+=e.value:t.push(_.clone(e,!0))})}),"avg"===s&&t.forEach(function(t){t.value=t.value/e.length}),t},x=function(t){var e=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,arguments.length>2&&void 0!==arguments[2]?arguments[2]:[0,0]);if(f===!1)return void A();void 0===t&&(t={stores:k()});var n=t.stores.sort(function(t,e){return t.value>e.value?-1:t.value===e.value?0:1}),a=_.sum(n,"value"),o=d3.select(r[0]).select(".segment").classed("left",!1),i=o.select(".text");o.classed("empty",0===a),a&&R(n),i.selectAll("*").remove(),n.forEach(function(t){var e=i.append("div");e.append("span").style("background-color",E(t.label)),e.append("span").text(t.label),e.append("span").text(numeral(t.value).format("0,0"))}),C();var c=o.node().getBoundingClientRect(),s=$(r).width()-h;o.classed("left",c.height+15>=e[1]&&s-c.width-70<=e[0])},R=function(t){if(f!==!1){var e=d3.select(r[0]).select(".segment"),n=e.select("svg"),a=60,o=60,i=a/2,c=d3.pie().sort(null).value(function(t){return Math.abs(t.value)}),s=d3.arc().outerRadius(i).innerRadius(0);n.data([t]);var u=n.select("g").attr("transform","translate("+a/2+","+o/2+")");u.selectAll("*").remove();var d=u.selectAll(".arc").data(c).enter().append("g").attr("class","arc");d.append("path").attr("d",s).attr("fill",function(t){return E(t.data.label)})}},C=function(){f!==!1&&$(r).children(".segment").addClass("active")},A=function(){$(r).children(".segment").removeClass("active")},O=function(t){var e=o.map(function(t){return t.x}),n=t-30;return d3.scaleOrdinal().domain(e).range(_.range(e.length).map(function(t,r){return n/(e.length-1)*r+15}))},I=function(t){return d3.select(r[0]).selectAll("svg.mainSvg").empty()?d3.select(p[0]).append("svg").attr("class","mainSvg").attr("width",t+h).attr("height",v+g).append("g").attr("transform","translate(".concat(h,", 5)")):(d3.select(p[0]).selectAll("svg.mainSvg").attr("width",t+h),d3.select($("svg.mainSvg > g",r)[0]))},P=function(t){var e=a.select(".line");return e.empty()?a.append("path").datum(o.map(function(t){return _objectSpread({},t,{y:0})})).attr("class","line").attr("d",S).datum(o).transition().duration(y.duration).attr("d",S):t?e.datum(o).transition().duration(y.duration).attr("d",S):e.datum(o.map(function(t){return _objectSpread({},t,{y:0})})).attr("d",S).datum(o).transition().duration(y.duration).attr("d",S)},D=function(t){t.selectAll("text").attr("style",function(t){return"month"!==i?"":0===moment("".concat(t).concat(moment().format("/MM/YYYY")),"DD/MM/YYYY").day()?"font-weight: bold; font-size: 12px; fill: #0288d1;":""})},N=function(t,e){var n=a.select(".x.axis"),r=a.select(".y.axis"),o=d3.axisBottom().scale(d).tickSize(-v,0,0),i=d3.axisLeft().scale(l).tickSize(-t,0,0);return n.empty()&&r.empty()?(n=a.append("g").attr("class","x axis").attr("transform","translate(0,"+v+")").call(o),r=a.append("g").attr("class","y axis").call(i),D(n),{x:n,y:r}):(n.call(o),e?r.transition().duration(y.duration).call(i):r.call(i),D(n),{x:n,y:r})},U=function(t){var e=a.select(".area");return e.empty()?a.append("path").datum(o.map(function(t){return _objectSpread({},t,{y:0})})).attr("class","area").attr("d",b).datum(o).transition().duration(y.duration).attr("d",b):(e.datum(o),t?e.datum(o).transition().duration(y.duration).attr("d",b):e.datum(o.map(function(t){return _objectSpread({},t,{y:0})})).attr("d",b).datum(o).transition().duration(y.duration).attr("d",b))},j=function(t){t=e("translate")(t);var n=$(".legend",r);return 0===n.length?d3.select(p[0]).append("div").attr("class","legend").append("p").text(t):$("p",n).text(t)},L=function(t,e){function n(){var n=this;e===!1&&(r.style("display","block"),e=!0);var a=d.range();"today"===i&&a.splice(-1,1);var s=d.domain(),u=a.map(function(t,e){return{domain:s[e],i:e,num:t,diff:Math.abs(t-d3.mouse(n)[0])}}).sort(function(t,e){return t.diff>e.diff?1:-1})[0],p=o.find(function(t){return t.x===u.domain}),m=(u.i+1)/a.length;if(x(p,m,[u.num,l(p.y)]),u.domain!==c.domain){c=u;var f=r.select("text");if(r.attr("transform","translate("+u.num+", "+l(p.y)+")"),f.text(numeral(p.y).format("0,0")),r.select(".x-hover-line").attr("y2",v-l(p.y)),r.select(".y-hover-line").attr("x2",t+t),r.select("circle").attr("r",2).transition().duration(300).attr("r",7.5),m>.9){var h=f.node().getBBox(),g=h.width;f.attr("x",-g-15)}else f.attr("x",15)}}var r=a.select(".focus");r.empty()===!1&&(r.remove(),a.selectAll(".overlay").remove()),r=a.append("g").attr("class","focus").style("display","none"),r.append("line").attr("class","x-hover-line hover-line").attr("y1",0).attr("y2",v),r.append("line").attr("class","y-hover-line hover-line").attr("x1",t).attr("x2",t),r.append("circle").attr("r",7.5),r.append("text").attr("x",15).attr("dy",".31em"),a.append("rect").attr("transform","translate(0, 0)").attr("class","overlay").attr("width",t).attr("height",v).on("mouseout",function(){r.style("display","none"),e=!1,x()}).on("mousemove",n);var c={}},M=function(){var t=a.select(".dots");t.empty()===!1&&t.remove();var e=_.clone(o,!0);"today"===i&&e.splice(-1,1),a.append("g").attr("class","dots").selectAll(".dot").data(e).enter().append("circle").attr("r",0).attr("cx",function(t){return d(t.x)}).attr("cy",function(t){return l(t.y)}).transition().delay(y.duration).duration(400).attr("r",3)},G=function(){var t=d3.select(r[0]).select("svg.mainSvg");if(t.empty()===!1){var e=$(r).width()-h;d=O(e),t.attr("width",e+h),t.select(".area").attr("d",b),t.select(".line").attr("d",S),t.select(".overlay").attr("width",e),t.selectAll(".dots circle").data(o).attr("cx",function(t){return d(t.x)}).attr("cy",function(t){return l(t.y)}),N(e)}},F=function(){$(r).addClass("hide")},Y=function(){$(r).removeClass("hide")},q=function(){$(r).empty()};n.$on("$destroy",function(){q(),H()});var H=t.$watch("body_smallMenu",function(t,e){e!==t&&setTimeout(G)});n.$on("chartLoad",function(t,e){var n=e.data,r=e.period,a=e.type,d=e.title,l=e.show,p=e.group;if(l){var m=i===r;i=r,c=p,s=a,f=n.datasets.length>1,o=w(n),u=d,T(m),Y(),x(),window.addEventListener("resize",G)}else i!==r&&(F(),window.removeEventListener("resize",G))}),F()}}}]),angular.module("cloudshop.company",[]).config(["$stateProvider",function(t){t.state("authenticated.card.company",{url:"/company",templateUrl:"js/pages/card/company/_view.html",controller:"companyCtrl",data:{pageTitle:"COMPANY",cardToolbar:{active:!1}},"abstract":!0}).state("authenticated.card.company.settings",{url:"/company/settings",templateUrl:"js/pages/card/company/_settings.html",data:{pageTitle:"SETTINGS",cardToolbar:{active:!1}},"abstract":!0}).state("authenticated.card.company.settings.main",{url:"/main/",templateUrl:"js/pages/card/company/_main.html",data:{pageTitle:"COMPANY_SETTINGS"}}).state("authenticated.card.company.settings.requisites",{url:"/requisites/",templateUrl:"js/pages/card/company/_requisites.html",data:{pageTitle:"REQUISITES"}}).state("authenticated.card.company.settings.newsletter",{url:"/daily-report/",templateUrl:"js/pages/card/company/_daily-report.html",data:{pageTitle:"EMAILREPORT"}}).state("authenticated.card.company.settings.data",{url:"/data/",templateUrl:"js/pages/card/company/_data.html",data:{pageTitle:"DATA"}}).state("authenticated.card.company_requisites_sidebar",{url:"/requisites-s/",templateUrl:"js/pages/card/company/_requisites-sidebar.html",controller:"companyCtrl",data:{pageTitle:"COMPANY_REQUISITES",sidebar:!0}}).state("authenticated.card.company.discounts",{url:"/discounts/",templateUrl:"js/pages/card/company/_discounts.html",data:{pageTitle:"DISCOUNTS"}}).state("authenticated.card.company.staff",{url:"/staff/",templateUrl:"js/pages/card/profile/_list.html",controller:"profileListCtrl",data:{pageTitle:"EMPLOYEES",permission:"staff",method:"GET"}}).state("authenticated.card.company.stores",{url:"/stores/",templateUrl:"js/pages/card/store/_list.html",controller:"storeCtrl",data:{pageTitle:"STORES",permission:"stores"}}).state("authenticated.card.company.accounts",{url:"/accounts/",templateUrl:"js/pages/card/accounts/_list.html",controller:"accountCtrl",data:{pageTitle:"ACCOUNTS",permission:"accounts"}})}]),angular.module("cloudshop.company").controller("ecommerceSettingsCtrl",["$scope","db","companyService","api","cardService","$state",function(t,e,n,r,a,o){function i(){}t.page=o.current.data,t.$watch("form.$valid",function(t){a.init.toggle(0,!!t)}),i()}]),angular.module("cloudshop.catalog").service("catalogFilterService",["webworker","db",function(t,e){var n=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function r(n,a){var o;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(0!==Object.keys(a).length){r.next=2;break}return r.abrupt("return",n);case 2:return console.time("filter-time"),r.next=5,t("catalog",{cmd:"filter",data:n,params:a});case 5:return o=r.sent,console.timeEnd("filter-time"),r.abrupt("return",o.map(e.storage.catalog.proto));case 8:case"end":return r.stop()}},r)}));return function(t,e){return n.apply(this,arguments)}}();return{init:n}}]),angular.module("cloudshop.support",[]).config(["$stateProvider",function(t){t.state("authenticated.card.support",{url:"/support/:post",templateUrl:"js/pages/card/support/_view.html",controller:"supportCtrl",data:{pageTitle:"HELP",sidebar:!0,sidebarSize:"l"}})}]),angular.module("cloudshop.support").service("supportService",["$sce",function(t){var e="https://cloudshop.ru/portal/",n=[{id:1,url:"articles/как-быстро-провести-закупку/"},{id:2,url:"programma-online-kassa-ofd-54fz/"},{id:3,url:"articles/кассовое-оборудование-cloudshop/"},{id:4,url:"articles/подключить-домен-интернет-магазину/"},{id:5,url:"articles/как-исправить-себестоимость/"},{id:6,url:"articles/connect-cloudshop-woocommerce/"},{id:7,url:"articles/cloudshop-evotor-товроучет/"}].map(function(n){return n.url=t.trustAsResourceUrl(e+n.url+"?included=1"),n});return{posts:n}}]),angular.module("cloudshop.support").controller("supportCtrl",["$scope","supportService","$state",function(t,e,n){n.params.post&&(t.post=e.posts.filter(function(t){return t.id==n.params.post})[0])}]),angular.module("cloudshop.catalog").directive("catalogSelectOne",["catalogService","db",function(t,e){return{restrict:"A",link:function(n,r){var a=_toConsumableArray(e.storage.catalog.formatted),o=t.selected.find(function(t){return t._id==n.value._id});$(r).bind("change",function(){var e=[],r=$(this).is(":checked"),o=a.find(function(t){return t._id==n.value._id});e=r?_.uniq([].concat(_toConsumableArray(t.selected),[o])):t.selected.filter(function(t){return t._id!=n.value._id}),t.selected=e,n.$apply()}),$(r).prop("checked",!!o)}}}]).directive("catalogSelectAll",["catalogService","paginator",function(t,e){return{restrict:"A",link:function(n,r){$(r).bind("change",function(){var r=$("body td input[catalog-select-one]"),a=$(this).is(":checked");a?t.selected=_.clone(e.data.filtered,!0):t.selected=[],r.prop("checked",a),n.$apply()})}}}]),angular.module("cloudshop.catalog").directive("catalogGroupsBreadcrumbs",["filterCatalogService","db","$rootScope","safeApply",function(t,e,n,r){return{restrict:"E",replace:!0,scope:{selected:"=?",groups:"=?",select:"=?"},template:'\n        <ul ng-show="data.length" class="catalog-groups-breadcrumbs">\n          <li ng-click="selectGroup(\'0\')"><i class="icon" ng-class="{\'spinner loading\': loading, home: !loading}"></i></li>\n          <li ng-repeat="item in data" ng-click="selectGroup(item._id)"><span>{{item.name}}</span></li>\n        </ul>\n      ',
link:function(a){a.data=[],a.loading=!1,a.Groups=a.groups||[],a.selected=a.selected||t.f.group,a.selectGroup=a.select?function(t){return a.select(t)}:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(e){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return a.loading=!0,t.f.group.value=e,n.next=4,t.init();case 4:a.loading=!1,a.data=o(e),r(a);case 7:case"end":return n.stop()}},n)}));return function(t){return e.apply(this,arguments)}}(),e.method.init("catalog").then(function(){a.Groups=a.groups||e.storage.catalog.getGroup(),a.selected&&0===a.data.length&&(a.data=o(a.selected.value)),window.setTimeout(function(){return a.$apply()},10)}),n.$on("WS_UPDATE_CATALOG",function(){a.Groups=a.groups||e.storage.catalog.getGroup(),a.$apply()});var o=function(t){return i(t).reverse()},i=function c(t){if("0"===t)return[];var e=a.Groups.find(function(e){return e._id===t}),n=[];return e&&(n=n.concat([e].concat(_toConsumableArray(c(e.id_group))))),n};a.$watch("selected",function(t,e){var n=t.value;(n||e.value!==n&&!a.loading)&&window.setTimeout(function(){a.data=o(n),a.$apply()},10)},!0)}}}]).directive("catalogGroupItem",["filterCatalogService",function(t){return{restrict:"C",link:function(e,n){$(n).click(_asyncToGenerator(regeneratorRuntime.mark(function r(){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return t.f.group.value=e.value._id,n.next=3,t.init();case 3:e.$apply();case 4:case"end":return n.stop()}},r)}))),$("td.table-checkbox",n).click(function(t){return t.stopPropagation()}),$("a.group-settings",n).click(function(t){return t.stopPropagation()})}}}]),angular.module("cloudshop.catalog").directive("catalogListFilter",["$timeout",function(t){return{restrict:"C",link:function(e,n){t(function(){var t=$(n).children(".catalog-filter");$("input",n).on("focus",function(){$(n).addClass("active")}),$(".filter.icon",n).on("click",function(){$(n).addClass("active"),setTimeout(function(){t.show()},0)}),$(n).on("click",function(t){t.stopPropagation()}),$(document).on("click",function(){$(n).removeClass("active"),t.hide()});var r=function(){if(t[0]){var e=t[0].dataset.params;return Number(e)}return 0};e.$watch(r,function(t,e){var r=$("div.input",n).find("i");t?r.addClass("blue inverted"):e&&r.removeClass("blue inverted")})},600)}}}]),angular.module("cloudshop.catalog").directive("catalogColumns",["catalogColumnService","$rootScope",function(t,e){return{restrict:"E",replace:!0,template:'\n        <div><dropdown action="nothing" class="right pointing icon smooth basic large-icon button catalog-columns-dropdown">\n  				<i popup popup-content="{{ \'TABLE_SETTINGS\' | translate }}" class="setting icon"></i>\n  				<div class="menu" style="right: 100% !important;">\n  					<div class="header">\n  						<i class="tags icon"></i>\n  						<span translate>TABLE_SETTINGS</span>\n  					</div>\n  					<div class="item" ng-repeat="(i, item) in fields">\n  						<div class="ui checkbox" ng-model="item.active">\n  							<input type="checkbox"/>\n  							<label ng-bind="item.title | translate"></label>\n  						</div>\n  					</div>\n  					<div class="divider"></div>\n  					<div class="item" ng-repeat="(i, item) in stores">\n  						<div class="ui checkbox" ng-model="item.active">\n  							<input type="checkbox"/>\n  							<label ng-bind="item.title"></label>\n  						</div>\n  					</div>\n  				</div>\n  			</dropdown></div>',link:function(n,r){var a={};n.fields=t.data.fields,n.stores=t.data.stores;var o=function(){var e="";if(angular.toJson(t.data)==a)return!1;a=angular.toJson(t.data),_.forEach(t.data,function(t,n){_.forEach(t,function(t,n){e+="pic"===n?"img.table-pic{display: ".concat(t.active?"inherit":"none",";}\n"):'td[data-name="'.concat(n,'"],th[data-name="').concat(n,'"]{display: ').concat(t.active?"table-cell":"none",";}\n")})}),e=document.createTextNode(e);var n=document.createElement("style"),r=document.head||document.getElementsByTagName("head")[0];n.type="text/css",n.id="catalogColumn",n.styleSheet?n.styleSheet.cssText=e:n.appendChild(e),document.getElementById("catalogColumn")?r.replaceChild(n,document.getElementById("catalogColumn")):r.appendChild(n)};n.$watch("fields",function(){o(),t.save()},!0),n.$watch("stores",function(){o(),t.save()},!0),$(r).on("click",".checkbox",function(){e.$broadcast("catalog.toggleColumns")})}}}]),angular.module("cloudshop.supplier").controller("clientShowCtrl",["$scope","db","modalService","clientService","$state","api","safeApply","apiRouteService",function(t,e,n,r,a,o,i,c){function s(){return u.apply(this,arguments)}function u(){return u=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,c.clients()["delete"](t.data);case 3:n.method.close(),e.next=8;break;case 6:e.prev=6,e.t0=e["catch"](0);case 8:case"end":return e.stop()}},e,null,[[0,6]])})),u.apply(this,arguments)}function d(){n.method.add([{title:"EDIT",className:"green",active:!0,action:{url:"authenticated.card.client_edit",param:{clients_id:l}},visible:!0},{title:"DELETE",className:"red","float":"right",active:!0,action:s,visible:!!l,perm:["clients","DELETE"]}])}var l=a.params.clients_id;t.id=l,t.historyTab=1,t.data=r.method.data,t.method=r.method,t.modalService=n.init.data,t.history={query:{contractor:l},config:{client:"clients"}},t.statsQuery={contragent_id:l},t.$on("$destroy",function(){n.init.remove(),n.init.data.loading=!1,r.method.clear()});var p=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function r(){var n,a,c;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(d(),!l){r.next=21;break}if(n=e.storage.clients.data.find(function(t){return t._id===l}),r.prev=3,n){r.next=11;break}return t.loading=!0,r.next=8,o.data.get("/data/:client/clients/".concat(l));case 8:a=r.sent,c=_slicedToArray(a.data.data,1),n=c[0];case 11:t.data=e.storage.clients.proto(n),r.next=17;break;case 14:r.prev=14,r.t0=r["catch"](3),t.error=!0;case 17:return r.prev=17,t.loading=!1,i(t),r.finish(17);case 21:case"end":return r.stop()}},r,null,[[3,14,17,21]])}));return function(){return n.apply(this,arguments)}}();p()}]),angular.module("cloudshop.clients",[]).config(["$stateProvider",function(t){t.state("authenticated.card.clients",{url:"/clients",templateUrl:"js/pages/clients/_list.html",controller:"clientsCtrl",data:{pageTitle:"CLIENTS",permission:"clients"}}).state("authenticated.card.clients_import",{url:"/import",templateUrl:"js/pages/clients/import.html",data:{pageTitle:"IMPORT_CLIENTS",permission:"clients",method:"POST"}}).state("authenticated.card.client_add",{url:"/clients/add",templateUrl:"js/pages/clients/card/_form.html",controller:"clientCtrl",data:{pageTitle:"CREATED",permission:"clients",method:"POST"}}).state("authenticated.card.client_show",{url:"/clients/show/:clients_id",templateUrl:"js/pages/clients/card/_view.html",controller:"clientShowCtrl",data:{pageTitle:"CUSTOMER_PROFILE",permission:"clients",sidebar:!0}}).state("authenticated.card.client_edit",{url:"/clients/edit/:clients_id",templateUrl:"js/pages/clients/card/_form.html",controller:"clientCtrl",data:{pageTitle:"CUSTOMER_EDIT",permission:"clients",method:"PUT",sidebar:!0}})}]),angular.module("cloudshop.clients").service("clientService",["apiRouteService",function(t){var e={template:function(){return{name:null,type:"person",phones:"",emails:"",bday:null,discount:0,sex:"male",enable_savings:!1,"default":!1,address:{actual:null,legal:null},details:[{key:null,value:null}],bank_details:[{key:null,value:null}]}},data:{},format:function(t){var n=t||_.clone(e.data,!0);return n.phones=n.phones.split(",").map(function(t){return(t+"").trim()}),n.emails=n.emails.split(",").map(function(t){return(t+"").trim()}),n.bday=+n.bday||null,n},un_format:function(t){var n=t||_.clone(e.data,!0);return n.phones=n.phones?n.phones.join(", "):"",n.emails=n.emails?n.emails.join(", "):"",n.discount=+n.discount,n},save:function(){return e.data._id?e.edit():e.add()},add:function(){return t.clients().add(e.format()).then(function(t){return e.clear(),t})},edit:function(){return t.clients().edit(e.format()).then(function(t){return e.clear(),t})},remove:function(){return t.clients()["delete"](e.data)},clear:function(){e.data=e.template()}};return e.clear(),{method:e}}]),angular.module("cloudshop.clients").controller("clientCtrl",["$scope","db","modalService","clientService","$state","$rootScope","apiRouteService",function(t,e,n,r,a,o,i){function c(){return s.apply(this,arguments)}function s(){return s=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.clients()["delete"](t.data);case 2:n.method.close();case 3:case"end":return e.stop()}},e)})),s.apply(this,arguments)}function u(){var t=r.method.save();o.$broadcast("notify.loading2",{title:"SAVE",promise:t}),n.method.close()}function d(){n.method.add([{title:"SAVE",className:"green",active:!1,action:u,visible:!0,perm:["clients","POST"]},{title:"DELETE",className:"red","float":"right",active:!0,action:c,visible:!!p,perm:["clients","DELETE"]}])}function l(){d()}var p=a.params.clients_id;if(t.data=r.method.data,t.loading=!1,t.page=a.current.data,t.modalService=n.init.data,p){var m,f=_.where(e.storage.clients.data,{_id:p});m=f[0]?new Promise(function(t){t({data:_.clone(f,!0)})}):e.method.query.get("/data/:client/clients/"+p,{v:"v3"}),t.loading=!0,Promise.all([m]).then(function(e){var n=r.method.un_format(e[0].data[0]);t.data=_.merge(t.data,n),t.loading=!1,l(),t.$apply()})}t.$watch("data",function(t){t&&t.name?n.init.enable([0,1]):n.init.disable([0,1])},!0),t.$on("$destroy",function(){n.init.remove(),r.method.clear()}),p||l()}]),angular.module("cloudshop.profile",[]).config(["$stateProvider",function(t){t.state("authenticated.card.profile",{url:"/profile/:staff_id",templateUrl:"js/pages/card/profile/_view.html",controller:"profileCtrl",data:{pageTitle:"PROFILE"}}).state("authenticated.card.profile_edit",{url:"/profile/edit/:staff_id",templateUrl:"js/pages/card/profile/_settings.html",controller:"profileSettingsEditCtrl",data:{pageTitle:"PROFILE_EDIT",sidebar:!0}}).state("authenticated.card.staff_add",{url:"/staff/add/",templateUrl:"js/pages/card/profile/_form.html",controller:"profileEditCtrl",data:{pageTitle:"CREATE_NEW_EMPLOYEE",permission:"staff",method:"POST",sidebar:!0}}).state("authenticated.card.staff_edit",{url:"/staff/edit/:staff_id",templateUrl:"js/pages/card/profile/_form.html",controller:"profileEditCtrl",data:{pageTitle:"EMPLOYEE_EDIT",permission:"staff",method:"PUT",sidebar:!0}})}]),angular.module("cloudshop.profile").controller("profileSettingsEditCtrl",["$scope","$state","modalService","companyService","api","imageUpload",function(t,e,n,r,a,o){function i(){}t.data=_.clone(a.user.data,!0),t.password={},t.loading=!1,t.errorText="",t.image=[t.data.pic].filter(function(t){return Boolean(t)}),t.page=e.current.data,t.$watch("form.$valid",function(t){n.method.toggle(0,t)}),t.$on("$destroy",function(){n.init.remove()});var c=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function a(){var e,i,c,s;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(t.loading=!0,n.method.disable(0),a.prev=2,!(null===(e=t.image)||void 0===e?void 0:e.length)){a.next=7;break}return a.next=6,o.save(t.image[0]);case 6:t.data.pic=a.sent;case 7:return t.data.phone=String(t.data.phone),a.next=10,r.profile.save(t.data);case 10:if(i=a.sent,!i.error){a.next=13;break}throw i;case 13:if(!t.password.newPassword||!t.password.oldPassword){a.next=24;break}return c=_objectSpread({},t.password,{name:t.data.name}),a.next=17,r.profile.change_password(c);case 17:if(s=a.sent,!s||!s.error){a.next=24;break}throw t.password.newPassword="",t.password.oldPassword="",s;case 24:t.loading=!1,n.method.close(),a.next=33;break;case 28:a.prev=28,a.t0=a["catch"](2),t.loading=!1,n.method.enable(0),t.errorText=a.t0.error;case 33:t.$apply();case 34:case"end":return a.stop()}},a,null,[[2,28]])}));return function(){return e.apply(this,arguments)}}();n.method.add([{title:"SAVE",className:"green",active:!0,action:c,visible:!0}]),i()}]),angular.module("cloudshop.profile").service("profile",["api",function(t){var e=function(t){if(Array.isArray(t)&&(t={permission:t[0],method:t[1]}),!t.permission)return!0;t.method||(t.method="GET");var e={POST:"create",GET:"get",PUT:"edit",DELETE:"delete"},r=e[t.method.toUpperCase()];r||(r=t.method);var o=n.permissions()[t.permission];return o?a(r,o):!1},n={data:function(){var e=t.user.data.positions[this.user_id()];return e.permissions?e:e.data},user_id:function(){return _.last(_.keys(t.user.data.positions))},extend_permission:function(){return{reports:this.data().permissions["reports-products-groups"],dashboard:this.data().permissions["reports-products-groups"]}},permissions:function(){return _objectSpread({},this.data().permissions,{},n.extend_permission())}},r=function(){return n.data().type},a=function(t,e){try{return t.split(".").reduce(function(t,e){return t[e]},e)}catch(n){console.log(t,e)}},o={cashier:{title:"CASHIER",color:""},manager:{title:"MANAGER",color:""},owner:{title:"OWNER",color:""},storeman:{title:"STOREMAN",color:""}};return{permission:e,types:o,getType:r}}]),angular.module("cloudshop.profile").controller("profileListCtrl",["$scope","modalService","$state","companyService","api","db",function(t,e,n,r,a,o){function i(t){return c.apply(this,arguments)}function c(){return c=_asyncToGenerator(regeneratorRuntime.mark(function e(a){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a.loading=!0,t.loading=!0,e.prev=2,e.next=5,r.staff.remove(_objectSpread({},a,{stopped:+moment().format("X")}));case 5:n.go("authenticated.card.company.staff"),e.next=10;break;case 8:e.prev=8,e.t0=e["catch"](2);case 10:return e.prev=10,a.loading=!1,t.$apply(),e.finish(10);case 14:case"end":return e.stop()}},e,null,[[2,8,10,14]])})),c.apply(this,arguments)}function s(t){return u.apply(this,arguments)}function u(){return u=_asyncToGenerator(regeneratorRuntime.mark(function e(n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=n||t.data,n.loading=!0,e.prev=2,e.next=5,r.staff.update(n);case 5:e.next=9;break;case 7:e.prev=7,e.t0=e["catch"](2);case 9:return e.prev=9,n.loading=!1,t.$apply(),e.finish(9);case 13:case"end":return e.stop()}},e,null,[[2,7,9,13]])})),u.apply(this,arguments)}function d(t){return l.apply(this,arguments)}function l(){return l=_asyncToGenerator(regeneratorRuntime.mark(function t(e){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,s(_objectSpread({},e,{stopped:null}));case 2:e.stopped=null;case 3:case"end":return t.stop()}},t)})),l.apply(this,arguments)}function p(){o.method.init(["staff","stores"]).then(function(){t.data=o.storage.staff,t.$apply()})}t.user=a.user,t.role=_.map(r.staff.role,function(t,e){return _objectSpread({},t,{role:e})}),t.update=s,t.remove=i,t.repair=d,t.showDeleted=!1,t.data=[],t.$on("$destroy",function(){e.init.remove()}),t.$watch("user",function(t,e){e&&p()},!0),t.getRole=function(e){return(t.role.find(function(t){return t.role===e.type})||{}).title},t.toggleDeleted=function(){t.showDeleted=!t.showDeleted},t.count=function(t){var e=o.storage.staff.data.filter(function(t){return!t.deleted});return"all"===t?e.length:"stopped"===t?e.filter(function(t){return t.stopped}).length:e.filter(function(e){return e.type===t}).length},t.getStores=function(e){return t.stores=o.storage.stores.data.filter(function(t){return(e.stores||[]).includes(t._id)}).map(function(t){return t.name}).join(", ")},p()}]),angular.module("cloudshop.profile").controller("profileEditCtrl",["$scope","$state","modalService","companyService","db","imageUpload","$rootScope","permissionsService","$filter","api",function(t,e,n,r,a,o,i,c,s,u){function d(){p(),a.method.init(["staff","stores","staffRoles"]).then(function(e){var n=_slicedToArray(e,2),r=n[0],a=n[1];t.id&&(t.formData=_.clone(r.find(function(e){return e._id===t.id}))),t.stores=a.map(function(t){return{label:t.name,value:t._id}}),t.image=[t.formData.pic].filter(function(t){return Boolean(t)}),i.$broadcast("STAFF_FORM_DATA_LOADED",t.formData),t.$apply()})}t.country=u.user.company().country,t.formData={stores:[],type:"cashier"},t.helpText={stores:"\n        ".concat(s("translate")("THE_EMPLOYEE_WILL_GET_ACCESS_TO_THE_SPEC"),'\n        <br /><a target="_blank" href="https://cloudshop.ru/portal/articles/store-access/">').concat(s("translate")("MORE_IN_THE_KNOWLEDGE_BASE"),"</a>\n      ")},t.stores=[],t.image=[],t.roles=_.map(r.staff.role,function(t,e){return _objectSpread({},t,{role:e})}).filter(function(t){return"owner"!==t.role}),t.loading=!1,t.page=e.current.data,t.id=e.params.staff_id,t.errorText=null,t.$watch("form.$valid",function(t){n.method.toggle(0,t)}),t.$on("$destroy",function(){n.init.remove()});var l=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function i(){var a,s;return regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(t.loading=!0,a=t.id?"update":"create",n.method.disable(0),i.prev=3,!(null===(s=t.image)||void 0===s?void 0:s.length)){i.next=8;break}return i.next=7,o.save(t.image[0]);case 7:t.formData.pic=i.sent;case 8:return t.formData.permissions=c.parseFieldsByRole(t.formData.type,t.perm_fields),t.formData.phone=String(t.formData.phone||""),i.next=12,r.staff[a](t.formData);case 12:t.loading=!1,e.go("authenticated.card.company.staff"),i.next=20;break;case 16:i.prev=16,i.t0=i["catch"](3),t.loading=!1,t.errorText=i.t0;case 20:return i.prev=20,n.method.enable(0),i.finish(20);case 23:t.$apply();case 24:case"end":return i.stop()}},i,null,[[3,16,20,23]])}));return function(){return a.apply(this,arguments)}}();t.changeRole=function(e){t.formData.type=e,i.$broadcast("STAFF_FORM_CHANGE_ROLE",e)};var p=function(){n.method.add([{title:"SAVE",className:"green",active:!0,action:l,visible:!0}])};d()}]),angular.module("cloudshop.profile").controller("profileCtrl",["$scope","modalService","$state","companyService","api","db",function(t,e,n,r,a,o){function i(e){return e=e||t.data,e.loading=!0,t.loading=!0,e.stopped=+moment().format("X"),r.staff.remove(e).then(function(){e.loading=!1,t.$apply(),n.go("authenticated.card.company.staff")})}function c(){o.method.init(["staff","stores"]).then(function(e){var n=_slicedToArray(e,2),r=n[0],a=n[1];t.data=r.find(function(t){return t._id===s}),t.stores=a.filter(function(e){return(t.data.stores||[]).includes(e._id)}).map(function(t){return t.name}).join(", "),t.data.deleted===!1&&d(),t.$apply()})}var s=n.params.staff_id;t.data={},t.staff=r.staff,t.loading=!1,t.history={query:{user:s}},t.$on("$destroy",function(){e.init.remove()});var u=function(){var t="authenticated.card.staff_edit";s===a.user.data._id&&(t="authenticated.card.profile_edit"),n.go(t,{staff_id:s})},d=function(){e.method.add([{title:"EDIT",className:"green",active:!0,visible:s===a.user.data._id||"owner"===a.user.getRole(),action:u},{title:"DELETE",className:"red","float":"right",active:!0,action:i,visible:s!==a.user.data._id,perm:["staff","DELETE"]}])};c()}]),angular.module("cloudshop.profile").service("permissionsService",["db",function(t){var e=this;this.roles={};var n=function(t,e){try{return t.split(".").reduce(function(t,e){return t[e]},e)}catch(n){console.warn(n),console.log(t,e)}},r=function(t,e,n){var r=e.split(".");return r.reduce(function(e,n){return void 0===e[n]?e[n]=r[r.length-1]===n?t:{}:"boolean"==typeof e[n]&&(e[n]=t),e[n]},n),n};this.names={catalog:{_settings:{name:"WORK_WITH_PRODUCTS",type:"checkboxes"},create:{name:"ALLOW_CREATE_NEW_PRODUCT",subname:"THE_EMPLOYEE_WILL_BE_ABLE_TO_CREATE_NEW_"},edit:{name:"ALLOW_EDIT_PRODUCT",subname:"THE_EMPLOYEE_WILL_BE_ABLE_TO_CHANGE_PROD"},"delete":{name:"ALLOW_DELETE_PRODUCTS",subname:"THE_EMPLOYEE_WILL_BE_ABLE_TO_DELETE_EXIS"},stock:{name:"SHOW_STOCK",subname:"THE_EMPLOYEE_WILL_RECEIVE_INFORMATION_AB",fields:["catalog.fields.stock"]},cost:{name:"SHOW_COST",subname:"THE_EMPLOYEE_WILL_RECEIVE_INFORMATION_ABOUT_COST",fields:["catalog.fields.cost"]},purchase:{name:"SHOW_PURCHASE_PRICE",subname:"THE_EMPLOYEE_WILL_RECEIVE_INFORMATION_ON",fields:["catalog.fields.purchase"]},"export":{name:"ALLOW_DOWNLOAD_PRODUCTS_LIST",subname:"THE_EMPLOYEE_WILL_BE_ABLE_TO_SAVE_THE_PR"},price_labels:{name:"ALLOW_PRINT_PRICE_TAGS",subname:"EMPLOYEE_CAN_GENERATE_PRICE_TAGS_BY_TEMP"}},sale_product:{_settings:{name:"Продажа товара",type:"checkboxes"},negative_sale:{name:"Разрешить продажу в минус",subname:"\n            Сотрудник сможет продавать на кассе в минус.\n            <b>Внимание</b> настройка может повлиять на работу Android:POS в оффлайн режиме.\n          ",fields:["sales.negative_sale"]}},documents:{_settings:{name:"WORKING_WITH_DOCUMENTS",type:"dropdowns"},sales_get:{name:"SALE",fields:["sales.get"]},sales_create:{name:"SALE",fields:["sales.create"]},sales_edit:{name:"SALE",fields:["sales.edit"]},sales_delete:{name:"SALE",fields:["sales.delete"]},return_sales_get:{name:"RETURN_SALE",fields:["return_sales.get"]},return_sales_create:{name:"RETURN_SALE",fields:["return_sales.create"]},return_sales_edit:{name:"RETURN_SALE",fields:["return_sales.edit"]},return_sales_delete:{name:"RETURN_SALE",fields:["return_sales.delete"]},purchase_get:{name:"PURCHASE",fields:["purchases.get"]},purchase_create:{name:"PURCHASE",fields:["purchases.create"]},purchase_edit:{name:"PURCHASE",fields:["purchases.edit"]},purchase_delete:{name:"PURCHASE",fields:["purchases.delete"]},return_purchase_get:{name:"RETURN_PURCHASE",fields:["return_purchases.get"]},return_purchase_create:{name:"RETURN_PURCHASE",fields:["return_purchases.create"]},return_purchase_edit:{name:"RETURN_PURCHASE",fields:["return_purchases.edit"]},return_purchase_delete:{name:"RETURN_PURCHASE",fields:["return_purchases.delete"]},changes_get:{name:"WAREHOUSE_DOCUMENTS",fields:["changes.get","movements.get"]},changes_create:{name:"WAREHOUSE_DOCUMENTS",fields:["changes.create","movements.create"]},changes_edit:{name:"WAREHOUSE_DOCUMENTS",fields:["changes.edit","movements.edit"]},changes_delete:{name:"WAREHOUSE_DOCUMENTS",fields:["changes.delete","movements.delete"]},money_get:{name:"PAYMENT_ORDERS",fields:["money.get"]},money_create:{name:"PAYMENT_ORDERS",fields:["money.create"]},money_edit:{name:"PAYMENT_ORDERS",fields:["money.edit"]},money_delete:{name:"PAYMENT_ORDERS",fields:["money.delete"]}}},Object.keys(this.names).forEach(function(t){Object.keys(e.names[t]).forEach(function(n){if("_settings"!==n){var r=Array.isArray(e.names[t][n].fields)?e.names[t][n].fields:[e.names[t][n].fields||"".concat(t,".").concat(n)];e.names[t][n]=_objectSpread({},e.names[t][n],{fields:r})}})}),this.getFieldsByRole=function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=_.merge({},e.names);return r=_.merge({},e.roles[t],r),Object.keys(a).forEach(function(t){Object.keys(a[t]).forEach(function(e){var o=a[t][e],i=o.fields&&o.fields.length>0?o.fields[0]:"".concat(t,".").concat(e);"_settings"!==e&&(a[t][e]=_objectSpread({},o,{value:!!n(i,r)}))})}),a},this.setValues=function(t,a,o,i){var c=n("".concat(o,".").concat(a,".fields"),e.names);return c.forEach(function(e){i=r(t,e,i)}),i},this.parseFieldsByRole=function(t,n){var r=_.merge({},e.roles[t]);Object.keys(n).forEach(function(t){Object.keys(n[t]).forEach(function(a){"_settings"!==a&&(r=e.setValues(n[t][a].value,a,t,r))})});var a=r.catalog;a.fields,a["export"],_objectWithoutProperties(a,["fields","export"]);return r};var a=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function r(){var n,a,o;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,t.method.init("staffRoles");case 2:n=r.sent,a=_slicedToArray(n,1),o=a[0],o.forEach(function(t){e.roles[t._id]=_.merge({},t.permissions)});case 6:case"end":return r.stop()}},r)}));return function(){return n.apply(this,arguments)}}();a()}]),angular.module("cloudshop.profile").directive("permissionsDropdownList",["safeApply","$filter",function(t,e){return{restrict:"E",scope:{data:"="},replace:!0,template:'\n      <div class="list list-dropdowns">\n        <div class="item-dropdown" ng-repeat="(key, item) in dropdowns">\n          <div>\n            <div class="ui checkbox" ng-click="checkboxClick(key)" ng-model="model[key]">\n              <input type="checkbox"/>\n              <label>{{titles[key] | translate}}</label>\n            </div>\n            <with-help ng-show="help[key]" text="{{help[key]}}"></with-help>\n          </div>\n          <div ng-if="model[key]">\n            <dropdown-multiple\n              model-change="onChange"\n              ng-model="models[key]"\n              data-id="{{key}}"\n              data="item"\n              scheme="{label: \'name\', value: \'key\'}"\n              placeholder="Выбрать тип документа"\n            />\n          </div>\n        </div>\n      </div>\n    ',link:function(n){n.titles={get:"ALLOW_SEE_DOCUMENTS",create:"ALLOW_CREATE_DOCUMENTS",edit:"ALLOW_EDIT_DOCUMENTS","delete":"ALLOW_DELETE_DOCUMENTS"},n.help={get:"THE_EMPLOYEE_WILL_BE_SHOWN_DOCUMENTS_AND",create:"EMPLOYEE_CAN_CREATE_NEW_DOCUMENTS_AND_MO",edit:"THE_EMPLOYEE_WILL_BE_ABLE_TO_MODIFY_EXIS","delete":"THE_EMPLOYEE_WILL_BE_ABLE_TO_DELETE_EXIST_DOCUMENTS"};var r=function(t){return n.dropdowns[t].filter(function(t){return t.value}).map(function(t){return t.key})},a=function(){var t=n.data,a=Object.keys(t);n.dropdowns={},a.forEach(function(r){var a=r.split("_"),o=a[a.length-1];n.dropdowns[o]||(n.dropdowns[o]=[]),n.dropdowns[o].push(_objectSpread({key:r},t[r],{name:e("translate")(t[r].name)}))}),n.models={get:r("get"),create:r("create"),edit:r("edit"),"delete":r("delete")},n.model={get:!!r("get").length,create:!!r("create").length,edit:!!r("edit").length,"delete":!!r("delete").length}};n.onChange=function(t,e){n.dropdowns[t].forEach(function(t){var r=e.includes(t.key);n.data[t.key].value!==r&&(n.data[t.key].value=r)})},n.checkboxClick=function(e){setTimeout(function(){n.model[e]||(n.models[e]=[],n.onChange(e,[]),t(n))})},a(n.data)}}}]),angular.module("cloudshop.profile").directive("permissionsCheckboxList",["$rootScope","permissionsService",function(t,e){return{restrict:"E",scope:!0,replace:!0,template:'\n      <div class="field permissions-checkbox">\n        <a href="" class="ui basic button" translate>CHANGE_USER_PERMISSIONS</a>\n        <div class="permissions-checkbox-list">\n          <div class="list" ng-repeat="category in blocks">\n            <div class="title">{{category.name | translate}}</div>\n            <div class="item" ng-if="category.type === \'checkboxes\'" ng-repeat="(key, item) in $parent.perm_fields[category.key]">\n              <div class="ui checkbox" ng-model="item.value">\n                <input type="checkbox"/>\n                <label>{{item.name | translate}}</label>\n              </div>\n              <with-help ng-show="item.subname" text="{{item.subname}}"></with-help>\n            </div>\n            <permissions-dropdown-list\n              ng-if="category.type === \'dropdowns\'"\n              data="$parent.perm_fields[category.key]"\n            >\n            </permissions-dropdown-list>\n          </div>\n        </div>\n      </div>\n    ',link:function(n,r){var a=n.$parent,o=function(){var r=a.formData;a.perm_fields=e.getFieldsByRole(a.formData.type,r.permissions);var o=function(){n.blocks=Object.keys(a.perm_fields).map(function(t){var e=a.perm_fields[t]._settings;return delete a.perm_fields[t]._settings,_objectSpread({key:t},e)})};o(),t.$on("STAFF_FORM_CHANGE_ROLE",function(t,n){a.perm_fields=e.getFieldsByRole(n,r.permissions),o()})};$(r).on("click","> a",function(){$(r).toggleClass("active")}),t.$on("STAFF_FORM_DATA_LOADED",o)}}}]),angular.module("cloudshop.stores",[]).config(["$stateProvider",function(t){t.state("authenticated.card.store_add",{url:"/store/add/",templateUrl:"js/pages/card/store/_form.html",controller:"storeEditCtrl",data:{pageTitle:"NEW_STORE",permission:"stores"}}).state("authenticated.card.store_show",{url:"/store/:stores_id",templateUrl:"js/pages/card/store/_view.html",controller:"storeCtrl",data:{pageTitle:"STORE_VIEW",permission:"stores",sidebar:!0}}).state("authenticated.card.store_edit",{url:"/store/edit/:stores_id",templateUrl:"js/pages/card/store/_form.html",controller:"storeEditCtrl",data:{pageTitle:"STORE_EDIT",permission:"stores",sidebar:!0}})}]),angular.module("cloudshop.stores").service("store",["api","db","apiRouteService",function(t,e,n){var r=this;r.method={data:{},save:function(){function t(t,e){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(t,r){var o;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return t=this.format(t),r=Object.assign({method:"edit"},r||{}),a.next=4,n.stores()[r.method](t);case 4:return o=a.sent,a.next=7,e.method.init("accounts",{reload:!0});case 7:return a.abrupt("return",o);case 8:case"end":return a.stop()}},a,this)}));return t}(),create:function(t){return this.save(t,{method:"add",text:"STORE_CREATED «"+t.name+"»"})},update:function(t){return this.save(t,{text:"STORE_UPDATED «"+t.name+"»"})},remove:function(t){return this.save({_id:t._id,name:t.name,deleted:!0},{method:"delete",text:"STORE_DELETED «"+t.name+"»"})},format:function(t){return delete t.$$hashKey,t}}}]),angular.module("cloudshop.stores").controller("storeEditCtrl",["$scope","db","$state","api","modalService","store",function(t,e,n,r,a,o){function i(){t.loading=!0;var e=s?"update":"create";a.method.disable(0),o.method[e](t.data).then(function(){a.method.close()})}function c(){a.method.add([{title:"SAVE",className:"green",active:!0,action:i,visible:!0,perm:["stores","POST"]}]),s&&(t.loading=!0,e.method.init("stores").then(function(e){t.loading=!1,t.data=_.clone(_.where(e[0],{_id:s})[0],!0),t.$apply()}))}var s=n.params.stores_id;t.loading=!1,t.store=o.method,t.data={},t.db=e.storage,t.page=n.current.data,t.$watch("form.$valid",function(t){a.method.toggle([0],t)}),t.$on("$destroy",function(){a.init.remove()}),c()}]),angular.module("cloudshop.stores").controller("storeCtrl",["$scope","db","modalService","$state","store","confirmModal",function(t,e,n,r,a,o){var i=r.params.stores_id;t.db=e,t.code=null,t.history={query:{contractor:i}},t.id=i,t.historyTab=1,t.$on("$destroy",function(){n.init.remove()}),t.remove=function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function o(e){return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return t.loading=!0,e=e||t.data,r.prev=2,r.next=5,a.method.remove(e);case 5:n.method.close(),r.next=10;break;case 8:r.prev=8,r.t0=r["catch"](2);case 10:return r.prev=10,t.loading=!1,t.$apply(),r.finish(10);case 14:case"end":return r.stop()}},o,null,[[2,8,10,14]])}));return e}(),n.method.add([{title:"EDIT",className:"green",active:!0,action:{url:"authenticated.card.store_edit",param:{stores_id:i}},visible:!!i},{title:"DELETE",className:"red","float":"right",active:!0,action:t.remove,visible:!!i,perm:["stores","DELETE"]}]);var c=function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function a(){var r,o,c;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return t.loading=!0,a.prev=1,a.next=4,e.method.init("stores");case 4:r=a.sent,o=_slicedToArray(r,1),c=o[0],i&&(t.data=c.find(function(t){return t._id===i}),t.code=200,t.data||(t.code=404,n.init.disable([0,1]))),a.next=12;break;case 10:a.prev=10,a.t0=a["catch"](1);case 12:return a.prev=12,t.loading=!1,t.$apply(),a.finish(12);case 16:case"end":return a.stop()}},a,null,[[1,10,12,16]])}));return function(){return r.apply(this,arguments)}}();c()}]),angular.module("cloudshop.company").service("companyService",["api","$filter","db","$rootScope","$http","apiRouteService",function(t,e,n,r,a,o){function i(){c.staff.init(),c.company.init(),c.ecommerce.init()}var c=this;c.scope={},c.store={
data:{},init:function(){}},c.profile={save:function(){function e(t){return a.apply(this,arguments)}var a=_asyncToGenerator(regeneratorRuntime.mark(function o(e){var a,i;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return a="/profile/",e={name:e.name,email:e.email,phone:e.phone,pic:e.pic},o.prev=2,o.next=5,t.data.put(a,_objectSpread({},e,{v:"v3"}));case 5:if(i=o.sent,!i.data.error){o.next=8;break}throw new Error(i.data.error);case 8:return o.next=10,t.user.init();case 10:return r.$apply(),n.method.reload("staff"),o.abrupt("return",i.data);case 15:throw o.prev=15,o.t0=o["catch"](2),{error:c.staff.errors[o.t0.data.error]};case 18:case"end":return o.stop()}},o,null,[[2,15]])}));return e}(),change_password:function(){function t(t){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function n(t){var e;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,a.post("/new_password",t);case 2:return e=n.sent,n.abrupt("return",e.data);case 4:case"end":return n.stop()}},n)}));return t}()},c.staff={format:function(t){},errors:{600:e("translate")("A_USER_WITH_THIS_EMAIL_ALREADY_EXISTS"),601:e("translate")("ADD_USER_FAILED")},save:function(t,r){var a=this;return _asyncToGenerator(regeneratorRuntime.mark(function i(){var c,s,u,d,l,p,m;return regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(c=a,"object"===_typeof(t)){i.next=3;break}return i.abrupt("return",!1);case 3:return s=_.clone(t,!0),u=s.deleted,d=s.role,l=_objectWithoutProperties(s,["deleted","role"]),r=_objectSpread({method:"edit"},r),["cashier","storeman"].includes(l.type)||(l.stores=[]),i.prev=6,i.next=9,o.staff()[r.method](l);case 9:if(p=i.sent,!p.error){i.next=12;break}throw p.error;case 12:return n.method.reload("staff"),i.abrupt("return",p.data);case 16:throw i.prev=16,i.t0=i["catch"](6),m=i.t0.data&&i.t0.data.error?a.errors[i.t0.data.error]:e("translate")("SERVER_ERROR");case 20:case"end":return i.stop()}},i,null,[[6,16]])}))()},fields:["name","email","stores","pic","phone","password","type"],create:function(t){return this.save(t,{method:"add",text:e("translate")("EMPLOYEE_CREATED")+t.name})},update:function(t){var e={_id:t._id,stopped:null,name:t.name,email:t.email,phone:t.phone,type:t.type,stores:t.stores,pic:t.pic,permissions:t.permissions,inn:t.inn};return t.password&&(e.password=t.password),this.save(e,{text:"EMPLOYEE_UPDATED "+t.name})},remove:function(t){return this.save({_id:t._id,name:t.name,stopped:t.stopped,type:t.type},{method:"delete",text:e("translate")("EMPLOYEE_DELETED")+" "+t.name})},role:{manager:{title:"MANAGER"},owner:{title:"OWNER"},cashier:{title:"CASHIER"},storeman:{title:"STOREMAN"}},init:function(){this.format()},destroy:function(){}},c.company={data:t.user.company(),fieldArrayFormat:function(t){return(t||[]).map(function(t){return{value:t}})},detailsFakeData:[{key:e("translate")("ITN"),value:""},{key:e("translate")("IEC"),value:""},{key:e("translate")("ОГРН/ОГРНИП"),value:""},{key:e("translate")("OKPO"),value:""},{key:e("translate")("NUMBER_AND_DATE_OF_CERTIFICATE"),value:""}],format:function(){var t={name:this.data.name||e("translate")("MY_STORE"),country:this.data.country,currency:this.data.currency,currency_iso:this.data.currency_iso,address:Array.isArray(this.data.address)?{}:this.data.address,emails:this.fieldArrayFormat(this.data.emails),phones:this.fieldArrayFormat(this.data.phones),web:this.data.web,legal_name:this.data.legal_name,legal_full_name:this.data.legal_full_name,details:this.data.details||[],bank_details:this.data.bank_details||[],head_name:this.data.head_name,head_position:this.data.head_position,accountant_name:this.data.accountant_name,vat:this.data.vat||!1,vat_templates:this.data.vat_templates||[],created:this.data.created,savings_discounts:this.data.savings_discounts,discounts:this.data.discounts,plu_pref:this.data.plu_pref};0===t.details.length&&(t.details=_toConsumableArray(this.detailsFakeData)),this.data=t},un_format:function(){var t=_.clone(this.data,!0);return t.emails=t.emails.map(function(t){return t.value}).filter(function(t){return!!t}),t.phones=t.phones.map(function(t){return t.value}).filter(function(t){return!!t}),t.details=t.details.filter(function(t){return t.key&&t.value}),t.bank_details=t.bank_details.filter(function(t){return t.key&&t.value}),t},save:function(){var e=this,n=e.un_format();return new Promise(function(e,a){t.data.put("/data/:client/settings",_objectSpread({},n,{v:"v3"})).then(function(t){r.country=n.country,e(t)}).then(function(){return t.user.init()}).then(function(){r.$broadcast("NOTIFY",{title:"COMPANY",subtitle:"CHANGES_SAVED"}),r.$broadcast("updateMenu")})["catch"](a)})},init:function(){this.format()},destroy:function(){this.data=[]}},c.accounts={types:{store:{_id:"store",title:"STORE_ACCOUNT",icon:"building outline",visible:!1,priority:0,edit:!0},wallet:{_id:"wallet",title:"WALLET",icon:"money",visible:!0,priority:4,edit:!0},bank_card:{_id:"bank_card",title:"BANK_CARD",icon:"payment",visible:!0,priority:3,edit:!0},bank_account:{_id:"bank_account",title:"DEBIT_ACCOUNT",icon:"university",visible:!0,priority:2,edit:!0},register:{_id:"register",title:"REGISTER",icon:"inbox",visible:!0,priority:1,edit:!1}},un_format:function(t){return t.bank_details=(t.bank_details||[]).filter(function(t){return t.key&&t.value}),t},save:function(){function t(t,n){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function n(t,e){var r;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return t=this.un_format(t),e=Object.assign({method:"edit"},e||{}),void 0!==t.use_terminal&&"bank_account"!==t.type&&(t.use_terminal=void 0),n.next=5,o.accounts()[e.method](t);case 5:return r=n.sent,n.abrupt("return",r);case 7:case"end":return n.stop()}},n,this)}));return t}(),create:function(t){return this.save(t,{method:"add",text:"ACCOUNT_CREATED"+t.name})},update:function(t){return this.save(t,{text:"ACCOUNT_UPDATED"+t.name})},remove:function(t){return this.save({_id:t._id,name:t.name,deleted:!0},{method:"delete",text:"ACCOUNT_DELETED"+t.name})},init:function(t){}},c.ecommerce={value:{status:!1,visible:!0,theme:{id:"id1",cover:"https://pic.cloudshop.ru/v1/v1443513973/mrfogrttdlljcigb49ax.jpg"},domains:{sub:null,main:null},info:{title:t.user.company().name||e("translate")("MY_STORE"),description:e("translate")("STORE_DESCRIPTION_IN_SEVERAL_LINES"),about:null,address:t.user.company().address.actual,email:t.user.data.email,phone:(t.user.data.phone||"").toString(),logo:null},settings:{store:null,categories:[],zero_stocks:1,country:t.user.company().country,currency:{}}},headerBg:[{title:"NATURE",img:["https://pic.cloudshop.ru/v1/v1443513973/instjffqkqqeousxg9n4.jpg","https://pic.cloudshop.ru/v1/v1443513973/brljsta3e5dsd5ye2iqo.jpg","https://pic.cloudshop.ru/v1/v1443513973/lrzr3murufl9zm2cuiqr.jpg"]},{title:"CITY",img:["https://pic.cloudshop.ru/v1/v1443513973/mrfogrttdlljcigb49ax.jpg","https://pic.cloudshop.ru/v1/v1443513973/mzw5idldrgmztyprsro1.jpg","https://pic.cloudshop.ru/v1/v1443513973/hsnaactixuvjd4bk1bsi.jpg"]},{title:"SKY",img:["https://pic.cloudshop.ru/v1/v1443513973/iv97afciqbj4lw6l0okm.jpg","https://pic.cloudshop.ru/v1/v1443513973/v7qgbulrleh4irprfn8v.jpg"]}],bodyBg:["#fff","#F5F5F5","https://pic.cloudshop.ru/v1/v1443513973/zaxgnr5ktflfpxjr3n6j.jpg","https://pic.cloudshop.ru/v1/v1443513973/auyf1fkveieznue5alr5.jpg","https://pic.cloudshop.ru/v1/v1443513973/mdzruyxwhl13m7ciq6bh.jpg","https://pic.cloudshop.ru/v1/v1443513973/agljqwul5f3nbcvvksoo.jpg","https://pic.cloudshop.ru/v1/v1443513973/xu0rarq3fupv0tsznv4h.jpg"],save:function(e,n,r){return t.data[e](r||"/data/:client/ecommerce",_objectSpread({},n,{v:"v3"}))},edit:function(t){var e=this;return this.save("put",t).then(function(n){return e.value=Object.assign({},e.value,t),n})["catch"](function(t){return Promise.reject(t)})},enable:function(){return this.value.status=!0,this.edit(this.value)},init:function(){return"object"!=_typeof(t.user.company().ecommerce.info)?this.value=Object.assign({},t.user.company().ecommerce,this.value):this.value=Object.assign({},this.value,t.user.company().ecommerce),this.format(this.value)},format:function(t){t.info.phone=(t.info.phone||"").toString()}},i()}]),angular.module("cloudshop.company").controller("companyCtrl",["$scope","api","companyService","$state","db","modalService","$filter","$rootScope",function(t,e,n,r,a,o,i,c){function s(){o.method.add([{title:"SAVE",className:"green",active:!0,action:u,visible:!0,perm:["reports","GET"]}])}t.sidebar=r.$current.data.sidebar,t._range=_.range,t.dataFields={catalog:{value:!1,label:"PRODUCTS_AND_SERVICES"},docs:{value:!1,label:"OPERATIONS",text:"ATTENTION_THIS_OPTION_CLEARS_THE_COST_OF"},moneys:{value:!1,label:"TRANSACTIONS"},suppliers:{value:!1,label:"SUPPLIERS"},clients:{value:!1,label:"CLIENTS"},stores:{value:!1,label:"STORES_AND_ACCOUNTS"},registers:{value:!1,label:"REGISTERS_AND_SHIFTS"}},t.userRole=e.user.getRole(),t.companyID=e.user.clientID(),t.company=n.company,t.data=t.company.data,t.plu_code={helpText:"\n			PLU код применяется в весах с печатью этикетки содержащей информацию о весе товара. Формат штрих-кода для настройки весов: <br />NN PPPPP WWWWW S где:<br />\n			NN - префикс штрих-кода весового товара (21 по умолчанию)<br />\n			PPPPP - PLU код товара;<br />\n			WWWWW - вес товара в тысячных единицах;<br />\n			S - контрольная сумма\n			"},t.dropdown={country:{placeholder:"ENTER_COUNTRY_NAME",name:"countries",nameField:"nativeName","class":"basic",limit:300,search:!0},currency:{placeholder:"ENTER_CURRENCY",name:"currencies","class":"basic",limit:300},timezone:{placeholder:"SELECT",name:"timezones","class":"basic",limit:999,search:!0}},t.store=n.store,t.accounts={data:[],types:n.accounts.types},t.suggestions={onChange:function(e){t.data.legal_name=e.name.short_with_opf,t.data.legal_full_name=e.name.full_with_opf,t.data.details=e.detailsData,t.data.address.legal=e.address.unrestricted_value,e.management&&(t.data.head_name=e.management.name,t.data.head_position=e.management.post)}},t.dailyReportSave=_asyncToGenerator(regeneratorRuntime.mark(function l(){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return t.loading=!0,n.prev=1,t.dailyReport.timezone=parseInt(t.dailyReport.timezone),n.next=5,e.data.put("/data/:client/settings",_objectSpread({},t.dailyReport,{v:"v3"}));case 5:c.$broadcast("NOTIFY",{title:"EMAIL_REPORT",subtitle:"CHANGES_SAVED"}),n.next=11;break;case 8:n.prev=8,n.t0=n["catch"](1),n.t0.data&&n.t0.data.error&&(t.dailyReport.daily_email_report=!1);case 11:return n.prev=11,t.loading=!1,t.$apply(),n.finish(11);case 15:case"end":return n.stop()}},l,null,[[1,8,11,15]])}));var u=function(){o.method.disable(0),n.company.save().then(function(){t.$apply(),o.method.close()})};t.watchData=function(){return _.map(t.dataFields,function(t){return t.value}).filter(function(t){return t}).length>0},t.deleteData=function(){t.deleteDataLoading=!0;var n=prompt(i("translate")("ENTER_YOUR_PASSWORD"));if(n){var r={password:n,remove:{}};_.map(t.dataFields,function(t,e){t.value&&(r.remove[e]=t.value)}),e.data.post("/remove/:client",_objectSpread({},r,{v:"v3"})).then(function(){t.deleteDataLoading=!1,t.deleteSuccess=!0,setTimeout(function(){window.location.reload()},5e3),t.$apply()})}else t.deleteDataLoading=!1},t.$on("$destroy",function(){}),t.$watch("data.currency_iso",function(e,n){if(e&&e!==n){var r=a.storage.currencies.data.find(function(t){return t._id===e})||{};t.data.currency=r.description||null}});var d=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function r(){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,a.method.init(["stores","accounts"]);case 3:t.store.data=a.storage.stores.data,t.accounts.data=a.storage.accounts,t.dailyReport={name:e.user.company().name,daily_email_report:e.user.company().daily_email_report,timezone:parseInt(e.user.company().timezone)},n.next=10;break;case 8:n.prev=8,n.t0=n["catch"](0);case 10:return n.prev=10,t.$apply(),n.finish(10);case 13:t.sidebar&&s();case 14:case"end":return n.stop()}},r,null,[[0,8,10,13]])}));return function(){return n.apply(this,arguments)}}();d()}]),angular.module("cloudshop.documents").service("docService",["$filter","apiRouteService","payService","api","db","fn","alertModal",function(t,e,n,r,a,o,i){var c={data:{},pastedExcel:!1,template:function(t,e,n,r){return{from:t||{},to:e||{},status:void 0===n||n,store:r||"",date:moment().format("X"),discount_percent:0,discount_sum:0,number:null,products:[],qty:0,sub:0,sum:0,type:c.data.type||"sales",uuid:o.guid()}},findByID:function(t,e,n){var r=_.where(e,{_id:t})[0];return r?n?r[n]:r:!1},remove:function(){return e.document()["delete"](this.data)},build:function(t){return Object.assign({},t,{sub:c.product.totalPrice(!0),discount_sum:c.discount.inSum(),discount_percent:c.discount.inPercent(),qty:c.product.count(),date:+c.data.date,sum:c.product.totalPrice(),products:c.product.relevance()})},save:function(){function t(t){return n.apply(this,arguments)}var n=_asyncToGenerator(regeneratorRuntime.mark(function r(t){var n,o,s,d,l,p,m;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:n=t._id?"edit":"add",o=u[t.type+(t.sub_type||"")],s=Object.assign({},c.paid.data),void 0!==t.state&&(t.state=+t.state),d=function(t){var e={};return Object.keys(t.prices).forEach(function(n){(n===c.data.price||-1===n.indexOf("store_"))&&(e[n]=t.prices[n])}),e},["inventory"].includes(t.sub_type)&&(t.products=t.products.map(function(e){return _objectSpread({},e,{prices:d(e),qty:e.qty||0,discount_sum:0,price:e.prices[t.price],sub:e.prices[t.price]*e.qty||0,sum:e.prices[t.price]*e.qty||0})}),t.sum=_.sum(t.products,"sum")||0,t.sub=t.sum),["out"].includes(t.sub_type)&&(l="out"===t.sub_type?-1:1,t.products=t.products.map(function(e){return _objectSpread({},e,{prices:d(e),qty:l*Math.abs(e.qty),discount_sum:0,price:e.prices[t.price],sub:e.prices[t.price]*e.qty||0,sum:e.prices[t.price]*e.qty||0})}),t.qty=l*Math.abs(t.qty)),t.products=t.products.map(function(t){return delete t.stock,(isNaN(t.sum)||isNaN(t.sub)||isNaN(t.qty))&&(t.sum=0,t.sub=0,t.qty=0),t.discount_percent=parseFloat(t.discount_percent||0),t}),o.price||(t.sum=0,t.sub=0),t.store||(t.store=this.getStoreId(t)),"sales"===t.type&&(t.products=t.products.map(function(t){var e=a.storage.catalog.data.find(function(e){return e._id===t._id})||{},n=e.vat||0,r=(t.sum*n/(n+100)).round();return _objectSpread({},t,{vat:n,vat_sum:r})}),t.vat_sum=_.sum(t.products,"vat_sum")),r.prev=11,u[t.type].pay&&(p=[],c.paid.constant=Object.assign({},c.paid.constant,{contragent:_objectSpread({},"debit"===c.paid.constant.type?t.to:t.from)}),angular.forEach(s,function(t){delete t.edited;var e=_objectSpread({},_.clone(c.paid.constant,!0),{},t),n="bank_account"!==(a.storage.accounts.data.find(function(t){return t._id===e.store})||{}).type;delete e.date_ts,p.push(_objectSpread({},e,{cash:n}))})),r.next=20;break;case 15:if(r.prev=15,r.t0=r["catch"](11),"cancel"===r.t0){r.next=20;break}return r.next=20,i("При создании оплат произошла ошибка повторите попытку снова, созданный документ находится в журнале");case 20:return p&&(t.orders=p),delete t.date_ts,r.next=24,e.document()[n](t);case 24:return m=r.sent,t._id=m.data.data._id,t.number=m.data.data.number,r.abrupt("return",t);case 28:case"end":return r.stop()}},r,this,[[11,15]])}));return t}(),getStoreId:function(t){var e,n;return"stores"===(null===(e=t.from)||void 0===e?void 0:e.type)?t.from._id:"stores"===(null===(n=t.to)||void 0===n?void 0:n.type)?t.to._id:void 0},insert:function(t){return this.save(t)},clear:function(){c.data=c.template(),c.paid.data=[c.paid.template(!0)],p.prod_price.value="price",p.prod_price.name=p.prod_price.name.filter(function(t){return-1===t._id.indexOf("store_")})},discount:{value:0,override:!1,modal:{title:"",body:""},inPercent:function(){var t=_.map(c.data.products,function(t){return t.discount_percent/100*(t.price*t.qty)});if(t=_.sum(t)){var e=t/c.product.totalPrice(!0)*100;return+e}return 0},inSum:function(){return(this.inPercent()/100*c.product.totalPrice(!0)).round()},change:function(){var t,e=this;return"sales"!=c.data.type?!1:(this.value=+this.value,t=+this.value,0>t||t>100?(this.value=0>t?0:100,!1):void(c.data.products=c.data.products.map(function(n){var r=n.discountProduct;return(n.discountProduct<t||e.override)&&(r=t),n.discount_percent=r,n.discount_sum=n.price*(r/100),n})))}},setProdPricesDropdownValue:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:c.data.from;if(e._id){var n={name:"".concat(t("translate")("SELLING_PRICE_IN")," «").concat(e.name,"»"),_id:"store_".concat(e._id)};3===p.prod_price.name.length?p.prod_price.name.splice(1,0,n):p.prod_price.name[1]=n,p.prod_price.value="store_".concat(e._id)}},product:{storePrice:function(){if(["sales","return_sales"].includes(c.data.type)||["inventory","out"].includes(c.data.sub_type)){var t;["inventory","out"].includes(c.data.sub_type)?(t=c.data.from,t._id&&(c.data.price="store_".concat(t._id)),c.setProdPricesDropdownValue(t)):t="sales"===c.data.type?c.data.from:c.data.to;var e=function(e){var n=c.data.products[e],r=a.storage.catalog.formatted.find(function(t){return t._id===n._id});n.price=r.storePrice?r.storePrice(t._id)||n.price:n.price};for(var n in c.data.products)e(n)}},addFromDoc:function(t){return c.data.products=this.addFromJson(t.products)},addAll:function(t,e){var n=this,r=e.estimated,a=c.data.from._id;t.forEach(function(t){var e=c.data.products.find(function(e){return e._id===t._id})||{},o=e._id,i=e.counted,s=1;try{r&&(s=t.stock[a]||0,0>s&&(s=0))}catch(u){}finally{"inventory"===c.data.sub_type?!i&&(!o||r&&o)&&n.add(t,s,{estimated:r,counted:r,from:"add-all"}):n.add(t,s,{from:"add-all"})}})},add:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{counted:!0,from:"list"};if("function"!=typeof t.storePrice&&(t=a.storage.catalog.proto(t)),["set","service"].includes(t.type)&&["return_sales","sales"].includes(c.data.type)===!1)return!1;if(["sales","return_sales"].indexOf(c.data.type)>=0){var r="sales"===c.data.type?c.data.from._id:c.data.to._id;t.price=t.storePrice?t.storePrice(r)||t.price:t.price}if(this.isSelected(t))c.data.products=c.data.products.map(function(n){return n._id===t._id&&(n.qty=parseFloat(n.qty)+e,"inventory"===c.data.sub_type&&(n.stock.new_stock=parseFloat(n.stock.new_stock)+e,n.counted=!0)),n});else{var o=_.clone(t,!0),i=u[c.data.type+(c.data.sub_type||"")].price||"price";"sales"!==c.data.type&&(o.discount=0),o.price=o.price||0;var s={_id:o._id,qty:"inventory"===c.data.sub_type?0:e,price:+(o[i]||0),sub:null,sum:null,discount_percent:o.discount||0,discount_sum:o.price*(o.discount/100),discountProduct:o.discount||0,pack:{},product:{name:o.name,sku:o.sku,pic:o.pic,barcode:o.barcode,properties:o.properties,categories:o.categories,type:o.type,unit:o.unit,free_price:o.free_price},container:o.container||[],counted:n.counted};s=this.format(s,o,_objectSpread({qty:e},n)),c.data.products.push(s),c.discount.change()}},format:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{estimated:!0,qty:1,type:"internal",from:""},o={};if(r.estimated===!1&&"inventory"===c.data.sub_type&&(r.qty=0),["changes","movements"].includes(c.data.type)){var i=n.stock?n.stock[c.data.from._id]||0:0;"inventory"===c.data.sub_type||"changes"===c.data.type&&!c.data.sub_type?"document"===r.from?c.data._id&&!c.data.status?(o.stock={current:n.stock,new_stock:i+e.qty},o.qty=e.qty):(o.stock={current:_objectSpread({},_.clone(n.stock,!0),_defineProperty({},c.data.from._id,e.qty_before)),new_stock:e.qty_after},o.qty=e.qty):(o.stock={current:n.stock||{},new_stock:r.qty},o.qty=r.qty-i):(o.stock={current:n.stock||{},new_stock:i},o.qty=e.qty),o.stock&&(o.stock.new_stock=t("num")(o.stock.new_stock))}return["inventory","out"].includes(c.data.sub_type)&&(e.prices={price:n.price,purchase:n.purchase,cost:n.cost},a.storage.stores.data.forEach(function(t){var r,a=null===(r=n.store_prices)||void 0===r?void 0:r[t._id];e.prices["store_".concat(t._id)]=void 0!==a?a:n.price}),e.price=e.prices[c.data.price]),_objectSpread({},e,{},o)},addFromJson:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return e.map(function(e){var n=_.where(a.storage.catalog.data,{_id:e._id})[0]||{stock:{}};return e=t.format(e,n,{from:"document"}),e.discountProduct=e.discount_percent,"changes"!==c.data.type&&(e.qty=e.qty<0?-1*e.qty:e.qty),e})},buildProducts:function(e,n){var r=[];n||(n=e);var o=_objectSpread({container:[]},a.storage.catalog.data.find(function(t){return t._id===e._id})||{}),i=o.container.filter(function(t){return!t.deleted}),s=_.sum(i,"sum")||0;return i.forEach(function(u,d){var l=e.sum/(o.price/u.sum);if(0===s&&(l=e.sum/i.length,d===i.length-1&&(l=e.sum-_.sum(r,"sum"))),"set"===u.type)u.sum=l,r=r.concat(c.product.buildProducts(u,n));else{var p=a.storage.catalog.data.find(function(t){return t._id===u._id})||{},m=u.qty*n.qty,f=n.discount_percent/100,h=l*f/(1-f);r.push({_id:p._id,qty:t("num")(m,3),price:((l+h)/m||0).round(),sub:(l+h||0).round(),sum:(l||0).round(),discount_percent:+n.discount_percent,discount_sum:(h||0).round(),product:{name:p.name,sku:p.sku,pic:p.pic,barcode:p.barcode,properties:p.properties,categories:p.categories,type:p.type,id_parent:e._id}})}}),r},relevance:function(){var t=[],e=_.map(c.data.products,function(e){return e.sub=(e.price*e.qty).round(),e.discount_sum=(e.sub*(e.discount_percent/100)).round(),e.sum=(e.sub*((100-e.discount_percent)/100)).round(),"set"==e.product.type&&(t=t.concat(c.product.buildProducts(e))),delete e.$$hashKey,delete e.product.pic,delete e.container,e});return e=t.concat(e).map(function(t){return["movements"].indexOf(c.data.type)>=0&&(t.sub=0,t.discount_sum=0,t.sum=0),t})},remove:function(t,e){console.time("remove"),c.data.products.splice(e,1),console.timeEnd("remove")},edit:function(t){t.edit=!t.edit},isSelected:function(t){return c.data.products.find(function(e){return e._id===t._id})},totalItemPrice:function(t,e){var n=(t.price*t.qty).round();return t.discount_percent>0&&!e&&(n*=(100-t.discount_percent)/100),n},totalPrice:function(t){var e=0;return c.data.products.forEach(function(n){e+=c.product.totalItemPrice(n,t)}),e.round()},count:function(){return _.sum(_.pluck(c.data.products,"qty"))}},paid:{data:[],constant:{contragent:{},source:null,type:null},template:function(t,e,n){return{store:c.data.store,status:!!t,sum:(e||0).round(),date:n||moment().format("X")}},add:function(){var t=!this.data.length,e=c.product.totalPrice()-this.totalPaid();this.data.push(c.paid.template(t,e))},remove:function(){function t(t){return n.apply(this,arguments)}var n=_asyncToGenerator(regeneratorRuntime.mark(function r(t){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(!t._id){n.next=3;break}return n.next=3,e.order()["delete"](t);case 3:this.data=this.data.filter(function(e){return e.$$hashKey!=t.$$hashKey});case 4:case"end":return n.stop()}},r,this)}));return t}(),totalPaid:function(t){var e={status:t};return"undefined"==typeof t&&(e={}),_.sum(_.pluck(_.where(this.data,e),"sum"))},bar:function(){var t=(100*(1-(c.product.totalPrice()-this.totalPaid(!0))/c.product.totalPrice())).round(0);return t>100?100:t},barNoActive:function(){return(100*(1-(c.product.totalPrice()-this.totalPaid(!1))/c.product.totalPrice())).round(0)},change:function(t,e){var n=c.paid.data[e];n.sum=t.sum.round(),n.edited=!0,this.totalPaid()>c.product.totalPrice()&&(n.sum=(t.sum-(this.totalPaid()-c.product.totalPrice())).round())},refresh:function(){var t=(this.totalPaid()-c.product.totalPrice()).round(),e=_.map(this.data.reverse(),function(e){return t>0&&(t>e.sum?(t-=e.sum,e.sum=0):(e.sum-=+t,t=0)),e.sum=e.sum.round(),e});this.data=e.reverse()},init:function(){this.data=[this.template(!0)]}},init:function(){var t=this;return _asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.method.init("stores");case 2:t.data=t.template(),t.paid.init(),p.prod_filter.value=1,p.prod_price.value="price";case 6:case"end":return e.stop()}},e)}))()}},s={clients:{title:"CUSTOMER",url:"authenticated.card.client_show",allow:["sales","return_sales"]},suppliers:{title:"SUPPLIER",url:"authenticated.card.supplier_show",allow:["purchases","return_purchases"]},stores:{title:"STORE",url:"authenticated.card.store_show",allow:["stores"]},accounts:{title:"INVOICES",url:"authenticated.card.account_show",allow:["stores"]},staff:{title:"EMPLOYEES",url:"authenticated.card.profile",allow:["stores"]}},u={sales:{active:!0,color:"#02A99C",title:t("translate")("SALE"),title2:t("translate")("SALES"),pay:{type:"debit",source:100},from:"stores",to:"clients",discount:!0,url:"authenticated.card.doc_create.sell",price:"price"},purchases:{active:!0,color:"#02A8F8",title:t("translate")("PURCHASE"),title2:t("translate")("PURCHASES"),pay:{type:"credit",source:200},excel:!0,from:"suppliers",to:"stores",url:"authenticated.card.doc_create.purchase",price:"purchase",docFilter:function(t){return["inventory","group"].includes(t.type)}},return_sales:{active:!0,color:"#FF5350",title:t("translate")("RETURN_SALE"),title2:t("translate")("SALES_RETURN"),pay:{type:"credit",source:201},from:"clients",to:"stores",url:"authenticated.card.doc_create.return_sell",price:"price"},return_purchases:{active:!0,color:"#FF723F",title:t("translate")("RETURN_PURCHASE"),title2:t("translate")("RETURN_PURCHASES"),pay:{type:"debit",source:101},from:"stores",to:"suppliers",url:"authenticated.card.doc_create.return_purchase",price:"purchase",docFilter:function(t){return["inventory","group"].includes(t.type)}},changes:{active:!1,color:"#8C57C6",title:"ADJUSTMENT",title2:"ADJUSTMENTS",pay:!1,from:"stores",url:"authenticated.card.doc_create.changes",docFilter:function(t){return["inventory","group"].includes(t.type)}},changesinventory:{type:"changes",sub_type:"inventory",active:!0,color:"#8C57C6",title:t("translate")("STOCKTAKE"),title2:"STOCKTAKES",pay:!1,from:"stores",url:"authenticated.card.doc_create.changes_inventory",docFilter:function(t){return["inventory","group"].includes(t.type)}},changesin:{type:"changes",sub_type:"in",active:!0,color:"#8C57C6",title:"STOCK_ADJUSTMENT",title2:"STOCK_ADJUSTMENTS",pay:!1,excel:!0,from:"stores",price:"purchase",url:"authenticated.card.doc_create.changes_in",docFilter:function(t){return["inventory","group"].includes(t.type)}},changesout:{type:"changes",sub_type:"out",active:!0,color:"#8C57C6",title:"WRITEOFF",title2:"WRITEOFFS",pay:!1,excel:!0,from:"stores",price:"price",url:"authenticated.card.doc_create.changes_out",docFilter:function(t){return["inventory","group"].includes(t.type)}},movements:{active:!0,color:"#FF7E02",title:t("translate")("MOVEMENT"),title2:"TRANSFERS",pay:!1,from:"stores",to:"stores",url:"authenticated.card.doc_create.moving",docFilter:function(t){return["inventory","group"].includes(t.type)}}},d=[{_id:0,name:"WITHOUT_STATUS",_color:"white"},{_id:1,name:"NEW",_color:"purple"},{_id:2,name:"IN_WORK",_color:"blue"},{_id:3,name:"CLOSED",_color:"green"},{_id:4,name:"CANCELED",_color:"red"}],l={productFilter:function(t){return u[c.data.type].docFilter?u[c.data.type].docFilter(t):!0},diffPrice:function(e){var n=e.qty*e.prices[c.data.price];return"".concat(n>0?"+":"").concat(t("price")(n))},productsFilter:function(t){if(!c.data.from._id||"changes"!==c.data.type&&!c.data.sub_type||!t.stock)return!0;try{var e=t.stock.current?t.stock.current[c.data.from._id]:0;switch(+p.prod_filter.value){case 2:return 0!==t.qty;case 3:return e<t.stock.new_stock;case 4:return e>t.stock.new_stock;case 5:return t.counted;case 6:return!t.counted;default:return!0}}catch(n){console.warn("ERROR PF",n,_objectSpread({},t))}},updateStocks:function(t,e){if("changes"===c.data.type){var n=c.data.from._id;switch(t.stock.new_stock=t.stock.new_stock||0,t.stock.current[n]=t.stock.current[n]||0,e){case"new":t.qty=t.stock.new_stock-t.stock.current[n];break;case"qty":t.stock.new_stock=t.stock.current[n]-t.qty}}}},p={prod_filter:{name:[{name:"ALL_PRODUCTS",_id:1},{name:"WITH_DISCREPANCY",_id:2},{name:"SURPLUS",_id:3},{name:"SHORTFALLS",_id:4},{name:"Подсчитано",_id:5},{name:"Не подсчитано",_id:6}],icon:"unhide","class":"pointing top left",text:"FILTER",value:1,limit:99},prod_price:{name:[{name:"SELLING_PRICE",_id:"price"},{name:"PURCHASE",_id:"purchase"},{name:"COST",_id:"cost"}],icon:"dollar","class":"pointing top left",text:"SELLING_PRICE",value:"price",limit:999,onChange:function(t,e){var n=e._id;if(c.data.price=n,"out"===c.data.sub_type){var r=0;c.data.products=c.data.products.map(function(t){var e=t.prices[c.data.price];return r+=e*t.qty,_objectSpread({},t,{price:e,sub:e*t.qty,sum:e*t.qty})}),c.data.sub=r,c.data.sum=r}}}},m=[{url:"/print/doc/sales/:id",label:"INVOICE",type:"sales"},{url:"/print/check/:id",label:"SALES_RECEIPT",type:"sales"},{url:"/print/bso/torg12/:id",label:"ТОРГ 12",type:"sales"},{url:"/print/bso/upd/:id",label:"UTD",type:"sales"},{url:"/print/doc/purchases/:id",props:"",label:"INVOICE",type:"purchases"},{url:"/print/doc/purchases/:id",props:"price=0",label:"INVOICE_WITHOUT_PRICE",type:"purchases"},{url:"/print/doc/purchases/:id",props:"price=purchase",label:"INVOICE_WITH_PURCHASE_PRICES",type:"purchases"},{url:"/print/doc/purchases/:id",props:"price=store",label:"INVOICE_WITH_RETAIL_PRICES",type:"purchases"},{url:"/print/doc/return_sales/:id",label:"INVOICE",type:"return_sales"},{url:"/print/doc/return_purchases/:id",label:"INVOICE",type:"return_purchases"},{url:"/print/doc/movements/:id",props:"price=0",label:"INVOICE_WITHOUT_PRICE",type:"movements"},{url:"/print/doc/movements/:id",props:"price=store",label:"INVOICE_WITH_RETAIL_PRICES",type:"movements"},{url:"/print/doc/changes/:id",label:"INVOICE",type:"changes"},{url:"/print/doc/inventory/blank/:id",label:"FORM",type:"changes",sub_type:"inventory"},{url:"/print/doc/inventory/:id",label:"INVENTORY",type:"changes",sub_type:"inventory"},{url:"/print/doc/changes/:id",props:"",label:"INVOICE",type:"changes",sub_type:"in"},{url:"/print/doc/changes/:id",props:"price=0",label:"INVOICE_WITHOUT_PRICE",type:"changes",sub_type:"in"},{url:"/print/doc/changes/:id",props:"price=purchase",label:"INVOICE_WITH_PURCHASE_PRICES",type:"changes",sub_type:"in"},{url:"/print/doc/changes/:id",props:"price=store",label:"INVOICE_WITH_SALE_PRICES",type:"changes",sub_type:"in"},{url:"/print/doc/changes/:id",props:"",label:"INVOICE",type:"changes",sub_type:"out"},{url:"/print/doc/changes/:id",props:"price=0",label:"INVOICE_WITHOUT_PRICE",type:"changes",sub_type:"out"},{url:"/print/doc/changes/:id",props:"price=purchase",label:"INVOICE_WITH_PURCHASE_PRICES",type:"changes",sub_type:"out"},{url:"/print/doc/changes/:id",props:"price=store",label:"INVOICE_WITH_SALE_PRICES",type:"changes",sub_type:"out"}];return c.init(),{doc:c,types:u,states:d,clients:s,helpers:l,dropdown:p,printDropdown:m}}]),angular.module("cloudshop.documents").directive("docScroll",["safeApply",function(t){return{restrict:"A",link:function(e,n){$(n).bind("click",function(){try{var n=e.$parent.$parent,r=n.pageSize,a=n.currentPage,o=n.setCurrentPage,i=n.doc.data.products;i.length>r*a&&(o(),t(e)),setTimeout(function(){try{var t=$(".docsTotal:visible:first").position().top-$(window).height()+200;$(".my.sidebar").scrollTop(t)}catch(e){}},100)}catch(c){console.warn(c)}})}}}]).directive("documentForm",["$timeout",function(t){return{restrict:"C",link:function(e,n){var r=e.$parent.doc.data;if("purchases"!=r.type&&$("input[select-text]:first",n).focus(),["movements","changes"].indexOf(r.type)>-1){var a;$(n).on("keyup change",".document-highlight-input input",function(){var e=$(this).val();if(a==e)return!1;var n=$(this).parent().index();$(this).closest("tr").find(".document-highlight-input").each(function(){
var e=this;$(this).index()!=n&&($(this).css({backgroundColor:"rgba(251, 189, 8, .2)",transition:"all 1s easy"}),t(function(){$(e).css({backgroundColor:"#fff"})},300))}),a=e})}}}}]).directive("stateToggle",["$timeout",function(t){return{restrict:"C",link:function(e,n){$(".checkbox",n).bind("click",function(){e.stateToggle&&t(function(){return $(".dropdown",n).dropdown("show")})})}}}]),angular.module("cloudshop.documents").controller("documentCtrl",["$scope","APPS","companyService","db","docService","cardService","$state","$rootScope","$filter","api","catalogFilterService","holdDocService","safeApply","alertModal","confirmModal","webworker",function(t,e,n,r,a,o,i,c,s,u,d,l,p,m,f,h){function g(){t.randomNew=Math.random()}function v(){return y.apply(this,arguments)}function y(){return y=_asyncToGenerator(regeneratorRuntime.mark(function e(){var n,r,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=a.doc.build(_.clone(t.doc.data,!0)),e.next=4,I(n);case 4:if(n=e.sent,n.from._id||t.error.push("from"),-1!=["changes"].indexOf(n.type)||n.to&&n.to._id||t.error.push("to"),"inventory"===n.sub_type&&n.status&&(n.date=+moment().format("X")),!t.error.length){e.next=10;break}throw"validation";case 10:return t.currentPage=1,t.error=[],t.loading=!0,o.init.toggle([0,1],!1),p(t),e.next=17,t.doc.save(n);case 17:if(r=e.sent,r._id){e.next=20;break}throw"server";case 20:return n._id=r._id,n.pastedExcel=t.doc.pastedExcel,n.stateName=(a.states.find(function(t){return t._id===n.state})||{}).name,c.$broadcast("docs.create",n),i.go(i.current,{},{reload:!0}),e.abrupt("return",n);case 28:if(e.prev=28,e.t0=e["catch"](0),s=e.t0.data?e.t0.data.error:void 0,["validation","cancel"].includes(e.t0)||[5e3,5001,5002].includes(s)!==!1){e.next=34;break}return e.next=34,m("AN_ERROR_OCCURRED_WHILE_CREATING_THE_DOC");case 34:return e.prev=34,t.loading=!1,o.init.toggle([0,1],!0),p(t),e.finish(34);case 39:case"end":return e.stop()}},e,null,[[0,28,34,39]])})),y.apply(this,arguments)}function b(){o.method.add([{title:"SAVE",className:"green",active:!0,action:v,visible:!0},{visible:!0,template:"js/pages/card/documents/directives/print-dropdown.html",action:v}])}t.data=r.storage,t.apps=e,t.doc=a.doc,t.params={};var E={},S=i.params.id;t.loading=!1,t.inited=!1,t.catalogLoading=!0,t.stateToggle=!1,t.stateToggleShow=!1,t.docExcelLoading=!1,t.productSearch="",t.user=u.user,t.userRole=u.user.getRole(),t.filtered=null,t.error=[],t.currentPage=1,t.pageSize=100,t.setCurrentPage=function(e){t.currentPage=e||t.currentPage+1,p(t)},t.stocks={},t.meta={paid_errors:[],order:{company:!1,client:!1,account:!1}};var T={clients:{title:"CLIENT",subtitle:{suffix:"%",body:"discount"},name:"clients",create:"authenticated.card.client_add","class":"basic floating large fluid button",search:!0,icon:"content"},stores:{title:"STORE",name:"stores",create:"authenticated.card.store_add","class":"basic floating large fluid button",search:!0,icon:"content"},suppliers:{title:"SUPPLIER",name:"suppliers",create:"authenticated.card.supplier_add","class":"basic floating large fluid button",search:!0,icon:"content"}};t.dropdown=Object.assign({state:{name:_.clone(a.states,!0).map(function(t){return _objectSpread({},t,{_id:t._id++})}),"class":"pointing top left",text:"SELECT_STATUS",onChange:function(e,n){t._changeState(n._id)}}},a.dropdown);var w=null;t.$watch("doc.data.bank_account_pay",function(e,n){if(t.doc.paid.data[0])if(e&&!n){w=_.clone(t.doc.paid.data[0],!0);var a=r.storage.accounts.data.find(function(t){return t._id===w.store}),o=r.storage.accounts.data.find(function(t){return"bank_account"===t.type});a&&"bank_account"===a.type||(o&&o._id?(t.doc.paid.data[0].status=!1,t.doc.paid.data[0].store=o._id):t.doc.paid.data[0].store=null)}else!e&&n&&(t.doc.paid.data[0].store=w.store,t.doc.paid.data[0].status=w.status)}),t.$watchCollection("doc.paid.data",function(e){e&&0===e.length&&(t.doc.data.bank_account_pay=!1)}),t.$watch("showProductPanel",function(t){o.method.data.className=t?"documents-expand":"documents-compress"}),t.$watch("doc.data.products",function(e,n){if("undefined"==typeof e||""===e||1==t.loading)return!1;var r=t.doc.paid.data;r.length<2&&(t.doc.product.totalPrice()<t.doc.paid.totalPaid()?t.doc.paid.refresh():1!==r.length||r[0]._id||r[0].edited||(r[0].sum=t.doc.product.totalPrice()))},!0),t.$watch("doc.data",function(e){if("undefined"==typeof e||""===e||!E)return!1;if(E.from&&t.data[E.from].data){var n=t.doc.findByID(t.doc.data.from._id,t.data[E.from].data);n&&(t.doc.data.from.name=n.name,t.doc.data.from.type=E.from)}if(E.to&&t.data[E.to].data&&t.doc.data.to){var r=t.doc.findByID(t.doc.data.to._id,t.data[E.to].data);r&&(t.doc.data.to.name=r.name,t.doc.data.to.type=E.to)}var a=0!=_.size(t.doc.data.products);o.init.toggle([0,1],!!a&&!t.loading),t.doc.data.from._id&&(t.error=t.error.filter(function(t){return"from"!==t})),"changes"!==t.doc.data.type&&(!E.to||t.doc.data.to&&t.doc.data.to._id)&&(t.error=t.error.filter(function(t){return"to"!==t}))},!0),t.$watch("doc.data.from._id",function(t){"inventory"===a.doc.data.sub_type&&t&&a.doc.data.products.forEach(function(e){e.qty=e.stock.new_stock-(e.stock.current?e.stock.current[t]:0)})},!0),t.$watch("doc.data.from",function(e,n){return S&&!n._id||_.isEqual(e,n)?!1:(g(),void(e&&E&&"stores"===E.from&&(t.doc.data.store=e._id,t.doc.product.storePrice(),S||(t.doc.paid.data=t.doc.paid.data.map(function(t){return t.store=e._id,t})))))},!0),t.$watch("doc.data.to",function(e,n){return S&&!n._id||_.isEqual(e,n)?!1:(g(),void(e&&E&&"stores"===E.to&&(t.doc.data.store=e._id,t.doc.product.storePrice(),S||(t.doc.paid.data=t.doc.paid.data.map(function(t){return t.store=e._id,t})))))},!0),t.$watch("doc.data.to._id",function(e){"undefined"!=typeof e&&""!==e&&"sales"===t.doc.data.type&&(t.doc.discount.value=+t.doc.findByID(e,t.data.clients.data,"discount"))}),t.$watch("doc.discount.value",function(e){"undefined"!=typeof e&&""!==e&&t.doc.discount.change()}),t.$watch("doc.data.type",function(e){"undefined"!=typeof e&&""!==e&&(t.error=[])});var k=function(e){var n=_.sum(t.doc.data.products,"qty");return S&&t.oldQty!==n||!S&&t.doc.data.products.length?(e&&(e.preventDefault(),e.returnValue=""),!0):!1},$=!1,x=c.$on("$stateChangeStart",function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n,r){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i.current.name!==n.name){e.next=2;break}return e.abrupt("return",!0);case 2:if(a=n.name+""+i.current.name,$||!k()||-1!=a.indexOf(".modal.")){e.next=14;break}return e.prev=4,t.preventDefault(),e.next=8,f(s("translate")("ENTERED_DATA_WILL_BE_LOST"),!1,{successText:"STAY",cancelText:"".concat(s("translate")("GO_TO_SECTION")," «").concat(s("translate")(n.data.pageTitle),"»")});case 8:e.next=14;break;case 10:e.prev=10,e.t0=e["catch"](4),$=!0,i.go(n,r);case 14:$=!1;case 15:case"end":return e.stop()}},e,null,[[4,10]])}));return function(e,n,r){return t.apply(this,arguments)}}());t.$watch("stateToggle",function(e){e&&t.doc.data.state||(t.doc.data.state=e?1:null)}),t.$watch("randomNew",function(t){!!t&&A()}),t.$watch("productSearch",function(e,n){e!=n&&(e?n||(t.Catalog.showGroupOld=t.Catalog.showGroup,t.Catalog.showGroup=!1):t.Catalog.showGroup=t.Catalog.showGroupOld,A())}),t.toggleProductPanel=function(){t.showProductPanel=!t.showProductPanel},t._changeState=function(e){e&&(t.doc.data.status=[3].indexOf(e)>-1)},t.Catalog={onClick:function(e){if("group"===e.type)t.Catalog.id_group=e._id,t.randomNew=Math.random();else{var n=1;if(t.productSearch){var r=pluCode(u.user.company().plu_pref,t.productSearch);r.code===e.PLU_code&&(n=r.weight)}t.doc.product.add(e,n,{estimated:!1,counted:!0,from:"list"})}},back:function(){var e=r.storage.catalog.data.find(function(e){return e._id===t.Catalog.id_group})||{id_group:"0"},n=e.id_group;t.Catalog.id_group=n||"0",t.randomNew=Math.random()},toggle:function(){t.Catalog.showGroup=!t.Catalog.showGroup,t.Catalog.id_group="0",t.randomNew=Math.random()},showBack:!1,showGroup:!0,showGroupOld:!0,id_group:"0"},t.catalogFilterMethods={params:{},onChange:function(e){t.catalogFilterMethods.params=e,g()}};var R=20,C=0;t.showMore=function(){R+=20,g()},t.showButtonShowMore=function(){return C>R},t.result=[],t.filterLoading=!1,t.productsLoading=!1;var A=_.throttle(_asyncToGenerator(regeneratorRuntime.mark(function j(){var e,n,r,a;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(e=_toConsumableArray(t.result),t.products){o.next=3;break}return o.abrupt("return",e);case 3:if(t.randomNew!==t.randomOld||t.productSearch!==t.productSearchOld){o.next=5;break}return o.abrupt("return",e);case 5:if(console.time("doc-catalog"),t.productsLoading=!0,e=t.filtered||t.products.formatted,t.randomOld=t.randomNew,t.productSearchOld=t.productSearch,n=pluCode(u.user.company().plu_pref,t.productSearch),r=n.code&&/^\d+$/.test(t.productSearch),!r){o.next=17;break}return o.next=15,h("catalog",{cmd:"plu_code",plu:n,catalog:e});case 15:e=o.sent,0===e.length&&(r=!1,e=t.filtered||t.products.formatted);case 17:if(r||!t.productSearch){o.next=25;break}return t.filterLoading=!0,o.next=21,h("catalog",{cmd:"search",query:t.productSearch,catalog:e});case 21:if(a=o.sent,t.productSearch===a.query){o.next=24;break}return o.abrupt("return",!1);case 24:e=a.data;case 25:return o.next=27,d.init(e,t.catalogFilterMethods.params);case 27:e=o.sent,t.productSearch||(e=O(e)),e=s("filter")(e,t.helpers.productFilter),t.resultTotal=e,e=t.Catalog.showGroup?e.filter(function(e){return e.id_group===t.Catalog.id_group}):e.filter(function(t){return"group"!==t.type}),C=e.length,t.result=e.slice(0,R),t.Catalog.showBack="0"!==t.Catalog.id_group,t.productsLoading=!1,t.filterLoading=!1;try{t.$apply()}catch(i){}return console.timeEnd("doc-catalog"),o.abrupt("return",e);case 40:case"end":return o.stop()}},j)})),100),O=function(t){return t.sort(function(t,e){return"group"===t.type&&"group"===e.type?t.name>e.name?1:-1:"group"===t.type?-1:"group"===e.type?1:t.updated>e.updated?-1:1})};t.filter={onSubmit:function(e){t.randomNew=Math.random(),t.filtered=e},addAll:function(){return _asyncToGenerator(regeneratorRuntime.mark(function e(){var n,a,o,i,c,u,d;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=[],"0"===t.Catalog.id_group){e.next=7;break}return e.next=4,h("catalog",{cmd:"groups",withGroups:!1,data:[{_id:t.Catalog.id_group,type:"group"}],catalog:r.storage.catalog.formatted});case 4:n=e.sent,e.next=8;break;case 7:n=t.resultTotal.filter(function(t){return"group"!==t.type});case 8:return e.prev=8,o=t.doc.data.from._id,i="changes"===t.doc.data.type?"\n						<br /><br />\n						<label>\n						<input ".concat(o?"":'disabled="disabled"',' type="checkbox" name="estimated" />\n						Заполнить расчётными остатками\n						</label>\n						').concat(o?"":'<div class="ui warning message">Выберите магазин для того, чтобы заполнить остатками</div>',"\n					"):"",e.next=13,f("".concat(s("translate")("PLURAL_ADD_ALL_PRODUCTS",{val:n.length})," ").concat(i),!1,{successText:"ADD",cancelText:"CANCEL"});case 13:c=e.sent,u=_slicedToArray(c,1),d=u[0],a=!!d,e.next=22;break;case 19:return e.prev=19,e.t0=e["catch"](8),e.abrupt("return",null);case 22:t.doc.product.addAll(n,{estimated:a}),p(t);case 24:case"end":return e.stop()}},e,null,[[8,19]])}))()}},t.helpers=a.helpers,t.product={price:function L(e){if(!E.price)return"";if("price"===E.price){var n="stores"===E.from?"from":"to",a=r.storage.catalog.proto(e).storePrice(t.doc.data[n]._id);if(["out","inventory"].includes(t.doc.data.sub_type)){var L=e[t.doc.data.price];return 0===t.doc.data.price.indexOf("store_")&&(L=e.store_prices[t.doc.data.price.replace("store_","")],L=void 0===L?e.price:L),s("curr")(L)}if(null!==a)return s("curr")(a)}return s("curr")(e[E.price])}},t.productTotal=function(){return{qty:_.sum(t.doc.data.products,"qty"),price:_.sum(t.doc.data.products,"price"),discount:_.sum(t.doc.data.products,"discount_percent"),total:0}};var I=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(e){var r,o,i,c,s,u,d;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if("inventory"!==e.sub_type||!e.status){n.next=17;break}if(r=e.products.filter(function(t){return!t.counted}),console.warn({doc:e}),r.length){n.next=5;break}return n.abrupt("return",e);case 5:return o='\n					<br /><br />\n					<label>\n					<input type="checkbox" name="remove" />\n					Удалить неподсчитанные позиции из документа\n					</label>\n				',n.next=8,f("В документе есть неподсчитанные позиции. Они будут сохранены с нулевым фактическим остатком. ".concat(o),!1,{successText:"Продолжить",cancelText:"CANCEL"});case 8:if(i=n.sent,c=_slicedToArray(i,1),s=c[0],!s){n.next=17;break}for(u=0;u<e.products.length;u+=1)e.products[u].counted||t.productRemove(e.products[u],u);if(0!==t.doc.data.products.length){n.next=15;break}throw"cancel";case 15:return d=a.doc.build(t.doc.data),n.abrupt("return",d);case 17:return n.abrupt("return",e);case 18:case"end":return n.stop()}},n)}));return function(t){return e.apply(this,arguments)}}();t.stockCount=function(e){if("service"==e.type)return"";var n=e.stockCount,r="stores"==E.from?"from":"to";return t.doc.data[r]&&t.doc.data[r]._id&&(n=e.stock[t.doc.data[r]._id]),n=n||0},t.togglePaidForm=function(){t.paidEditShow=!t.paidEditShow},t.paidChange=function(e,n){var r=t.doc.paid.data[n];r.sum=e.sum.round()},t.productRemove=function(e){var n=t.doc.data.products.findIndex(function(t){return t._id===e._id});1==t.doc.data.products.length&&(t.showProductPanel=!0),t.doc.product.remove(e,n)},t.remove=_asyncToGenerator(regeneratorRuntime.mark(function M(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.doc.remove(i.params.id);case 3:i.go("authenticated.card.journal"),e.next=9;break;case 6:e.prev=6,e.t0=e["catch"](0),console.warn(e.t0);case 9:case"end":return e.stop()}},M,null,[[0,6]])}));var P=c.$on("WS_UPDATE",function(e,n){u.user.data._id===n._user&&"data"===n.type&&(t.doc.data.from&&t.doc.data.from.type==n.meta.type&&(t.doc.data.from._id=n.meta.data._id),t.doc.data.to&&t.doc.data.to.type==n.meta.type&&(t.doc.data.to._id=n.meta.data._id)),t.randomNew=Math.random(),t.$apply()}),D=c.$on("WS_UPDATE_CATALOG_POST",function(e,n){t.docExcelLoading||(n.forEach(function(e){t.doc.product.add(e,1,{estimated:!1,counted:!0,from:"list"})}),t.randomNew=Math.random(),t.$apply())}),N=function(t){var e=Number(t.slice(0,2)),n=t.slice(2,7),r=Number(t.slice(7,12))/1e3;return{pref:e,code:n,weight:r}},U=c.$on("BARCODE_SCAN",function(e,n){var a,o=1,i=u.user.company(),c=i.plu_pref,s=N(n);s.pref===Number(c)&&(a=r.storage.catalog.data.find(function(t){return t.PLU_code===s.code}),a&&(o=s.weight)),a||(a=r.storage.catalog.data.find(function(t){return String(t.barcode).includes(n)})),a?(t.doc.product.add(a,o,{counted:!0,from:"scanner-barcode"}),p(t)):setTimeout(function(){m("Товар со штрих-кодом ".concat(n," не найден"))},200)});t.$on("$destroy",function(){window.removeEventListener("beforeunload",k),o.init.remove(),o.init.data.loading=!1,o.method.data.className="",t.doc.clear(),P(),D(),U(),x()}),b(),t.init=function(e){window.addEventListener("beforeunload",k),S||t.doc.clear(),e.id&&(t.printDropdown=_.clone(a.printDropdown,!0).filter(function(t){return t.type===e.type&&(e.sub_type?t.sub_type===e.sub_type:!0)}).map(function(t){return _objectSpread({},t,{url:function(e,n){return URL+t.url.replace(":id",n)+"."+e+(t.props?"?".concat(t.props):"")}})})),e.id||(t.doc=a.doc,t.doc.data.type=e.type),t.stateToggleShow=["sales","purchases"].includes(e.type),t.inited=!0,t.showProductPanel=!0,t.paidEditShow=!1,t.printToggle=!1,e.sub_type&&(t.doc.data.sub_type=e.sub_type),"changes"!==e.type||!["inventory","out"].includes(e.sub_type)&&e.sub_type||(S?(t.doc.data.status===!0&&"inventory"===e.sub_type&&setTimeout(function(){return o.init.remove(0)}),a.dropdown.prod_price.value=t.doc.data.price,a.doc.setProdPricesDropdownValue()):t.doc.data.price="price"),E=Object.assign({type:e.type},a.types[e.type+(a.doc.data.sub_type||"")]),t.params=E,t.dropdown=Object.assign(t.dropdown,{from:null,to:null,accounts:{name:"accounts",subtitle:{body:function(t){return n.accounts.types[t.type].title}},create:"authenticated.card.account_add",filterFunc:function(e){return t.doc.data.bank_account_pay?"bank_account"===e.type:S?!0:"register"!==e.type},"class":"floating basic fluid right labeled icon button",search:!0,icon:"content"}}),t.dropdown.from=_objectSpread({},T[E.from],{},"movements"===E.type?{title:"STORE_FROM"}:{}),E.to?t.dropdown.to=_objectSpread({},T[E.to],{},"movements"===E.type?{title:"STORE_TO"}:{}):delete t.doc.data.to,E.pay&&(a.doc.paid.constant.type=E.pay.type,a.doc.paid.constant.source=E.pay.source),i.params.fromDoc||[E.from,E.to].forEach(function(n){n&&r.method.init(n).then(function(){if(!e.id){var n=_.where(r.storage[E.from].data,{"default":!0})[0];if(t.doc.data.from._id=n?n._id:"",E.to&&"movements"!==E.type){var a=_.where(r.storage[E.to].data,{"default":!0})[0];t.doc.data.to={_id:a?a._id:null}}}t.$apply()})}),r.method.init("catalog").then(function(){t.catalogLoading=!1,t.products=r.storage.catalog,A()}).then(function(){t.$apply()})}}]),angular.module("cloudshop.catalog").config(["$stateProvider",function(t){t.state("authenticated.card.catalog",{url:"/catalog","abstract":!0,views:{"":{templateUrl:"js/pages/card/catalog/_view.html"}},data:{pageTitle:"PRODUCTS_AND_SERVICES"}}).state("authenticated.card.catalog.list",{url:"/list",templateUrl:"js/pages/catalog/_list.html",controller:"catalogCtrl",data:{pageTitle:"CATALOG",permission:"catalog"}}).state("authenticated.card.catalog.changePrices",{url:"/list/changeprices",templateUrl:"js/pages/card/catalog/price-editor/_view.html",controller:"catalogPriceChangeCtrl",data:{pageTitle:"PRICE_EDITOR",permission:"catalog"}}).state("authenticated.card.catalog.get",{url:"/get/:productId",templateUrl:"js/pages/card/catalog/show/_view.html",controller:"showCtrl",data:{pageTitle:"VIEW_PRODUCT",permission:"catalog",sidebar:!0}}).state("authenticated.card.catalog.pageHistory",{url:"/history/:productId",templateUrl:"js/pages/card/catalog/show/blocks/history.html",controller:"catalogPageHistoryCtrl",data:{pageTitle:"OPERATIONS",permission:"catalog",method:"POST",sidebar:!0,sidebarSize:"xl"}}).state("authenticated.card.catalog.scanner",{url:"/scanner/?type",templateUrl:"js/pages/card/catalog/scanner/_view.html",controller:"scannerCtrl",data:{pageTitle:"SCANNING",sidebar:!0}}).state("authenticated.card.catalog.create",{url:"/create/?type&group_id",templateUrl:"js/pages/card/catalog/form/_view.html",controller:"formCtrl",data:{pageTitle:"PRODUCT_CREATION",permission:"catalog",method:"POST",sidebar:!0}}).state("authenticated.card.catalog.groupcreate",{url:"/group-create/",templateUrl:"js/pages/card/catalog/group/form.html",controller:"catalogGroupformCtrl",data:{pageTitle:"GROUP_CREATION",permission:"catalog",method:"POST",sidebar:!0,sidebarSize:"xs"}}).state("authenticated.card.catalog.groupedit",{url:"/group-edit/:group_id",templateUrl:"js/pages/card/catalog/group/form.html",controller:"catalogGroupformCtrl",data:{pageTitle:"EDITING_A_GROUP",permission:"catalog",method:"PUT",sidebar:!0,sidebarSize:"xs"}}).state("authenticated.card.catalog.update",{url:"/update/:productId",templateUrl:"js/pages/card/catalog/form/_view.html",controller:"formCtrl",data:{pageTitle:"EDITING_PRODUCT",permission:"catalog",method:"PUT",sidebar:!0}}).state("authenticated.card.catalog.group",{url:"/group/:tab",templateUrl:"js/pages/card/catalog/group_operations/_view.html",controller:"catalogGroupCtrl",data:{pageTitle:"GROUP_OPERATIONS",permission:"catalog",sidebar:!0,sidebarSize:"l"}}).state("authenticated.card.catalog.stock",{url:"/stock/",templateUrl:"js/pages/card/catalog/stock/_view.html",controller:"catalogStockTotalCtrl",data:{pageTitle:"EVALUATION_OF_THE_STOCK",permission:"catalog",sidebar:!0}})}]),angular.module("cloudshop.company").config(["$stateProvider",function(t){t.state("authenticated.card.account_list",{url:"/accounts/",templateUrl:"js/pages/card/accounts/_list.html",controller:"accountCtrl",data:{pageTitle:"ACCOUNTS"}}).state("authenticated.card.account_show",{url:"/account/:accounts_id",templateUrl:"js/pages/card/accounts/_view.html",controller:"accountCtrl",data:{pageTitle:"ACCOUNT_PROFILE",sidebar:!0}}).state("authenticated.card.account_edit",{url:"/account/edit/:accounts_id",templateUrl:"js/pages/card/accounts/_form.html",controller:"accountEditCtrl",data:{pageTitle:"ACCOUNT_EDIT",sidebar:!0}}).state("authenticated.card.account_add",{url:"/account/add/",templateUrl:"js/pages/card/accounts/_form.html",controller:"accountEditCtrl",data:{pageTitle:"CREATE_NEW_ACCOUNT",sidebar:!0}})}]),angular.module("cloudshop.company").controller("accountEditCtrl",["$scope","companyService","api","modalService","$state","db","apiRouteService",function(t,e,n,r,a,o,i){function c(){return s.apply(this,arguments)}function s(){return s=_asyncToGenerator(regeneratorRuntime.mark(function n(){var a,o,c,s,u;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return t.loading=!0,a=d?"update":"create",r.method.disable(0),n.prev=3,n.next=6,e.accounts[a](t.data);case 6:if(o=n.sent,c=o.data.data,t.data.balance=t.data.balance||{balance:0},s=t.data.balance.balance-l,0==s){n.next=14;break}return u={date:+moment().format("X"),type:s>0?"debit":"credit",source:300,store:c._id,sum:Math.abs(s),status:!0},n.next=14,i.order().add(u);case 14:r.method.close(),n.next=20;break;case 17:n.prev=17,n.t0=n["catch"](3),r.method.enable(0);case 20:return n.prev=20,t.$apply(),n.finish(20);case 23:case"end":return n.stop()}},n,null,[[3,17,20,23]])})),s.apply(this,arguments)}function u(){d&&(t.loading=!0,o.method.init("accounts").then(function(e){t.data=p(e[0].find(function(t){return t._id===d})),l=_.clone(t.data.balance.balance,!0)||0,t.loading=!1,t.$apply()}))}var d=a.params.accounts_id,l=0;t.data={type:"bank_account",bank_details:[{key:"",value:""}],balance:{balance:0}},t.types=_.map(e.accounts.types),t.loading=!1,t.page=a.current.data,t.history={query:{store:d}},t.$watch("data.type",function(e){t.data.use_terminal&&e&&"bank_account"!=e&&delete t.data.use_terminal}),t.$watch("form.$valid",function(t){r.method.toggle([0],t)}),t.$on("$destroy",function(){r.init.remove()}),r.method.add([{title:"SAVE",className:"green",active:!0,action:c,visible:!0}]);var p=function(t){return _.clone(_objectSpread({bank_details:[{key:"",value:""}]},t),!0)};u()}]),angular.module("cloudshop.company").controller("accountCtrl",["$scope","$rootScope","db","companyService","api","modalService","$state",function(t,e,n,r,a,o,i){function c(t){return s.apply(this,arguments)}function s(){return s=_asyncToGenerator(regeneratorRuntime.mark(function t(e){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,r.accounts.remove(e||r.accounts.data);case 3:o.method.close(),t.next=8;break;case 6:t.prev=6,t.t0=t["catch"](0);case 8:return t.prev=8,t.finish(8);case 10:case"end":return t.stop()}},t,null,[[0,6,8,10]])})),s.apply(this,arguments)}t.db=n,t.accounts=r.accounts;var u=i.params.accounts_id;t.page=i.current.data,t.history={query:{store:u}},t.$on("$destroy",function(){o.init.remove(),r.accounts.data={}}),e.$on("WS_UPDATE_ACCOUNTS",function(){t.$apply()}),t.total=function(){return _.sum(n.storage.accounts.data.filter(function(t){return t.include}),"balance.balance")},t.remove=c,o.method.add([{title:"EDIT",className:"green",active:!1,action:{url:"authenticated.card.account_edit",param:{accounts_id:u}},visible:!!u},{title:"DELETE",className:"red","float":"right",active:!1,action:c,visible:!!u,perm:["suppliers","DELETE"]}]);var d=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function a(){var e,i,c;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return t.loading=!0,a.prev=1,a.next=4,n.method.init("accounts");case 4:e=a.sent,i=_slicedToArray(e,1),c=i[0],u&&(r.accounts.data=c.find(function(t){return t._id===u}),r.accounts.data&&o.method.toggle([0,1],r.accounts.types[r.accounts.data.type].edit)),a.next=12;break;case 10:a.prev=10,a.t0=a["catch"](1);case 12:return a.prev=12,t.loading=!1,t.$apply(),a.finish(12);case 16:case"end":return a.stop()}},a,null,[[1,10,12,16]])}));return function(){return e.apply(this,arguments)}}();d()}]),angular.module("cloudshop").directive("menuLabel",["localStorageService","$rootScope","$state",function(t,e,n){return{restrict:"C",link:function(r,a){var o=t.get("menu-reports-new-label");if("reports"===r.$parent.item.id&&!o){a[0].classList.add("menu-label--show");var i=function(){t.set("menu-reports-new-label",1),a[0].classList.remove("menu-label--show")};"authenticated.card.reports"===n.current.name&&i(),e.$on("$stateChangeSuccess",function(t,e,n){"authenticated.card.reports"===e.name&&i()})}}}}]),angular.module("cloudshop").directive("mainMenu",["$timeout",function(t){return{restrict:"C",link:function(e,n){function r(){$(".item-block").each(function(){var t=$(this).hasClass("active");$("i.caret",this).toggleClass("up",t).toggleClass("down",!t)})}$(n).on("click","div.item",function(t){t.preventDefault();var e=$(this).parent();$(".item-block.active",n).removeClass("active"),$(e).addClass("active");var a=$(this).next(".menu").find("a:first");a&&a.click(),r()}),t(function(){r()})}}}]).directive("mainMenu",["$rootScope",function(t){return{restrict:"C",link:function(e,n){var r,a=function(){$(n).on("mouseenter",".item-block",i).on("mouseleave",".item-block",c)},o=function(){$(n).off("mouseenter",".item-block",i).off("mouseleave",".item-block",c)},i=function(){var t=$(this).find(".menu:not(.ng-hide)");t.length&&(r=$(t).clone(!0),$("body").append(r),r.addClass("smallMenuSub").css({top:$(this).offset().top,left:60}).on("mouseleave",function(){$(this).remove()}).on("click",function(){$(this).remove()}))},c=function(){r&&r.is(":hover")===!1&&r.remove()};t.$watch("body_smallMenu",function(t,e){e!==t&&(t?a():o())}),t.body_smallMenu&&a()}}}]),angular.module("cloudshop").controller("MenuCtrl",["$rootScope","$scope","localStorageService","api","docService","$state","profile","authenticator","CONFIG",function(t,e,n,r,a,o,i,c,s){function u(){var t=r.user.company(),n=!t.country||!t.currency_iso;e.menu=[{id:"start",title:"LETS_START",url:"authenticated.start",icon:"rocket",roles:["owner"],hidden:"trial"!==r.user.getTarif().tarif_type,className:["blue"]},{id:"dashboard",title:"DASHBOARD",url:"authenticated.dashboard",icon:"grid layout",permission:"dashboard"},{id:"catalog",title:"PRODUCTS_AND_SERVICES",icon:"cube",url:"authenticated.card.catalog.list",permission:"catalog"},{id:"registers",title:"REGISTERS_AND_SHIFTS",icon:"inbox",permission:"reports",sub:[{title:"SHIFTS",url:"authenticated.card.register.shift",permission:"shifts"},{title:"REGISTERS",url:"authenticated.card.register.cash",permission:"registers"},{title:"APP_DOWNLOAD",url:"authenticated.card.register.download",className:["active","blue"]}]},{id:"journal",title:"OPERATIONS",icon:"refresh",url:"authenticated.card.journal"},{id:"money",title:"TRANSACTIONS",icon:"dollar",permission:"money",url:"authenticated.card.money"},{id:"reports",title:"REPORTS",icon:"area chart",permission:"reports",url:"authenticated.card.reports"},{id:"contragents",title:"AGENTS",icon:"user",sub:[{title:"SUPPLIERS",url:"authenticated.card.supplier",permission:"suppliers"},{title:"CLIENTS",url:"authenticated.card.clients",permission:"clients"}]},{id:"company",title:"COMPANY",icon:"users",permission:"reports",className:n?["warning"]:[],sub:[{title:"SETTINGS",url:"authenticated.card.company.settings.main"},{title:"EMPLOYEES",url:"authenticated.card.company.staff"},{title:"STORES",url:"authenticated.card.company.stores"},{title:"ACCOUNTS",url:"authenticated.card.company.accounts"},{title:"DISCOUNTS",url:"authenticated.card.company.discounts"},{title:"PRINT_TEMPLATES",url:"authenticated.card.doc_print_templates"}]},{id:"ecommerce",title:"ECOMMERCE",icon:"world",permission:"reports",hidden:!(r.user.positions().settings.ecommerce&&r.user.positions().settings.ecommerce.status),sub:[{title:"SETTINGS",url:"authenticated.card.ecommerce.settings.domain",hidden:!(r.user.positions().settings.ecommerce&&r.user.positions().settings.ecommerce.status)},{url:"authenticated.card.ecommerce.theme",hidden:!(r.user.positions().settings.ecommerce&&r.user.positions().settings.ecommerce.status)},{url:"authenticated.card.ecommerce.start",hidden:r.user.positions().settings.ecommerce&&r.user.positions().settings.ecommerce.status}]},{id:"integration",title:"INTEGRATION",url:"authenticated.card.marketplace.list",icon:"attach",hidden:!s.integration_menu,permission:"dashboard"},{id:"yandex",title:"Реклама бизнеса",icon:"yandex",url:"authenticated.card.yandex",hidden:!s.yandexPartner},{id:"payment",title:"TARIFFS_AND_PAYMENT",url:"authenticated.payment",icon:"gift",roles:["owner"],className:0===r.user.positions().tarif.price?["orange"]:[]},{id:"trash",title:"TRASH",url:"authenticated.card.trash",icon:"trash alternate outline",permission:"suppliers",method:"POST",className:["trash"]}].filter(function(t){return Array.isArray(t.roles)?t.roles.includes(r.user.positions().type):!0}).filter(function(t){return t.sub&&(t.sub=t.sub.filter(function(t){return i.permission(t)})),i.permission(t)}).map(function(t){return t.sub&&(_.forEach(t.sub,function(e){e.url==o.current.name&&("object"!=_typeof(t.className)&&(t.className=[]),t.className.push("active")),e.title||(e.title=o.get(e.url).data.pageTitle)}),t.sub=t.sub.filter(function(t){return i.permission(t)})),t})}function d(){u(),"true"==n.cookie.get("smallMenu")&&e.toggleMenu(),r.user.profile().then(function(){e.user=r.user,e.userType=i.types[r.user.positions().type].title,e.$apply()})}e.authenticator=c,e.$state=o,e.bottomLinks=s.menuBottomLinks,e.menu=[],e.newDocument={d:_.map(a.types,function(t){return{title:t.title,url:t.url,active:t.active}}).filter(function(t){try{return t.active&&i.permission(o.get(t.url).data)}catch(e){console.warn("ERROR",e),console.warn("ERROR@",t,t.url,o.get(t.url))}}).filter(function(t){return t.active}),p:[{title:"INCOME",url:"authenticated.card.pay_create.cash_parish"},{title:"EXPENSE",url:"authenticated.card.pay_create.cash_outflow"},{title:"REMITTANCE",url:"authenticated.card.pay_create.cash_transfer"}]},e.toggleMenu=function(){t.body_smallMenu=!t.body_smallMenu,n.cookie.set("smallMenu",t.body_smallMenu)},e.toggleSubMenu=function(t,n){e.menu.map(function(t){return t.active=!t.active&&n.$parent.item.$$hashKey==t.$$hashKey,t})},t.$on("updateMenu",function(){u()}),d()}]),angular.module("cloudshop.account",[]).config(["$stateProvider",function(t){t.state("anonymous.login",{url:"/login/?action",templateUrl:"js/pages/account/login/_view.html",controller:"loginCtrl",data:{pageTitle:"LOG_IN_CLOUDSHOP"}}).state("anonymous.register",{url:"/register/?_partner",templateUrl:"js/pages/account/register/_view.html",controller:"registerCtrl",data:{pageTitle:"REGISTRATION_IN_CLOUDSHOP"}}).state("anonymous.passwordReset",{url:"/reset/",templateUrl:"js/pages/account/passwordReset/view.html",controller:"passwordResetCtrl",data:{pageTitle:"PASSWORD_RECOVERY_IN_CLOUDSHOP"}}).state("anonymous.passwordResetSuccess",{url:"/reset-success-letter/",templateUrl:"js/pages/account/passwordReset/success-letter.html",data:{pageTitle:"CHECK_MAIL"}}).state("anonymous.passwordChangeSuccess",{url:"/reset-success-change/",templateUrl:"js/pages/account/passwordReset/success-change.html",data:{pageTitle:"PASSWORD_SUCCESSFULLY_CHANGED"}}).state("anonymous.passwordResetError",{url:"/reset-error/",templateUrl:"js/pages/account/passwordReset/error.html",data:{pageTitle:"ERROR"}}).state("anonymous.changePassword",{url:"/new-password/:code/:email",templateUrl:"js/pages/account/passwordReset/new-password.html",controller:"changePasswordCtrl",data:{pageTitle:"CHANGE_PASSWORD"}}).state("authenticated.card.permission_denied",{url:"/permission-denied/",templateUrl:"js/pages/account/permission/_view.html",
data:{pageTitle:"ACCESS_DENIED"}})}]),angular.module("cloudshop.account").controller("registerCtrl",["$scope","$filter","api","localStorageService","$rootScope","$state","defaultState","$location","fn","CONFIG","db","$http",function(t,e,n,r,a,o,i,c,s,u,d,l){t.logoStyle={"background-image":"url(/images/logo-blue-".concat(u.name,".svg)")},t.error=null,t.errors={},t.data={promo_code:""},t.loading=!1,t.licence=!0,t.register=_asyncToGenerator(regeneratorRuntime.mark(function m(){var i,c,s,d,l;return regeneratorRuntime.wrap(function(p){for(;;)switch(p.prev=p.next){case 0:if(t.error=null,!t.form.$valid){p.next=32;break}return t.loading=!0,t.data.referrer=window.location.search.replace("?",""),t.data.phone===u.phone_prefix&&(t.data.phone=""),t.data.roistat=null===(i=window.roistat)||void 0===i?void 0:i.getVisit(),c=_objectSpread({},t.data),c.country&&(c.country="country_".concat(c.country)),s=o.params._partner||u.partner,s&&(c=_objectSpread({},c,{_partner:s,_link:!0})),p.prev=10,p.next=13,n.user.register(c);case 13:if(d=p.sent,!d.data.error){p.next=16;break}throw d.data.error;case 16:try{yaCounter21370750.reachGoal("signup")}catch(m){}r.set("email",t.email),r.cookie.set("auth",!0),o.go("authenticated.start",{signup:!0}),setTimeout(function(){return a.$broadcast("DB.REGISTRATION",{name:t.name,email:t.email})},2e3),p.next=28;break;case 23:p.prev=23,p.t0=p["catch"](10),l=[],600==p.t0?l.push(e("translate")("A_USER_WITH_THIS_EMAIL_ALREADY_EXISTS")):605==p.t0?l.push(e("translate")("USER_WITH_THIS_PHONE_NUMBER_ALREADY_EXIS")):l.push(e("translate")("AN_ERROR_HAS_OCCURRED")),t.error=l.join("<br>");case 28:return p.prev=28,t.loading=!1,t.$apply(),p.finish(28);case 32:case"end":return p.stop()}},m,null,[[10,23,28,32]])})),t.dropdown={country:{placeholder:"COUNTRY",name:[],"class":"basic",limit:300,search:!0,icon:"dropdown"},currency:{placeholder:"CURRENCY",name:[],"class":"basic",limit:300,search:!0,icon:"dropdown"}};var p=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(){var e,r,a,o,i,p,m,f,h,g,v,y,b;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return e=c.$$search,e.name&&(t.data.name=e.name),e.email&&(t.data.email=e.email),e.phone?t.data.phone=e.phone:t.data.phone=u.phone_prefix,r=e.promo_code||s.getCookie("promo_code"),r&&(t.promocode=!0,t.data.promo_code=r),n.next=8,d.method.init("countries");case 8:if(a=n.sent,o=_slicedToArray(a,1),i=o[0],p={},i.forEach(function(t){t.currencies.forEach(function(t){[null,"(none)"].includes(t.code)||(p[t.code]=t)})}),m=Object.values(p).map(function(t){return{name:t.name,_id:t.code,description:t.symbol}}),t.dropdown.currency.name=_.sortBy(m,"name"),t.dropdown.country.name=i.map(function(t){return{name:t.nativeName,_id:t.alpha2Code}}),f=localStorage.getItem("country"),h=localStorage.getItem("currency"),f&&h){n.next=37;break}return n.prev=19,n.next=22,l.get("https://api.ipregistry.co/?key=c9ealxyl9jiuo7xb");case 22:g=n.sent,v=g.data,y=v.currency,b=v.location.country,t.data.country=b.code,t.data.currency=y.code,localStorage.setItem("country",b.code),localStorage.setItem("currency",y.code),n.next=35;break;case 32:n.prev=32,n.t0=n["catch"](19),console.warn(n.t0);case 35:n.next=39;break;case 37:t.data.country=f,t.data.currency=h;case 39:case"end":return n.stop()}},n,null,[[19,32]])}));return function(){return e.apply(this,arguments)}}();p()}]),angular.module("cloudshop.account").controller("passwordResetCtrl",["$rootScope","$scope","authenticator","$stateParams","localStorageService","defaultState","$state","db","api",function(t,e,n,r,a,o,i,c,s){e.loading=!1,e.error=!1,e.errors={},e.email=a.get("email"),e.reset=function(){s.user.start=!1,e.errors.email=!e.email,e.email&&(e.loading=!0,e.error=!1,n.reset({email:e.email}).then(function(t){var e=t.data;return e}).then(u)["catch"](d).then(function(){e.loading=!1,e.$apply()}))};var u=function(){i.go("anonymous.passwordResetSuccess")},d=function(t){var n=t.data;e.error=n.error}}]).controller("changePasswordCtrl",["$scope","api","$state",function(t,e,n){var r=n.params.code;t.loading=!1,t.error=!1,t.errors={},t.send=function(){var a=t.pass,o=t.pass2;return a!==o?(t.errors.pass2=!0,void(t.error=1)):a.length<4?void(t.error=2):(t.loading=!0,void e.data.post("/restore-password-s2",{code:r,password:a,v:"v3"}).then(function(){n.go("anonymous.passwordChangeSuccess")})["catch"](function(e){var n=e.data;t.error=n.error}))}}]),angular.module("cloudshop.account").controller("loginCtrl",["$rootScope","$scope","authenticator","$stateParams","localStorageService","defaultState","$state","db","api","CONFIG",function(t,e,n,r,a,o,i,c,s,u){e.logoStyle={"background-image":"url(/images/logo-blue-".concat(u.name,".svg)")},e.loading=!1,e.showError=!1,e.errors={};var d=a.get("user");e.users=a.get("users")||[],e.users.length?(e.user=e.users.filter(function(t){return t.active})[0],e.login=e.user.email,d&&a.remove("user")):d&&(e.user=d,e.users=[d],e.login=e.user.email),e.email=a.get("email"),e.password="",e.unsetUser=function(){e.user={}},e.selectUser=function(){e.user=this.item,e.login=this.item.email},e.auth=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function r(t,o){var i,c;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(s.user.start=!1,e.errors.login=!e.login,e.errors.password=!e.password,i={login:t||e.login,password:o||e.password},!i.login||!i.password){r.next=21;break}return e.loading=!0,e.showError=!1,r.prev=7,r.next=10,n.login(i);case 10:c=r.sent,t&&a.set("qrcode_auth",1),e._loginSuccess(c),r.next=18;break;case 15:r.prev=15,r.t0=r["catch"](7),e.showError=!0;case 18:return r.prev=18,e.loading=!1,r.finish(18);case 21:case"end":return r.stop()}},r,null,[[7,15,18,21]])}));return function(e,n){return t.apply(this,arguments)}}(),e._loginSuccess=function(n){var r=n.data.data[0];if(n.data.status){a.set("email",e.login),a.cookie.set("auth",!0),s.user.start=!0,s.user.auth=!0,s.user.data=r;var o=(a.get("users")||[]).filter(function(t){return t.id!==s.user.data._id}).map(function(t){return t.active=!1,t});o.push({id:s.user.data._id,name:s.user.data.name,email:s.user.data.email,pic:s.user.data.pic,active:!0}),a.set("users",o),t.$broadcast("AUTH.SUCCEEDED",r),setTimeout(function(){try{var t=a.get("referer");if(!(t&&t.state.name.indexOf("authenticated")>-1&&"authenticated.card.permission_denied"!==t.state.name))throw"";i.go(t.state.name,t.params,{absolute:!0})}catch(e){i.go("authenticated.dashboard")}},100)}},e.$QRsize=200,e.$on("$destroy",function(){}),t.$on("AUTH.QR.RESP",function(t,n){e.$QRcode=n,e.$apply()}),t.$on("AUTH.QR.SUCCEEDED",function(t,n){e.auth(n.login,n.password),e.$apply()}),t.$broadcast("AUTH.QR")}]).run(["$rootScope","localStorageService",function(t,e){+e.get("qrcode_auth")&&t.$on("METRICS_INIT",function(){e.set("qrcode_auth",0),t.$broadcast("METRICS_EVENT",{type:"authQRCodeLogin",payload:{type:"QRCodeAuth"}})})}]),angular.module("social.vk",[]),angular.module("social.vk").service("vkService",["$http",function(t){var e=this;e.init=function(){}}]),angular.module("cloudshop").service("metricsService",["api","CONFIG","$rootScope",function(t,e,n){var r=this;this.parse={doc:{state:function(){},init:function(t){return t}},reports:{types:{"authenticated.card.reports_product":"SALES_BY_PRODUCT__SERVICES","authenticated.card.reports_categories":"SALES_BY_CATEGORY","authenticated.card.reports_set":"SALES_BY_SETS","authenticated.card.reports_day":"SALES_BY_DAYS","authenticated.card.reports_week":"SALES_BY_WEEKS","authenticated.card.reports_month":"SALES_BY_MONTHS","authenticated.card.reports_motion":"MOVEMENT_OF_GOODS","authenticated.card.reports_agent":"CUSTOMERS__SUPPLIERS","authenticated.card.reports_finance":"FINANCIAL_REPORT","authenticated.card.reports_staff":"STAFF_REPORT"},state:function(t,e){return t.name.includes(".modal.")&&(t.name=t.name.replace(/\.modal.+/,"")),this.types[t.name]}}},this.metrics=new Metrics({url:e.metrics_link}),this.init=_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.user.profile();case 2:e.metrics.active&&(r.metrics.init({user_id:t.user.data._id,client_id:t.user.positions()._id}),n.$broadcast("METRICS_INIT"));case 3:case"end":return a.stop()}},a)})),this.track=function(){if(e.metrics.active){var t;(t=r.metrics).track.apply(t,arguments)}}}]).run(["metricsService","$rootScope","CONFIG",function(t,e,n){e.$on("AUTH.SUCCEEDED",function(){t.init().then(function(){})}),e.$on("docs.create",function(e,n){t.track("createDocument",{type:n.type+(n.sub_type?"_".concat(n.sub_type):""),state:n.stateName||null,status:n.status,lines:n.products.length,sum:n.sum,discount:n.discount_sum,savePrint:!!n.print,pastedExcel:n.pastedExcel,barcodeScann:!1,onlineKassa:!1})}),e.$on("catalog.create",function(e,n){t.track("createProduct",n)}),e.$on("METRICS_EVENT",function(e,n){t.track(n.type,n.payload)}),e.$on("catalog.import",function(e,n){var r=n.created,a=n.updated;t.track("catalogImport",{created:r.length,updated:a.length})}),e.$on("DB.CATALOG.SUCCEEDED",function(t,e){var r=e.length;try{window[n.messenger.name].identify([{op:"update_or_create",key:"catalog",value:r}])}catch(t){}}),e.$on("DB.STORES.SUCCEEDED",function(t,e){var r=e.length;try{window[n.messenger.name].identify([{op:"update_or_create",key:"stores",value:r}])}catch(t){}}),e.$on("DB.STAFF.SUCCEEDED",function(t,e){try{window[n.messenger.name].identify([{op:"update_or_create",key:"staff",value:e.filter(function(t){return!t.deleted}).length}])}catch(t){}}),e.$on("AUTH.SUCCEEDED",function(t,e){try{window[n.messenger.name].auth(e._id,e.messenger_hash),window[n.messenger.name].identify({$email:e.email,$name:e.name})}catch(t){console.warn(t)}}),e.$on("DB.REGISTRATION",function(t,e){try{window[n.messenger.name].track("$registered",{$email:e.email,$name:e.name})}catch(t){console.warn(t)}})}]),angular.module("cloudshop.yandex",[]).config(["$stateProvider",function(t){t.state("authenticated.card.yandex",{url:"/yandex",templateUrl:"js/pages/yandex/index.html",data:{pageTitle:"Яндекс.Бизнес"}})}]),angular.module("cloudshop.yandex").directive("yandexContainer",["api",function(t){return{restrict:"E",replace:!0,template:"<div></div>",link:function(e,n){window.YaPartnerWidget.init({container:n[0],partnerName:"cloudshop",partnerSiteId:t.user.company().created,products:["subscription"],companySearchText:"123"})}}}]),angular.module("cloudshop.trash",[]).config(["$stateProvider",function(t){t.state("authenticated.card.trash",{url:"/trash/:category",templateUrl:"js/pages/trash/_list.html",controller:"trashCtrl",data:{pageTitle:"TRASH",permission:"suppliers",method:"POST"}})}]),angular.module("cloudshop.trash").service("trashService",["api","$rootScope","dateRange","alertModal",function(t,e,n,r){var a=this;a.defaultTab="catalog",a.activeTab="",a.data=[],a.empty=!1,a.loading=!1,a.showCount=30,a.get=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(e,r){var o,i,c,s,u,d,l;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return o=r.offset,i=r.limit,c=a.filter.date.value,s=c.start,u=c.end,d="/data/:client/".concat(e,"?deleted=true&offset=").concat(o,"&limit=").concat(i,"&updated_start=").concat(s,"&updated_end=").concat(u),"catalog"===e&&(d+=["inventory","service","set"].map(function(t){return"&types[]=".concat(t)}).join("")),n.next=6,t.data.get(d,{v:"v3"});case 6:return l=n.sent,n.abrupt("return",l);case 8:case"end":return n.stop()}},n)}));return function(t,n){return e.apply(this,arguments)}}(),a.object={catalog:{name:"catalog",started:!1,total:0,loaded:0,data:[],query:{offset:0,limit:20},title:"PRODUCTS_AND_SERVICES",init:function(){return a.get(this.name,this.query)}},suppliers:{name:"suppliers",started:!1,total:0,loaded:0,data:[],query:{offset:0,limit:20},title:"SUPPLIERS",init:function(){return a.get(this.name,this.query)}},clients:{name:"clients",started:!1,total:0,loaded:0,data:[],query:{offset:0,limit:20},title:"CLIENTS",init:function(){return a.get(this.name,this.query)}},stores:{name:"stores",started:!1,total:0,loaded:0,data:[],query:{offset:0,limit:20},title:"ACCOUNTS__STORES",init:function(){return a.get(this.name,this.query)}}},a.restore=_asyncToGenerator(regeneratorRuntime.mark(function o(){var n,i,c,s,u;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return n="catalog"===a.activeTab,i=a.object[a.activeTab],c=i.data.filter(function(t){return t.restore}).map(function(t){var e=(t.restore,_objectWithoutProperties(t,["restore"]));return _objectSpread({},e,{deleted:!1,updated:parseInt(new Date/1e3,10)})}),s=c.map(function(t){return _objectSpread({_id:t._id,name:t.name,deleted:!1},n?{id_group:0}:{})}),o.prev=4,o.next=7,t.data.put("/data/:client/"+a.activeTab+"/import",_objectSpread({},s,{v:"v3"}));case 7:return u=o.sent,i.data=i.data.filter(function(t){return!t.restore}),a.data=i.data,console.warn("restoreData",c),n&&e.$broadcast("catalog.update",c),o.abrupt("return",u);case 15:o.prev=15,o.t0=o["catch"](4),r("AN_ERROR_OCCURRED_WHILE_CREATING_THE_DOC");case 18:case"end":return o.stop()}},o,null,[[4,15]])})),a.filter={date:{value:{start:0,end:moment().format("X")},values:n.date,init:function(){return a.init(a.activeTab)},apply:function(t){var e=t.range();return _.forEach(a.object,function(t){t.started=!1}),this.value.start=e.from.format("X"),this.value.end=e.to.format("X"),this.init()}}},a.selected=function(){return _.where(a.data,{restore:!0}).length},a.append=function(){var t=a.object[a.activeTab];t.query.offset+=t.query.limit,a.init(a.activeTab,!0)},a.init=function(t,n){n=!!n,a.activeTab=t||a.defaultTab;var r=a.object[a.activeTab];return!n&&(a.data=[],a.empty=!1,r.started)?(a.data=r.data,a.data.length||(a.empty=!0),!1):(a.loading=n?"append":"start",void r.init().then(function(t){a.loading=!1,n?r.data=r.data.concat(t.data.data):r.data=t.data.data,a.data=r.data,r.total=t.data.total,r.total>0&&(r.loaded+=r.query.limit),0==r.total&&(a.empty=!0),e.$apply()}))}}]),angular.module("cloudshop.supplier").controller("trashCtrl",["$scope","db","$state","trashService",function(t,e,n,r){function a(){t.trash.init()}t.trash=r,t.type="catalog",t.objects=_.map(r.object,function(t){return{name:t.name,title:t.title}}),t.$on("$destroy",function(){}),a()}]),angular.module("cloudshop.supplier").controller("suppliersCtrl",["$scope","db","profile","$rootScope","$filter",function(t,e,n,r,a){function o(){e.method.get("suppliers").then(function(e){t.data=e,t.loaded=!0,0==e.length&&(t.error=!0),c(t.sorting),t.$apply()})}t.data=[],t.pagination={currentPage:1,pageSize:50},t.filter={search:""},t.sorting={field:"name",reverse:!1},t.columnSettings={save:function(){console.warn("save")},list:{phones:{label:a("translate")("PHONE"),active:!0,sorting:!1},emails:{label:a("translate")("EMAIL"),active:!0,sorting:!1},"address.legal":{label:a("translate")("ADDRESS"),active:!0,sorting:!1},created:{label:a("translate")("CREATED"),active:!0,sorting:!1}}},t.buttons={create:n.permission(["suppliers","POST"]),"export":"owner"===n.getType()};var i=function(n){if("undefined"==typeof n)return!1;var r=n.toLowerCase(),a=["name","description","phones","emails"];t.data=e.storage.suppliers.data.filter(function(t){var e=!1;return a.map(function(n){var a=(JSON.stringify(t[n])||"").toLowerCase();a.includes(r)&&(e=!0)}),e})};t.$watch("filter.search",i);var c=function(e){var n=function(t){return _.get(t,e.field)};t.data=_.sortByOrder(t.data,n,[e.reverse?"desc":"asc"])};t.$watch("sorting",function(t,e){_.isEqual(t,e)===!1&&c(t)},!0);var s=r.$on("WS_UPDATE",function(n,r){"suppliers"==r.meta.type&&(t.filter.search?i(t.filter.search):t.data=e.storage.suppliers.data,t.$apply())});t.$on("$destroy",function(){s()}),t.buildForXSLX=function(){var e=[[]],n=["CREATED","DEFAULT","NAME","PHONES","EMAIL","ACTUAL_ADDRESS","LEGAL_ADDRESS","BANK_DETAILS","REQUISITES_OF_ORGANIZATION","WWW","DESCRIPTION"].map(function(t){return a("translate")(t)});e.push(n);var r=t.data.map(function(t){return[moment(t.created,"X").format("DD/MM/YYYY HH:mm"),t["default"]?"1":"-",t.name,t.phones?t.phones.join(", "):"-",t.emails?t.emails.join(", "):"-",t.address?t.address.actual||"-":"-",t.address?t.address.legal||"-":"-",(t.bank_details||[]).filter(function(t){return t.key}).map(function(t){return t.key+":"+t.value}).join("\n"),(t.details||[]).filter(function(t){return t.key}).map(function(t){return t.key+":"+t.value}).join("\n"),t.web||"-",t.description||"-"]});return r[0].forEach(function(t){e[0].push(_typeof(t))}),e.concat(r)},o()}]),angular.module("cloudshop.reports").service("reports",["$rootScope","$state","$filter","paginator","api","payService",function(t,e,n,r,a,o){var i=this,c=this,s=n("translate");this.filter_query={},this.settings={view:"table"},this.fields={name:"NAME",barcode:"BARCODE",sku:"SKU",staff_name:"EMPLOYEE",revenue:"REVENUE",profit:"GROSS_PROFIT",cost:"SALE_COST",cost_return_sales:"REFUND_COST",sales:"SALES",return_sales:"SALES_RETURN",count:"SALED",margin:"MARGINALITY",rent:"PROFITABILITY",sales_count:"SALES",avg:"AVERAGE_TICKET",average_price:"AVERAGE_PRICE",return_sales_count:"SALES_RETURN",sales_sum:"SALES_SUM",debit_sum:"INCOMES_AMOUNT",credit_sum:"EXPENSES_AMOUNT",purchases_count:"PURCHASES",return_purchases_count:"RETURN_PURCHASES",purchases_sum:"PURCHASES_SUM",return_purchases_sum:"PURCHASES_REFUND_SUM",return_sales_sum:"REFUND_SUM",qty_before:"INITIAL_RESIDUES",movs_in:"INCOME",movs_out:"EXPENSE",qty_after:"ENDING_BALANCE",discount_sum:"DISCOUNTS_AMOUNT",avg_product_check:"AVERAGE_NUMBER_OF_ITEMS_PER_CHECK"},this.filter=[{_id:"date",name:"DATE",type:"date",value:[+moment().subtract(60,"days").startOf("day").format("X"),+moment().endOf("day").format("X")],required:!0}];var u=function(t,e,n){for(var r=t.startOf("day"),a=e.endOf("day"),o=[r.format("X")];r.add(1,n).diff(a)<0;)o.push(r.clone().format("X"));return o};this.chart={build:function(t){var e=[];return t=t.sort(function(t,e){var n;return n=t.staff_name?t.staff_name.sort>e.staff_name.sort:t.name.sort>e.name.sort,n?1:-1}),_.forEach(t,function(t,n){delete t.$$hashKey,_.forEach(t,function(r,a){r.chart&&(e[n]=e[n]||[],e[n].push(Object.assign({x:_.where(t,{label:!0})[0].title,y:+r.sort.toFixed(2)||0,type:r.type||"bar",text:s(c.fields[a])},r.chart)))})}),e}},this.sort={reverse:{},fieldName:"profit",init:function(){var t=this;if("table"!=c.methods.current().view)return!1;"undefined"==typeof this.reverse[this.fieldName]?(this.reverse={},this.reverse[this.fieldName]=!0):this.reverse[this.fieldName]=!this.reverse[this.fieldName];var e=function(e){return t.reverse[t.fieldName]?e:-1*e},n=function(t,n){return t>n?e(-1):t==n?0:e(1)},a="name";"Staff"===c.methods.current().name?("profit"===this.fieldName&&(this.fieldName="sales_count"),a="staff_name"):"SetSales"===c.methods.current().name&&"profit"===this.fieldName&&(this.fieldName="revenue");var o=(r.data.filtered||[]).sort(function(e,r){var o;if(e[a].group&&r[a].group||!e[a].group&&!r[a].group){var i=n(e[t.fieldName].sort,r[t.fieldName].sort);o=i}else e[a].group?o=-1:r[a].group&&(o=1);return o});r.data.filtered=o},field:function(t){this.fieldName=t,this.init(),r.method.init(!0)},destroy:function(){this.fieldName="profit",this.reverse={}}},this.search={data:[],init:function(t){return 0==this.data.length&&(this.data=_.clone(r.data.filtered,!0)),r.data.filtered=c.methods.progress(n("filter")(this.data,t)),r.method.init(!0),r.data.filtered},destroy:function(){this.data=[]}};var d={period:{icon:"calendar outline",view:"table",views:[{id:"table",icon:"list layout"},{id:"chart",icon:"area chart"}],helpText:{revenue:"SALES_SUM_WITHOUT_REFUNDS_FOR_THE_CUSTOM",profit:"REVENUE_WITHOUT_COST_OF_SALES",sales:"NUMBER_OF_PRODUCT_SALES",margin:"GROSS_PROFIT_DIVIDED_BY_THE_REVENUE",rent:"GROSS_PROFIT_DIVIDED_BY_THE_COST"},changeView:function(t){this.view=t,"chart"==this.view&&(this.chartData=c.chart.build(r.data.filtered))},print:{template:"/js/pages/reports/print/simple.html",data:function(){var t=_.clone(c.filter_query,!0),e="D MMMM YYYY";return c.methods.current().params&&"month"==c.methods.current().params.type&&(e="MMMM YYYY"),t.start=moment(t.start,"X").format(e),t.end=moment(t.end,"X").format(e),{title:c.methods.current().title.replace(/(<.*?>)/,""),filter:t,head:_.map(r.data.filtered[0],function(t,e){return t.hide||s(c.fields[e])}).filter(function(t){return t!==!0}),data:r.data.filtered}}},"export":function(){var t=r.data.filtered.map(function(t){return _.filter(t,function(t){return!t.hide}).map(function(t,e){var n;return n=0==e?t.title:t.sort})});return t.unshift(_.map(r.data.filtered[0],function(t,e){return t.hide||s(c.fields[e])}).filter(function(t){return t!==!0})),t.unshift(t[1].map(function(t){return _typeof(t)})),t},format:function(t){var e=this;return c.sort.fieldName="name",t=e.f.addEmptyFields(t),t.map(function(r,a){var o=e.f.date(r,a,t.length),i=e.f.name(r,a,t.length),s=r.sales.cost-r.return_sales.cost,u=r.sales.sum-r.return_sales.sum,d=s?r.profit/s:0,l=u?r.profit/u:0;return{name:{label:!0,sort:+o.format("X"),title:i},sales_sum:{sort:+r.sales.sum||0,title:n("number")(r.sales.sum,2)},return_sales_sum:{sort:+r.return_sales.sum||0,title:n("number")(r.return_sales.sum,2)},cost:{chart:{},sort:+r.sales.cost||0,title:n("number")(r.sales.cost,2)},cost_return_sales:{chart:{},sort:+r.return_sales.cost||0,title:n("number")(r.return_sales.cost,2)},profit:{chart:{},sort:+r.profit||0,title:n("number")(r.profit,2)},sales:{link:{exportQuery:!0,params:{start:function(){return o.startOf(c.methods.current().api.params.group).format("X")},end:function(){return o.endOf(c.methods.current().api.params.group).format("X")}},url:"authenticated.card.sidebar_journal"},sort:+r.sales.count||0,title:+r.sales.count},return_sales:{link:{exportQuery:!0,params:{start:function(){return o.startOf(c.methods.current().api.params.group).format("X")},end:function(){return o.endOf(c.methods.current().api.params.group).format("X")},docType:"return_sales"},url:"authenticated.card.sidebar_journal"},sort:+r.return_sales.count||0,title:+r.return_sales.count},rent:{sort:100*d||0,title:(100*d).toFixed(0)+"%"},margin:{sort:100*l||0,title:(100*l).toFixed(0)+"%"},avg:{hide:!0,chart:{type:"line",aspect:"spline",stack:2},sort:r.revenue/(r.sales.count||r.sales)}}})},filter:this.filter.concat([{_id:"store_id",name:"STORE",type:"dropdown",show:!0,settings:{name:"stores",limit:10,search:!0}}])}};this.menu=[{name:"ProductSales",title:"SALES_BY_PRODUCTS",icon:"cube",url:"authenticated.card.reports_product",api:{url:"/report/:client/sales/groups-products/0/1000/",params:{v:"v3"}},helpText:{revenue:"PRODUCT_SALES_AMOUNT_WITHOUT_REFUND_FOR_",profit:"REVENUE_WITHOUT_COST_OF_SALES",sales:"NUMBER_OF_PRODUCT_SALES",count:"NUMBER_OF_UNITS_SOLD",margin:"GROSS_PROFIT_DIVIDED_BY_THE_REVENUE",rent:"GROSS_PROFIT_DIVIDED_BY_THE_COST"},params:{},print:d.period.print,"export":d.period["export"],format:function(t){return t.filter(function(t){return"total/avg"!==t._id}).map(function(t){return{name:{link:{url:"authenticated.card.catalog.get",params:{productId:t._id}},sort:t.product.name,title:t.product.name,group:"group"===t.product.type},barcode:{title:t.product.barcode,sort:t.product.barcode},sku:{title:t.product.sku,sort:t.product.sku},revenue:{sort:+t.revenue||0,title:n("number")(t.revenue,2)},profit:{sort:+t.profit||0,title:n("number")(t.profit,2)},cost:{sort:+t.cost||0,title:n("number")(t.cost,2)},sales:{link:{exportQuery:!0,url:"authenticated.card.sidebar_history",params:_objectSpread({productId:"group"===t.product.type?0:t._id,title:"sales",type:["sales"]},"group"===t.product.type?{id_group:t._id}:{})},sort:+t.sales||0,title:+t.sales||0},count:{sort:+t.count||0,title:n("number")(t.count,2)},rent:{sort:100*t.rent||0,title:(100*t.rent).toFixed(0)+"%"},margin:{sort:100*t.margin||0,title:(100*t.margin).toFixed(0)+"%"}}})},filter:this.filter.concat([{_id:"no_group",name:"DISPLAY",show:!0,type:"dropdown",required:!0,value:"false",settings:{name:[{_id:!0,name:"PRODUCTS_ONLY"},{_id:!1,name:"GROUPS_AND_PRODUCTS"}]}},{_id:"search",name:"SEARCH",show:!0,type:"text",required:!0,channel:"search"},{_id:"type",name:"TYPE",type:"dropdown",show:!0,settings:{name:[{_id:"inventory",name:"PRODUCTS"},{_id:"service",name:"SERVICES"}],search:!0}},{_id:"client_id",name:"PARTNER",type:"dropdown",settings:{name:"clients,suppliers",limit:5,search:!0}},{_id:"store_id",name:"STORE",type:"dropdown",settings:{name:"stores",limit:10,search:!0}}])},{name:"CategorySales",title:"SALES_BY_CATEGORIES",icon:"tags",url:"authenticated.card.reports_categories",api:{url:"/report/:client/sales/product2/0/1000/",params:{category_report:!0,v:"v1"}},params:{},helpText:{revenue:"PRODUCT_SALES_AMOUNT_WITHOUT_REFUND_FOR_",profit:"REVENUE_WITHOUT_COST_OF_SALES",sales:"NUMBER_OF_PRODUCT_SALES",count:"NUMBER_OF_UNITS_SOLD",margin:"GROSS_PROFIT_DIVIDED_BY_THE_REVENUE",rent:"GROSS_PROFIT_DIVIDED_BY_THE_COST"},print:d.period.print,"export":d.period["export"],format:function(t){return t.map(function(t){return"c6f7fe9489884f1e059404b77bd12fc9"==t._id.category&&(t._id.category=s("NO_CATEGORY")),{name:{sort:t._id.category,title:t._id.category},revenue:{sort:+t.revenue||0,title:n("number")(t.revenue,2)},profit:{sort:+t.profit||0,title:n("number")(t.profit,2)},cost:{sort:+t.cost||0,title:n("number")(t.cost,2)},sales:{sort:+t.sales||0,title:+t.sales||0},count:{sort:+t.count||0,title:n("number")(t.count,2)},rent:{sort:100*t.rent||0,title:(100*t.rent).toFixed(0)+"%"},margin:{sort:100*t.margin||0,title:(100*t.margin).toFixed(0)+"%"}}})},filter:this.filter.concat([{_id:"search",name:"SEARCH",show:!0,type:"text",required:!0,channel:"search"},{_id:"type",name:"TYPE",type:"dropdown",show:!0,settings:{name:[{_id:"inventory",name:"PRODUCTS"},{_id:"service",name:"SERVICES"},{_id:"set",name:"SETS"}],search:!0}},{_id:"store_id",name:"STORE",type:"dropdown",settings:{name:"stores",limit:10,search:!0}},{_id:"client_id",name:"PARTNER",type:"dropdown",settings:{name:"clients,suppliers",limit:5,search:!0}}])},{name:"SetSales",title:"SALES_BY_SETS",icon:"cubes",url:"authenticated.card.reports_set",api:{url:"/report/:client/sales/product2/0/1000/",params:{type:"set",v:"v1"}},params:{},helpText:{revenue:"PRODUCT_SALES_AMOUNT_WITHOUT_REFUND_FOR_",sales:"NUMBER_OF_SET_SALES",average_price:"REVENUE_DIVIDED_BY_THE_NUMBER_OF_SETS_SO",count:"NUMBER_OF_SETS_SOLD"},print:d.period.print,"export":d.period["export"],format:function(t){return t.map(function(t){var e=t.revenue/t.count;return{name:{link:{url:"authenticated.card.catalog.get",params:{productId:t._id._id}},sort:t._id.name,title:t._id.name},barcode:{title:t._id.barcode,sort:t._id.barcode},sku:{title:t._id.sku,sort:t._id.sku},revenue:{sort:+t.revenue||0,title:n("number")(t.revenue,2)},sales:{link:{exportQuery:!0,url:"authenticated.card.sidebar_history",params:{productId:t._id._id,title:"sales",type:["sales"]}},sort:+t.sales||0,title:+t.sales||0},average_price:{sort:e,title:n("number")(e,2)},count:{sort:+t.count||0,title:n("number")(t.count,2)}}})},filter:this.filter.concat([{_id:"search",name:"SEARCH",show:!0,type:"text",required:!0,channel:"search"},{_id:"client_id",name:"PARTNER",type:"dropdown",show:!0,settings:{name:"clients,suppliers",limit:5,search:!0}},{_id:"store_id",name:"STORE",type:"dropdown",settings:{name:"stores",limit:10,search:!0}}])},Object.assign({},d.period,{name:"DaySales",title:"SALES_BY_DAYS",type:"dates",url:"authenticated.card.reports_day",api:{url:"/report/:client/sales/date/0/1000/",params:{group:"day"}},params:{},f:{date:function l(t){var l=moment(t._id.year+"/"+t._id.month+"/"+t._id.day,"YYYY-MM-DD");return l},name:function(t){var e="D MMMM YYYY";return this.date(t).format("YYYY")==moment().format("YYYY")&&(e="D MMMM"),this.date(t).format(e)},addEmptyFields:function(t){var e=this;t=t.map(function(t){return _objectSpread({},t,{date:e.date(t)})}).sort(function(t,e){return+t.date.format("X")>+e.date.format("X")?1:-1});var n=t[0].date,r=t[t.length-1].date,a=u(n,r,"days").map(function(t){var e=moment(t,"X");return{_id:{day:+e.format("D"),month:+e.format("MM"),year:+e.format("YYYY")},cost:0,revenue:0,sales:{sum:0,cost:0,count:0},return_sales:{count:0,sum:0,cost:0},profit:0,margin:0,rent:0}});return a.map(function(e){var n=_.where(t,{_id:{day:e._id.day,month:e._id.month,year:e._id.year}})[0];return n||e})}}}),Object.assign({},d.period,{name:"WeekSales",title:"SALES_BY_WEEKS",type:"dates",url:"authenticated.card.reports_week",api:{url:"/report/:client/sales/date/0/1000/",params:{group:"week"}},params:{},f:{date:function(t){return moment().year(t._id.year).isoWeek(t._id.week).weekday(0)},name:function(t,e,n){var r=+t._id.week,a="D MMM YYYY",o="D MMM YYYY",c=moment().year(t._id.year).isoWeek(r).weekday(0),s=moment().year(t._id.year).isoWeek(r).weekday(6),u=_slicedToArray(i.menu[3].filter,1),d=_slicedToArray(u[0].value,2),l=d[0],p=d[1];return 0===e&&+c.format("X")<l&&(c=moment(l,"X")),e+1===n&&+s.format("X")>p&&(s=moment(p,"X")),c.format("YYYY")===s.format("YYYY")&&(a="D MMM"),s.format("YYYY")===moment().format("YYYY")&&(o="D MMM"),c.format(a)+" – "+s.format(o)},addEmptyFields:function(t){var e=moment(c.filter_query.start,"X"),n=moment(c.filter_query.end,"X"),r=u(e,n,"weeks").concat([n]).map(function(t){var e=moment(t,"X");return{_id:{week:e.isoWeek(),year:+e.isoWeekYear()},uniq:"".concat(e.isoWeek()).concat(e.isoWeekYear()),cost:0,revenue:0,sales:{sum:0,cost:0,count:0},return_sales:{count:0,sum:0,cost:0},profit:0,margin:0,rent:0}});return r=_.uniq(r,"uniq"),r.map(function(e){var n=_.where(t,{_id:{week:e._id.week,year:e._id.year}})[0];return n||e})}}}),Object.assign({},d.period,{name:"MonthSales",title:"SALES_BY_MONTH",type:"dates",url:"authenticated.card.reports_month",api:{url:"/report/:client/sales/date/0/1000/",params:{group:"month"}},params:{},f:{date:function(t){return moment(t._id.year+"/"+t._id.month+"/01")},name:function(t){return this.date(t).format("MMMM, YYYY")},addEmptyFields:function(t){var e=this;t=t.map(function(t){return t.date=e.date(t),t}).sort(function(t,e){return+t.date.format("X")>+e.date.format("X")?1:-1});var n=t[0].date,r=t[t.length-1].date,a=u(n,r.add("months",1).date(0),"months").map(function(t){var e=moment(t,"X");return{_id:{day:+e.format("D"),month:+e.format("MM"),year:+e.format("YYYY")},cost:0,revenue:0,sales:{sum:0,cost:0,count:0},return_sales:{count:0,sum:0,cost:0},profit:0,margin:0,rent:0}});return a.filter(function(t){return 1===a.length||1==t._id.day}).map(function(e){delete e._id.day;var n=_.where(t,{_id:{month:e._id.month,year:e._id.year}})[0];return n||e})}}}),{name:"Motion",title:"MOVEMENTS_REPORT",icon:"refresh",url:"authenticated.card.reports_motion",api:{url:"/report/:client/statistic/movements/0/1000/",params:{}},helpText:{qty_before:"INITIAL_PRODUCTS_STOCK",movs_in:"Количество поступившего товара (по всем документам)",movs_out:"Количество выбывшего товара (по всем документам)",qty_after:"FINAL_PRODUCTS_STOCK"},print:d.period.print,"export":d.period["export"],format:function(t){return c.sort.fieldName="name",c.sort.reverse={name:!0},t.map(function(t){return{name:{link:{url:"authenticated.card.catalog.get",params:{productId:t._id._id}},sort:t._id.name,title:t._id.name},barcode:{title:t._id.barcode,sort:t._id.barcode},sku:{title:t._id.sku,sort:t._id.sku},qty_before:{sort:+t.qty_before||0,title:n("number")(t.qty_before,2)},movs_in:{link:{exportQuery:!0,url:"authenticated.card.sidebar_history",params:{productId:t._id._id,sign:1,title:"debit",type:["purchases","return_sales","movements","changes"]}},sort:+t.movs["in"]||0,title:n("number")(t.movs["in"],2)},movs_out:{link:{exportQuery:!0,url:"authenticated.card.sidebar_history",params:{productId:t._id._id,sign:-1,title:"credit",type:["sales","return_purchases","movements","changes"]}},sort:+t.movs.out||0,title:n("number")(t.movs.out,2)},qty_after:{link:{exportQuery:!0,url:"authenticated.card.sidebar_history",params:{productId:t._id._id,title:"movs"}},sort:+t.qty_after||0,title:n("number")(t.qty_after,2)}}})},filter:this.filter.concat([{_id:"search",name:"SEARCH",show:!0,type:"text",required:!0,
channel:"search"},{_id:"store_id",name:"STORE",type:"dropdown",show:!0,settings:{name:"stores",limit:10,search:!0}}])},{name:"Agent",title:"AGENTS_REPORT",icon:"users",url:"authenticated.card.reports_agent",api:{url:"/report/:client/statistic/contragents/0/1000/",params:{}},helpText:{sales_count:"NUMBER_OF_SALES",return_sales_count:"THE_NUMBER_OF_RETURNS_FROM_THE_CLIENT",avg:"SALES_SUM_DIVIDED_BY_THE_NUMBER_OF_SALES",sales_sum:"SALES_AMOUNT",return_sales_sum:"REFUNDS_AMOUNT",debit_sum:"INCOMES_ORDER_AMOUNT",credit_sum:"EXPENSES_ORDER_AMOUNT",purchases_count:"NUMBER_OF_PURCHASES",return_purchases_count:"NUMBER_OF_SUPPLIER_REFUNDS",purchases_sum:"PURCHASES_AMOUNT",return_purchases_sum:"PURCHASES_RETURNS_AMOUNT"},print:d.period.print,"export":d.period["export"],format:function(t){return"clients"==c.filter_query.type?(c.sort.fieldName="sales_count",t.map(function(t){return{name:{link:{url:"authenticated.card.client_show",params:{clients_id:t._id._id}},sort:t._id.name,title:t._id.name},sales_count:{link:{exportQuery:!0,params:{docType:"sales",to:t._id._id},url:"authenticated.card.sidebar_journal"},sort:+t.docs.sales.count||0,title:+t.docs.sales.count},return_sales_count:{link:{exportQuery:!0,params:{docType:"return_sales",from:t._id._id},url:"authenticated.card.sidebar_journal"},sort:+t.docs.return_sales.count||0,title:+t.docs.return_sales.count},avg:{sort:+(t.docs.sales.sum/t.docs.sales.count)||0,title:n("number")(t.docs.sales.sum/t.docs.sales.count||0,2)},sales_sum:{sort:+t.docs.sales.sum||0,title:n("number")(t.docs.sales.sum,2)},return_sales_sum:{sort:+t.docs.return_sales.sum||0,title:n("number")(t.docs.return_sales.sum,2)},debit_sum:{sort:+t.money.debit.sum||0,title:n("number")(t.money.debit.sum,2)},credit_sum:{sort:+t.money.credit.sum||0,title:n("number")(t.money.credit.sum,2)}}})):(c.sort.fieldName="purchases_sum",t.map(function(t){return{name:{link:{url:"authenticated.card.supplier_show",params:{suppliers_id:t._id._id}},sort:t._id.name,title:t._id.name},purchases_count:{link:{exportQuery:!0,params:{docType:"purchases",from:t._id._id},url:"authenticated.card.sidebar_journal"},sort:+t.docs.purchases.count||0,title:+t.docs.purchases.count},return_purchases_count:{link:{exportQuery:!0,params:{docType:"return_purchases",to:t._id._id},url:"authenticated.card.sidebar_journal"},sort:+t.docs.return_purchases.count||0,title:+t.docs.return_purchases.count},purchases_sum:{sort:+t.docs.purchases.sum||0,title:n("number")(t.docs.purchases.sum,2)},return_purchases_sum:{sort:+t.docs.return_purchases.sum||0,title:n("number")(t.docs.return_purchases.sum,2)},debit_sum:{sort:+t.money.debit.sum||0,title:n("number")(t.money.debit.sum,2)},credit_sum:{sort:+t.money.credit.sum||0,title:n("number")(t.money.credit.sum,2)}}}))},filter:this.filter.concat([{_id:"type",name:"TYPE",type:"dropdown",value:"clients",required:!0,settings:{name:[{_id:"clients",name:"CLIENTS"},{_id:"suppliers",name:"SUPPLIERS"}],search:!0}},{_id:"contragent_id",name:"PARTNER",type:"dropdown",show:!0,settings:{name:"clients,suppliers",limit:5,search:!0}}])},{name:"Finance",title:"FINANCIAL_REPORT",icon:"dollar",url:"authenticated.card.reports_finance",api:{url:"/report/:client/finance/date/0/1000",params:{group:"month"}},types:{debit:"INCOME",credit:"EXPENSE"},view:"finance",views:[{id:"finance",icon:"list layout"},{id:"finance.chart",icon:"area chart"}],head:[],changeView:function(t){if(this.view=t,"finance.chart"==this.view){var e={};_.forEach(r.data.filtered[1],function(t,n){e[n]=t.filter(function(t){return"undefined"!=typeof t.sort})}),this.chartData=e}},print:{template:"/js/pages/reports/print/finance.html",data:function(){return{filter:{year:c.methods.current().filter[0].value},head:c.methods.current().head,data:r.data.filtered}}},"export":function(){var t=this.methods.current(),e=angular.fromJson(angular.toJson(r.data.filtered)),n=[];return _.forEach(e[0],function(e,r){n.push([s(t.types[r])].concat(_.range(t.head.length).map(function(){return""}))),e.forEach(function(t){n.push(_.map(t,function(t,e){var n=0==e?t.title:t.sort;return n}))})}),n.push([s("TOTAL")].concat(_.range(t.head.length).map(function(){return""}))),_.forEach(e[1],function(t){n.push(_.map(t,function(t){return s(t.title)}))}),n.unshift(t.head.map(function(t){return s(t.title)})),n[0].unshift(s("CATEGORY")),n.unshift(n[2].map(function(t){return _typeof(t)})),console.warn({result:n}),n},build:function(t){var e=this,r=[{debit:{},credit:{}}],a=function(t){var r={0:{sort:t,title:t}};return e.head.forEach(function(t){var e=+moment().format("YYYY")==i&&t.id>+moment().format("MMYYYY");r[t.id]={sort:0,title:e?"-":n("number")(0,2)}}),r},i=e.filter[0].value;this.head=_.map(_.range(1,13),function(t){return{id:+(t+""+i),title:moment(t+"/01/"+i).format("MMMM")}}),t.forEach(function(t){_.forEach(r[0],function(e,c){_.forEach(t[c],function(e,s){if(301!=s&&t._id.year==i){var u=_.where(o.pay.source,{id:+s})[0];u=u?u.title:-1,r[0][c][s]=r[0][c][s]||a(u);var d={start:+moment(t._id.month+"/1/"+t._id.year).startOf("month").format("X"),end:+moment(t._id.month+"/1/"+t._id.year).endOf("month").format("X")};r[0][c][s][t._id.month+""+t._id.year]={sort:e,title:n("number")(e,2),link:{url:"authenticated.card.sidebar_orders",exportQuery:!0,params:{start:d.start,end:d.end,source:+s,type:c,sum:e}}}}})})});var c=[];c.push({debit:_.map(r[0].debit,function(t){return t}),credit:_.map(r[0].credit,function(t){return t})});var s=this.head.map(function(t){return _.sum(c[0].debit.map(function(e){return{sort:e[t.id].sort}}),"sort")}),u=this.head.map(function(t){return _.sum(c[0].credit.map(function(e){return{sort:e[t.id].sort}}),"sort")}),d=s.map(function(t,e){var r=t-u[e];return{title:n("number")(r,2),sort:r}}),l=d.map(function(t,e){var r=_.sum(d.slice(0,e+1),"sort");return{title:n("number")(r,2),sort:r}});return c.push({debit:[{title:"INCOMES_AMOUNT"}].concat(s.map(function(t){return{title:n("number")(t,2),sort:t}})),credit:[{title:"EXPENSES_AMOUNT"}].concat(u.map(function(t){return{title:n("number")(t,2),sort:t}})),balanceInHand:[{title:"NET"}].concat(d),accumulation:[{title:"ACCUMULATED_BALANCE"}].concat(l)}),_.forEach(c[1],function(t,n){c[1][n]=c[1][n].map(function(t,r){if(r>0){var a=e.head[r-1].id,o=+moment().format("YYYY")==i&&a>+moment().format("MMYYYY");if(t.title=o?"-":t.title,["debit","credit"].indexOf(n)>-1&&t.sort){var c={start:+moment(e.head[r-1].id.toString().replace(i,"")+"/1/"+i).startOf("month").format("X"),end:+moment(e.head[r-1].id.toString().replace(i,"")+"/1/"+i).endOf("month").format("X")};t.link={url:"authenticated.card.sidebar_orders",params:{start:c.start,end:c.end,type:n},exportQuery:!0}}}return t})}),c},format:function(t){return t=this.build(t)},filter:[{_id:"year",name:"YEAR",type:"dropdown",value:+moment().format("YYYY"),required:!0,channel:"finance",settings:{name:function(){var t=+moment(a.user.company().created,"X").format("YYYY")-5,e=+moment().format("YYYY");return _.map(_.range(t,e+1),function(t){return{_id:t,name:t}}).reverse()}(),search:!0}}]},{name:"Staff",title:"STAFF_REPORT",icon:"users",url:"authenticated.card.reports_staff",api:{url:"/report/:client/sales/user/0/1000/",params:{v:"v2"}},params:{},helpText:{sales_count:"NUMBER_OF_SALES_EXECUTED_BY_AN_EMPLOYEE",return_sales_count:"NUMBER_OF_SALES_REFUNDS_ISSUED_BY_AN_EMP",sales_sum:"",return_sales_sum:"",avg:"SALES_SUM_DIVIDED_BY_THE_NUMBER_OF_SALES",discount_sum:"SUM_OF_DISCOUNTS",avg_product_check:"AVERAGE_QTY_ITEMS_IN_THE_RECEIPT"},print:d.period.print,"export":d.period["export"],format:function(t){return t.map(function(t){var e=a.user.positions().staff[t._id]||{data:{}};return{staff_name:{link:{url:"authenticated.card.profile",params:{staff_id:t._id}},sort:e.data.name,title:e.data.name+(e.stopped?" <em>уволен ".concat(n("dateNice")(e.stopped),"</em>"):"")},sales_count:{link:{exportQuery:!0,params:{docType:"sales",user:t._id,type:"staff"},url:"authenticated.card.sidebar_journal"},sort:+t.sales.count||0,title:(+t.sales.count).toFixed(0)},return_sales_count:{link:{exportQuery:!0,params:{docType:"return_sales",user:t._id,type:"staff"},url:"authenticated.card.sidebar_journal"},sort:+t.return_sales.count||0,title:(+t.return_sales.count).toFixed(0)},sales_sum:{sort:+t.sales.sum||0,title:n("number")(t.sales.sum,2)},return_sales_sum:{sort:+t.return_sales.sum||0,title:n("number")(t.return_sales.sum,2)},avg:{sort:+(t.sales.sum/t.sales.count)||0,title:n("number")(t.sales.sum/t.sales.count,2)},discount_sum:{sort:+t.sales.discount_sum||0,title:n("number")(t.sales.discount_sum,2)},avg_product_check:{sort:+t.sales.products_avg||0,title:n("number")(t.sales.products_avg,2)},email:{hide:!0,title:e.data.email},phone:{hide:!0,title:e.data.phone}}})},filter:this.filter.concat([{_id:"search",name:"SEARCH",show:!0,type:"text",required:!0,channel:"search"},{_id:"user_id",name:"EMPLOYEES",type:"dropdown",show:!0,settings:{name:"staff",search:!0}}])}],this.methods={go:function(n,r){var a=n.link.params||{};return n.group?void t.$broadcast("report.filter.init",n):("function"==typeof a.start&&(a.start=a.start()),"function"==typeof a.end&&(a.end=a.end()),n.link.exportQuery?(a=angular.toJson(Object.assign({},c.filter_query,a)),void e.go(n.link.url,{query:window.btoa(a)})):void e.go(n.link.url,a))},current:function(){var t=c.menu.filter(function(t){return e.is(t.url,t.params)})[0];if(!t){var n=e.current.name.replace(/\.modal.+/,"");t=c.menu.filter(function(t){return t.url==n})[0]}return t.view=t.view||"table",t},progress:function(t){var e={group:{},catalog:{}};if(t[0]&&(t[0].credit||t[0].debit))return _.forEach(t[0],function(e,n){var r={};_.forEach(t[0][n][0],function(e,a){try{"number"==typeof e.sort&&(r[a]=_.max(t[0][n],a+".sort"),r[a]=r[a][a].sort)}catch(o){console.warn(o,t)}}),t[0][n]=t[0][n].map(function(t){return _.forEach(t,function(e,n){"number"==typeof e.sort&&(t[n].progress=+(e.sort/r[n]*100).toFixed(2))}),t})}),t;if(t[0]){var n=t[0].name?"name":"staff_name";return _.forEach(t[0],function(r,a){try{"number"==typeof r.sort&&(e.group[a]=_.max(t.filter(function(t){return t[n].group}),a+".sort"),e.catalog[a]=_.max(t.filter(function(t){return!t[n].group}),a+".sort"),e.group[a]=(e.group[a][a]||{sort:0}).sort,e.catalog[a]=(e.catalog[a][a]||{sort:0}).sort)}catch(o){console.warn(o,a,r)}}),t.map(function(t){return _.forEach(t,function(r,a){if("number"==typeof r.sort){var o=t[n]&&t[n].group?"group":"catalog";t[a].progress=+(r.sort/e[o][a]*100).toFixed(2)}}),t})}return[]},format:function(t){return t&&t.length?(t=this.current().format(t),t=this.progress(t)):[]},destroy:function(){c.search.destroy()}}}]),angular.module("cloudshop.reports").controller("reportsInnerCtrl",["$scope","$rootScope","db","paginator","apiRouteService","api","$filter","reports","safeApply",function(t,e,n,r,a,o,i,c,s){function u(){t.dropdown={stores:{name:"stores",limit:5,"class":"floating fluid labeled icon button",icon:"home",search:!0,cancel:!0}}}t.pg=r,t.helpText={},t.db=n.storage,t.reports=c,t.searchQuery="",t.filter={name:"report"+c.methods.current().name,onChange:function(e,n){return"main"==n?(e.no_group&&(e.no_group="true"===e.no_group),c.filter_query=e,t.group.select(0),l()):"search"==n?(t.searchQuery=e.search,c.search.init(e.search),s(t)):"finance"==n?(e.year&&(e.start=+moment("1/1/".concat(e.year)).format("X"),e.end=+moment("12/31/".concat(e.year)).endOf("day").format("X"),delete e.year),c.filter_query=e,l()):void 0},fields:c.methods.current().filter||[]},t.group={selected:{value:null},add_group:function(e){if(e){var n={id_group:t.group.selected.value||0,name:e.title,_id:e.link.params.productId};t.group.data.push(n)}},select:function(e,n){t.group.add_group(n),t.group.selected.value=e,c.filter_query=_objectSpread({},c.filter_query,{id_group:e}),e||delete c.filter_query.id_group,l()},data:[]},t.$on("$destroy",function(){t.pg.method.clear(),c.methods.destroy()}),e.$on("report.filter.init",function(e,n){return t.group.select(n.link.params.productId,n)});var d={},l=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function r(){var e,a,i,s,u;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(t.code=null,t.data=[],t.pg.data.filtered=[],t.pg.method.init(!0),e=_objectSpread({v:"v2"},c.methods.current().api.params,{},c.filter_query),!_.isEqual(d,e)){r.next=7;break}return r.abrupt("return",Promise.resolve());case 7:return d=e,r.prev=8,r.next=11,n.method.init("sources");case 11:return r.next=13,o.data.post(c.methods.current().api.url,e);case 13:a=r.sent,i=a.data.data,c.sort.destroy(),t.data=i,c.search.data=_toConsumableArray(c.methods.format(i)),c.sort.init(),s=c.methods.current(),s.changeView&&c.methods.current().changeView(c.methods.current().view),u=c.search.init(t.searchQuery),t.data?u&&0!=u.length?(t.total=p(u,s.type),t.code=200,s.helpText&&(t.helpText=_objectSpread({},s.helpText))):t.code=404:t.code=500,r.next=29;break;case 25:r.prev=25,r.t0=r["catch"](8),console.warn("error",r.t0),t.code=500;case 29:return r.prev=29,t.$apply(),r.finish(29);case 32:case"end":return r.stop()}},r,null,[[8,25,29,32]])}));return function(){return e.apply(this,arguments)}}(),p=function(t,e){var n=[],r={};return Object.keys(t[0]).forEach(function(t){return n.push(t)}),n.forEach(function(n){switch(n){case"name":case"staff_name":r[n]="TOTAL";break;case"sales":case"return_sales":case"return_sales_count":r[n]=_.sum(t,"".concat(n,".sort"));break;case"rent":var a="dates"===e?_.sum(t,"profit.sort")/(_.sum(t,"cost.sort")-_.sum(t,"cost_return_sales.sort"))*100:_.sum(t,"profit.sort")/_.sum(t,"cost.sort")*100;r[n]=(isFinite(a)?Math.round(a):0)+"%";break;case"margin":var o="dates"===e?_.sum(t,"profit.sort")/(_.sum(t,"sales_sum.sort")-_.sum(t,"return_sales_sum.sort"))*100:_.sum(t,"profit.sort")/_.sum(t,"revenue.sort")*100;r[n]=(isFinite(o)?Math.round(o):0)+"%";break;case"avg":r[n]=i("number")(_.sum(t,"sales_sum.sort")/_.sum(t,"sales_count.sort"),2);break;case"average_price":r[n]=i("number")(_.sum(t,"revenue.sort")/_.sum(t,"count.sort"),2);break;case"avg_product_check":r[n]=i("number")(_.sum(t,"".concat(n,".sort"))/t.length,2);break;case"sku":case"barcode":r[n]="";break;default:r[n]=i("number")(_.sum(t,"".concat(n,".sort")),2)}}),r};u()}]),angular.module("cloudshop.reports").controller("reportsIndexCtrl",["$scope",function(t){}]),angular.module("cloudshop.reports").directive("reports",["$state","reports","$timeout",function(t,e,n){return{restrict:"E",replace:!0,template:'<div class="item" id="reports-menu">\n					<div class="row items">\n						<div ng-repeat="item in menu" class="col-xs-8">\n							<a href="" class="ui fluid large basic smooth button" ng-class="{active: item.active}" ui-sref="{{item.url}}({{item.params}})">\n								<i class="ui icon" ng-class="item.icon"></i>\n								<span ng-bind-html="item.title | translate"></span>\n								<div ng-if="item.badge" class="floating ui red label">new</div>\n							</a>\n						</div>\n					</div>\n				</div>',link:function(r,a){function o(){r.menu=r.menu.map(function(e){return e.active=t.is(e.url,e.params),e});var e=_.where(r.menu,{active:!0})[0],n=$(a).closest(".dropdown");n&&e&&$(".text",n).text(e.title.replace(/<.+>/,"")).removeClass("default")}r.menu=e.menu,n(o,1)}}}]).directive("tableHeader",["reports",function(t){return{restrict:"A",link:function(e,n){e.reports=t,e.$watch("reports.sort",function(t){$(".sort",n).addClass("ng-hide"),e.key==t.fieldName&&(t.reverse[e.key]?$(".descending",n).removeClass("ng-hide"):$(".ascending",n).removeClass("ng-hide"))},!0)}}}]),angular.module("cloudshop.start",[]).config(["$stateProvider",function(t){t.state("authenticated.start",{url:"/start?signup",templateUrl:"js/pages/start/index.html",controller:"startCtrl",data:{pageTitle:"LETS_START",permission:"dashboard"}})}]),angular.module("cloudshop.start").service("startService",["api","$state",function(t,e){var n=this;this.steps={catalog:{active:!1,complete:!0,label:"1_ADD_ITEM",text:"YOU_CAN_ADD_AN_UNLIMITED_NUMBER_OF_PRODU",icon:"product",button:{text:"ADD_PRODUCT",onClick:function(){e.go("authenticated.card.catalog.list.modal.catalog_create")}}},stock:{active:!1,complete:!1,label:"2_INPUT_STOCK",text:"THE_BALANCES_CAN_BE_ENTERED_THROUGH_POST",icon:"qty",button:{text:"SET_STOCK",onClick:function(){e.go("authenticated.card.doc_create.changes_in")}}},sale:{active:!1,complete:!1,label:"3_MAKE_THE_FIRST_SALE",text:"SALES_CAN_BE_MADE_THROUGH_ALL_CLOUDSHOP_",icon:"sale",button:{text:"MAKE_SALE",onClick:function(){e.go("authenticated.card.doc_create.sell")}}},report:{active:!1,complete:!1,label:"4_LOOK_IN_REPORT",text:"ON_THE_DASHBOARD_THERE_ARE_THE_MAIN_INDI",icon:"report",button:{text:"LOOK_AT",onClick:function(){e.go("authenticated.card.reports_product")}}},tarif:{active:!1,complete:!1,label:"5_GET_1_MONTH_FOR_FREE",text:"WHEN_YOU_FIRST_PURCHASE_THE_TARIFF_PLAN_",icon:"tarif",button:{text:"GET_IT",onClick:function(){e.go("authenticated.payment",{plan:!0})}}}},this.parse=function(t){var e=_.clone(n.steps,!0);if(t.catalog>0&&(e.catalog.complete=!0),(t.docs.changes>0||t.docs.purchases>0)&&(e.stock.complete=!0),t.docs.sales>0&&(e.sale.complete=!0,e.tarif.active=!0,e.tarif.complete=!0),t.catalog){var r;Object.keys(e).forEach(function(t){r&&e[r].complete&&e[t].complete===!1&&(e[t].active=!0),r=t})}else e.catalog.active=!0;return e},this.fetch=_asyncToGenerator(regeneratorRuntime.mark(function r(){var e,n;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,t.data.get("/stats/:client",{v:"v3"});case 2:return e=r.sent,n=e.data.data,r.abrupt("return",n);case 5:case"end":return r.stop()}},r)}))}]),angular.module("cloudshop.start").controller("startCtrl",["$scope","startService",function(t,e){t.steps=e.steps;var n=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function r(){var n;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,e.fetch();case 3:n=r.sent,t.steps=e.parse(n),r.next=9;break;case 7:r.prev=7,r.t0=r["catch"](0);case 9:case"end":return r.stop()}},r,null,[[0,7]])}));return function(){return n.apply(this,arguments)}}();n()}]),angular.module("cloudshop.plugin",[]).config(["$stateProvider",function(t){t.state("authenticated.plugin",{url:"/plugin/:name",templateUrl:"js/pages/plugin/_view.html",controller:"pluginCtrl",data:{pageTitle:"APPS"}})}]),angular.module("cloudshop.plugin").controller("pluginCtrl",["$scope","$state","$http","$sce","$rootScope","api",function(t,e,n,r,a,o){function i(){s&&n.get("/plugins/"+s+"/plugin.json").then(function(e){c=Object.assign(c,e.data),t.url=r.trustAsResourceUrl("/plugins/"+s+"/"+c.main+"?client_id="+_.keys(o.user.data.positions)[0]),a.$broadcast("changeTitle",["APPS",c.name])})["catch"](function(e){t.err=e})}var c={main:"index.html"},s=e.params.name;i()}]),angular.module("cloudshop").config(["$stateProvider",function(t){t.state("authenticated.payment",{url:"/payment?plan",templateUrl:"js/pages/payment/_view.html",controller:"paymentCtrl",data:{pageTitle:"TARIFFS_AND_PAYMENT"}})}]),angular.module("cloudshop").factory("billingModal",["$rootScope","$filter","$state","alertModal",function(t,e,n,r){return function(){t.$on("billingPermDenied",function(t,n){e(n)});var e=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t,e.next=5e3===e.t0?3:5001===e.t0?6:5002===e.t0?9:12;break;case 3:return a="ACCOUNT_IS_BLOCKED_THERE_MAY_BE_INSUFFIC",o="RECHARGE_THE_BALANCE",e.abrupt("break",12);case 6:return a="THIS_SERVICE_IS_NOT_INCLUDED_IN_YOUR_TAR",o="CHANGE_TARIFF",e.abrupt("break",12);case 9:return a="THE_TRIAL_PERIOD_IS_OVER",o="CHOOSE_A_TARIFF",e.abrupt("break",12);case 12:return e.next=14,r(a,{cancelText:o,size:"tiny"});case 14:n.go("authenticated.payment");case 15:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}()}}]).run(["billingModal",function(t){t()}]),angular.module("cloudshop").controller("paymentCtrl",["$scope","$http","$sce","$rootScope","api","$state","CONFIG",function(t,e,n,r,a,o,i){function c(){t.url=n.trustAsResourceUrl("https://".concat(i.billing,"/").concat(o.params.plan?"select-plan.php":"","?t=").concat(a.user.data.token,"&c=").concat(_.keys(a.user.data.positions)[0]))}c()}]),angular.module("cloudshop.money",[]).config(["$stateProvider",function(t){t.state("authenticated.card.money",{url:"/money",templateUrl:"js/pages/orders/_list.html",controller:"moneyCtrl",data:{pageTitle:"TRANSACTIONS",permission:"money"}})}]).config(["$stateProvider",function(t){t.state("authenticated.card.pay_create",{url:"/pay",template:"<ui-view></ui-view>",data:{pageTitle:"CREATING_ORDER"}}).state("authenticated.card.money_show",{url:"/money/show/:orderId",templateUrl:"js/pages/orders/page/_view.html",controller:"payCtrl",data:{pageTitle:"VIEW_ORDER",permission:"money",method:"GET"}}).state("authenticated.card.pay_create.cash_parish",{url:"/cash-parish",templateUrl:"js/pages/orders/page/_view.html",controller:"payCtrl",data:{pageTitle:"INCOME",type:"debit",permission:"money",method:"POST"}}).state("authenticated.card.pay_create.cash_outflow",{url:"/cash-outflow",templateUrl:"js/pages/orders/page/_view.html",controller:"payCtrl",data:{pageTitle:"EXPENSE",type:"credit",permission:"money",method:"POST"}}).state("authenticated.card.pay_create.cash_transfer",{url:"/cash-transfer",templateUrl:"js/pages/orders/page/_view.html",controller:"payTransferCtrl",data:{pageTitle:"REMITTANCE",type:"transfer",permission:"money",method:"POST"}}).state("authenticated.card.source_form",{url:"/source-form/:id",templateUrl:"js/pages/orders/page/sources/form.html",controller:"sourceFormCtrl",data:{pageTitle:"NEW_PAYMENT_CATEGORY",permission:"money",method:"POST"}})}]),angular.module("cloudshop.money").controller("moneyCtrl",["$scope","db","payService","docService",function(t,e,n,r){function a(){e.method.init(["suppliers"])}t.db=e.storage,t.types=r.types,t.source=_.map(n.pay.source,function(t){return t._id=t.id,t});var o={start:+moment().subtract(60,"days").startOf("day").format("X"),end:+moment().endOf("day").format("X")},i={1:!0,2:!1};t.filter={name:"_orderList",onChange:function(n){Promise.all([e.method.get("stores")]).then(function(){3==n.status?(n.deleted=!0,delete n.status):n.status&&(n.status=i[n.status]),t.query=n||o,t.$apply()})},fields:[{_id:"search_text",name:"SEARCH_BY_NUMBER_OR_COMMENT",type:"text",show:!0,required:!0},{_id:"date",name:"DATE",type:"date",defaultValue:[o.start,o.end]},{_id:"store",name:"ACCOUNT",type:"dropdown",settings:{name:"accounts",limit:10,search:!0}},{_id:"contragent",name:"PARTNER",type:"dropdown",settings:{name:"suppliers,clients,staff",search:!0}},{_id:"user",name:"AUTHOR",type:"dropdown",settings:{name:"staff",limit:10,search:!0}},{_id:"status",name:"STATUS",show:!0,type:"dropdown",settings:{name:[{_id:1,name:"DOCUMENT_IS_APPLIED"},{_id:2,name:"DOCUMENT_IS_DELAYED"},{_id:3,name:"DELETED"}]}},{_id:"type",name:"TYPE",type:"dropdown",show:!0,settings:{name:[{name:"EXPENSE",_id:"credit"},{name:"INCOME",_id:"debit"}]}},{_id:"source",name:"CATEGORY",type:"dropdown",settings:{name:[].concat(_toConsumableArray(e.storage.sources.data),_toConsumableArray(e.storage.sources.deprecated)),limit:999,search:!0,nameField:"title",valueField:"id"}}]},a()}]),angular.module("marketplace").service("marketPlaceService",[function(){var t=[{id:1,label:"ONLINE_REGISTERS_RU"},{id:3,label:"LOYALTY_SYSTEMS"}],e=[{category:1,status:!0,name:"evotor",label:"Эвотор",description:"SMART_TERMINAL",supportLink:7,gallery:["Эвотор 7.3","Эвотор 5i","Эвотор 10","Эвотор 5","Эвотор 7.2"],page:{color:"#E84427",button:{label:"CONNECT",url:"https://market.evotor.ru/store/apps/29ed04cf-5684-4fde-9b21-48b8d927a963"}}},{category:1,status:!0,name:"mspos",label:"МультиСофт MSPOS",description:"SMART_TERMINAL",gallery:[{label:"MSPOS-Е-Ф",price:"21 900"},{label:"MSPOS-К",price:"13 900"},{label:"MSPOS-Т-Ф",price:"24 500"}],page:{color:"#EC662B"}},{category:1,status:!0,name:"sunmi",label:"SUNMI",description:"SMART_TERMINAL",gallery:["SUNMI T1 Mini","SUNMI V1"],page:{logoBg:"#F8F9FA",color:"#EC662B"}},{category:1,status:!0,name:"atol",label:"Атол",description:"Фискальные регистраторы",gallery:[{label:"Атол 1Ф",price:"7 000"},{label:"Атол 15Ф",price:"7 000"},{label:"Атол 30Ф / 30Ф+",price:"11 000"},{label:"Атол 11Ф",price:"14 000"},{label:"Атол 20Ф",price:"9 200"},{label:"Атол 25Ф",price:"21 200"},{label:"Атол 50Ф",price:"9 500"},{label:"Атол 55Ф",price:"22 290"},{label:"Атол 77Ф",price:"26 000"},{label:"Атол FPrint 22ПТК",price:"25 400"}],page:{color:"#EC232F"}},{category:4,status:!0,name:"tochka",description:"OPEN_AN_ACCOUNT_FOR_BUSINESS_AND_SERVICE",page:{logoBg:"#FFF",color:"#96c0e6"}},{category:4,status:!0,name:"tochka2",description:"Зарегистрируй ИП или ООО бесплатно",page:{logoBg:"#FFF",color:"#96c0e6"}},{category:2,status:!0,name:"woocommerce",label:"WooCommerce",description:"INTEGRATION_WITH_ONLINE_STORE",supportLink:6,page:{color:"#9C5C8F"}},{category:3,status:!0,name:"uds",label:"UDS",description:"LOYALTY_SYSTEM",page:{color:"#7956A0"}}],n={},r=function(){function t(e){_classCallCheck(this,t),Object.assign(this,e)}return _createClass(t,[{key:"getInfo",value:function(){var t=this.settings.type||this.type,n=_.clone(e.find(function(e){return e.name===t}),!0);switch(this.settings.type){case"woocommerce":n.description=this.settings.url}return n}}]),t}();return{data:e,categories:t,current:n,model:r}}]),angular.module("marketplace").controller("marketplaceLogCtrl",["$scope","$state","api","$sce",function(t,e,n,r){var a=e.params.pluginId,o=n.user.clientID();t.url=r.trustAsResourceUrl("https://connect.cloudshop.ru/history?client=".concat(o,"&integration=").concat(a))}]),angular.module("marketplace").controller("marketplaceListCtrl",["$scope","marketPlaceService",function(t,e){t.categories=e.categories,t.data=e.data}]),angular.module("marketplace").controller("marketplaceItemCtrl",["$scope","$state","marketPlaceService","db","modalService",function(t,e,n,r,a){var o=e.params.pluginName,i=e.params.pluginId;t.id=i,t.loading=!1,t.error=null,t.newItem=!!o,t.data={},t.plugin=o,t.$on("$destroy",function(){a.method.remove()}),t.back=a.method.close;var c=function(t){return t.gallery?Array.from(t.gallery).map(function(e,n){var r="string"==typeof e?{label:e}:e;return _objectSpread({},r,{url:"/images/plugins/".concat(t.name,"/gallery-").concat(n+1,".png")})}):void 0},s=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function s(){var e;return regeneratorRuntime.wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(!i){s.next=18;break}return t.loading=!0,s.prev=2,s.next=5,r.method.init("integrations");case 5:t.data=r.storage.integrations.data.find(function(t){return t._id===i}),t.service=n.data.find(function(e){return e.name===(t.data.settings.type||t.data.type)}),s.next=12;break;case 9:s.prev=9,s.t0=s["catch"](2),t.error=!0;case 12:return s.prev=12,t.loading=!1,t.$apply(),s.finish(12);case 16:s.next=19;break;case 18:o&&(t.service=n.data.find(function(t){return t.name===o}),a.method.toggleActions(!1));case 19:t.service.page&&(e=t.service.page,t.page={color:e.color,colorStart:tinycolor(e.color).lighten(10),colorEnd:tinycolor(e.color).darken(10),logoBg:e.logoBg,button:_objectSpread({className:"orange"},e.button||{}),gallery:c(t.service)});case 20:case"end":return s.stop()}},s,null,[[2,9,12,16]])}));return function(){return e.apply(this,arguments)}}();s()}]),angular.module("marketplace").controller("marketplaceInstalledCtrl",["$scope","marketPlaceService","db","$rootScope","apiRouteService",function(t,e,n,r,a){t.integrations=n.storage.integrations,t.toggle=_asyncToGenerator(regeneratorRuntime.mark(function o(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,a.integrations().edit({_id:this.item._id,active:!this.item.active});case 3:return this.item.active=!this.item.active,t.next=6,n.method.reload("integrations");case 6:t.next=10;break;case 8:t.prev=8,t.t0=t["catch"](0);case 10:case"end":return t.stop()}},o,this,[[0,8]])})),t["delete"]=_asyncToGenerator(regeneratorRuntime.mark(function i(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,a.integrations()["delete"](this.item);case 3:return t.next=5,n.method.reload("integrations");case 5:t.next=9;break;case 7:t.prev=7,t.t0=t["catch"](0);case 9:case"end":return t.stop()}},i,this,[[0,7]])})),r.$on("WS_UPDATE_INTEGRATIONS",function(){n.method.reload("integrations")}),n.method.init("integrations")}]),angular.module("marketplace").directive("marketplace",["$timeout",function(t){return{restrict:"C",link:function(e,n){t(function(){$(".disabled",n).each(function(){$(this).removeAttr("href")})})}}}]).directive("steps",[function(){return{restrict:"C",link:function(t,e){var n=function(){$(".step",e).each(function(t){var e=$(this);e.prepend($('\n            <div class="number"><span>'.concat(t+1,"</span></div>\n          ")))})};$(e).hasClass("my")&&n()}}}]),angular.module("cloudshop.journal").controller("journalCtrl",["$scope","db","dateRange","apiRouteService","$state","$stateParams","api","docService",function(t,e,n,r,a,o,i,c){function s(){e.method.init(["suppliers","staff"])}t.db=e.storage,t.types=c.types;var u={1:!0,2:!1};t.filter={name:"_documentList",onChange:function(n){Promise.all([e.method.get("stores"),e.method.get("accounts")]).then(function(){3==n.status?(n.deleted=!0,delete n.status):n.status&&(n.status=u[n.status]),n.payment&&(n.payment="1"===n.payment),n.fiscal&&(n.fiscal="0"===n.fiscal?!0:null),""===n.search_text&&delete n.search_text,n.state&&(n.state=[+n.state]),"cashier"===i.user.positions().type&&(n.user=i.user.data._id,n.my=["sales","return_sales"]),t.query=n,console.log("$scope.query",t.query),t.$apply()})},fields:[{_id:"search_text",name:"SEARCH_BY_NUMBER_OR_COMMENT",type:"text",show:!0,required:!0},{_id:"date",name:"DATE",type:"date",defaultValue:[+moment().subtract(60,"days").startOf("day").format("X"),+moment().endOf("day").format("X")]},{_id:"from",name:"SENDER",type:"dropdown",settings:{name:"stores,suppliers,clients",limit:3,search:!0}},{_id:"to",name:"RECIPIENT",type:"dropdown",settings:{name:"stores,suppliers,clients",limit:3,search:!0}},{_id:"user",name:"AUTHOR",type:"dropdown",settings:{name:"staff",limit:10,search:!0}},{_id:"status",name:"STATUS",type:"dropdown",show:!0,settings:{name:[{_id:1,name:"APPLIED"},{_id:2,name:"DELAYED"},{_id:3,name:"DELETED"}],limit:3}},{_id:"payment",name:"PAYMENT",type:"dropdown",show:!0,settings:{name:[{_id:1,name:"PAID"},{_id:2,name:"UNPAID"}],limit:2}},{_id:"type",name:"TYPE",type:"dropdown",show:!0,settings:{name:_.map(t.types,function(t,e){return _objectSpread({},t,{name:t.title,_id:e})}),limit:10,search:!0}},{_id:"state",name:"ORDER_STATUS",type:"dropdown",settings:{name:_.clone(c.states.filter(function(t){return t._id}),!0),search:!0}},{_id:"fiscal",name:"Фискальный чек",type:"dropdown",settings:{name:[{_id:"0",name:"Да"},{_id:"1",name:"Нет"}],search:!0}}]},t.$on("$destroy",function(){}),s()}]),angular.module("cloudshop.gift",[]).config(["$stateProvider",function(t){t.state("authenticated.card.gift",{url:"/gift",templateUrl:"js/pages/gift/_view.html",controller:"giftCtrl",data:{pageTitle:"GIFT"}})}]),angular.module("cloudshop.gift").controller("giftCtrl",["$scope","$state","$http","$sce","$rootScope","api","CONFIG",function(t,e,n,r,a,o,i){function c(){t.url=r.trustAsResourceUrl("https://".concat(i.billing,"/getBonus.php?t=").concat(o.user.data.token,"&c=").concat(o.user.clientID()))}c()}]),angular.module("cloudshop.dashboard",[]).config(["$stateProvider",function(t){t.state("authenticated.dashboard",{url:"/?signup",templateUrl:"js/pages/dashboard/_view.html",controller:"dashboardCtrl",data:{pageTitle:"DASHBOARD",permission:"dashboard",redirectTo:"authenticated.card.catalog.list"}})}]),angular.module("cloudshop.dashboard").directive("panelDocsLink",["dashboardService","api",function(t,e){return{restrict:"A",link:function(e,n,r){e.docs=t.panel.docs,e.$watch("docs.type",function(t,e){t&&t!==e&&$(n).is(".active");
});var a,o=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function r(){var n,a;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,n=t.panel.docs.initCurrent(e.item.type,e.item.sub_type),a=n.data.data,r.abrupt("return",a);case 5:return r.prev=5,r.t0=r["catch"](0),console.warn(r.t0),r.abrupt("return",[]);case 9:case"end":return r.stop()}},r,null,[[0,5]])}));return function(){return n.apply(this,arguments)}}(),i=function(t){_.chain(t).filter(function(t){return t.status}).map(function(t){return t.products}).flatten().value()};$(n).on("click","a",function(){a?$("td",a).empty():(a=$('<tr><td colspan="4"></td></tr>'),n.parent().after(a)),$(n).addClass("active"),o().then(function(t){console.warn({data:t}),$("td",a).html(t.length),i(t)})})}}}]),angular.module("cloudshop.dashboard").service("dashboardService",["db","chartService","api","docService","localStorageService","catalogStockTotalService","catalogFilterS","$state",function(t,e,n,r,a,o,i,c){a.set("chart.stores",(a.get("chart.stores")||[]).filter(function(e){return!!_.where(t.storage.stores.data,{_id:e})[0]}));var s={stock:{loading:!0,storage:{store:a.get("dashboard.stock.stores")||[]},fullData:[],data:[],openCost:function(){i.query={types:["inventory"],prices:[{_id:"cost",type:"cost",values:{from:0,to:0}}]},c.go("authenticated.card.catalog.list")},openStock:function(){i.query={types:["inventory"],stocks:[{_id:"main",name:"GENERAL",type:"main",values:{symbol:"<",value:0}}]},c.go("authenticated.card.catalog.list")},openExpired:function(){i.query={expiration:{value:null,type:2}},c.go("authenticated.card.catalog.list")},calcByStore:function(){var t=this.storage.store,e=_toArray(this.fullData.data),n=e[0],r=e.slice(1);if(t.length){var a=r.filter(function(e){return t.includes(e.store._id)});this.data={cost:_.sum(a,"cost"),price:_.sum(a,"price"),qty:_.sum(a,"qty"),emptyCost:_.chain(a.map(function(t){return t.emptyCost})).flatten().uniq().value().length,expirationDate:_.chain(a.map(function(t){return t.expirationDate})).flatten().uniq().value().length}}else this.data=_objectSpread({},n,{emptyCost:this.fullData.emptyCost,emptyStock:this.fullData.emptyStock,expirationDate:this.fullData.expirationDate})},init:function(){var e=this;return a.set("dashboard.stock.stores",this.storage.store.filter(function(t){return!!t})),t.method.init("catalog").then(function(){return t.storage.catalog.formatted}).then(o.init).then(function(t){e.loading=!1,e.fullData=t,e.calcByStore()})["catch"](function(t){console.warn(t)})}},indicators:{loading:!1,chart:{type:a.get("chart.type")||"month",store:a.get("chart.stores")||[],data:[],init:e.init},indicators:{data:[],format:function(){},init:function(){return new Promise(function(t){t()})}},init:function(){var t=this;return _asyncToGenerator(regeneratorRuntime.mark(function e(){var n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t,n.loading=!0,a.set("chart.type",n.chart.type),a.set("chart.stores",n.chart.store.filter(function(t){return!!t})),e.prev=4,e.next=7,Promise.all([s.indicators.chart.init({type:n.chart.type,store_id:n.chart.store}),s.indicators.indicators.init()]);case 7:return r=e.sent,n.loading=!1,e.abrupt("return",r);case 12:e.prev=12,e.t0=e["catch"](4),console.warn(e.t0);case 15:case"end":return e.stop()}},e,null,[[4,12]])}))()},rebuild:function(t){e.field!=t&&(e.field=t,e.rebuild(t))}},events:{data:{},query:{start:moment().format("X"),end:moment().add(1,"year").format("X"),status:!1},init:function(){return new Promise(function(t){t()})}},docs:{show:!1,type:"month",types:_.clone(r.types,!0),loading:!1,format:function(t){var e,n=this;_.forEach(n.types,function(r,a){e=_.where(t.data.data,{_id:a})[0],e=e||{sum:0,qty:0,count:0},e.qty<0&&(e.qty*=-1),n.types[a]=Object.assign(n.types[a],e),"changesinventory"===a&&(n.types[a].deep=!0)})},init:function(){var t=this;return _asyncToGenerator(regeneratorRuntime.mark(function r(){var a,o,i,c,s;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return a=t,a.loading=!0,o=e.types[a.type].range2?"range2":"range",i=+e.types[a.type][o]()[0].format("X"),c=+e.types[a.type][o]()[1].format("X"),r.prev=5,r.next=8,n.data.post("/report/:client/statistic/docs",{start:i,end:c});case 8:return s=r.sent,a.show=!0,a.format(s),a.loading=!1,r.abrupt("return",a.types);case 15:r.prev=15,r.t0=r["catch"](5);case 17:case"end":return r.stop()}},r,null,[[5,15]])}))()},initCurrent:function(t,r){var a=e.types[this.type].range2?"range2":"range",o=+e.types[this.type][a]()[0].format("X"),i=+e.types[this.type][a]()[1].format("X"),c={type:t};return r&&(c.sub_type=r),n.data.post("/search/docs/:client/0/999",_objectSpread({start:o,end:i},c,{v:"v3"}))}}},u={date:_.map(e.types,function(t,e){return t.id=e,t})},d=function(t){var e=[];return t=t||_.keys(s),_.forEach(t,function(t){e.push(s[t].init())}),Promise.all(e)};return{panel:s,block:u,init:d}}]),angular.module("cloudshop.dashboard").controller("dashboardCtrl",["$scope","db","$filter","dateRange","api","dashboardService","chartService","$rootScope","docService",function(t,e,n,r,a,o,i,c,s){function u(){}t.db=e.storage,t.load=!1,t.panel=o.panel,t.block=o.block,t.indicators=i.fields,t.chartService=i,t.$watch("panel.indicators.chart.type",function(e){return"undefined"==typeof e?!1:(t.load=!0,void o.panel.indicators.init().then(function(){t.load=!1,t.$apply()}))}),t.$watch("panel.indicators.chart.store",function(e){return"undefined"==typeof e?!1:void(t.panel.indicators.chart.store.length&&!t.panel.indicators.chart.store[0]?t.panel.indicators.chart.store=[]:(t.load=!0,o.panel.indicators.init().then(function(){t.load=!1,t.$apply()})))}),t.$watch("panel.stock.storage.store",function(e){return"undefined"==typeof e?!1:void(t.panel.stock.storage.store.length&&!t.panel.stock.storage.store[0]?t.panel.stock.storage.store=[]:o.panel.stock.init().then(function(){return t.$apply()}))}),t.$watch("panel.docs.type",function(e){return"undefined"==typeof e?!1:void o.panel.docs.init().then(function(){return t.$apply()})});var d=c.$on("WS_UPDATE_CATALOG",function(){o.init().then(function(){return t.$apply()})});t.$on("$destroy",function(){d()}),u()}]),angular.module("cloudshop.ecommerce",[]).config(["$stateProvider",function(t){t.state("authenticated.card.ecommerce-admin",{url:"/ecommerce-admin",templateUrl:"js/pages/ecommerce/admin/index.html",data:{pageTitle:"Интернет-витрина"}}).state("authenticated.card.ecommerce",{"abstract":!0,url:"/ecommerce",templateUrl:"js/pages/ecommerce/_view.html",controller:"ecommerceCtrl",data:{pageTitle:"Интернет-витрина"}}).state("authenticated.card.ecommerce.start",{url:"/start/",templateUrl:"js/pages/ecommerce/start/_view.html",data:{pageTitle:"START"}}).state("authenticated.card.ecommerce.theme",{url:"/theme/",templateUrl:"js/pages/ecommerce/theme/_view.html",data:{pageTitle:"APPEARANCE"}}).state("authenticated.card.ecommerce.settings",{"abstract":!0,url:"/settings",templateUrl:"js/pages/ecommerce/settings/_view.html",data:{pageTitle:"Интернет-витрина"}}).state("authenticated.card.ecommerce.settings.main",{url:"/settings/main",templateUrl:"js/pages/ecommerce/settings/main/index.html",data:{pageTitle:"ABOUT_SHOP"}}).state("authenticated.card.ecommerce.settings.domain",{url:"/settings/domain",templateUrl:"js/pages/ecommerce/settings/domain/index.html",data:{pageTitle:"STOREFRONT_SETTINGS"}}).state("authenticated.card.ecommerce.settings.products",{url:"/settings/products",templateUrl:"js/pages/ecommerce/settings/products/index.html",data:{pageTitle:"PRODUCT"}}).state("authenticated.card.ecommerce.settings.other",{url:"/settings/other",templateUrl:"js/pages/ecommerce/settings/other/index.html",data:{pageTitle:"OTHER"}}).state("authenticated.card.ecommerce.settings.analytics",{url:"/settings/analytics",templateUrl:"js/pages/ecommerce/settings/analytics/index.html",data:{pageTitle:"ANALYTICS"}})}]),angular.module("cloudshop.company").controller("ecommerceCtrl",["$scope","db","companyService","api","cardService","$state","$http","imageUpload","$rootScope","safeApply",function(t,e,n,r,a,o,i,c,s,u){function d(t){return _.filter(e.storage.catalog.data,function(e){return e.categories&&e.categories.indexOf(t)>=0}).length}function l(){t.data.status||o.go("authenticated.card.ecommerce.start"),e.method.init(["categories"]).then(function(e){var n=_slicedToArray(e,1),r=n[0];t.data.settings.categories=t.data.settings.categories||[];var a=(t.data.domains.sub||"").split("."),o=_toArray(a),i=o[0],c=o.slice(1);t.meta.sub=i,t.meta.domain=c.length?c.join("."):"mycloudshop.ru",t.categories=_.map(r,function(e){var n=d(e.title);return{title:e.title,items:n,selected:t.data.settings.categories.indexOf(e.title)>=0}}),t.$apply()})}t.meta={dropdown:{name:[{name:"mycloudshop.ru",_id:"mycloudshop.ru"},{name:"cloudshop.me",_id:"cloudshop.me"},{name:"cloudshop.in.ua",_id:"cloudshop.in.ua"},{name:"cloudshop.uz",_id:"cloudshop.uz"},{name:"cloudshop.kg",_id:"cloudshop.kg"}],icon:"dropdown"},domain:null,sub:null},t.db=e,t.errorText="",t.headerBgTab=0,t.ecommerce=n.ecommerce,t.data=_.clone(n.ecommerce.value,!0),t.origData=n.ecommerce.value,t.domain=t.origData.domains.main||t.origData.domains.sub,t.page=o.current.data,t.dropdown={store:{title:"STORE",name:"stores",create:"authenticated.card.store_add","class":"floating fluid basic labeled icon button",icon:"home",search:!0},zero_stocks:{title:"ZERO_STOCKS",name:[{name:"SHOW_ZERO_STOCKS_GOODS",_id:1},{name:"HIDE_ZERO_STOCKS_GOODS",_id:2},{name:"Показывать с пометкой «нет на складе»",_id:3}],"class":"floating fluid icon basic button",icon:"dropdown",search:!0},country:{placeholder:"ENTER_COUNTRY_NAME",name:"countries","class":"basic",limit:15,search:!0},currency:{placeholder:"ENTER_CURRENCY",name:"currencies","class":"basic",limit:10,search:!0,onChange:function(e,n){t.data.settings.currency=_objectSpread({},t.data.settings.currency,{},n),u(t)}}},t.$watch("form.$valid",function(t){a.init.toggle(0,!!t)}),t.$watch("meta.sub",function(e){var n="";null!==e&&(e&&(n=e+"."+t.meta.domain),t.data.domains.sub!==n&&(t.data.domains.sub=n))}),t.$watch("meta.domain",function(e){var n=t.data.domains.sub;n&&e&&(t.data.domains.sub=n.split(".")[0]+"."+e)}),t.$on("$destroy",function(){p()}),t.start={step:1,next:function(){this.step++,s.$broadcast("ecommerce.step",this.step-1)},prev:function(){this.step--},enable:function(){var e=this;this.saveStep(!1).then(function(){t.data.status=!0,e.saveStep()})},saveStep:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!0;return t.save().then(function(){e&&t.start.next()})},selectAllCats:function(){t.data.settings.categories=t.categories.map(function(t){return t.title}),t.categories=t.categories.map(function(t){return t.selected=!0,t})},check:function(e){var n=t.data;return e=e||this.step,1==e?n.info.title&&t.meta.sub&&n.info.description:2==e?!!n.info.email:3==e?!!n.settings.store:void 0}},t.getTheFiles=function(e,n){angular.forEach(e,function(e){c.save(e).then(function(e){"logo"==n?t.data.info.logo=e:"cover"==n&&(t.data.theme.cover=e),t.save(),t.$apply()})})},t.categorySelect=function(){this.item.selected=!this.item.selected,t.data.settings.categories=t.categories.filter(function(t){return t.selected}).map(function(t){return t.title})},t.disable=function(){n.ecommerce.value.status=!1,n.ecommerce.edit(n.ecommerce.value)},t.theme={logo:{"delete":function(){t.data.info.logo=null,t.save()}},cover:{select:function(e){t.data.theme.cover=e,t.save()}},bodyBg:{select:function(e){t.data.theme.bodyBg=e,t.save()}}},t.save=function(){return t.loading=!0,n.ecommerce.edit(t.data).then(function(){return r.user.init()}).then(function(){t.errorText="",t.origData=_.clone(t.data,!0),t.domain=t.origData.domains.main||t.origData.domains.sub}).then(function(){s.$broadcast("updateMenu"),r.user.getEcommerce().status||o.go("authenticated.card.ecommerce.start"),t.loading=!1,t.$apply()})["catch"](function(e){var n=e.data,r={604:"STORE_DESCRIPTION_MUST_BE_NO_MORE_THAN_1",603:"THIS_DOMAIN_IS_ALREADY_TAKEN",605:"INVALID_DOMAIN_NAME",900:"Домен занят другим пользователем CloudShop",901:"Необходимо установить запись типа А в настройках DNS вашего домена",902:"INVALID_DOMAIN_NAME"};return t.errorText=r[n.error],t.loading=!1,t.$apply(),Promise.reject(n)})};var p=t.$on("updater",function(t,e){"stores"==e.type&&(n.ecommerce.value.settings.store=e.data._id)});l()}]),angular.module("cloudshop.company").directive("domainTabs",[function(){return{restrict:"C",link:function(t,e){var n=$(".ui.buttons>a",e),r=$(".tab",e),a=function(t){r.hide(),r.eq(t).show(),n.removeClass("active"),n.eq(t).addClass("active")};n.bind("click",function(){var t=$(this).index();a(t),r.eq(t).find("input").focus().select()}),a(0)}}}]),angular.module("cloudshop.catalog").service("catalogService",["api","IMAGE_UPLOAD_URL","$http","apiRouteService","db","fn","$rootScope","tablePaginationService","webworker","$state","confirmModal","$filter",function(t,e,n,r,a,o,i,c,s,u,d,l){var p=[{add:"PRODUCT",title:"PRODUCT",value:"inventory",enabled:!0,selected:!1,icon:"cube"},{add:"SERVICES",title:"SERVICE",value:"service",enabled:!0,selected:!1,icon:"asterisk"},{add:"SET",title:"SET",value:"set",enabled:!0,selected:!1,icon:"cubes"},{add:"GROUPS",title:"GROUP",value:"group",enabled:!0,selected:!1,icon:"folder"}],m={data:{},stock:{},clone:{},template:function(){return{type:"inventory",store_prices:{},group:{_id:null,name:null,property:[{key:"",values:""}]},properties:[{key:"",values:[]}],component:[],container:[],categories:[],packs:[],unit:null,price:0,purchase:0,discount:0,pic:[]}},format:function(t){return t=t||_.clone(this.data,!0),this.data=Object.assign(this.template(),t),delete this.data.info,this.data.discount=+this.data.discount,this.data.purchase=+this.data.purchase,this.data.price=+this.data.price,this.data.store_prices=!this.data.store_prices||Array.isArray(this.data.store_prices)?{}:this.data.store_prices,this.data.group.property=_.filter(this.data.properties,function(t){return t.key&&t.values.length}),delete this.data.properties,this.data},groups:{extract:function(t){var e=arguments;return _asyncToGenerator(regeneratorRuntime.mark(function n(){var r,o;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return r=e.length>1&&void 0!==e[1]?e[1]:!1,n.next=3,s("catalog",{data:t,withGroups:r,cmd:"groups",catalog:a.storage.catalog.formatted});case 3:return o=n.sent,n.abrupt("return",o);case 5:case"end":return n.stop()}},n)}))()},extractWithGroup:function(t){var e=this;return _asyncToGenerator(regeneratorRuntime.mark(function n(){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e.extract(t,!0);case 2:return n.abrupt("return",n.sent);case 3:case"end":return n.stop()}},n)}))()}},importFormat:function(){var t=this.format(),e=[];return t.group._id=o.guid(),t.group.name=t.name,angular.forEach(m.properties.data,function(n,r){var a=_objectSpread({},_.clone(t,!0),{},m.properties.props[r]);a.group.property=_.map(n,function(e,n){return{key:t.group.property[n].key,value:e}}),a.name=t.name+" ("+n.join(", ")+")",e.push(a)}),e},saveOne:function(e){return t.data.put("/data/:client/catalog/"+e._id,_objectSpread({},e,{v:"v3"}))},save:function(){function t(){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function n(){var t,e,a,o,c,s,u,d,l;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(t=_.clone(m.stock,!0)||{},e=_.clone(m.data,!0),"set"!=m.data.type||0!=m.data.container.length){n.next=5;break}return alert("SET_COMPOSITION_IS_EMPTY"),n.abrupt("return",{});case 5:if(!m.data._id){n.next=23;break}if(delete m.data.group,a=_.clone(m.data,!0),"set"==a.type&&(a.container=a.container.map(function(t){return delete t.weight,delete t.originPrice,t})),a.packs&&a.packs.length&&(a.packs=a.packs.filter(function(t){return t.name&&t.qty})),!a.pic.length){n.next=14;break}return n.next=13,m.image.save(a.pic);case 13:a.pic=n.sent;case 14:return n.next=16,m.edit(a);case 16:return o=n.sent,"set"==m.data.type&&m.complect.update(),"inventory"==e.type&&angular.forEach(t,function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function n(t,a){var o;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(e.stock=e.stock||{},e.stock[a]=e.stock[a]||0,o=t-e.stock[a],0===o||!o){n.next=6;break}return n.next=6,r.document().add(_objectSpread({type:"changes"},m.doc.create(o,a)));case 6:case"end":return n.stop()}},n)}));return function(e,n){return t.apply(this,arguments)}}()),m.clear(),n.abrupt("return",[o]);case 23:if(c=_.clone(m.data,!0),"set"==c.type&&(c.container=c.container.map(function(t){return delete t.weight,delete t.originPrice,t})),!c.pic.length){n.next=29;break}return n.next=28,m.image.save(c.pic);case 28:c.pic=n.sent;case 29:return n.next=31,m.add(c);case 31:if(s=n.sent,s.length){n.next=34;break}throw new Error("EMPTY_PRODUCT");case 34:return u=s,m.data._id=s[0]._id,"set"==m.data.type&&m.complect.update(),"inventory"==m.data.type&&(0==m.properties.data.length?angular.forEach(t,function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.document().add(_objectSpread({type:"changes",sub_type:"in"},m.doc.create(t,n)));case 2:case"end":return e.stop()}},e)}));return function(e,n){return t.apply(this,arguments)}}()):(d={},u.forEach(function(t){var e=t.stock||{};console.log("stocks",e),Object.keys(e).forEach(function(n){Array.isArray(d[n])===!1&&(d[n]=[]),e[n]&&d[n].push(_objectSpread({type:"changes",sub_type:"in"},m.doc.create(e[n],n,t)))})}),l=[],Object.keys(d).forEach(function(t){var e=_objectSpread({},d[t][0],{qty:0,products:[]});d[t].forEach(function(t){e.products.push(t.products[0]),e.qty+=t.qty}),l.push(e)}),console.log("documents",l),l.forEach(function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.document().add(t);case 2:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}()))),i.$broadcast("catalog.create",{type:c.type,hasBarcode:!!c.barcode,hasSku:!!c.sku,hasPhoto:!!c.pic.length,hasStock:!!m.stock.length,hasCategory:!!c.categories.length,hasModifications:!!m.properties.data.length,hasGroup:0!==c.id_group,hasSupplier:!!c.supplier,hasPrice:!!c.price,hasPurchase:!!c.purchase,count:s.length,hasMarkedItem:!!c.marking_type,markingType:c.marking_type,generatedBarcode:!1,findByBarcode:!1}),m.clear(),n.abrupt("return",[s]);case 41:case"end":return n.stop()}},n)}));return t}(),add:function(){function t(t){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function n(t){var e,a,o,i,c;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(t=t||m.format(),t._id||!(m.properties.data.length>0)){n.next=13;break}for(e=m.importFormat(),a=e.map(function(t){return t.name}).join("<br />"),o=0;o<e.length;o+=1)e[o].pic=t.pic;return i="\n						".concat(l("translate")("WILL_BE_CREATED_PRODUCTS")," ").concat(m.properties.data.length,"<br />\n				 		").concat(a,"\n					"),n.next=8,d(i);case 8:return n.next=10,r.catalog()["import"](e);case 10:return n.abrupt("return",n.sent);case 13:return n.next=15,r.catalog().add(t);case 15:return c=n.sent,n.abrupt("return",[c]);case 17:case"end":return n.stop()}},n)}));return t}(),edit:function(){function t(t){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function n(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||m.format(),t=this.actualizeComponent(t),e.next=4,r.catalog().edit(t);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}},n,this)}));return t}(),actualizeComponent:function(t){try{t.component.length&&(t.component=t.component.filter(function(t){return a.storage.catalog.data.find(function(e){return e._id===t._id})}));var e=a.storage.catalog.formatted.filter(function(t){return"set"===t.type});e.forEach(function(e){var n=e.container.find(function(e){return e._id===t._id});n&&!t.component.find(function(t){return t._id===e._id})&&t.component.push(_objectSpread({},n,{_id:e._id,name:e.name,type:"set"}))})}catch(n){}finally{return t}},updateComponent:function(){function t(t){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function n(t){var e;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return e=m.data.container.map(function(e){var n=a.storage.catalog.formatted.find(function(t){return t._id===e._id});if(n){var r;switch(t){case"delete":r=n.component.filter(function(t){return t._id!==m.data._id});break;case"create":r.push({})}return{_id:e._id,name:e.name,component:r}}}).filter(function(t){return!!t}),n.next=3,r.catalog()["import"](e,"put");case 3:case"end":return n.stop()}},n)}));return t}(),remove:function(){function t(){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function n(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.catalog()["delete"](m.data);case 2:if(t=e.sent,"set"!==m.data.type){e.next=6;break}return e.next=6,this.updateComponent("delete");case 6:return e.abrupt("return",t);case 7:case"end":return e.stop()}},n,this)}));return t}(),getOne:function(e){return t.data.get("/data/:client/catalog/"+e,{v:"v3"})},doc:{create:function(t,e,n){return n=n||m.data,{from:m.doc.store.obj(e),status:!0,products:m.doc.format(t,n),store:e,sub:n.purchase*t,discount_sum:0,discount_percent:0,sum:n.purchase*t,qty:t,date:+moment().format("X")}},supplier:{data:null,obj:function(){var t=_.where(a.storage.suppliers.data,{_id:this.data})[0];return{_id:this.data,name:t?t.name:null,type:"suppliers"}}},store:{obj:function(t){var e=_.where(a.storage.stores.data,{_id:t})[0];return{_id:e._id,name:e?e.name:null,type:"stores"}}},format:function(t,e){return e=e||m.format(),[{_id:e._id,qty:t,price:e.purchase,sub:e.purchase*t,discount_sum:0,discount_percent:0,sum:e.purchase*t,product:{name:e.name,sku:e.sku,barcode:e.barcode,categories:e.categories,type:e.type}}]}},stocks:{count:function(){return _.sum(m.stock,function(t){return t})}},complect:{check:function(){m.data.container=m.data.container.map(function(t){return t.price=t.originPrice,t.qty=Math.abs(t.qty),t.sum=t.price*t.qty,t}),console.log("check",_.clone(m.data.container,!0)),this.updatePrice(),this.updateWeight()},updatePrice:function(){return m.data.price=+_.sum(m.data.container,"sum").toFixed(2),m.data.price},changePrice:function(){"set"===m.data.type&&this.changePrices()},recalculateSum:function(){var t=0;m.data.container=m.data.container.map(function(e){var n=a.storage.catalog.data.find(function(t){return t._id===e._id});return e.price=(null===n||void 0===n?void 0:n.price)||0,e.sum=e.price?e.price*e.qty:0,t+=e.sum,e}),m.data.price=t,m.data.container=m.data.container.map(function(e){return e.weight=e.sum/t,e})},changePrices:function(){m.data.container=m.data.container.map(function(t){return t.sum=+(m.data.price*t.weight).toFixed(2),t.price=t.sum/t.qty||0,t});var t=m.data.price-_.sum(m.data.container,"sum").toFixed(2);0!==t&&m.data.container.some(function(e,n){return 0!==m.data.container[n].price?(m.data.container[n].sum+=t,!0):!1}),console.log("changePrice",m.data.container)},updateWeight:function(){var t=_.sum(m.data.container,"sum");m.data.container=m.data.container.map(function(e){return e.weight=e.sum/t,e.originPrice=e.price,e}),console.log("updateWeight",_.clone(m.data.container,!0))},add:function(t){t.selected=!0,m.data.container.push({_id:t._id,exist:!0,name:t.name,qty:1,price:+t.price.toFixed(2),sum:+t.price.toFixed(2),type:t.type,unit:t.unit||null,originPrice:t.price}),this.check()},remove:function(t){m.data.container=m.data.container.filter(function(e){return e._id!==t._id}),this.check()},update:function(){var t=[],e=_objectSpread({},m.data);console.log("update",e);var n=a.storage.catalog.data.map(function(t){return{_id:t._id,name:t.name,component:t.component||[]}}).filter(function(t){return t._id!==e._id});return _.forEach(n,function(n){e._id&&_.where(n.component,{_id:e._id}).length&&(n.component=n.component.filter(function(t){return t._id!==e._id}),t.push(n));var r=e.container.find(function(t){return t._id===n._id});r&&(n.component.push(_objectSpread({},r,{_id:e._id,name:e.name,type:"set"})),t=t.filter(function(t){return t._id!==n._id}),t.push(n))}),console.log("update",t),r.catalog()["import"](t,"put")},format:function(){return _.clone(a.storage.catalog.data,!0).map(function(t){return t.qty=1,t})},init:function(){return _asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,a.method.init("catalog");case 2:c.data=m.complect.format(),c.limit=10,c.init(),i.$apply();case 6:case"end":return t.stop()}},t)}))()}},properties:{data:[{key:"",values:[]}],props:[],split:function(){for(var t=_.clone(m.data.properties,!0),e=[t[0].key],n=t[0].values,r=1;r<t.length;r++)if($.trim(t[r].key)&&_.size(t[r].values)){e.push(t[r].key);var a=n,o=t[r]?t[r]:null;if(o){var i=[],c=o.values;a.forEach(function(t){c.forEach(function(e){i.push(t+":"+$.trim(e))})}),n=i}}return n=n.map(function(t){return t.split(":")})},check:function(){var t=_.last(m.data.properties);return t&&t.key&&t.values.length},add:function(){this.check()&&m.data.properties.push({key:"",values:[]})},remove:function(t){this.data=this.data.filter(function(e,n){return n!=t}),this.props=this.props.filter(function(e,n){return n!=t})}},image:{save:function(t){return _asyncToGenerator(regeneratorRuntime.mark(function r(){var a,o,i;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return a=[],t.forEach(function(t){a.push(new Promise(function(e){/^data\:image\//.test(t)?fetch(t).then(function(t){return t.blob()}).then(e):e(t)}))}),r.next=4,Promise.all(a);case 4:return o=r.sent,a=[],o.forEach(function(t){a.push(new Promise(function(r){if("string"==typeof t)r(t);else{var a=new FormData;a.append("upfile",t),n.post(e,a,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).then(function(t){var e=t.data.url?t.data.url:"";r(e)})}}))}),r.next=9,Promise.all(a);case 9:return i=r.sent,r.abrupt("return",i.filter(function(t){return!!t}));case 11:case"end":return r.stop()}},r)}))()},data:[]},clear:function(){m.data=m.template(),m.stock={}},init:function(){m.complect.init()}};return i.$on("EVENT_CATALOG_DUPLICATE",function(t,e){var n=(e._id,e._app,e._client,e._user,e.stock,e.code,e.cost,e.uuid,e.created,e.stockCount,e.component,e.$$hashKey,e.container),r=(e.group,_objectWithoutProperties(e,["_id","_app","_client","_user","stock","code","cost","uuid","created","stockCount","component","$$hashKey","container","group"]));m.data=_objectSpread({},r,{container:n.map(function(t){return _objectSpread({},t,{id_parent:void 0})})}),u.go("authenticated.card.catalog.create")}),m.clear(),{method:m,types:p,selected:[]}}]),angular.module("cloudshop.catalog").service("filterCatalogService",["paginator","db","catalogService","$filter","$timeout","catalogFilterService","webworker",function(t,e,n,r,a,o,i){var c=e.storage,s=function(){t.data.filtered=_toConsumableArray(c.catalog.formatted)},u={search:{enable:!1,query:null,prevValue:null,init:function(){function n(){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(){var n;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(!this.query){r.next=10;break}return null===this.prevValue&&(u.showGroup.prevValue=u.showGroup.value,u.showGroup.value=!1),this.prevValue=this.query,this.enable=!0,r.next=6,i("catalog",{cmd:"search",query:this.query,catalog:t.data.filtered});case 6:n=r.sent,this.query===n.query&&(t.data.filtered=n.data.map(e.storage.catalog.proto),t.method.changeStep(1)),r.next=11;break;case 10:this.enable&&(u.showGroup.value=u.showGroup.prevValue,this.prevValue=null,this.enable=!1);case 11:case"end":return r.stop()}},a,this)}));return n}()},group:{value:0,oldValue:0,page:0,init:function(){var e=this;if(u.showGroup.value){var n=t.data.filtered.filter(function(t){return t.id_group==e.value});t.data.filtered=n}setTimeout(function(){e.value!==e.oldValue&&(0==e.oldValue?(e.page=t.view.currentStep,t.method.changeStep(1)):0==e.value&&t.method.changeStep(e.page),e.oldValue=e.value)})}},showGroup:{value:!0,prevValue:!0,init:function(){var e=this,n=t.data.filtered.filter(function(t){return e.value||"group"!==t.type});t.data.filtered=n},toggle:function(t){this.value="undefined"==typeof t?!this.value:t,this.value===!1&&(u.group.value=0),d()}},sort:{enable:!0,reverse:{updated:!0,name:!0},fieldName:"updated",init:function(){var e=this;if(this.enable){var n,a=t.data.filtered.filter(function(t){return"group"!==t.type}),o=/^store_[0-9a-z]{24}$/;if(o.test(this.fieldName)){var i=this.fieldName.replace("store_","");n=a.sort(function(t,n){var r=t.stock[i]||0,a=n.stock[i]||0;return e.reverse[e.fieldName]?r>a?-1:1:a>r?-1:1})}else n=r("orderBy")(a,this.fieldName,this.reverse[this.fieldName]);var c=t.data.filtered.filter(function(t){return"group"===t.type}).sort(function(t,e){return t.name>e.name?1:-1});t.data.filtered=[].concat(_toConsumableArray(c),_toConsumableArray(n))}},field:function(e){this.reverse[e]=!this.reverse[e],this.enable=!0,this.fieldName=e,this.init(),t.method.init(!0)}}},d=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(e,r){var a;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return s(),console.time("view-time"),a=[],_.forEach(u,function(t,e){"object"==_typeof(u[e])&&u[e].init&&a.push(u[e].init())}),n.next=6,Promise.all(a);case 6:return n.next=8,o.init(t.data.filtered,t.data.catalogQuery);case 8:t.data.filtered=n.sent,console.timeEnd("view-time"),t.method.init(!!e,!!r);case 11:case"end":return n.stop()}},n)}));return function(t,n){return e.apply(this,arguments)}}();return{f:u,clear:s,init:d}}]),angular.module("cloudshop.catalog").controller("catalogCtrl",["$scope","catalogColumnService","db","$state","$filter","paginator","profile","catalogService","filterCatalogService","apiRouteService","$rootScope","$timeout","catalogGroupService","docService","catalogFilterS","api","confirmModal","alertModal","safeApply",function(t,e,n,r,a,o,i,c,s,u,d,l,p,m,f,h,g,v,y){function b(t){return E.apply(this,arguments)}function E(){return E=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var a,o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.db.catalog.formatted=t.db.catalog.formatted.filter(function(t){return!_.where(r,{_id:t._id}).length}),s.init(!0),e.prev=2,a=[],o=r.filter(function(t){return"set"===t.type}),o.forEach(function(t){t.container.forEach(function(e){var r=n.storage.catalog.formatted.find(function(t){return t._id===e._id});r&&a.push({_id:r._id,name:r.name,component:r.component.filter(function(e){return e._id!==t._id})})})}),e.next=8,u.catalog()["import"](r,"delete");case 8:return i=e.sent,e.next=11,u.catalog()["import"](a,"put");case 11:return c.selected=[],e.abrupt("return",i);case 15:e.prev=15,e.t0=e["catch"](2),console.warn(e.t0),v("ERROR_DELETING_PRODUCT");case 19:return e.prev=19,y(t),e.finish(19);case 22:case"end":return e.stop()}},e,null,[[2,15,19,22]])})),E.apply(this,arguments)}t.db=n.storage,t.filters=s,t.filter=s.f,t.catalogService=c,t.now=+moment().format("X"),t.pg=o,t.role=h.user.positions().type,t.$watch("selectedDropdown",function(e){e&&void 0!=e&&(t.groupModal=!0,t.selectedDropdown=!1)}),t.$watch("pg.data.visible",function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(e){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(e&&void 0!=e){n.next=2;break}return n.abrupt("return");case 2:return n.next=4,c.method.groups.extract(t.pg.data.filtered);case 4:t.visibleCount=n.sent.length,y(t);case 6:case"end":return n.stop();
}},n)}));return function(t){return e.apply(this,arguments)}}()),d.$on("DB.CATALOG.LOADED_COUNT",function(e,n){var r=n.count,a=n.total;t.count=r,t.total=a,t.$apply()});var S=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function r(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.pg.data.filtered=n.storage.catalog.formatted,e.next=3,s.init(!1,!0);case 3:y(t);case 4:case"end":return e.stop()}},r)}));return function(){return e.apply(this,arguments)}}(),T=d.$on("WS_UPDATE_CATALOG",S);t.$on("$destroy",function(){t.pg.method.clear(),T()}),t.filter_cat=function(e){t.categories.map(function(t){return t.title==e&&(t.selected=!0),t}),t.filter_categories=!0},t.filterQuery=_asyncToGenerator(regeneratorRuntime.mark(function R(){var e;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return t.searchLoading=!0,e=new Date,n.next=4,s.init();case 4:console.log("search duration:",((new Date-e)/1e3).toFixed(2),"s"),t.searchLoading=!1,y(t);case 7:case"end":return n.stop()}},R)})),t.groupProducts=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,w();case 2:p.selected=e.sent,p.selectedFirstLvl=c.selected,r.go("authenticated.card.catalog.group",{tab:t});case 5:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}(),t.doc=m,t.addToDoc=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,w();case 2:n=e.sent,r.go(t),l(function(){n.forEach(function(t){m.doc.product.add(t,1,{estimated:!1,counted:!1,from:"catalog-external"})})});case 5:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}(),t.catalogFilterMethods={onChange:function(){function e(t){return n.apply(this,arguments)}var n=_asyncToGenerator(regeneratorRuntime.mark(function r(e){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return o.data.catalogQuery=e,s.f.showGroup.value=!1,n.next=4,s.init();case 4:y(t);case 5:case"end":return n.stop()}},r)}));return e}()},t.toggleGroup=_asyncToGenerator(regeneratorRuntime.mark(function C(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s.f.showGroup.value=!s.f.showGroup.value,e.next=3,s.init();case 3:y(t);case 4:case"end":return e.stop()}},C)})),t.removeSelectedProducts=_asyncToGenerator(regeneratorRuntime.mark(function A(){var t,e,n,r,o;return regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,k();case 2:return t=i.sent.map(function(t){return{_id:t._id,deleted:!0,name:t.name,type:t.type,container:t.container}}),e=t.filter(function(t){return"group"===t.type}).length,n=t.filter(function(t){return"group"!==t.type}).length,i.prev=5,r=a("translate")("Будет удалено<br /> групп: {groups}<br /> позиций: {products}<br /> Вы уверены?",{groups:e,products:n}),i.next=9,g(r);case 9:return i.next=11,b(t);case 11:return o=i.sent,i.abrupt("return",o);case 15:i.prev=15,i.t0=i["catch"](5);case 17:case"end":return i.stop()}},A,null,[[5,15]])}));var w=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,c.method.groups.extract(c.selected.length?c.selected:o.data.filtered);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}},e)}));return function(){return t.apply(this,arguments)}}(),k=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,c.method.groups.extractWithGroup(c.selected.length?c.selected:o.data.filtered);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}},e)}));return function(){return t.apply(this,arguments)}}();t.changePrices=_asyncToGenerator(regeneratorRuntime.mark(function O(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,w();case 2:t=e.sent.map(function(t){return t._id}),d.$broadcast("pushProductToPriceChange",t);case 4:case"end":return e.stop()}},O)})),t.openStockTotal=_asyncToGenerator(regeneratorRuntime.mark(function I(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,w();case 2:t=e.sent,d.$broadcast("pushProductStockTotal",t);case 4:case"end":return e.stop()}},I)})),t.selectedDataVisible=_asyncToGenerator(regeneratorRuntime.mark(function P(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.selectedData(!0);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},P)}));var $=function D(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=t.find(function(t){return t._id===e});return r?(n.push(r.name),D(t,r.id_group,n)):n.reverse().join("/")};t.selectedData=_asyncToGenerator(regeneratorRuntime.mark(function N(){var t,r,o,i,c,s,u,d,l,p,m=arguments;return regeneratorRuntime.wrap(function(f){for(;;)switch(f.prev=f.next){case 0:return t=m.length>0&&void 0!==m[0]?m[0]:!1,f.t0=_,f.next=4,k();case 4:f.t1=f.sent,r=f.t0.clone.call(f.t0,f.t1,!0),o=n.storage.catalog.data.filter(function(t){return"group"===t.type}),i=r.filter(function(t){return"group"!==t.type}),c={name:{title:"NAME",type:"string"}},t||_.forEach(e.fields,function(t,e){"pic"!==e&&t.hidden&&(c[e]=t)}),_.forEach(e.data.fields,function(e,n){"pic"!==n&&(!t||t&&e.active)&&(c[n]=e)}),s={},u={},_.forEach(e.data.stores,function(e,n){(!t||t&&e.active)&&(s[n]={title:"".concat(e.title," (Остаток)"),type:"number"},t||(u[n.replace("store_","prices_")]={title:"".concat(e.title," (Цена)"),type:"number"}))}),Object.assign(c,u,s),c.stockCount={title:a("translate")("GENERAL_STOCK"),type:"number"},console.log("db.storage",n.storage),d=[],l=regeneratorRuntime.mark(function h(t){var e,r,a,s;return regeneratorRuntime.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:e=_objectSpread({},i[t]),r=[],a=regeneratorRuntime.mark(function l(t){var a,i,s,u,d,p;return regeneratorRuntime.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:if(a=Object.keys(c)[t],/^store_[0-9a-z]{24}$/.test(a)&&(i=a.replace("store_",""),e[a]=e.stock[i]),/^prices_[0-9a-z]{24}$/.test(a)&&(s=a.replace("prices_",""),e[a]=null===e||void 0===e?void 0:e.store_prices[s]),"id_group"===a&&(e[a]=$(o,e[a])),"categories"===a&&"object"==_typeof(e[a])&&(e[a]=e[a].join(", ")),["created","expiration_date"].includes(a)&&e[a]&&(e[a]=moment(e[a],"X").format("DD/MM/YYYY")),"supplier"===a&&e[a]&&(u=n.storage.suppliers.data.find(function(t){return t._id===e[a]})||{},e[a]=u.name),"marking_type"!==a||!e[a]){l.next=12;break}return l.next=10,n.method.init("marking_types");case 10:d=l.sent[0].find(function(t){return t._id===e[a]}),e[a]=null===d||void 0===d?void 0:d.name;case 12:if("ru_tax_system"!==a||!e[a]){l.next=17;break}return l.next=15,n.method.init("ru_tax_system");case 15:p=l.sent[0].find(function(t){return t._id===e[a]}),e[a]=null===p||void 0===p?void 0:p.name;case 17:"boolean"==typeof e[a]&&(e[a]=Number(e[a])),"string"==typeof e[a]&&(e[a]=e[a].replace(/(\r\n\t|\n|\r\t)/gm,"").trim()),e[a]=void 0===e[a]?"":e[a],r.push(e[a]);case 21:case"end":return l.stop()}},l)}),s=0;case 4:if(!(s<Object.keys(c).length)){u.next=9;break}return u.delegateYield(a(s),"t0",6);case 6:s+=1,u.next=4;break;case 9:d.push(r);case 10:case"end":return u.stop()}},h)}),p=0;case 20:if(!(p<i.length)){f.next=25;break}return f.delegateYield(l(p),"t2",22);case 22:p+=1,f.next=20;break;case 25:return d.unshift(_.map(c,function(t){return a("translate")(t.title)})),d.unshift(_.map(c,function(t){return t.type})),console.warn("fields",c),console.warn("newData",d),f.abrupt("return",d);case 30:case"end":return f.stop()}},N)})),t.toggleSelect=function(){t.toggleAll=!t.toggleAll},t.selectCat=function(t){t=String(t).toLowerCase(),f.query?f.query=_objectSpread({},f.query,{categories:f.query.categories?[].concat(_toConsumableArray(f.query.categories),[t]):[t]}):f.query={categories:[t]}};var x=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function r(){var e,a,o;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,n.method.init("categories","stores");case 2:return r.prev=2,r.next=5,n.method.init("catalog");case 5:if(e=r.sent,a=_slicedToArray(e,1),o=a[0],!i.permission(["suppliers","GET"])){r.next=11;break}return r.next=11,n.method.init("suppliers");case 11:if(t.pg.data.filtered=n.storage.catalog.formatted,0!=o.length){r.next=14;break}throw"not found";case 14:return r.next=16,s.init();case 16:r.next=22;break;case 18:r.prev=18,r.t0=r["catch"](2),console.warn(r.t0),t.error=!0;case 22:return r.prev=22,t.loaded=!0,y(t),r.finish(22);case 26:case"end":return r.stop()}},r,null,[[2,18,22,26]])}));return function(){return e.apply(this,arguments)}}();x()}]),angular.module("cloudshop.catalog").service("catalogColumnService",["localStorageService","db","api",function(t,e,n){var r=this;t.get("settings.catalog.column")||t.set("settings.catalog.column",{fields:{},stores:{}}),this.settings=t.get("settings.catalog.column")||{fields:{},stores:{}},this.fields={_id:{title:"ID товара",active:!1,hidden:!0,type:"string"},name:{title:"NAME",active:!0,hidden:!0,type:"string"},id_group:{title:"Группа",active:!1,hidden:!0,type:"string"},free_price:{title:"Товар по свободной цене",active:!1,hidden:!0,type:"number"},is_weighed:{title:"Весовой товар",active:!1,hidden:!0,type:"number"},description:{title:"Описание",active:!1,hidden:!0,type:"string"},pic:{title:"PHOTO",active:!0,hidden:!1},code:{title:"CODE",active:!0,hidden:!1,type:"string"},vat:{title:"VAT",active:!1,hidden:!1,type:"number"},barcode:{title:"BARCODE",active:!1,hidden:!1,type:"string"},sku:{title:"SKU",active:!0,hidden:!1,type:"string"},unit:{title:"UNIT",active:!0,hidden:!1,type:"string"},PLU_code:{title:"PLU код",active:!1,hidden:!1,type:"string"},expiration_date:{title:"EXPIRATION_DATE",active:!1,hidden:!1,type:"string"},categories:{title:"CATEGORY",active:!1,hidden:!1,type:"string"},country:{title:"COUNTRY",active:!1,hidden:!1,type:"string"},supplier:{title:"SUPPLIER",active:!1,hidden:!1,type:"string"},price:{title:"SELLING_PRICE",active:!0,hidden:!1,type:"number"},cost:{title:"COST",active:!1,hidden:!1,type:"number"},purchase:{title:"PURCHASING_PRICE",active:!1,hidden:!1,type:"number"},created:{title:"CREATED",active:!1,hidden:!1,type:"string"},discount:{title:"DISCOUNT",active:!0,hidden:!1,type:"number"},min_qty:{title:"MIN_STOCK",active:!1,hidden:!1,type:"number"},marking_type:{title:"Тип маркировки",active:!1,hidden:!0,type:"string"},ru_tax_system:{title:"Система налогообложения",active:!1,hidden:!0,type:"string"}},"country_RU"===n.user.company().country&&(this.fields.marking_type.hidden=!1,this.fields.ru_tax_system.hidden=!1),this.data={fields:_.clone(this.fields,!0),stores:{}},this.save=function(){t.set("settings.catalog.column",r.data)};var a=function(){e.method.init("stores").then(function(){var t={},n={};e.storage.stores.data.forEach(function(e){t["store_"+e._id]={title:e.name,active:r.settings.stores["store_"+e._id]?r.settings.stores["store_"+e._id].active:!0}}),_.forEach(r.data.fields,function(t,e){t.hidden||(n[e]={title:t.title,active:r.settings.fields[e]?r.settings.fields[e].active:t.active,type:t.type})}),r.data={stores:t,fields:n},r.save()})};a()}]),angular.module("cloudshop.clients").controller("clientsCtrl",["$scope","db","$filter","profile","$rootScope",function(t,e,n,r,a){function o(){t.loaded=!1,e.method.get("clients").then(function(e){t.data=e,t.loaded=!0,0==e.length&&(t.error=!0),c(t.sorting),t.$apply()})}t.data=[],t.count=0,t.total=0,t.pagination={currentPage:1,pageSize:50},t.filter={search:""},t.sorting={field:"name",reverse:!1},t.columnSettings={list:{phones:{label:n("translate")("PHONE"),active:!0,sorting:!1},emails:{label:n("translate")("EMAIL"),active:!0,sorting:!1},discount:{label:n("translate")("DISCOUNT"),active:!0,sorting:!0},bday:{label:"BIRTHDAY",active:!0,sorting:!0},"info.user.name":{label:"ADDED",active:!0,sorting:!0},created:{label:n("translate")("CREATED"),active:!0,sorting:!0}}},t.buttons={create:r.permission(["clients","POST"]),"export":"owner"===r.getType()};var i=function(n){if(void 0===n)return!1;var r=n.toLowerCase(),a=["name","discount_card","description","phones","emails"];t.data=e.storage.clients.data.filter(function(t){var e=!1;return a.map(function(n){var a=(JSON.stringify(t[n])||"").toLowerCase();a.includes(r)&&(e=!0)}),e})};t.$watch("filter.search",i);var c=function(e){var n=function(t){return _.get(t,e.field)};t.data=_.sortByOrder(t.data,n,[e.reverse?"desc":"asc"])};t.$watch("sorting",function(t,e){_.isEqual(t,e)===!1&&c(t)},!0);var s=a.$on("WS_UPDATE_CLIENTS",function(){t.filter.search?i(t.filter.search):t.data=e.storage.clients.data,t.$apply()});t.buildForXSLX=function(){var e=[[]],r=["CREATED","DEFAULT","CLIENT","PHONES","EMAIL","SITE","ADDRESS","DATE_OF_BIRTH","DISCOUNT","ACCUMULATIVE_DISCOUNT","DISCOUNT_CARD","GENDER","DESCRIPTION","ADDED"].map(function(t){return n("translate")(t)});e.push(r);var a=t.data.map(function(t){return[moment(t.created,"X").format("DD/MM/YYYY HH:mm"),t["default"]?"1":"-",t.name,t.phones?t.phones.join(", "):"-",t.emails?t.emails.join(", "):"-",t.site||"-",t.address?t.address.actual||"-":"-",t.bday?moment(t.bday,"X").format("DD/MM/YYYY"):"-",String(t.discount)||"-",t.enable_savings?"1":"-",t.discount_card||"-",n("translate")("male"==t.sex?"MAL":"female"==t.sex?"FEM":"-"),t.description||"-",t.info.user.name||"-"]});return a[0].forEach(function(t){e[0].push(_typeof(t))}),e.concat(a)},a.$on("DB.CLIENTS.LOADED_COUNT",function(e,n){var r=n.count,a=n.total;t.count=r,t.total=a,t.$apply()}),t.$on("$destroy",function(){s()}),o()}]),angular.module("cloudshop").controller("HeaderCtrl",["$scope","api","profile","authenticator","CONFIG",function(t,e,n,r,a){function o(){e.user.profile().then(function(){t.user=e.user,t.userType=e.user.positions().type,t.userTypeTitle=n.types[e.user.positions().type].title,t.$apply()})}t.authenticator=r,t.logoStyle={"background-image":"url(/images/logo-".concat(a.name,".svg)")},t.shortLogoStyle={"background-image":"url(/images/logo-short-".concat(a.name,".svg)")},o()}]),angular.module("cloudshop").controller("authenticatedCtrl",["$scope","$state","loginState",function(t,e,n){t.$on("LOGGED_OUT",function(){e.go(n)})}]),angular.module("cloudshop").controller("anonymousCtrl",["$scope","$state","defaultState",function(t,e,n){t.$on("LOGGED_IN",function(){e.go(n)})}]),angular.module("cloudshop").service("webworkerService",[function(){var t=this,e=["catalog"];this.workers={},this.uuids={},e.forEach(function(e){t.workers[e]=new Worker("/webworkers/".concat(e,".js?v=").concat(window.APP_HASH)),t.workers[e].addEventListener("message",function(e){t.uuids[e.data.uuid]&&(t.uuids[e.data.uuid](e.data.data),delete t.uuids[e.data.uuid])},!1)}),this.send=function(e,n){t.uuids[e]=n}}]).run(["webworkerService",function(){}]).factory("webworker",["webworkerService","fn",function(t,e){return function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function r(n,a){var o,i,c,s,u,d;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return o=e.guid(),i=angular.toJson(_objectSpread({},a,{uuid:o})),t.workers[n].postMessage(i),c=new Promise(function(e,n){return t.send(o,e)}),r.next=6,Promise.all([c]);case 6:return s=r.sent,u=_slicedToArray(s,1),d=u[0],i=null,a=null,r.abrupt("return",d);case 12:case"end":return r.stop()}},r)}));return function(t,e){return n.apply(this,arguments)}}()}]),angular.module("cloudshop.websocket",[]),angular.module("cloudshop.websocket").run(["websocket",function(t){}]).service("websocketClient",[function(){function t(){this.number=0,this.autoReconnectInterval=5e3}return t.prototype.open=function(t){var e=this;this.url=t,this.instance=new WebSocket(this.url),this.instance.onopen=function(){e.onopen()},this.instance.onmessage=function(t,n){e.number++,e.onmessage(t,n,e.number)},this.instance.onclose=function(t){switch(console.warn("onclose",t),t.code){case 1e3:console.log("WebSocket: closed");break;default:e.reconnect(t)}e.onclose(t)},this.instance.onerror=function(t){switch(console.warn("onerror",t),t.code){case"ECONNREFUSED":e.reconnect(t);break;default:e.onerror(t)}}},t.prototype.close=function(){return this.instance.close()},t.prototype.send=function(t,e){try{this.instance.send(t,e)}catch(n){this.instance.emit("error",n)}},t.prototype.reconnect=function(t){console.log("WebSocketClient: retry in ".concat(this.autoReconnectInterval,"ms"),t);var e=this;setTimeout(function(){console.log("WebSocketClient: reconnecting..."),e.open(e.url)},this.autoReconnectInterval)},t.prototype.onopen=function(t){console.log("WebSocketClient: open",arguments)},t.prototype.onmessage=function(t,e,n){console.log("WebSocketClient: message",arguments)},t.prototype.onerror=function(t){console.log("WebSocketClient: error",arguments)},t.prototype.onclose=function(t){console.log("WebSocketClient: closed",arguments)},t}]).service("websocket",["api","$rootScope","CONFIG","websocketClient",function(t,e,n,r){var a,o=function(){var o=_asyncToGenerator(regeneratorRuntime.mark(function i(){var o,c,s=arguments;return regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(o=s.length>0&&void 0!==s[0]?s[0]:"main",void 0!==n.websocket){i.next=3;break}return i.abrupt("return");case 3:if(c=function(){var e;switch(o){case"main":e={command:"auth_by_token",user:t.user.data._id,token:t.user.data.token};break;case"qr":e={command:"qrcode_auth"}}try{a.send(JSON.stringify(e))}catch(n){}},!a||1!==a.instance.readyState){i.next=6;break}return i.abrupt("return",c());case 6:a=new r,a.open("wss://".concat(n.websocket)),a.onmessage=function(t){try{var n=JSON.parse(t.data);if("ping"===n.type)a.send(JSON.stringify({type:"pong"}));else switch(n.type){case"qrcode":e.$broadcast("AUTH.QR.RESP",n.code);break;case"auth_data":e.$broadcast("AUTH.QR.SUCCEEDED",n);break;case"data":case"doc":e.$broadcast("WS_UPDATE",n);break;case"stock":n.meta.stocks=!0,n.meta["import"]=!0,n.meta.method="updated",e.$broadcast("WS_UPDATE",n);break;case"shift":e.$broadcast("WS_UPDATE_SHIFT",n)}}catch(r){console.warn(r)}},a.onopen=c;case 10:case"end":return i.stop()}},i)}));return function(){return o.apply(this,arguments)}}(),i=function(){console.log("close"),a.onclose=function(){},a.close()};e.$on("AUTH.SUCCEEDED",function(){try{o()}catch(t){console.warn(t)}}),e.$on("AUTH.QR",function(){try{o("qr")}catch(t){console.warn(t)}}),e.$on("WS.CLOSE",i)}]),angular.module("cloudshop.translate",["pascalprecht.translate"]).config(["$translateProvider",function(t){var e=18;t.useMessageFormatInterpolation(),t.useStaticFilesLoader({prefix:"/languages/",suffix:".json?v=".concat(e)})}]).run(["translateService",function(t){t.setLanguage()}]),angular.module("cloudshop.translate").service("translateService",["$translate","localStorageService","CONFIG",function(t,e,n){var r=this;this.defaultLanguage=n.lang||"ru",this.languages={en:{code:"en",label:"English"},ru:{code:"ru",label:"Русский"},uk:{code:"uk",label:"Українська",numeral:"uk-ua"},az:{code:"az",label:"Azerbaijani",numeral:"en"}},this.setLanguage=function(n){return n=n||r.get(),t.use(n),moment.locale(n),numeral.locale(r.languages[n].numeral||n),e.set("language",n)},this.get=function(){var t=e.get("language");return r.languages[t]?t:r.defaultLanguage}}]),angular.module("cloudshop.translate").directive("languageSwitch",["translateService",function(t){return{restrict:"E",replace:!0,template:'\n      <div ng-class="classes" style="padding: 0;" ng-if="active">\n        <dropdown2 ng-model="language" settings="languageSettings"></dropdown2>\n      </div>\n    ',link:function(e,n,r){e.active=!0;var a={en:"us",uk:"ua"},o=Object.keys(t.languages).map(function(e){return{_id:e,name:t.languages[e].label,flag:a[e]||e}});e.language=t.get(),e.classes=r["class"];var i=function(e){t.setLanguage(e),window.location.reload()};e.languageSettings={name:o,icon:"translate",onChange:function(t,e){i(e._id)}}}}}]),angular.module("cloudshop").run(["$state","$templateCache","$http",function(t,e,n){setTimeout(function(){var r=[];angular.forEach(t.get(),function(t,a){void 0!==t.templateUrl&&t.preload!==!1&&-1==r.indexOf(t.templateUrl)&&(r.push(t.templateUrl),n.get(t.templateUrl,{cache:e}))})},5e3)}]),String.prototype.includes||(String.prototype.includes=function(t,e){return"number"!=typeof e&&(e=0),e+t.length>this.length?!1:-1!==this.indexOf(t,e)}),Array.prototype.includes||(Array.prototype.includes=function(t){var e=Object(this),n=parseInt(e.length)||0;if(0===n)return!1;var r,a=parseInt(arguments[1])||0;for(a>=0?r=a:(r=n+a,0>r&&(r=0));n>r;){var o=e[r];if(t===o||t!==t&&o!==o)return!0;r++}return!1});var round=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-2;return decimalAdjust("round",this,t)},floor=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-3;return decimalAdjust("floor",this,t)};Number.prototype.round=round,Number.prototype.floor=floor,Array.prototype.find||(Array.prototype.find=function(t){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e,n=Object(this),r=n.length>>>0,a=arguments[1],o=0;r>o;o++)if(e=n[o],t.call(a,e,o,n))return e}),"function"!=typeof Object.assign&&(Object.assign=function(t){if(null==t)throw new TypeError("Cannot convert undefined or null to object");t=Object(t);for(var e=1;e<arguments.length;e++){var n=arguments[e];if(null!=n)for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}),angular.module("cloudshop").factory("safeApply",[function(){return function(t,e){try{var n=t.$root.$$phase;"$apply"==n||"$digest"==n?e&&t.$eval(e):e?t.$apply(e):t.$apply()}catch(r){console.log(r)}}}]),angular.module("cloudshop.updater",[]),angular.module("cloudshop.updater").run(["updater","updater2",function(t,e){}]).service("updater",["api","db","profile","$rootScope",function(t,e,n,r){var a=this;a.time=+moment().format("X"),a.objects=["catalog","suppliers","clients","stores","register"],a.documents=["sales","purchases","return_sales","return_purchases","changes","movements"],a.init=function(){r.$on("pusher",function(n,o){var i=_.clone(o.resource,!0),c=100;if(a.objects.indexOf(i)>=0&&e.storage[i].started){var s="/last/:client/"+i+"/"+(a.time-5)+"/0/1000";r.$broadcast("notify.loading",{action:"show",resource:i,data:o}),setTimeout(function(){e.method.get(i).then(function(){var n="catalog"===i?{v:"v3"}:{},c=[t.data.get(s,n)];"catalog"==i&&c.push(e.method.reload("categories")),Promise.all(c).then(function(t){_.forEach(t[0].data.data,function(t){if(t.deleted)e.storage[i].data=e.storage[i].data.filter(function(e){return e._id!=t._id});else{var n=!1;e.storage[i].data=e.storage[i].data.map(function(e){return e._id==t._id?(n=!0,t):e}),n||e.storage[i].data.push(t)}e.storage[i].formatted&&(e.storage[i].formatted=e.storage[i].format())});var n=[],c="single";o.data.data=t[0].data.data,a.objects.indexOf(o.resource)>-1&&"undefined"!=typeof o.data&&("catalog"==o.resource&&o.data.data.length>1?(o.data.data&&o.data.data.forEach(function(t){t&&n.push(_.where(e.storage[i].data,{_id:t._id})[0])}),c="import"):n=_.where(e.storage[i].data,{_id:o.data.data[0]._id})[0]),r.$broadcast("notify.loading",{action:"hide",resource:i,data:o}),r.$broadcast("updater",{type:i,data:n,method:c})})})},c),a.time=+moment().format("X")}})},a.init()}]).service("updater2",["api","db","$rootScope",function(t,e,n){var r=function(r,a){var o=a.meta,i=a._user;if(void 0===e.storage[o.type])return new Error("Unknown type");if("catalog"!==o.type||i!==t.user.data._id||!window.windowTabActive){var c=e.storage[o.type];if(c){var s=Array.isArray(o.data)?o.data:[o.data];switch(o.method){case"created":case"restored":"function"==typeof c.proto&&(s=s.map(function(t){return c.proto(t)}));var u=s.map(function(t){return t._id});c.data=c.data.filter(function(t){return u.includes(t._id)===!1}),s.forEach(function(t){c.data.push(t)});break;case"updated":var d=function(t){s.forEach(function(e){c.data[t]._id===e._id&&(c.data[t]=_objectSpread({},c.data[t],{},e),"function"==typeof c.proto&&(c.data[t]=c.proto(c.data[t])),e.deleted&&c.data.splice(t,1))})};for(var l in c.data)d(l);break;case"deleted":var p=function(t){s.forEach(function(e){c.data[t]._id==e._id&&c.data.splice(t,1)})};for(var m in c.data)p(m)}"catalog"!==o.type||o.stocks||e.method.reload("categories"),c.formatted&&(c.formatted=c.format())}n.$broadcast("WS_UPDATE_".concat(o.type.toUpperCase()),o.data,!0)}};n.$on("WS_UPDATE",r)}]),window.fn={},String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1)},window.fn.sleep=function(t){return new Promise(function(e){return setTimeout(e,t)})};var pluralForm=function(t,e,n,r){return t=Math.abs(t),t%=100,t>=5&&20>=t?r:(t%=10,1==t?e:t>=2&&4>=t?n:r)};angular.module("cloudshop").run(["$rootScope",function(t){t.pluralForm=pluralForm}]).service("fn",[function(){var t=this;this.getCookie=function(t){var e=document.cookie.match(new RegExp("(?:^|; )"+t.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return e?decodeURIComponent(e[1]):void 0},this.setCookie=function(t,e,n){n=n||{};var r=n.expires;if("number"==typeof r&&r){var a=new Date;a.setTime(a.getTime()+1e3*r),r=n.expires=a}r&&r.toUTCString&&(n.expires=r.toUTCString()),e=encodeURIComponent(e);var o=t+"="+e;for(var i in n){o+="; "+i;var c=n[i];c!==!0&&(o+="="+c)}document.cookie=o},this.utcOffset=function(){var t=new Date;return-60*t.getTimezoneOffset()},this.bcGenerator=function(t){var e,n=1-Math.random(),r=2e11,a=t?String(t):(r+r/2*n).toFixed(0).toString(),o=3*(1*a[1]+1*a[3]+1*a[5]+1*a[7]+1*a[9]+1*a[11]),i=1*(1*a[0]+1*a[2]+1*a[4]+1*a[6]+1*a[8]+1*a[10]),c=1*i+1*o;e=c>=10?1*c.toString()[c.toString().length-1]:c;var s=10-e;return 10==s&&(s=0),a.toString()+s.toString()},this.barcodeByCode=function(e){var n=e.code,r=(String(n)+"-").split("-").map(function(t){return String(t).replace(/[^0-9]/g,"")}),a="2"+(r[1]?"9":"0")+"0".repeat(5-r[0].length)+r[0]+"0".repeat(5-r[1].length)+r[1];return t.bcGenerator(a)},this.pluralForm=function(t,e,n,r){return t=Math.abs(t),t%=100,t>=5&&20>=t?r:(t%=10,1==t?e:t>=2&&4>=t?n:r)},this.guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,n="x"==t?e:3&e|8;return n.toString(16)})},this.setValues={stores:[],catalog:[],setsData:[],get:function(t){var e=this,n=[],r=!1;return _.forEach(t.container,function(t){var a=_.clone(e.catalog.find(function(e){return e._id===t._id}),!0);a&&(a.qty=t.qty,"set"==t.type?0===Object.keys(a.stock).length?r=!0:n.push(a):"service"!==a.type&&n.push(a))}),r||n},eachSets:function(){var t=this;this.setsData.sort(function(t,e){return t.container.filter(function(t){return"set"===t.type}).length>e.container.filter(function(t){return"set"===t.type}).length?1:-1}).map(function(e){var n=t.data(e);return n&&(e=n),e}),this.setsData=this.setsData.filter(function(t){return 0===Object.keys(t.stock).length}),this.setsData.length&&this.eachSets()},setStocks:function(t,e,n){return this.setsData=t,this.catalog=e,this.stores=n,n.length&&this.eachSets(),t},data:function(t){var e=this.get(t);if(Array.isArray(e)===!1)return!1;e.forEach(function(e){t.cost+=e.cost*e.qty}),t.cost=+t.cost.toFixed(2);var n={};return this.stores.forEach(function(r,a){a=r._id,0===e.length&&(t.stock[a]=0),e.forEach(function(t){if(["inventory","set"].includes(t.type)){t.stock=t.stock||{};var e=t.stock[r._id]?1e3*t.stock[r._id]/(1e3*t.qty):0;n[r._id]||(n[r._id]=[]),n[r._id].push(e)}else console.warn("set error",t)})}),Object.keys(n).forEach(function(e){var r=Math.min.apply(Math,_toConsumableArray(n[e]));r>=1&&(t.stock[e]=r,t.stock[e]-=t.stock[e]%1)}),t.stockCount=_.sum(t.stock),t.min_qty_alert=!!(+t.min_qty&&+t.min_qty>t.stockCount),t}}}]),angular.module("cloudshop").filter("en2ru",["$filter",function(t){return function(e,n){if("string"==typeof n&&n||"object"==_typeof(n)&&n.name){var r=_.clone(n,!0),a={"~":"Ё","`":"ё","@":'"',"#":"№",q:"й",w:"ц",e:"у",r:"к",t:"е",y:"н",u:"г",i:"ш",o:"щ",p:"з",a:"ф",s:"ы",d:"в",f:"а",g:"п",h:"р",j:"о",k:"л",l:"д",z:"я",x:"ч",c:"с",v:"м",b:"и",n:"т",m:"ь",Q:"Й",W:"Ц",E:"У",R:"К",T:"Е",Y:"Н",U:"Г",I:"Ш",O:"Щ",P:"З",A:"Ф",S:"Ы",D:"В",F:"А",G:"П",H:"Р",J:"О",K:"Л",L:"Д",Z:"Я",X:"Ч",C:"С",V:"М",B:"И",N:"Т",M:"Ь","[":"х","{":"Х","]":"ъ","}":"Ъ",";":"ж",":":"Ж","'":"э",'"':"@",",":"б","<":"Б",".":"/",">":"Ю","&":"?","/":".","Ё":"~","ё":"`","№":"#","й":"q","ц":"w","у":"e","к":"r","е":"t","н":"y","г":"u","ш":"i","щ":"o","з":"p","ф":"a","ы":"s","в":"d","а":"f","п":"g","р":"h","о":"j","л":"k","д":"l","я":"z","ч":"x","с":"c","м":"v","и":"b","т":"n","ь":"m","Й":"Q","Ц":"W","У":"E","К":"R","Е":"T","Н":"Y","Г":"U","Ш":"I","Щ":"O","З":"P","Ф":"A","Ы":"S","В":"D","А":"F","П":"G","Р":"H","О":"J","Л":"K","Д":"L","Я":"Z","Ч":"X","С":"C","М":"V","И":"B","Т":"N","Ь":"M","х":"[","Х":"{","ъ":"]","Ъ":"}","ж":";","Ж":":","э":"'","Э":'"',"б":",","Б":"<","ю":".","Ю":">","?":"&"},o=function(t,e,n){return e>t.length-1?t:t.substr(0,e)+n+t.substr(e+1)};if("object"==_typeof(n)){var i=n;n=n.name}if(n.length>0)for(var c=0;c<n.length;c++){var s=n.charAt(c);a.hasOwnProperty(s)&&(n=o(n,c,a[s]))}i&&(n=_objectSpread({},i,{name:n}));var u=lunrSearch(n,e,t),d=lunrSearch(r,e,t);return _.uniq(u.concat(d),"_id")}return"object"==_typeof(n)?t("filter")(e,n):e}}]).filter("currentDate",["$filter",function(t){return function(e){return e=e||new Date,t("date")(e,"yyyy-MM-dd")}}]).filter("substring",["$filter",function(){return function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";return(t||"").trim().substring(0,e)+n}}]).filter("plural",[function(){return function(t,e){return t=Math.abs(t),t%=100,t>=5&&20>=t?e[2]:(t%=10,1==t?e[0]:t>=2&&4>=t?e[1]:e[2])}}]).filter("catalogSearch",["$filter",function(t){return function(e,n){if(n){var r=["name","barcode","sku","categories","properties","unit"];return e.filter(function(e){var a=!1;return r.forEach(function(r){if(!a){var o={};o[r]=n,a=!!t("filter")([e],o).length}}),a})}return e}}]).filter("currentDateTime",[function(){return function(t){return t=t||new Date,new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes())}}]).filter("cur",["api",function(t){return function(){return t.user.company().currency||""}}]).filter("curr",["$filter",function(t){return function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return e=e||0,t("number")(e,n)+" "+t("cur")("")}}]).filter("price",["$filter",function(t){return function(e){return e=e||0,t("number")(e,2)}}]).filter("num",[function(){return function(t){t=+(t||0);try{return parseFloat(t.toFixed(3))}catch(e){console.warn("error",t)}return t}}]).filter("dateFilter",[function(){return function(t,e){"string"==typeof e&&(e={date:e});var n=Object.keys(e)[0];return _.filter(t,function(t){return+t[n]>=1e3*e[n][0]&&+t[n]<=1e3*e[n][1]})}}]).filter("dateFormat",[function(){return function(t,e){return e=e||"D MMMM YYYY",moment(t,"X").format(e)}}]).filter("dateNice",[function(){return function(t,e){if(!t)return"-";t=t||moment().format("X");var n=moment(t,"X"),r=(moment(t-t%86400,"X"),{format:"",year:n.format("D MMMM YYYY"),month:n.format("D MMMM"),today:"TODAY",yesterday:"YESTERDAY"}),a="month";return n.format("YYYY")!=moment().format("YYYY")&&(a="year"),e&&(r.format=n.format(e),a="format"),r[a].toLowerCase()}}]).filter("highlight",["$sce",function(t){return function(e,n){try{return n&&e&&(e=String(e).replace(new RegExp("("+n+")","gi"),'<em class="highlighted">$1</em>')),t.trustAsHtml(e)}catch(r){return e}}}]);var lunrSearch=function(t,e,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:["name","sku","barcode"],a="object"===_typeof(t)?t.name:t,o=[];if(e.length<1500){var i=lunr(function(){
var t=this;this.use(lunr.ru),r.forEach(function(e){return t.field(e)}),this.ref("_id")});e.forEach(function(t){t.name=t.name.replace(/\"/g,""),i.add(t)}),o=i.search(a).map(function(t){return e.filter(function(e){return e._id==t.ref})[0]})}var c=[];return n&&"object"!==_typeof(t)&&r.forEach(function(t){var r={};r[t]=a,c=c.concat(n("filter")(e,r))}),_.uniq(o.concat(c),"_id").filter(function(t){return!!t})};angular.module("cloudshop").directive("csMenu",[function(){return{restrict:"C",link:function(t,e){$(e).on("click","a",function(){for(var t=$(this).index(),e=$(this).parent().children(),n=$(this).parent().parent().children(),r=0;r<e.length;r+=1)$(e[r]).toggleClass("active",r===t),$(n[r+1]).toggle(r===t)}),setTimeout(function(){return $("a.active",e).click()})}}}]).directive("ref",[function(){return{restrict:"E",replace:!0,transclude:!0,template:'\n			<a ng-href="{{url}}" target="_blank" ng-transclude></a>\n		',link:function(t,e){t.url=$(e).text()}}}]).directive("includeReplace",function(){return{require:"ngInclude",restrict:"A",link:function(t,e){e.replaceWith(e.children())}}}).directive("dynamicCtrl",["$compile",function(t){return{restrict:"A",terminal:!0,priority:1e5,scope:{dynamicCtrl:"="},link:function(e,n){e.dynamicCtrl&&(n.attr("ng-controller",e.dynamicCtrl),t(n)(e))}}}]).directive("csMenu",[function(){return{restrict:"C",link:function(t,e){$(e).on("click",".disabled",function(t){t.stopPropagation(),t.preventDefault()})}}}]).directive("popup",["$filter",function(t){return{restrict:"A",scope:{active:"=?popupActive"},link:function(e,n,r){var a,o=0;$(n).is(".icon.help")&&(o=-9);var i=function(){var e={};Object.keys(r).filter(function(t){return t.includes("popup")}).forEach(function(n){r[n]&&(e[n.replace("popup","").toLowerCase()]=r[n]==+r[n]?+r[n]:["popupContent","popupHtml"].includes(n)?t("translate")((r[n]||"").replace(/\\/g,"/")):r[n])}),a=Object.assign({variation:"inverted small",on:"hover",offset:0,transition:"slide down",hoverable:!0,delay:{show:150,hide:100}},e),$(n).popup(a)};i(),e.$on("$destroy",function(){$(n).popup("destroy"),"focus"==r.on&&$("div[scroll]").unbind("scroll")}),e.$watch("active",function(t){t===!1?$(n).popup("destroy"):t===!0&&$(n).popup(a)}),"focus"==r.on&&$("div[scroll]").bind("scroll",function(){$(n).popup("hide")})}}}]).directive("inlinePopupEdit",["apiRouteService","profile","$compile",function(t,e,n){return{restrict:"A",scope:{object:"=obj"},link:function(n,r,a){var o=function(){var e=a.inlinePopupEdit,o=$(r).parent(),i='\n						<div class="no-wrap">\n							<div class="ui small input"><input type="text" /></div>\n							<a class="ui icon large smooth small button"><i class="icon checkmark"></i></a>\n						</div>\n					',c=function(t){var e=_.sum(t.container,"sum");return t.container=t.container.map(function(n){var r=n.sum/e;return n.sum=r*t.price,n.price=n.sum/n.qty,n}),console.log("updateWeight",_.clone(t.container,!0)),t.container};$(r).popup({on:"click",inline:!0,exclusive:!0,hideOnScroll:!0,html:i,position:"bottom left"}),o.on("keypress","input",function(t){13==t.keyCode&&u()}),o.on("click","a.button",function(t){return u()}),$(r).click(function(t){t.preventDefault(),$(this).removeClass("visible");var r=$(this).next(".popup");r.addClass("inline-edit-form"),$(".input input",r).val(n.object[e]).select().focus(),s||(s=n.object[e])});var s,u=function(){$(r).popup("hide");var a=+$("input",o).val();if(s==a)return!1;s=a;var i={name:n.object.name};i[e]=a,n.object[e]=a,"set"===n.object.type&&"price"===e&&(i.container=c(n.object)),t.catalog().edit(_objectSpread({_id:n.object._id},i)),n.$apply()}};if(a.inlinePerm){var i=a.inlinePerm.split("."),c=_toArray(i),s=c[0],u=c.slice(1);e.permission([s,u.join(".")])?o():r[0].classList.add("disabled")}else o()}}}]).directive("updateTitle",["$rootScope","safeApply","$state",function(t,e,n){return{replace:!0,template:'\n					<div>\n						<span translate>{{title[0]}}</span>\n						<span ng-if="title[1]">/ {{(title[1] | translate).toLowerCase()}}</span>\n					</div>\n				',link:function(r){var a=function(e,a){var o=n.get(a.name.replace(/([a-z\.])?\.[a-z\_]+$/g,"$1")),i=o.data?o.data.pageTitle:null;i=a.data&&i==a.data.pageTitle?null:i,a.data&&a.data.pageTitle&&(t.pageTitle=[],i&&t.pageTitle.push(i),t.pageTitle.push(a.data.pageTitle)),r.title=t.pageTitle};t.$on("$stateChangeSuccess",a),t.$on("changeTitle",function(t,e){r.title=e,r.$apply()}),setTimeout(function(){r.title=t.pageTitle,e(r)},400)}}}]).directive("body",["$rootScope","$filter","$state",function(t,e,n){return{restrict:"E",link:function(r,a){var o=i=t.pageTitle||"CloudShop",i=o,c=function(t){document.title=e("translate")(t)},s=function(e,r){var a=n.get(r.name.replace(/([a-z\.])?\.[a-z\_]+$/g,"$1")),o=a.data?a.data.pageTitle:null;o=r.data&&o==r.data.pageTitle?null:o,r.data&&r.data.pageTitle&&(i=r.data.pageTitle,t.pageTitle=[],o&&t.pageTitle.push(o),t.pageTitle.push(r.data.pageTitle)),c(i)};t.$on("$stateChangeSuccess",s),t.$on("changeTitle",function(t,e){c(e[0]),r.$apply()}),c(i)}}}]).directive("tabs",[function(){return{restrict:"A",scope:{active:"=active",name:"=name"},link:function(t,e,n){$(e).tab({}),t.$watch("active",function(n){return n?($(e).tab("change tab",t.name),void(t.active=!1)):!1})}}}]).directive("tabsState",["$state",function(t){return{restrict:"A",link:function(e,n,r){e.params=t.params;var a=e.$watch("params.tab",function(t){if(r.name==t){var e=$('.ui.tab[data-tab="'+t+'"]');e.addClass(".active"),e.nextAll("div[data-tab]").remove(".active"),e.prevAll("div[data-tab]").remove(".active")}});e.$on("$destroy",a)}}}]).directive("sendToIframe",["fn","CONFIG",function(t,e){return{restrict:"A",scope:{stType:"@",stData:"=",stBind:"@",stContext:"="},link:function(n,r){n.bind=n.bind||"click",n.stType=n.stType||"catalog";var a={catalog:{url:e["export"].catalog,field:"catalog"},price_tags:{url2:e["export"].labels,url:"/labels",field:"data"},docs:{url:e["export"].docs,field:"data"}},o=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function o(){var e,i,c,s,u;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(e=t.guid(),i=n.stData,"function"!=typeof n.stData){o.next=6;break}return o.next=5,n.stData.call(n.stContext);case 5:i=o.sent;case 6:if(i){o.next=9;break}return console.info(n.stData+": not found data"),o.abrupt("return",!1);case 9:c="price_tags"===n.stType&&i.label_per_page?a[n.stType].url2:a[n.stType].url,s=$('<iframe style="display:none" name="'+e+'" />'),u=$('<form method="post" action="'+c+'" class="'+e+'" target="'+e+'" />'),$("body").append(s),$("body").append(u),u.append('<input name="'+a[n.stType].field+'" type="hidden" />').find("input").val(angular.toJson(i)),u.submit().remove(),$(r).addClass("loading"),setTimeout(function(){$(r).removeClass("loading")},4e3);case 17:case"end":return o.stop()}},o)}));return function(){return e.apply(this,arguments)}}();$(r).bind(n.bind,function(t){t.preventDefault(),o()})}}}]).directive("fetchIframe",[function(){return{restrict:"A",link:function(t,e,n){var r=function(){var t=$('<iframe src="'.concat(n.fetchIframe,'" />'));$(t).css({width:1,height:1,position:"absolute",top:-999}),$("body").append(t)};$(e).bind("click",function(t){t.preventDefault(),r()})}}}]).directive("panel",[function(){return{restrict:"C",scope:{load:"=loading"},link:function(t,e){var n=function(){$(e).addClass("animated zoomIn"),(void 0!==t.load||void 0!==t.$parent.loading)&&t.$watch(t.load?"load":"$parent.loading",function(t){$(e).toggleClass("_loading",!!t)})};0===$(e).closest(".sidebar").length&&n()}}}]).directive("scrollTop",[function(){return{restrict:"C",link:function(t,e){$(e).click(function(){$(this).closest(".baron__scroller").scrollTop(0),$(this).closest(".my.sidebar").scrollTop(0)})}}}]).directive("wr",["$timeout",function(t){return{restrict:"C",link:function(e,n){$(n).bind("click",function(){t(function(){window.dispatchEvent(new Event("resize"))})})}}}]).directive("autoFocus",[function(){return{restrict:"A",link:function(t,e){$(e).focus().select()}}}]).directive("selectText",[function(){return{restrict:"A",link:function(t,e){$(e).bind("focus",function(){$(this).select()})}}}]).directive("fileModel",["$parse",function(t){return{restrict:"A",link:function(e,n,r){var a=t(r.fileModel),o=a.assign;n.bind("change",function(){e.$apply(function(){r.multiple?o(e,n[0].files):o(e,n[0].files[0])})})}}}]).directive("ngFiles",["$parse",function(t){function e(e,n,r){var a=t(r.ngFiles);n.on("change",function(t){a(e,{$files:t.target.files,name:r.name})})}return{link:e}}]).directive("form",["$timeout",function(t){return{restrict:"E",link:function(e,n,r){if(r.name){var a=r.name;e.$watch(a+".$error",function(){t(function(){},500)},!0)}}}}]),angular.module("cloudshop").service("debug",["DEV",function(t){t&&(window.SC=function(t){return angular.element(t).scope()})}]).run(["debug",function(t){}]),angular.module("cloudshop").service("schemes",[function(){var t=function(t,e){return t.map(function(t){return SchemaInspector.sanitize(e,t).data})};this.catalog=function(n){return t(n,e)},this.clients=function(e){return t(e,n)},this.sources=function(e){return t(e,r)};var e={type:"object",properties:{name:{type:"string"},categories:{type:"array",optional:!1,items:{type:"string",rules:["trim"]},def:[]},packs:{type:"array",optional:!1,def:[],items:{type:"object",properties:{name:{type:"string"},qty:{type:"number"}}}},PLU_code:{type:"string",optional:!1,def:""},barcode:{type:"string",optional:!1,def:""},is_weighed:{type:"boolean",optional:!1,def:!1},free_price:{type:"boolean",optional:!1,def:!1},component:{type:"array",optional:!1,def:[]},container:{type:"array",optional:!1,def:[],items:{type:"object",properties:{qty:{type:"number",optional:!1,def:1},price:{type:"number",optional:!1,def:.01},sum:{type:"number",optional:!1,def:.01}}}},pic:{type:"array",optional:!1,def:[]},price:{type:"number",optional:!1,def:0},purchase:{type:"number",optional:!1,def:0},discount:{type:"number",optional:!1,def:0},cost:{type:"number",optional:!1,def:0},stock:{type:"object",optional:!1,def:{}},store_prices:{type:"object",optional:!1,def:{}},min_qty:{type:"number",optional:!1,def:0},id_group:{type:"string",optional:!0,def:"0"},unit:{type:"string",optional:!0,def:""},marking_type:{type:"string",optional:!0,def:""}}},n={type:"object",properties:{name:{type:"string"},sex:{type:"string"},type:{type:"string",optional:!1,def:"person"},emails:{type:"array",optional:!1,def:[]},phones:{type:"array",optional:!1,def:[]},enable_savings:{type:"boolean",optional:!1,def:!1},address:{type:"object",optional:!1,def:{actual:null,legal:null}},details:{type:"array",optional:!1,def:[]},bank_details:{type:"array",optional:!1,def:[]},bday:{type:"number"},discount:{type:"number",optional:!1,def:0},"default":{type:"boolean",optional:!1,def:!1}}},r={type:"object",properties:{title:{type:"string"},type:{type:"string"},id:{type:"number"},deleted:{type:"boolean",optional:!1,def:!1}}};return this}]),angular.module("cloudshop").service("db",["apiRouteService","api","$interval","$rootScope","fn","profile","marketPlaceService","schemes",function(t,e,n,r,a,o,i,c){function s(t){return angular.extend(this,t)}function u(t){return angular.extend(this,t)}function d(t){return angular.extend(this,t)}function l(t){return angular.extend(this,t)}function p(t){return angular.extend(this,t)}function m(t){return angular.extend(this,t)}function f(){_.forEach(h,function(t,e){t.preload&&g.init(e)})}s.prototype.storePrice=function(t){return t&&this.store_prices?this.store_prices[t]||this.price:this.price},s.prototype.getSupplier=function(){var t=this;return this.supplier&&h.suppliers.data.find(function(e){return e._id===t.supplier})||{}},s.prototype.getMarkingType=function(){var t=this;return this.marking_type&&h.marking_types.data.find(function(e){return e._id===t.marking_type})||{}},s.prototype.getRuTaxSystem=function(){var t=this;return this.ru_tax_system&&h.ru_tax_system.data.find(function(e){return e._id===t.ru_tax_system})||{}},s.prototype.getStocks=function(t){var e=this;if(t)return this.stock[t];var n=0;return h.stores.data.map(function(t){n+=e.stock[t._id]||0}),n},s.prototype.save=function(t){var n=this;return e.data.put("/data/:client/catalog/".concat(this._id),_objectSpread({_id:this._id,name:this.name},t,{v:"v3"})).then(function(){return angular.extend(n,t)})["catch"](function(t){return Promise.reject(t)})},u.prototype.getStaff=function(){return(this.users||[]).map(function(t){return h.staff.data.find(function(e){return e._id==t})}).filter(function(t){return!!t})},u.prototype.getStore=function(){var t=this;return h.stores.data.find(function(e){return e._id==t._store})||{}},u.prototype.getAccount=function(){var t=this;return h.accounts.data.find(function(e){return e._id==t._account})||{}},u.prototype.getTerminals=function(){var t=this;try{return h.accounts.data.filter(function(e){return t.accounts.includes(e._id)})}catch(e){}return[]},u.prototype.save=function(t){var n=this;return e.data.put("/data/:client/register/".concat(this._id),_objectSpread({_id:this._id,name:this.name},t,{v:"v3"})).then(function(){return angular.extend(n,t)})["catch"](function(t){return Promise.reject(t)})},d.prototype.getDetails=function(){return(this.details||[]).filter(function(t){return t.key&&t.value})},d.prototype.getBankDetails=function(){return(this.bank_details||[]).filter(function(t){return t.key&&t.value})},d.prototype.save=function(t){var n=this;return e.data.put("/data/:client/clients/".concat(this._id),_objectSpread({_id:this._id,name:this.name},t,{v:"v3"})).then(function(){return angular.extend(n,t)})["catch"](function(t){return Promise.reject(t)})},l.prototype.save=function(t){var n=this;return e.data.put("/data/:client/suppliers/".concat(this._id),_objectSpread({_id:this._id,name:this.name},t,{v:"v3"})).then(function(){return angular.extend(n,t)})["catch"](function(t){return Promise.reject(t)})},p.prototype.save=function(t){var n=this;return e.data.put("/data/:client/suppliers/".concat(this._id),_objectSpread({_id:this._id,name:this.name},t,{v:"v3"})).then(function(){return angular.extend(n,t)})["catch"](function(t){return Promise.reject(t)})},m.prototype.getBankDetails=function(){return(this.bank_details||[]).filter(function(t){return t.key&&t.value})};var h={catalog:{title:"CATALOG",data:[],formatted:[],object:{},started:!1,stepLimit:1e3,loadedCount:0,update:function(t,e){var n=this;console.time("push"),t=_.clone(t,!0);var r=t.map(function(t){return t._id});switch(e){case"post":t=t.filter(function(t){return!n.data.find(function(e){return e._id===t._id})}),t=this._format(t),this.formatted=[].concat(_toConsumableArray(this.formatted),_toConsumableArray(t)),this.data=[].concat(_toConsumableArray(this.data),_toConsumableArray(t));break;case"put":var a=function(e){var n=t.find(function(t){return t._id===e._id});return n&&Object.keys(n).forEach(function(t){e[t]=n[t]}),e};this.formatted=this.formatted.map(a),this.data=this.data.map(a);break;case"delete":this.formatted=this.formatted.filter(function(t){return!r.includes(t._id)}),this.data=this.data.filter(function(t){return!r.includes(t._id)});break;default:return}return console.timeEnd("push"),1===t.length&&t[0].categories&&t[0].categories.length&&g.reload("categories"),t},proto:function(t){return new s(t)},f:function(t){return t},getGroup:function(){return this.formatted.filter(function(t){return"group"===t.type})},format:function(){return this._format(this.data)},_format:function(t){var e=h.stores.data.map(function(t){return t._id}),n=c.catalog(t).map(function(t){var n={},r={};t.pic=t.pic.filter(function(t){return t}),e.forEach(function(e){n[e]=t.stock[e]||0}),delete t.$$hashKey,Object.keys(t.stock).map(function(e){void 0===n[e]&&0!==+t.stock[e]&&(r[e]=t.stock[e])}),t.stock=n,t.oldStock=r,Object.keys(t.stock||{}).map(function(e){try{t.stock[e]=t.stock[e].round(-4)}catch(n){console.warn(_.clone(t))}}),t.component=(t.component||[]).filter(function(t){return!!t}),t.container=(t.container||[]).filter(function(t){return!!t});var a;return a="group"===t.type?t:_objectSpread({},t,{oldStock:t.oldStock||{},stockCount:"set"===t.type?0:_.sum(t.stock),expiration_date_alert:!!(+t.expiration_date&&+t.expiration_date<+moment().format("X")),min_qty_alert:!!(+t.min_qty&&+t.min_qty>_.sum(t.stock))}),"set"===a.type&&(a.container=a.container.map(function(t){var e=_.where(h.catalog.data,{_id:t._id})[0];return t.deleted=!e,t}),a.cost=0),new s(a)}),r=n.filter(function(t){return"set"===t.type});if(r.length)try{r=a.setValues.setStocks(r,n,h.stores.data)}catch(o){console.warn(o)}return n}},catalog_groups:{title:"CATALOG_GROUPS",data:[],started:!1,f:function(t){return t},format:function(){var t=[].concat(_toConsumableArray(this.data),_toConsumableArray(h.catalog.data.filter(function(t){return"group"===t.type}))).map(function(t){return _objectSpread({},t,{id_group:"undefined"!=typeof t.id_group?t.id_group:t.id_parent||0})});return this.data=_.uniq(t,"_id"),this.data}},clients:{title:"CLIENTS",data:[],proto:function(t){return new d(t)},started:!1,stepLimit:1e3,loadedCount:0,f:function(t){var e=c.clients(t).map(function(t){if(t.stats){var e=t.stats,n=e.sales,r=e.return_sales,a=_objectWithoutProperties(e,["sales","return_sales"]);t.stats.avg=n.count>0?n.sum/n.count:0,t.stats.balance=-1*(n.sum-r.sum-a.debit.sum+a.credit.sum),13===String(t.stats.sales.last_date).length&&(t.stats.sales.last_date=parseInt(t.stats.sales.last_date/1e3)),13===String(t.stats.return_sales.last_date).length&&(t.stats.return_sales.last_date=parseInt(t.stats.return_sales.last_date/1e3))}return new d(t)});return e}},accounts:{title:"ACCOUNTS",data:[],formatted:[],started:!1,f:function(t){return t.data},format:function(){return this.data.map(function(t){return t.type=t.type||"store",t.balance=_objectSpread({},t.balance||{},{balance:+(t.balance||{}).balance}),t.include=!!t.include,new m(t)})}},stores:{title:"STORES",data:[],proto:function(t){return new p(t)},started:!1,f:function(t){return t.data.map(this.proto)}},sources:{title:"PAYMENT_CATEGORIES",data:[],deprecated:[],started:!1,preload:!0,f:function(t){var n=t.data;return this.deprecated=_.map(e.user.company().user_order_category,function(t,e){return{id:+e,title:t,type:+e>=2e3?"credit":"debit",deprecated:!0,deleted:!1}}),c.sources(n)}},ru_tax_system:{title:"Система налогообложения",data:[],started:!1,preload:!0,f:function(t){return t}},timezones:{title:"TIMEZONE",data:[],started:!1,preload:!1,f:function(t){return t.map(function(t){return _objectSpread({},t,{deleted:!1,name:t.title,_id:t.offset})})}},currencies:{title:"CURRENCY",data:[],started:!1,preload:!1,f:function(t){return t.map(function(t){return _objectSpread({},t,{deleted:!1,_id:t.code,description:t.symbol_native})})}},countries:{title:"COUNTRIES",data:[],started:!1,f:function(t){return t=t.map(function(t){return _objectSpread({},t,{priority:void 0===t.priority?999:t.priority})}).sort(function(t,e){return t.priority<e.priority?-1:t.priority>e.priority?1:0}).map(function(t){return _objectSpread({},t,{_id:t.value,deleted:!1})})}},marking_types:{title:"MARKING_CODE",data:[],started:!1,preload:!0,f:function(t){return t.map(function(t){return _objectSpread({},t,{deleted:!1})})}},staff:{title:"EMPLOYEES",data:[],started:!1,deleted:[],rolePriority:{owner:0,manager:1,cashier:2,storeman:3},f:function(t){var e=this,n=t.data;return this.deleted=n.filter(function(t){return!!t.stopped}).map(function(t){var e=t.data,n=_objectWithoutProperties(t,["data"]);return _objectSpread({},n,{},e,{deleted:!0})}),_.sortBy(n.map(function(t){var n=t.data,r=_objectWithoutProperties(t,["data"]);return _objectSpread({},r,{},n,{deleted:!!t.stopped,priority:e.rolePriority[t.type]})}),"priority").map(function(t){var e=(t.priority,_objectWithoutProperties(t,["priority"]));return e.permissions=e.permissions||{},e})}},staffRoles:{title:"ROLES",data:[],started:!1,deleted:[],f:function(t){var e=t.data;return e}},suppliers:{title:"SUPPLIERS",data:[],proto:function(t){return new l(t)},started:!1,f:function(t){return t.data.map(function(t){if(t.stats){var e=t.stats,n=e.purchases,r=e.return_purchases,a=_objectWithoutProperties(e,["purchases","return_purchases"]);t.stats.balance=-1*(n.sum-r.sum-a.credit.sum+a.debit.sum)}return t.site=t.site?t.site.indexOf("http")>=0?t.site:"http://"+t.site:null,t})}},register:{title:"REGISTERS",data:[],proto:function(t){return new u(t)},started:!1,f:function(t){return t.data.map(this.proto)}},integrations:{title:"INTEGRATION",data:[],proto:i.model,started:!1,f:function(t){var e=this;return t.data.map(function(t){return(void 0===t.settings.mappings||Array.isArray(t.settings.mappings))&&(t.settings.mappings={}),t}).map(function(t){return new e.proto(t)})}},money:{title:"MONEY",data:[],started:!1,f:function(t){return t.data}},journal:{title:"LOG",data:[],started:!1,f:function(t){return t.data}},categories:{title:"CATEGORIES",data:[],started:!1,oldData:[],f:function(t){var e=this;return t.data.map(function(t){t=String(t).trim();var n=!1;if(e.oldData.length>0){var r=e.oldData.find(function(e){return e.title==t});r&&(n=r.selected)}return{title:t,selected:n}})}},reports:{title:"REPORTS",data:[],started:!1,f:function(t){return _.map(t.data,function(t){return{title:t,selected:!1}})}}},g={reload:function(){function t(t){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function n(t){var e;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(!h[t]){n.next=9;break}return h[t].oldData=_.clone(h[t].data,!0),h[t].started=!1,n.next=5,g.get(t);case 5:return e=n.sent,console.log("DB.RELOAD.".concat(t.toUpperCase())),r.$broadcast("DB.RELOAD.".concat(t.toUpperCase()),e),n.abrupt("return",e);case 9:return n.abrupt("return");case 10:case"end":return n.stop()}},n)}));return t}(),get:function(e){return new Promise(function(a,o){var i=h[e];if(i||(console.warn(e,"DOES_NOT_EXIST"),o("error")),i&&!i.started){r.$broadcast("DB.".concat(e.toUpperCase(),".PENDING")),i.started=!0;var c=t[e]().get;i.stepLimit&&(c=function(){var n=_asyncToGenerator(regeneratorRuntime.mark(function a(){var n,o,c,s,u;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return n=!0,o=[],c=0,a.next=5,t[e]().count();case 5:s=a.sent,r.$broadcast("DB.".concat(e.toUpperCase(),".LOADED_COUNT"),{count:0,total:s});case 7:if(!n){a.next=20;break}return a.next=10,t[e]().get({offset:c,limit:i.stepLimit});case 10:return u=a.sent,a.next=13,new Promise(function(t){setTimeout(t,1e3)});case 13:o=[].concat(_toConsumableArray(o),_toConsumableArray(u.data.data)),i.loadedCount=o.length,c+=i.stepLimit,c>=s&&(n=!1),r.$broadcast("DB.".concat(e.toUpperCase(),".LOADED_COUNT"),{count:i.loadedCount,total:s}),a.next=7;break;case 20:return a.abrupt("return",{data:o});case 21:case"end":return a.stop()}},a)}));return function(){return n.apply(this,arguments)}}()),c().then(function(t){i.data=i.f(t.data),i.completed=!0,i.formatted&&(i.formatted=i.format());var n=i.data.slice(0);r.$broadcast("DB.".concat(e.toUpperCase(),".SUCCEEDED"),n),a(n)})["catch"](function(t){i.started=!1,r.$broadcast("DB.".concat(e.toUpperCase(),".FAILED"),t),o(t)})}else var s=n(function(){i.completed&&(n.cancel(s),a(h[e].data))},50)})},init:function(t,e){e=e||{};var n=this,r=[];return t="object"==_typeof(t)?t:t?[t]:[],angular.forEach(t,function(t){"undefined"!=typeof h[t]?(e.reload&&(h[t].started=!1),r.push(n.get(t))):console.warn("Model "+t+" not found")}),Promise.all(r)},query:{init:function(t,n,r){return new Promise(function(a,o){e.data[r](t,n).then(function(t){return a(t.data)})["catch"](function(t){return o(t)})})},get:function(t,e){return this.init(t,e,"get")},post:function(t,e){return this.init(t,e,"post")}},destroy:function(){_.forEach(h,function(t,e){h[e].started=!1,h[e].data=[]})}};return r.$on("logout",function(){g.destroy()}),r.$on("AUTH.SUCCEEDED",function(){return f()}),r.$on("catalog.update",function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"post",a=h.catalog.update(e,n);r.$broadcast("WS_UPDATE_CATALOG",a),r.$broadcast("WS_UPDATE_CATALOG_".concat(n.toUpperCase()),a)}),{method:g,storage:h}}]),angular.module("cloudshop").service("authenticator",["$rootScope","$state","defaultState","api","localStorageService","db","$window",function(t,e,n,r,a,o,i){function c(){return r.user.profile()}function s(t){return u.apply(this,arguments)}function u(){return u=_asyncToGenerator(regeneratorRuntime.mark(function e(n){var a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.user.login(n);case 2:if(a=e.sent,o=a.data.data[0],o&&!o.positions[_.keys(o.positions)[0]].stopped){e.next=6;break}throw"disabled";case 6:return a.data.status&&setTimeout(function(){t.$broadcast("AUTH")},100),e.abrupt("return",a);case 8:case"end":return e.stop()}},e)})),u.apply(this,arguments)}function d(t){return r.data.post("/restore-password-s1",_objectSpread({v:"v3"},t))}function l(t){return new Promise(function(e,n){r.user.register(t).then(function(t){t.data.status&&c(),e(t)},function(t){n(t)})})}function p(){return new Promise(function(t,e){r.user.widgets.destroy(),a.cookie.remove("auth"),r.user.logout().then(function(e){i.location.reload(),t(e)},function(t){e(t)})})}function m(){c()}return t.$on("logout",function(){p()}),t.$on("AUTH.SUCCEEDED",function(){m()}),{login:s,logout:p,register:l,reset:d}}]),angular.module("cloudshop").factory("affectConnection",[function(){return function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise(function(e,r){setTimeout(function(){Math.random()<n&&r(),e()},t)});case 2:case"end":return e.stop()}},e)}));return function(e,n){return t.apply(this,arguments)}}()}]).service("apiRouteService",["api","$http","$rootScope","confirmModal","alertModal","$injector","URL","$filter",function(t,e,n,r,a,o,i,c){var s=this;s.catalog=function(){return{count:function(){function e(){return n.apply(this,arguments)}var n=_asyncToGenerator(regeneratorRuntime.mark(function r(){var e,n;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,t.data.get("/count/:client/catalog/",{v:"v3"});case 2:return e=r.sent,n=e.data.data.total,r.abrupt("return",n);case 5:case"end":return r.stop()}},r)}));return e}(),get:function(){function e(){return n.apply(this,arguments)}var n=_asyncToGenerator(regeneratorRuntime.mark(function r(){var e,n=arguments;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return e=n.length>0&&void 0!==n[0]?n[0]:{offset:0,limit:10},r.next=3,t.data.get("/data/:client/catalog/?limit=".concat(e.limit,"&offset=").concat(e.offset),{v:"v3"});case 3:return r.abrupt("return",r.sent);case 4:case"end":return r.stop()}},r)}));return e}(),add:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r,o,i;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.post("/data/:client/catalog/",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,o=_slicedToArray(r.data.data,1),i=o[0],e._id=i._id,e.created=parseInt(new Date/1e3,10),e.updated=e.created,n.$broadcast("catalog.update",[e]),a.abrupt("return",_objectSpread({},e,{},i));case 10:case"end":return a.stop()}},a)}));return e}(),edit:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r,o;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.put("/data/:client/catalog/".concat(e._id),_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,o=r.data.data,e.created=parseInt(new Date/1e3,10),e.updated=e.created,n.$broadcast("catalog.update",[e],"put"),a.abrupt("return",o);case 8:case"end":return a.stop()}},a)}));return e}(),"delete":function(){function e(t,e){return a.apply(this,arguments)}var a=_asyncToGenerator(regeneratorRuntime.mark(function o(e,a){var i;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,r("Вы действительно хотите удалить товар?",a);case 2:return o.next=4,t.data["delete"]("/data/:client/catalog/".concat(e._id),{v:"v3"});case 4:return i=o.sent,n.$broadcast("catalog.update",[e],"delete"),o.abrupt("return",i);case 7:case"end":return o.stop()}},o)}));return e}(),"import":function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r,o,i,c,s=arguments;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(r=s.length>1&&void 0!==s[1]?s[1]:"post",0!=e.length){a.next=3;break}return a.abrupt("return",[]);case 3:return o="delete"===r?"put":r,a.next=6,t.data[o]("/data/:client/catalog/import",_objectSpread({},e,{v:"v3"}));case 6:return i=a.sent,c=i.data.data.map(function(t){return"put"===r?_objectSpread({},t,{},e.find(function(e){return e._id===t._id})||{}):t}),n.$broadcast("catalog.update",c,r),a.abrupt("return",c);case 10:case"end":return a.stop()}},a)}));return e}()}},s.countries=function(){return{get:function(){return _asyncToGenerator(regeneratorRuntime.mark(function t(){var n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.get("/data/country-new.json");case 2:return n=t.sent,t.abrupt("return",n);case 4:case"end":return t.stop()}},t)}))()}}},s.currencies=function(){return{get:function(){function t(){return n.apply(this,arguments)}var n=_asyncToGenerator(regeneratorRuntime.mark(function r(){var t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e.get("".concat(i+encodeURIComponent("/ui/currencies"),"&api=v3"));case 2:return t=n.sent,n.abrupt("return",t);case 4:case"end":return n.stop()}},r)}));return t}()}},s.ru_tax_system=function(){return{get:function(){function t(){return n.apply(this,arguments)}var n=_asyncToGenerator(regeneratorRuntime.mark(function r(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.get("/data/ru_tax_system.json"));case 1:case"end":return t.stop()}},r)}));return t}()}},s.timezones=function(){return{get:function(){function t(){return n.apply(this,arguments)}var n=_asyncToGenerator(regeneratorRuntime.mark(function r(){var t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e.get("".concat(i+encodeURIComponent("/ui/timezones"),"&api=v3"));case 2:return t=n.sent,n.abrupt("return",t);case 4:case"end":return n.stop()}},r)}));return t}()}},s.marking_types=function(){return{get:function(){function n(){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(){var n,r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return r=null===(n=t.user.company().country)||void 0===n?void 0:n.replace(/.*?_([A-Z])/,"$1").toLowerCase(),["ru","kz","ua"].includes(r)===!1&&(r="ru"),a.abrupt("return",e.get("/data/marking-types-".concat(r,".json")));case 3:case"end":return a.stop()}},a)}));return n}()}},s.categories=function(){return{get:function(e){return t.data.get("/data/:client/catalog/categories",_objectSpread({},e,{v:"v3"}))}}},s.staff=function(){return{get:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.get("/:client/staff",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("staff.get",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),add:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.post("/:client/staff/",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("staff.post",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a);
}));return e}(),edit:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.put("/:client/staff/".concat(e._id),_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("staff.put",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),"delete":function(){function e(t){return a.apply(this,arguments)}var a=_asyncToGenerator(regeneratorRuntime.mark(function o(e){var a;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,r("Вы действительно хотите удалить сотрудника?");case 2:return o.next=4,t.data.put("/:client/staff/".concat(e._id),_objectSpread({},e,{v:"v3"}));case 4:return a=o.sent,n.$broadcast("staff.delete",_objectSpread({},e,{deleted:!0})),o.abrupt("return",a);case 7:case"end":return o.stop()}},o)}));return e}()}},s.staffRoles=function(){return{get:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.get("/:client/roles",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("staffRoles.get",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}()}},s.stores=function(){return{get:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.get("/data/:client/stores",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("store.get",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),add:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.post("/data/:client/stores/",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("store.post",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),edit:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.put("/data/:client/stores/".concat(e._id),_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("store.put",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),"delete":function(){function e(t){return i.apply(this,arguments)}var i=_asyncToGenerator(regeneratorRuntime.mark(function c(e){var i,s;return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,r("\n						Перед удалением магазина удостоверьтесь, что:<br />\n						1. В этом магазине обнулены все остатки товаров<br />\n						2. Обнулен счет магазина<br />\n						3. Нет касс привязанных к этому магазину<br /><br />\n						Продолжить?\n          ",!1,{size:"tiny"});case 2:return c.next=4,o.get("db").method.init("register");case 4:if(i=c.sent[0].filter(function(t){return t._store===e._id}),!i.length){c.next=9;break}return c.next=8,a("В разделе «Кассы и смены» открепите магазин «".concat(e.name,"» от кассы и повторите еще раз"));case 8:throw"regiters";case 9:return c.next=11,t.data["delete"]("/data/:client/stores/".concat(e._id),{v:"v3"});case 11:return s=c.sent,n.$broadcast("store.delete",_objectSpread({},e,{deleted:!0})),c.abrupt("return",s);case 14:case"end":return c.stop()}},c)}));return e}()}},s.accounts=function(){return{get:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.get("/data/:client/accounts",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("account.get",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),add:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.post("/data/:client/stores/",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("account.post",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),edit:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.put("/data/:client/stores/".concat(e._id),_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("account.put",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),"delete":function(){function e(t){return a.apply(this,arguments)}var a=_asyncToGenerator(regeneratorRuntime.mark(function o(e){var a;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,r("Вы действительно хотите удалить счет?");case 2:return o.next=4,t.data["delete"]("/data/:client/stores/".concat(e._id),{v:"v3"});case 4:return a=o.sent,n.$broadcast("account.delete",_objectSpread({},e,{deleted:!0})),o.abrupt("return",a);case 7:case"end":return o.stop()}},o)}));return e}()}},s.register=function(){return{get:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.get("/data/:client/register",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("register.post",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),add:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.post("/data/:client/register",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("register.post",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),edit:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.put("/data/:client/register/".concat(e._id),_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("register.put",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),"delete":function(){function e(t,e){return o.apply(this,arguments)}var o=_asyncToGenerator(regeneratorRuntime.mark(function i(e,o){var c,s,u;return regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,r("Вы действительно хотите удалить кассу?",o);case 2:return i.next=4,t.data.post("/shift/:client/",{v:"v3",_register:e._id,closed:null});case 4:if(c=i.sent,s=c.data.data,!s.length){i.next=10;break}return i.next=9,a("WE_CANNOT_DELETE_A_CASH_DESK_WITH_OPEN_S",{size:"tiny"});case 9:throw"";case 10:return i.next=12,t.data["delete"]("/data/:client/register/".concat(e._id),{v:"v3"});case 12:return u=_objectSpread({},e,{deleted:!0}),n.$broadcast("register.delete",u),i.abrupt("return",u);case 15:case"end":return i.stop()}},i)}));return e}()}},s.shift=function(){return{close:function(){function e(t){return a.apply(this,arguments)}var a=_asyncToGenerator(regeneratorRuntime.mark(function o(e){var a;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,r("Вы действительно хотите закрыть смену?");case 2:return o.next=4,t.data.post("/shift/:client/close/".concat(e._id),{v:"v3"});case 4:return a=o.sent,n.$broadcast("shift.post",a),o.abrupt("return",a);case 7:case"end":return o.stop()}},o)}));return e}()}},s.integrations=function(){return{get:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.get("/:client/integrations",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("integration.get",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),add:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.post("/:client/integrations/",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("integration.post",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),edit:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.put("/:client/integrations/".concat(e._id),_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("integration.put",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),"delete":function(){function e(t){return a.apply(this,arguments)}var a=_asyncToGenerator(regeneratorRuntime.mark(function o(e){var a;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,r("Вы действительно хотите удалить интеграцию?");case 2:return o.next=4,t.data["delete"]("/:client/integrations/".concat(e._id),{v:"v3"});case 4:return a=o.sent,n.$broadcast("integration.delete",_objectSpread({},e,{deleted:!0})),o.abrupt("return",a);case 7:case"end":return o.stop()}},o)}));return e}()}},s.clients=function(){return{count:function(){function e(){return n.apply(this,arguments)}var n=_asyncToGenerator(regeneratorRuntime.mark(function r(){var e,n;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,t.data.get("/count/:client/clients/",{v:"v3"});case 2:return e=r.sent,n=e.data.data.total,r.abrupt("return",n);case 5:case"end":return r.stop()}},r)}));return e}(),get:function(){function e(){return n.apply(this,arguments)}var n=_asyncToGenerator(regeneratorRuntime.mark(function r(){var e,n=arguments;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return e=n.length>0&&void 0!==n[0]?n[0]:{offset:0,limit:10},r.next=3,t.data.get("/data/:client/clients/?limit=".concat(e.limit,"&offset=").concat(e.offset),{v:"v3"});case 3:return r.abrupt("return",r.sent);case 4:case"end":return r.stop()}},r)}));return e}(),add:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.post("/data/:client/clients/",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("client.post",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),edit:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.put("/data/:client/clients/".concat(e._id),_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("client.put",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),"delete":function(){function e(t){return a.apply(this,arguments)}var a=_asyncToGenerator(regeneratorRuntime.mark(function o(e){var a;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,r("Вы действительно хотите удалить клиента?");case 2:return o.next=4,t.data["delete"]("/data/:client/clients/".concat(e._id),{v:"v3"});case 4:return a=o.sent,n.$broadcast("client.delete",_objectSpread({},e,{deleted:!0})),o.abrupt("return",a);case 7:case"end":return o.stop()}},o)}));return e}()}},s.suppliers=function(){return{get:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.get("/data/:client/suppliers",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("supplier.get",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),add:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.post("/data/:client/suppliers/",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("supplier.post",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),edit:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.put("/data/:client/suppliers/".concat(e._id),_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("supplier.put",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),"delete":function(){function e(t){return a.apply(this,arguments)}var a=_asyncToGenerator(regeneratorRuntime.mark(function o(e){var a;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,r("Вы действительно хотите удалить поставщика?");case 2:return o.next=4,t.data["delete"]("/data/:client/suppliers/".concat(e._id),{v:"v3"});case 4:return a=o.sent,n.$broadcast("supplier.delete",_objectSpread({},e,{deleted:!0})),o.abrupt("return",a);case 7:case"end":return o.stop()}},o)}));return e}()}},s.reports=function(){return{get:function(e,n){e=Object.assign({start:t.user.data.created,end:Date.now(),v:"v2"},e),n=Object.assign({limit:100,offset:0},n);var r="reports.full",a="product";return e.group||delete e.group,e.group&&(r="reports."+e.group,a="date"),t.data.post("/report/:client/sales/"+a+"/"+n.offset+"/"+n.limit+"/",e,!0)}}},s.money=function(){return{get:function(e,n){return e=e||{},n=n||{},e=Object.assign({limit:100,offset:0},e),t.data.post("/search/money/:client/"+e.offset+"/"+e.limit+"/",n)},search:function(t,e){return e=e||{},this.get(e,t)}}},s.journal=function(){return{get:function(e,n){return e=e||{},n=n||{},e=Object.assign({limit:100,offset:0},e),t.data.post("/search/docs/:client/"+e.offset+"/"+e.limit+"/",n)},search:function(t,e){return e=e||{},this.get(e,t)}}},s.document=function(){return{add:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.post("/docs/:client/"+e.type+"/",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("document.post",e._id),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),edit:function(){function e(t){return a.apply(this,arguments)}var a=_asyncToGenerator(regeneratorRuntime.mark(function o(e){var a;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(!e._id||!e._shift){o.next=3;break}return o.next=3,r("\n							Документ создан на кассе<br />\n							Любое изменение повлечет расхождение по кассе, продолжить?\n						");case 3:return o.next=5,t.data.put("/docs/:client/"+e.type+"/"+e._id,_objectSpread({},e,{v:"v3"}));case 5:return a=o.sent,n.$broadcast("document.put",e._id),o.abrupt("return",a);case 8:case"end":return o.stop()}},o)}));return e}(),restore:function(){function e(t){return a.apply(this,arguments)}var a=_asyncToGenerator(regeneratorRuntime.mark(function o(e){var a,i,c,s;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(a=e._id,i=e.orders,o.prev=1,!i||!i.length){o.next=8;break}return o.next=5,r("Восстановить документы оплат?");case 5:return c=i.map(function(e){return t.data.put("/money/:client/".concat(e._id),_objectSpread({},e,{deleted:!1,v:"v3"}))}),o.next=8,Promise.all(c);case 8:o.next=12;break;case 10:o.prev=10,o.t0=o["catch"](1);case 12:return o.next=14,t.data.get("/docs/:client/".concat(a,"/restore"),{v:"v3"});case 14:return s=o.sent,n.$broadcast("document.restore",a),o.abrupt("return",s);case 17:case"end":return o.stop()}},o,null,[[1,10]])}));return e}(),"delete":function(){function e(t){return a.apply(this,arguments)}var a=_asyncToGenerator(regeneratorRuntime.mark(function o(e){var a,i,u,d,l,p,m,f,h;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(a=e._id,i=e.type,u=e.orders,d=e._shift,!a||!d){o.next=4;break}return o.next=4,r(c("translate")("THE_DOCUMENT_WAS_CREATED_AT_THE_CHECKOUT"));case 4:if(p=u&&u.length?'\n						<br /><br />\n						<label>\n						<input type="checkbox" name="delete" checked="checked" />\n						'.concat(c("translate")("DELETE_PAYMENT"),"\n						</label>\n					"):"",d&&!p){o.next=11;break}return o.next=8,r("".concat(c("translate")("ARE_YOU_SURE_YOU_WANT_TO_DELETE_THE_DOCU")," ").concat(p));case 8:m=o.sent,f=_slicedToArray(m,1),l=f[0];case 11:return o.next=13,t.data["delete"]("/docs/:client/".concat(i,"/").concat(a),{v:"v3"});case 13:return h=o.sent,n.$broadcast("document.delete",a),l&&"on"===l.value&&u.forEach(function(t){s.order()["delete"](t,!0)}),o.abrupt("return",h);case 17:case"end":return o.stop()}},o)}));return e}()}},s.order=function(){return{get:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.get("/money/:client/".concat(e),{v:"v3"});case 2:return r=a.sent,n.$broadcast("order.get",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),add:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.post("/money/:client/",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("order.post",r),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),edit:function(){function e(t,e){return a.apply(this,arguments)}var a=_asyncToGenerator(regeneratorRuntime.mark(function o(e,a){var i;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(!e._shift){o.next=3;break}return o.next=3,r(c("translate")("THE_DOCUMENT_WAS_CREATED_AT_THE_CHECKOUT"),a);case 3:return o.next=5,t.data.put("/money/:client/"+e._id,_objectSpread({},e,{v:"v3"}));case 5:return i=o.sent,n.$broadcast("order.put",i),o.abrupt("return",i);case 8:case"end":return o.stop()}},o)}));return e}(),"delete":function(){function e(t,e){return a.apply(this,arguments)}var a=_asyncToGenerator(regeneratorRuntime.mark(function o(e,a){var i;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(!e._shift){o.next=5;break}return o.next=3,r(c("translate")("THE_DOCUMENT_WAS_CREATED_AT_THE_CHECKOUT"),a);case 3:o.next=7;break;case 5:return o.next=7,r("Вы действительно хотите удалить оплату?",a);case 7:return o.next=9,t.data["delete"]("/money/:client/"+e._id,{v:"v3"});case 9:return i=o.sent,n.$broadcast("order.delete",_objectSpread({},e,{deleted:!0})),o.abrupt("return",i);case 12:case"end":return o.stop()}},o)}));return e}(),restore:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.get("/money/:client/".concat(e._id,"/restore"),{v:"v3"});case 2:return r=a.sent,n.$broadcast("order.restore",e),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}()}},s.sources=function(){return{get:function(){function e(){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(){var e;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,t.data.get("/data/:client/sources",{v:"v3"});case 2:return e=r.sent,n.$broadcast("sources.get"),r.abrupt("return",e);case 5:case"end":return r.stop()}},a)}));return e}(),add:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(e){var r;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,t.data.post("/data/:client/sources",_objectSpread({},e,{v:"v3"}));case 2:return r=a.sent,n.$broadcast("sources.post",e._id),a.abrupt("return",r);case 5:case"end":return a.stop()}},a)}));return e}(),edit:function(){function e(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function o(e){var r;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.prev=0,o.next=3,t.data.put("/data/:client/sources/".concat(e.id),_objectSpread({},e,{v:"v3"}));case 3:return r=o.sent,n.$broadcast("sources.delete",e.id),o.abrupt("return",r);case 8:return o.prev=8,o.t0=o["catch"](0),o.next=12,a("THERE_WAS_AN_ERROR_EDITING_THE_CATEGORY");case 12:throw o.t0;case 13:case"end":return o.stop()}},o,null,[[0,8]])}));return e}(),"delete":function(){function e(t){return o.apply(this,arguments)}var o=_asyncToGenerator(regeneratorRuntime.mark(function i(e){var o;return regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:return i.prev=0,i.next=3,r("\n						".concat(c("translate")("ARE_YOU_SURE_YOU_WANT_TO_DELETE_THE_CATE")," «").concat(e.name,'»?<br />\n						<div class="ui mini message">\n							<div class="content">\n								<p>').concat(c("translate")("THE_CATEGORY_WILL_BE_REMOVED_FROM_ALL_PR"),"</p>\n							</div>\n						</div>\n					"));case 3:return i.next=5,t.data["delete"]("/data/:client/sources/".concat(e.id),{v:"v3"});case 5:return o=i.sent,n.$broadcast("sources.delete",e.id),i.abrupt("return",o);case 10:if(i.prev=10,i.t0=i["catch"](0),"cancel"===i.t0){i.next=15;break}return i.next=15,a("THERE_WAS_AN_ERROR_DELETING_THE_CATEGORY");case 15:throw i.t0;case 16:case"end":return i.stop()}},i,null,[[0,10]])}));return e}()}}}]),angular.module("cloudshop").service("errorHandlerService",["$state","statusBarService","$rootScope","$filter",function(t,e,n,r){var a={enable:void 0,type:"",title:""},o={init:function(t){return t>=500&&600>t?(n.$broadcast("logout"),!1):t&&c[t]?(e.text=c[t].title,e.type=i.error,n.$broadcast("statusBarShow"),!1):!0}},i={success:{css:"success",showTime:.5,icon:"checkmark"},info:{css:"info",showTime:3,icon:"info"},error:{css:"error",showTime:3,icon:"remove"}},c={1:{title:"Server error"},400:{title:"Not found"},401:{title:"Bad request"},402:{title:"Method not available"},500:{title:"Access denited"},501:{title:"Incorrect username or password"},502:{title:"Client DB not found"},503:{title:"Client not found"},506:{title:"Permission denied"},600:{title:"User exists"},601:{title:r("translate")("A_USER_WITH_THIS_EMAIL_ALREADY_EXISTS")},700:{title:"Object not found"},701:{title:"Invalid JSON"},702:{title:"Object not valid"},703:{title:"Оbject not updated"},800:{title:"Collection not found"},900:{title:"Network error"},2e3:{title:"Unable to save document"},1001:{title:"Invalid ID"},1002:{title:"Invalid JSON"},1005:{title:"Object not valid"}};return{data:a,method:o}}]),angular.module("cloudshop").constant("APPS",{unknown:{title:"UNDEFINED",icon:"warning sign"},WAPP:{title:"WEB_APPLICATION",icon:"world"},IOSAPP:{title:"MOBILE_APPLICATION",icon:"apple"},MAPP:{title:"MOBILE_APPLICATION",icon:"android"},PAPP:{title:"ANDROID_POS",icon:"android"},ECAPP:{title:"ECOMMERCE",icon:"shopping basket"},EVOAPP:{title:"Эвотор",icon:"file alternate"}}),angular.module("cloudshop").service("api",["$state","$rootScope","$http","URL","DEV","LOGIN_URL","LOGOUT_URL","REGISTER_URL","$interval","errorHandlerService","localStorageService","fn","alertModal","CONFIG",function(t,e,n,r,a,o,i,c,s,u,d,l,p,m){e.key=d.get("key");var f={login:function(t){return n({method:"POST",url:o,data:JSON.stringify({login:t.login,password:t.password})})},register:function(t){return n({method:"POST",url:c+"?api=v3",data:JSON.stringify(t)})},updatePrintTemplates:function(t){f.positions().settings.print_templates=t},clientID:function(){return _.keys(this.data.positions)[0]},logout:function(){return n({method:"POST",url:i})},positions:function g(){if(!f.data||0==_.keys(f.data.positions).length)return{};var g=f.data.positions[_.keys(f.data.positions)[0]],t=g.data;return t.type=g.type,t},getRole:function(){return this.positions().type},getTarif:function(){return this.positions().tarif||{}},company:function(){if(!f.data.positions)return{};var t=_.clone(f.data.positions[_.keys(f.data.positions)[0]].data,!0);return t.settings.company=t.settings.company||{},t.settings.company.address=t.settings.company.address||{},t.settings.company.plu_pref=t.settings.company.plu_pref||21,Object.assign(t.settings.company||{},{staff:t.staff,ecommerce:t.settings.ecommerce||{},created:t.created,email:t.email,active:t.active})},getEcommerce:function(){return this.company().ecommerce},init:function(){return this.start=!1,this.profile()},profile:function(){return new Promise(function(t,n){if(!d.cookie.get("auth"))return f.auth=!1,n({data:{error:500}});if(f.start&&_.size(f.data)>0)return t(f.data);if(f.start)var r=s(function(){return _.size(f.data)>0?(s.cancel(r),t(f.data)):f.auth?void 0:(s.cancel(r),n({data:{error:500}}))},50);else e.$broadcast("AUTH.PENDING"),f.start=!0,h.get("/profile",{v:"v3"}).then(function(r){try{var a=r.data.data[0];a.messenger_hash=a["".concat(m.messenger.name,"_hash")];var o=!a.positions[_.keys(a.positions)[0]].stopped;if(!a||o===!1)return f.start=!1,f.auth=!1,n();f.data=a||{},f.widgets.initForAuth(),e.$broadcast("AUTH.SUCCEEDED",a),t(f.data)}catch(i){return e.$broadcast("AUTH.FAILED"),n(r)}})["catch"](function(t){return f.auth=!1,n(t)})})},data:{},start:!1,auth:!0,widgets:{init:function(){console.log("DEV",a);try{m.pxVK&&f.widgets.pxVK.init(),m.messenger.active&&f.widgets.messenger.init(),m.yandexPartner&&f.widgets.yandexPartner.init(),a===!1&&f.widgets.googleTagManager.init()}catch(t){console.warn(t)}},initForAuth:function(){return _asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:try{}catch(e){console.warn(e)}case 1:case"end":return t.stop()}},t)}))()},destroy:function(){try{f.widgets.messenger.destroy()}catch(t){}},googleTagManager:{init:function(){insertJS("https://www.googletagmanager.com/gtag/js?id=".concat(m.googleTagManager),function(){function t(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],t("js",new Date),t("config",m.googleTagManager)})}},messenger:{init:function(){var t=m.messenger,e=t.name,n=t.domain,r=t.key;insertJS("//cdn.".concat(n,"/api.min.js"),function(){var t={messenger_hide_collapsed:!0,messenger_collapsed_animations:{smile:!1,vertical_funnel:!1,horizontal_funnel:!1,winking_smile:!1}};window[e].connect(r,{settings:t})})}},yandexPartner:{src:"geoadv-partner.yandex.ru/static/partner-script.js",init:function(){insertJS(this.src)}},pxVK:{init:function(){(window.Image?new Image:document.createElement("img")).src=location.protocol+"//vk.com/rtrg?r=eplOWQ5ZAg6rPLB0UAoeeRko3XWEzXdP42zcx2UqDutlQfR3ceBXmta1Eq6Yc*eDqr5hxqqqchW5hT/XZeIQ8pOATyyqWSwUgw572Qg95q54SeYM3T6C5mFM941xI8oXQNgMjg5nhoHxl28HWXSiWilNzJ6Rn0fEYbXTxi6FWWE-",(window.Image?new Image:document.createElement("img")).src=location.protocol+"//vk.com/rtrg?r=w215naTOohNdZ5/nRLVvU29SWfbHylBbi1akFjZl3coE8TgwuKWSTGjmL22HiBUkCskuduM8gjr*I93bDjGeCp5r35FOOL9F6Pmh29uJVEeqacXjT9C9mA9946ORgurkIyLkIwJ10WExt66ehUfDXqzT2JMyadmI2VcvUZ9Mm/U-"}}}},h={get:function(a,o){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"GET",c=(arguments.length>3?arguments[3]:void 0,Promise.resolve()),s=a.includes(":client");return s&&(c=f.profile()),c.then(function(t){if(s){if(a=a.replace(/(:client)/,_.keys(t.positions)[0]),"undefined"==typeof _.keys(t.positions)[0])return Promise.reject({data:{error:500}});var e=l.getCookie("company_id");e&&e===_.keys(t.positions)[0]||l.setCookie("company_id",_.keys(t.positions)[0],{expires:31536e3})}return a}).then(function(t){o=Object.assign({v:"v1"},o);var a=o.v;return delete o.v,n({method:i,url:r+encodeURIComponent(t)+"&api="+a+"&timezone="+l.utcOffset(),data:angular.toJson(o),headers:{key:e.key}})}).then(function(t){return"object"!==_typeof(t.data)?Promise.reject({data:{error:1}}):t}).then(function(t){return t.data.error?Promise.reject(t):t})["catch"](function(n){var r=n.data?n.data.error:900;return r>=5e3&&5002>=r?(e.$broadcast("billingPermDenied",r),Promise.reject({data:{error:r}})):(r>=500&&600>r&&(a.includes("/profile")?t.go("anonymous.login"):f.profile().then(function(t){"GET"!=i&&t._id&&p("ACCESS_DENIED")})["catch"](function(t){console.warn("FETCH ERROR",t)})),Promise.reject(n))})},post:function(t,e,n){return h.get(t,e,"POST",n)},put:function(t,e,n){return h.get(t,e,"PUT",n)},"delete":function(t,e,n){return h.get(t,e,"DELETE",n)}};return f.widgets.init(),{user:f,data:h}}]).run(["$rootScope","api",function(t,e){t.$on("AUTH.SUCCEEDED",function(){t.country=e.user.company().country})}]),angular.module("cloudshop").directive("withHelp",[function(){return{restrict:"E",replace:!0,transclude:!0,scope:{text:"@"},template:'\n      <span style="display: inline-flex;">\n        <span ng-transclude=""></span>\n        <i style="flex-basis: 20px;" popup popup-on="click" popup-html="{{text}}" class="icon help circular">?</i>\n      </span>\n    '}}]),angular.module("cloudshop").directive("body",["$rootScope",function(t){return{restrict:"E",link:function(){var t=function(t,e){window.windowTabActive=t};t(!0);var e=function(){var t,e,n={hidden:"visibilitychange",webkitHidden:"webkitvisibilitychange",mozHidden:"mozvisibilitychange",msHidden:"msvisibilitychange"};for(t in n)if(t in document){e=n[t];break}return function(n){return n&&document.addEventListener(e,n),!document[t]}}();e(function(){t(!!e())});var n=void 0===document.documentMode,r=window.chrome;n&&!r?$(window).on("focusin",function(){t(!0,"jQuery focusin")}).on("focusout",function(){t(!1,"jQuery focusout")}):window.addEventListener?(window.addEventListener("focus",function(e){t(!0,"addEventListener focus")},!1),window.addEventListener("blur",function(e){t(!1,"addEventListener blur")},!1)):(window.attachEvent("focus",function(e){t(!0,"attachEvent focus")}),window.attachEvent("blur",function(e){t(!1,"attachEvent blur")}))}}}]),angular.module("cloudshop").directive("warnLine",["api","$compile","$filter",function(t,e,n){return{restrict:"E",scope:{type:"@",color:"@"},template:'\n      <div>\n        <div class="ui message user-info-message" ng-class="color" ng-show="text">\n          <a href="" class="close">закрыть</a>\n          <div ng-bind-html="text"></div>\n        </div>\n        <div class="ui tiny modal">\n          <div class="header" ng-bind="modalTitle | translate"></div>\n          <div class="content">\n            <div class="description" ng-bind-html="modalBody"></div>\n          </div>\n          <div class="actions" style="text-align: center;">\n            <div ng-click="closeModal()" ui-sref="authenticated.payment" class="ui large green button" translate>GO_TO_THE_PAYMENT</div>\n          </div>\n        </div>\n      </div>\n    ',replace:!0,link:function(r,a){var o=["5858d8c3e632ed712a9f5c07","5858d8aee632ed712a9f5c06","5858d872e632ed712a9f5c05","5858d847e632ed712a9f5c04","5a2d4d8755a0e40166a7e8dd","5a2d474755a0e40166a7e8d7","5971f167f586370d4c47926a","5971f136f586370d4c479269","587ebefae0d948dac46eb8ac","587ebefae0d948dac46eb8ab","587ebefae0d948dac46eb8aa","587ebefae0d948dac46eb8a9"],i=function(){
return n("translate").apply(void 0,arguments)},c=$(".modal",a);c.modal({closable:!1}),r.color=r.color||"yellow";var s={new_year:function(){return'\n          -40% на все годовые тарифы\n          <a ui-sref="authenticated.payment">'.concat(i("LEARN_MORE"),"</a>.\n        ")},old_tariff:function(){return"\n          ".concat(i("WARN_LINE_PLANS_CHANGES"),'\n          <a ui-sref="authenticated.payment">').concat(i("LEARN_MORE"),"</a>.\n        ")},paid_end2:function(){return"\n          ".concat(i("WARN_LINE_ACCOUNT_HAS_BEEN_BLOCKED"),'\n          <a ui-sref="authenticated.payment">').concat(i("RECHARGE_THE_BALANCE"),"</a>.\n        ")},paid_end:function(){return"\n          ".concat(i("WARN_LINE_INSUFFICIENT_FUNDS"),'\n          <a ui-sref="authenticated.payment">').concat(i("RECHARGE_THE_BALANCE"),"</a>.\n        ")},trial_end:function(t){return"\n         ".concat(i("WARN_LINE_TRIAL_DAYS_LEFT",{day_count:t,day_plural:i(pluralForm(t,"DAY","DAYS","DAYS"))}),'.\n         <a ui-sref="authenticated.payment({plan: true})">').concat(i("CHOOSE_A_TARIFF"),"</a>.\n        ")},bonus:'Изучи CloudShop и получили 500 руб на оплату тарифа. <a ui-sref="authenticated.card.gift">Подробнее</a>',black_friday:'\n         Чёрная пятница в CloudShop ⚠️ +30% на счёт! <a ui-sref="authenticated.payment">Пополнить баланс</a>\n        '},u=!1;r.text=null;var d=function(){u=!(0===$(".user-info-message:visible").length&&u),$("body").toggleClass("warning-show",u)};$(a).on("click",".close",function(t){t.preventDefault(),$(_this57).parent().hide(),d()}),r.closeModal=function(){c.modal("hide")};var l=function(){t.user.profile().then(function(n){var a,i=t.user.positions().bill_info||{},u=t.user.positions(),l=u.tarif,p=Number(moment().format("X"));return p>+moment("2021-12-31").startOf("day").format("X")&&p<=+moment("2022-01-10").endOf("day").format("X")?(r.color="green",r.text=e("<div>".concat(s.new_year(),"</div>"))(r)[0].innerHTML,d()):o.includes(null===(a=l._id)||void 0===a?void 0:a.$oid)&&"web.ainur.app"!==window.location.host?(r.color="yellow",r.text=e("<div>".concat(s.old_tariff(),"</div>"))(r)[0].innerHTML,d()):"paid_end"===i.type&&i.status===!1?(r.color="red",r.text=e("<div>".concat(s[i.type+"2"](),"</div>"))(r)[0].innerHTML,r.modalTitle="ACCOUNT_IS_BLOCKED",r.modalBody="Аккаунт заблокирован и в течение 30 дней данные вашего профиля будут удалены.<br /> Внесите, пожалуйста, оплату на счет прямо сейчас, чтобы продолжить работу в CloudShop",d()):"money"===r.type&&i.status&&(r.text=e("<div>".concat(s[i.type](i.days),"</div>"))(r)[0].innerHTML,"trial_end"!==i.type&&(r.color="red",r.modalTitle="Ваш баланс - 0 рублей",r.modalBody="Чтобы данные не потерялись и ваш аккаунт не заблокировали, пополните баланс.<br /> Просто пройдите по кнопке ниже"),d()),"money"===r.type&&r.modalTitle&&c.modal("show"),n}).then(function(){var n=t.user.positions().bonus||{};"bonus"===r.type&&n.learn===!1&&(r.text=e("<div>".concat(s.bonus,"</div>"))(r)[0].innerHTML,d())})};l()}}}]),angular.module("cloudshop").factory("imageUpload",["$q","IMAGE_UPLOAD_URL","$http",function(t,e,n){return{save:function(){function t(t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(t){var r,o,i;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!/^data\:image\//.test(t)){a.next=6;break}return a.next=3,fetch(t).then(function(t){return t.blob()});case 3:r=a.sent,a.next=7;break;case 6:"object"===_typeof(t)&&(r=t);case 7:if(r){a.next=9;break}return a.abrupt("return",t);case 9:return o=new FormData,o.append("upfile",r),a.next=13,n.post(e,o,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).then(function(t){return t.data.url?t.data.url:""});case 13:return i=a.sent,a.abrupt("return",i);case 15:case"end":return a.stop()}},a)}));return t}()}}]),angular.module("cloudshop").factory("tablePaginationService",["$filter",function(t){return{offset:0,page:0,limit:30,data:[],"short":[],pagination:[],changeStep:function(t){this.page=t,this.offset=t*this.limit,this.init()},repeat:function(){var e=this,n=_.range(Math.ceil(this.data.length/this.limit)),r=n.length,a=this.page,o=a-4,i=a+4;0>o&&(o=0,i=8),n=n.filter(function(t,e){return e>=o&&i>e}).map(function(t){var n=t;return t={},t.id=n,t["class"]=t.id==e.page?"active":"",t.name=t.id+1,t}),this.pagination=t("limitTo")(n,9),this.pagination.length>1?(i>8&&this.pagination.unshift({id:0,name:"&laquo;"}),r>i&&this.pagination.push({id:r-1,name:"&raquo;"})):this.pagination=[]},init:function(){var t=this;this["short"]=_.filter(this.data,function(e,n){return n>=t.offset&&n<t.offset+t.limit}),this.repeat()}}}]).directive("tablePagination",["$compile","$filter","tablePaginationService",function(t,e,n){return{restrict:"A",scope:{settings:"=tablePagination"},link:function(e,r){function a(){$(r).append(t(c)(e)),$(r).find("tbody").html(i),$(r).addClass("table-pagination"),n.init()}e.service=n;var o=$("tbody tr",r);o.attr("ng-repeat",o.attr("repeat")+" in service.short track by $index");var i=t(o)(e),c=['<tfoot ng-show="service.pagination.length"><tr class="left aligned"><td colspan="'+$("thead th",r).size()+'"><div class="ui pagination small menu"><a class="item" ng-repeat="item in service.pagination track by $index" ng-class="[item.class]" ng-click="service.changeStep(item.id)" ng-bind-html="item.name"></a></div></td></tr></tfoot>'].join("");a()}}}]),angular.module("cloudshop").directive("tableColumns",["localStorageService",function(t){return{restrict:"A",replace:!0,template:'\n        <div><dropdown action="nothing" class="right pointing icon smooth basic large-icon button catalog-columns-dropdown">\n  				<i popup popup-content="Настройки таблицы" class="setting icon"></i>\n  				<div class="menu" style="right: 100% !important;">\n  					<div class="header">\n  						<i class="tags icon"></i>\n  						<span translate>TABLE_SETTINGS</span>\n  					</div>\n  					<div class="item" ng-repeat="(i, item) in list">\n  						<div class="ui checkbox" ng-model="item.active">\n  							<input type="checkbox"/>\n  							<label ng-bind="item.label | translate"></label>\n  						</div>\n  					</div>\n  				</div>\n  			</dropdown></div>',scope:{settings:"="},link:function(e,n,r){var a={},o=r.tableColumns,i="".concat(o,"-table-columns");e.list={};var c=function(){var n=t.get(i)||{};Object.keys(e.settings.list).forEach(function(t){if(n[t]){var r=n[t],a=(r.label,_objectWithoutProperties(r,["label"]));e.list[t]=_objectSpread({},e.settings.list[t],{},a)}else e.list[t]=_objectSpread({},e.settings.list[t])})},s=function(){t.set(i,e.list)},u=function(){var t="";if(angular.toJson(e.list)==a)return!1;a=angular.toJson(e.list),_.forEach(e.list,function(e,n){t+="pic"===n?"img.table-pic{display: ".concat(e.active?"inherit":"none",";}\n"):"#".concat(o,' td[data-name="').concat(n,'"], #').concat(o,' th[data-name="').concat(n,'"]{display: ').concat(e.active?"table-cell":"none",";}\n")}),t=document.createTextNode(t);var n=document.createElement("style"),r=document.head||document.getElementsByTagName("head")[0];n.type="text/css",n.id=i,n.styleSheet?n.styleSheet.cssText=t:n.appendChild(t),document.getElementById(i)?r.replaceChild(n,document.getElementById(i)):r.appendChild(n)};e.$watch("list",function(t){t&&Object.keys(t).length>0&&(u(),s())},!0);var d=function(){c()};d()}}}]),angular.module("cloudshop").service("statusBarService",[function(){this.type={css:"error"},this.text="",this.enable=!1}]).directive("statusBar",["statusBarService",function(t){return{restrict:"E",replace:!0,link:function(e,n){e.service=t,e.notification=null,e.$on("statusBarShow",function(){e.notification&&e.notification.hide(),e.notification=new NotificationFx({message:["<p>"+t.text+"</p>"].join(""),layout:"bar",effect:"slidetop",className:t.type.css,type:"notice",ttl:3e3,onClose:function(){}}),e.notification.show()})}}}]),angular.module("cloudshop").service("modalService",["$rootScope","$state","profile","$timeout",function(t,e,n,r){var a={data:{buttons:[],className:"",loading:!1,visible:!1,showActions:!0},add:function(t){this.data.buttons=t.filter(function(t){return a.check_permission(t)})},update:function(t,e){var n=this;Array.isArray(e)===!1&&(e=[e]),e.forEach(function(e){n.data.buttons[e]=_objectSpread({},n.data.buttons[e],{},t)})},append:function(t){this.data.buttons=this.data.buttons.concat(t.filter(function(t){return a.check_permission(t)}))},toggleActions:function(t){this.data.showActions=t},check_permission:function(t){var r="";return"string"==typeof t.action?r=t.action:"object"==_typeof(t.action)&&(r=t.action.url),r||t.perm?n.permission(t.perm||e.get(r).data):!0},click:function(t){"function"==typeof t.action?t.action(t.arguments):"string"==typeof t.action?e.go(t.action):"object"==_typeof(t.action)&&e.go(t.action.url,t.action.param)},remove:function(t,e){if(!t)return this.data.showActions=!0,this.data.className="",void(this.data.buttons=[]);"object"!==_typeof(t)&&(t=[t]);for(var n=0;n<t.length;n++)this.data.buttons[t[n]]&&delete this.data.buttons[t[n]];console.warn("destroy")},disable:function(t){"object"!==_typeof(t)&&(t=[t]);for(var e=0;e<t.length;e++)this.data.buttons[t[e]]&&(this.data.buttons[t[e]].active=!1)},disableAll:function(){for(var t=0;t<this.data.buttons.length;t++)this.disable(t)},enable:function(t){"object"!==_typeof(t)&&(t=[t]);for(var e=0;e<t.length;e++)this.data.buttons[t[e]]&&(this.data.buttons[t[e]].active=!0)},enableAll:function(){for(var t=0;t<this.data.buttons.length;t++)this.enable(t)},toggle:function(t,e){"object"!==_typeof(t)&&(t=[t]);for(var n=0;n<t.length;n++)this.data.buttons[t[n]]&&(this.data.buttons[t[n]].active="undefined"!=typeof e?!!e:!this.data.buttons[t[n]].active)},back:function(){var n=t.path.length>1?t.path.splice(-2)[0]:{toState:"authenticated.dashboard"};e.go(n.toState,n.toParams||{})},prev:function o(){var o=t.path[t.path.length-2];o?(t.path=t.path.filter(function(e,n){return n<t.path.length-2}),e.go(o.toState.name,o.toParams)):e.go(e.$current.parent.parent.name,{})},close:function(){e.$current.parent.parent["abstract"]||r(function(){e.go(e.$current.parent.parent.name,{})})}};return{init:a,method:a}}]),angular.module("cloudshop").provider("runtimeStates",["$stateProvider",function(t){this.$get=function(){return{addState:function(e,n){t.state(e,n)}}}}]).service("modalData",["runtimeStates",function(t){var e=this;e.state,e.states={catalog_get:"authenticated.card.catalog.get",catalog_page_history:"authenticated.card.catalog.pageHistory",catalog_update:"authenticated.card.catalog.update",catalog_create:"authenticated.card.catalog.create",catalog_group:"authenticated.card.catalog.group",catalog_group_create:"authenticated.card.catalog.groupcreate",catalog_group_edit:"authenticated.card.catalog.groupedit",catalog_stock:"authenticated.card.catalog.stock",client_get:"authenticated.card.client_show",client_update:"authenticated.card.client_edit",client_create:"authenticated.card.client_add",supplier_get:"authenticated.card.supplier_show",supplier_update:"authenticated.card.supplier_edit",supplier_create:"authenticated.card.supplier_add",account_get:"authenticated.card.account_show",account_update:"authenticated.card.account_edit",account_create:"authenticated.card.account_add",store_get:"authenticated.card.store_show",store_update:"authenticated.card.store_edit",store_create:"authenticated.card.store_add",profile_get:"authenticated.card.profile",profile_update:"authenticated.card.profile_edit",staff_create:"authenticated.card.staff_add",staff_edit:"authenticated.card.staff_edit",sidebar_history:"authenticated.card.sidebar_history",sidebar_journal:"authenticated.card.sidebar_journal",sidebar_orders:"authenticated.card.sidebar_orders",report_constructor_history:"authenticated.card.report_constructor.history",support:"authenticated.card.support",scanner:"authenticated.card.catalog.scanner",register_create:"authenticated.card.register.addBox",register_edit:"authenticated.card.register.editBox",register_show:"authenticated.card.register.showBox",shift_show:"authenticated.card.register.showShift",document_item:"authenticated.card.journal.item",holddocs:"authenticated.card.holddocs",order_item:"authenticated.card.money_show",order_debit:"authenticated.card.pay_create.cash_parish",order_credit:"authenticated.card.pay_create.cash_outflow",order_transfer:"authenticated.card.pay_create.cash_transfer",marketplace_item:"authenticated.card.marketplace.item",marketplace_installed_item:"authenticated.card.marketplace.installedItem",marketplace_log:"authenticated.card.marketplace.log",company_requisites_sidebar:"authenticated.card.company_requisites_sidebar",events:"authenticated.card.events"},e.data=[{state:"authenticated.dashboard"},{state:"authenticated.card.catalog.list"},{state:"authenticated.card.catalog.changePrices"},{state:"authenticated.card.catalog.import"},{state:"authenticated.card.trash"},{state:"authenticated.payment"},{state:"authenticated.card.company.settings.main"},{state:"authenticated.card.company.settings.requisites"},{state:"authenticated.card.company.settings.newsletter"},{state:"authenticated.card.company.settings.data"},{state:"authenticated.card.reports_product"},{state:"authenticated.card.reports_categories"},{state:"authenticated.card.reports_set"},{state:"authenticated.card.reports_day"},{state:"authenticated.card.reports_week"},{state:"authenticated.card.reports_month"},{state:"authenticated.card.reports_motion"},{state:"authenticated.card.reports_agent"},{state:"authenticated.card.reports_finance"},{state:"authenticated.card.reports_staff"},{state:"authenticated.card.journal"},{state:"authenticated.card.money"},{state:"authenticated.card.clients"},{state:"authenticated.card.supplier"},{state:"authenticated.card.company.staff"},{state:"authenticated.card.company.stores"},{state:"authenticated.card.company.accounts"},{state:"authenticated.card.doc_create.sell"},{state:"authenticated.card.doc_create.purchase"},{state:"authenticated.card.doc_create.return_sell"},{state:"authenticated.card.doc_create.return_purchase"},{state:"authenticated.card.doc_create.changes_inventory"},{state:"authenticated.card.doc_create.changes_in"},{state:"authenticated.card.doc_create.changes_out"},{state:"authenticated.card.doc_create.moving"},{state:"authenticated.card.doc.edit"},{state:"authenticated.card.pay_create.cash_parish"},{state:"authenticated.card.pay_create.cash_outflow"},{state:"authenticated.card.pay_create.cash_transfer"},{state:"authenticated.card.ecommerce.theme"},{state:"authenticated.card.ecommerce.settings.main"},{state:"authenticated.card.ecommerce.settings.domain"},{state:"authenticated.card.ecommerce.settings.products"},{state:"authenticated.card.ecommerce.start"},{state:"authenticated.card.register.cash"},{state:"authenticated.card.register.shift"},{state:"authenticated.card.marketplace.list"},{state:"authenticated.card.reports"},{state:"authenticated.start"},{state:"authenticated.card.report_constructor"},{state:"authenticated.card.yandex"}],e.set=function(){_.forEach(e.data,function(n){var r=n.state+".modal",a=e.state.get(n.state),o=_.clone(e.state.get("authenticated.modal"),!0);/\/$/.test(a.url)&&(o.url=o.url.replace("/","")),t.addState(r,o),_.forEach(e.states,function(n,a){t.addState(r+"."+a,_.clone(e.state.get(n),!0))})})},e.parseStateRef=function(t,e){var n,r=t.match(/^\s*({[^}]*})\s*$/);if(r&&(t=e+"("+r[1]+")"),n=t.replace(/\n/g," ").match(/^([^(]+?)\s*(\((.*)\))?$/),!n||4!==n.length)throw new Error("Invalid state ref '"+t+"'");return{state:n[1],paramExpr:n[3]||null}},e.splitStateRef=function(t){return t.state+(t.paramExpr?"("+t.paramExpr+")":"")},e.modalLink=function(t){var n=e.parseStateRef(t),r=e.state.current,a=_.filter(e.data,function(t){return-1!=r.name.indexOf(t.state)});if(a.length){var o=_.filter(_.map(e.states,function(t,e){return{id:e,value:t}}),function(t){return t.value==n.state})[0];o&&(n.state=a[0].state+".modal."+o.id)}return e.splitStateRef(n)},e.isModalLink=function(t){var n=e.parseStateRef(t);return!!_.filter(e.states,function(t){return t==n.state}).length}}]).run(["modalData",function(t){t.set()}]),angular.module("cloudshop").controller("modalCtrl",["$scope","$rootScope","modalService","$state",function(t,e,n,r){t.modal=n.init,t.path=e.path,t.current=r.current,t.close=!0;var a=e.$on("$stateChangeSuccess",function(){o(),i()}),o=function(){r.current.data&&r.current.data.sidebarSize?t.size=r.current.data.sidebarSize:t.size="m"},i=function(){var n=e.path[e.path.length-2];n&&n.toState&&n.toState.data&&(t.close=!n.toState.data.sidebar)};t.$on("$destroy",a),o(),i()}]),angular.module("cloudshop").config(["$provide",function(t){t.decorator("$state",["$delegate","modalData",function(t,e){e.state=t,e.state.baseGo=e.state.go;var n=function(t,n,r){"string"==typeof t&&e.isModalLink(t)&&(t=e.modalLink(t)),this.baseGo(t,n,r)};return e.state.go=n,t}])}]),angular.module("cloudshop").service("cardService",["$rootScope","$state","profile",function(t,e,n){var r={data:{buttons:[],className:"",loading:!1,visible:!1},add:function(t){this.data.buttons=t.filter(function(t){return r.check_permission(t)}).map(function(t){return t.title=t.title,t})},update:function(t,e){this.data.buttons[e]=_objectSpread({},this.data.buttons[e],{},t)},append:function(t){this.data.buttons=this.data.buttons.concat(t.filter(function(t){return r.check_permission(t)}).map(function(t){return t.title=t.title,t}))},check_permission:function(t){var r="";return"string"==typeof t.action?r=t.action:"object"==_typeof(t.action)&&(r=t.action.url),r||t.perm?n.permission(t.perm||e.get(r).data):!0},click:function(t){"function"==typeof t.action?t.action(t.arguments):"string"==typeof t.action?e.go(t.action):"object"==_typeof(t.action)&&e.go(t.action.url,t.action.param)},remove:function(t,e){if("undefined"==typeof t)return this.data.className="",void(this.data.buttons=[]);"object"!==_typeof(t)&&(t=[t]);for(var n=0;n<t.length;n++)this.data.buttons[t[n]]&&delete this.data.buttons[t[n]]},disable:function(t){"object"!==_typeof(t)&&(t=[t]);for(var e=0;e<t.length;e++)this.data.buttons[t[e]]&&(this.data.buttons[t[e]].active=!1)},enable:function(t){"object"!==_typeof(t)&&(t=[t]);for(var e=0;e<t.length;e++)this.data.buttons[t[e]]&&(this.data.buttons[t[e]].active=!0)},toggle:function(t,e){"object"!==_typeof(t)&&(t=[t]);for(var n=0;n<t.length;n++)this.data.buttons[t[n]]&&(this.data.buttons[t[n]].active="undefined"!=typeof e?!!e:!this.data.buttons[t[n]].active)},back:function(){var n=t.path.length>1?t.path.splice(-2)[0]:{toState:"authenticated.dashboard"};e.go(n.toState,n.toParams||{})}};return{init:r,method:r}}]),angular.module("cloudshop").controller("cardCtrl",["$scope","cardService",function(t,e){t.card=e.init,t.$watch("card.data.buttons",function(t){e.init.data.visible=!!_.where(t,{visible:!0}).length},!0)}]),angular.module("cloudshop").directive("sortableTableHeader",[function(){return{restrict:"A",scope:{settings:"=sortableTableHeader"},link:function(t,e){function n(){var e=$(this).attr(a);return t.settings&&t.settings.field?(t.settings.reverse=t.settings.field===e?!t.settings.reverse:!0,t.settings.field=e,r(),void t.$apply()):console.warn("Settings not found")}function r(){$(e).find("a["+a+"]").each(function(){if($(this).find("i.icon.sort").remove(),$(this).attr(a)===t.settings.field){var e=t.settings.reverse?"descending":"ascending";$(this).append('<i class="icon sort '+e+'"></i>')}})}var a="sortable-table-link";$(e).on("click","a["+a+"]",n),r()}}}]),angular.module("cloudshop").directive("scroll",[function(){return{restrict:"A",scope:{right:"@scrollRight",wrap:"@scrollWrap"},link:function(t,e,n){t.right=t.right||2,t.wrap=!!t.wrap;var r="scroll-"+_.random(1,998001);$(e).append(['<div class="baron__track">','<div class="baron__free">','<div id="'+r+'" class="baron__bar" style="right: '+t.right+'px"></div>',"</div>","</div>"].join("")),t.wrap&&$(e).wrap('<div class="baron__clipper" />'),$(e).addClass("baron baron__scroller _macosx").baron({bar:"#"+r})}}}]),angular.module("cloudshop").run(["$rootScope",function(t){t.overlay=!1}]).controller("SideBarController",["$scope",function(t){}]).directive("mySidebar",function(){return{restrict:"A",replace:!0,transclude:!0,controller:"SideBarController",scope:{action:"@","class":"@",model:"=ngModel"},template:'<div ng-class="[ sidebar_class, class ]" ng-transclude><div ng-transclude></div><div class="overlay"></div></div>',link:function(t,e,n,r){t.sidebar_class="my sidebar"}}}),angular.module("cloudshop").controller("reportSidebarOrdersCtrl",["$scope","$state","payService","db",function(t,e,n,r){t.query=angular.fromJson(window.atob(e.params.query));var a=t.query,o=a.start,i=a.end,c=a.source,s=a.type;a.sum;c&&(t.source=(n.pay.source.find(function(t){return t.id==c})||{title:""}).title.toLowerCase()),t.history={query:{start:o,end:i,source:c,status:!0,type:s}}}]),angular.module("cloudshop").controller("reportSidebarJournalCtrl",["$scope","$state","docService","db",function(t,e,n,r){t.doc=n,t.query=angular.fromJson(window.atob(e.params.query)),t.query.docType=t.query.docType||"sales";var a=t.query,o=a.start,i=a.end,c=a.from,s=a.to,u=a.user,d=a.docType,l=a.store_id,p=a.type;t.clientTypes={clients:"CLIENT",suppliers:"SUPPLIER",staff:"EMPLOYEE"},t.history={query:{start:o,end:i,from:c||("sales"===d?l:void 0),status:!0,type:d,to:s||("return_sales"===d?l:void 0),user:u}};var m=function(){p&&r.method.init(p).then(function(e){t.client=_.where(e[0],{_id:s||c||u})[0].name,t.$apply()})};m()}]),angular.module("cloudshop").config(["$stateProvider",function(t){t.state("authenticated.card.sidebar_history",{url:"/history_sidebar/:query",templateUrl:"js/components/report-sidebar/history.html",controller:"reportSidebarHistoryCtrl"}).state("authenticated.card.sidebar_journal",{url:"/journal_sidebar/:query",templateUrl:"js/components/report-sidebar/journal.html",controller:"reportSidebarJournalCtrl"}).state("authenticated.card.sidebar_orders",{url:"/orders_sidebar/:query",templateUrl:"js/components/report-sidebar/orders.html",controller:"reportSidebarOrdersCtrl"})}]),angular.module("cloudshop").controller("reportSidebarHistoryCtrl",["$scope","$state","api","docService","catalogService","db",function(t,e,n,r,a,o){function i(t){return _.map(t,function(t){return t.doc_=r.types[t.doc.type+(t.doc.sub_type||"")],t.author=o.storage.staff.data.find(function(e){return e._id===t._user}),t})}t.doc=r,t.query=angular.fromJson(window.atob(e.params.query));var c=t.query,s=c.productId,u=c.start,d=c.end,l=(c.from,c.to,c.type),p=void 0===l?null:l,m=c.store_id,f=c.client_id,h=c.sign,g=c.id_group;t.historySettings={offset:0,limit:10,total:0,loaded:0,load:!1},t.titles={debit:"INCOME",credit:"EXPENSE",movs:"OPERATIONS",sales:"SALES"},t.historyData=[],t.store_id=0,t.loadHistory=function(){var e=t.historySettings,r=e.offset,a=e.limit;t.historySettings.load=!0;var o={start:u,end:d,store_id:m,offset:r,limit:a,sign:h,contragent_id:f};s&&(o.product_id=s),g&&(o.group_id=g);var c=Object.keys(o).filter(function(t){return void 0!==o[t]}).map(function(t){return"".concat(t,"=").concat(o[t])});p&&c.push("types[]=".concat(p.join("&types[]=")));var l="/moves/:client/?".concat(c.join("&"));n.data.get(l,{v:"v3"}).then(function(t){return t.data}).then(function(e){t.historyData=t.historyData.concat(i(e.data)),t.historySettings.offset+=t.historySettings.limit,t.historySettings.loaded+=e.objects,t.historySettings.total=e.total,t.historySettings.load=!1,t.$apply()})};var v=function(){t.loadHistory(),o.method.init("catalog").then(function(e){t.product=_.where(e[0],{_id:s})[0],t.product&&(t.product.typeName=_.where(a.types,{value:t.product.type})[0].title),t.$apply()})};v()}]),angular.module("cloudshop").directive("qrCode",[function(){return{restrict:"E",scope:{code:"=",size:"="},replace:!0,template:'<div style="text-align: center"></div>',link:function(t,e){t.size=t.size||128;var n=function(){$(e[0]).empty(),new QRCode(e[0],{text:t.code,width:t.size,height:t.size,colorDark:"#444",colorLight:"transparent",correctLevel:QRCode.CorrectLevel.H})};t.$watch("code",function(t){t&&n()}),t.$watch("size",function(e){e&&t.code&&n()})}}}]),angular.module("cloudshop").directive("print2",["$http","$compile","$timeout",function(t,e,n){return{restrict:"A",scope:{settings:"=print2Settings"},link:function(r,a){var o=function(){return $(".print-container").remove(),$("body").append('<div class="print-container"></div>'),t.get(r.settings.template).then(function(t){r.print_data=r.settings.data(),$(".print-container").html(e(t.data)(r)),n(function(){window.print()})})};$(a).bind("click",function(t){t.preventDefault(),o()})}}}]),angular.module("cloudshop").directive("body",["$http","$compile","$rootScope","docService","api","db",function(t,e,n,r,a,o){return{restrict:"E",link:function(i){var c=function(n){var c=n.type,s=void 0===c?"document":c,u=n.data,d={document:{url:"document.html",format:function(){var t=u;t.from&&t.from.type&&(t.from.typeText=r.clients[t.from.type].title),t.to&&t.to.type&&(t.to.typeText=r.clients[t.to.type].title),t.doc=r.types[t.type],t.products=_.map(t.products,function(t){return t.qty=Math.abs(t.qty),t});var e=Promise.resolve(t);return"movements"===t.type&&(e=o.method.init("catalog").then(function(e){return t.products=_.map(t.products,function(n){var r=e[0].find(function(t){return t._id===n._id})||{},a=r.store_prices?void 0===r.store_prices[t.to._id]?r.price:r.store_prices[t.to._id]:r.price;return n.price=a||0,n.sum=n.qty*n.price,n}),t.sum=_.sum(t.products,"sum"),t})),e}},inventory:{url:"inventory.html",format:function(){var t=u;return t.from&&t.from.type&&(t.from.typeText=r.clients[t.from.type].title),t.doc=r.types[t.type],t.company=a.user.company().name,Promise.resolve(t)}},inventoryFull:{url:"inventory-full.html",format:function(){var t=u;return t.from&&t.from.type&&(t.from.typeText=r.clients[t.from.type].title),t.doc=r.types[t.type],t.company=a.user.company().name,Promise.resolve(t)}}};return i.print={data:u,template:null},$(".print-container").remove(),$("body").append('<div class="print-container"></div>'),i.loading=!0,t.get("/js/components/print/pages/".concat(d[s].url)).then(function(t){i.print.template=t.data}).then(d[s].format).then(function(t){i.print.data=t,$(".print-container").html(e(i.print.template)(i)),setTimeout(window.print,300),i.loading=!1})};n.$on("print",function(t,e){c(_.clone(e,!0))})}}}]).directive("print",["$rootScope",function(t){return{restrict:"A",scope:{pData:"="},link:function(e,n,r){$(n).bind("click",function(n){n.preventDefault(),console.warn("scope.pData",e.pData),t.$broadcast("print",{type:r.pType,data:e.pData})})}}}]),angular.module("cloudshop").factory("permissionCheck",["profile",function(t){return function(e){var n="!"===e[0];n&&(e=e.replace("!",""));var r=e.split("."),a=_toArray(r),o=a[0],i=a.slice(1);return t.permission([o,i.join(".")])===n}}]).directive("permission",["permissionCheck",function(t){return{restrict:"A",link:function(e,n,r){var a=r.permission,o=r.permissionText;try{t(a)&&(o?n[0].innerText=o:n[0].style.display="none")}catch(i){console.log(i)}}}}]).directive("permissionStart",["permissionCheck","$timeout",function(t,e){return{restrict:"EA",link:function(n,r,a){var o=a.permission,i=function(){try{if(t(o)){for(var e=$(r).index(),n=r[0].parentNode.children,a=e;a<n.length;a++){if("PERMISSION-END"===n[a].tagName){$(n[a]).remove();break}n[a].style.display="none"}$(r).remove()}}catch(i){console.log(i)}};e(i)}}}]),angular.module("cloudshop").directive("password",[function(){return{restrict:"E",replace:!0,transclude:!0,template:'\n				<div class="ui icon input" ng-transclude></div>\n      ',link:function(t,e,n){var r=!1;$(e).on("click",".icon",function(){r=!r,$("input",e).prop("type",r?"text":"password"),$(this).toggleClass("slash",r)});var a=function(){$(e).append('<i class="circular eye link icon"></i>')};a()}}}]),angular.module("cloudshop").service("paginator",[function(){var t={filtered:[],visible:[],catalogQuery:{},documentQuery:{}},e={start:0,step:100,currentStep:0},n={data:[],count:0,limit:7,"short":[],first:!1,last:!1},r={init:function(){function a(t,e){return o.apply(this,arguments)}var o=_asyncToGenerator(regeneratorRuntime.mark(function i(a,o){return regeneratorRuntime.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(t.filtered){i.next=2;break}return i.abrupt("return");case 2:return a&&(e.start=0),o||r.steps(),t.visible=t.filtered.slice(e.start,e.start+e.step),n.currentStep=n.currentStep||1,this["short"](),i.abrupt("return");case 8:case"end":return i.stop()}},i,this)}));return a}(),changeStep:function(t){n.currentStep=t,e.start=e.step*(t-1);for(var a=0;a<n.data.length;a+=1)n.data[a].active=t===n.data[a].value;this["short"](t),this.onChangeStep&&this.onChangeStep(),r.init(!1,!0)},"short":function(){var t=n.currentStep||1;n["short"]=_.filter(n.data,function(e,r){var a=r+1;return t<n.limit/2&&(t=n.limit/2),t>n.data.length-n.limit/2&&(t=n.data.length-n.limit/2),t-n.limit/2<a&&t+n.limit/2>=a}),n.first=t>4,n.last=n.data.length-t>5},visible:function(){return t.filtered.length?_.size(t.filtered)>e.step:!1},steps:function(){var r=n.count||_.size(t.filtered),a=_.ceil(r/e.step);a=_.range(0,a).map(function(t){return{value:t+1,active:0==t}}),n.data=a},clear:function(){t.filtered=[],t.visible=[],e.start=0,e.step=100},onChangeStep:null};return{data:t,config:e,view:n,method:r}}]),angular.module("cloudshop").directive("paginator",["paginator",function(t){return{restrict:"E",replace:!0,scope:{data:"="},templateUrl:"/js/components/paginator/_view.html",link:function(e,n){e.view=t.view,$(n).on("click","a",function(){var n=+$(this)[0].dataset.step;-1==n&&(n=e.data.length),t.method.changeStep(n),e.$apply()})}}}]),angular.module("cloudshop").directive("dirPaginationControls",[function(){return{restrict:"E",link:function(t,e,n){var r=n.scrollTo;r&&$(e).on("click","a",function(){var t=$(r).position().top-10,e=$(this).closest("div[ui-view]");$(e).scrollTop(t)})}}}]),angular.module("cloudshop").service("overlay",["$rootScope",function(t){this.init=function(e){t.$broadcast("overlay",e)}}]).directive("overlay",["overlay","$timeout",function(t,e){return{restrict:"E",replace:!0,template:'<div id="overlay"></div>',link:function(t,n){t.$on("overlay",function(t,r){r="boolean"==typeof r?{show:r}:r,r=Object.assign({delay:0,duration:600},r),e(function(){r.show===!0?($(n).css({opacity:0,display:"block"}),$(n).animate({opacity:.6},r.duration,"linear",function(){r.callback&&r.callback()})):$(n).hide()},r.delay)})}}}]),angular.module("cloudshop").directive("newspaper",["$filter","CONFIG",function(t,e){return{restrict:"A",link:function(n,r){var a=e.headwayapp,o="newspaper-container",i=function(){r[0].classList.add(o);var e={selector:".".concat(o),account:a,translations:{title:t("translate")("CLOUDSHOP_NEWS"),readMore:t("translate")("READ_MORE"),labels:{"new":t("translate")("NEWS"),improvement:t("translate")("UPDATE"),fix:t("translate")("CORRECTION")},footer:t("translate")("ALL_NEWS")},callbacks:{onShowWidget:function(){$("#HW_frame_cont").addClass("active")},onHideWidget:function(){$("#HW_frame_cont").removeClass("active")}}};Headway&&Headway.init(e)};insertJS("//cdn.headwayapp.co/widget.js",i)}}}]),angular.module("cloudshop.money").service("moneyTimeLineService",["payService","db","$state","docService","$filter",function(t,e,n,r,a){var o=null,i={config:{start:0,end:0,reverse:!0},format:function(t){return t=a("orderBy")(t,"date",this.config.reverse),_.map(t,function(t){var i=a("dateNice")(t.date);i!=o&&(t.day=i,o=i);var c=e.storage.sources.data.find(function(e){return e.id===t.source});if(c&&c.title||(c=e.storage.sources.deprecated.find(function(e){return e.id===t.source})),t.source=c?c.title:"CATEGORY_DELETED",t.user=e.storage.staff.data.find(function(e){return e._id===t._user}),t.typeName=a("translate")("credit"==t.type?"EXPENSE":"INCOME"),t.color="credit"===t.type?"#ff5350":"#02a99c",t.sum="credit"===t.type?-1*t.sum:t.sum,t.icon=void 0!==t.cash?t.cash?"money":"payment":null,t.iconTitle=void 0!==t.cash?t.cash?"PAID_IN_CASH":"PAID_IN_CARD":null,t.contragent&&t.contragent.type){var s=r.clients[t.contragent.type];
s&&(t.contragent.typeText=s?s.title:"unknow",t.contragent.go=function(){var e={};e[t.contragent.type+"_id"]=t.contragent._id,n.go(r.clients[t.contragent.type].url,e)})}return t})},load:function(){function t(){return n.apply(this,arguments)}var n=_asyncToGenerator(regeneratorRuntime.mark(function r(){var t,n,a,i,c,s,u=arguments;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return t=u.length>0&&void 0!==u[0]?u[0]:{},n=u.length>1&&void 0!==u[1]?u[1]:{},r.prev=2,a=t.start,i=t.end,c=_objectWithoutProperties(t,["start","end"]),c.start=+a,c.end=+i,this.config.start=t.start,this.config.end=t.end,o=null,r.next=11,e.method.init(["accounts","staff","sources"]);case 11:return r.next=13,e.method.query.post("/search/money/:client/"+n.offset+"/"+n.limit,c);case 13:return s=r.sent,r.abrupt("return",s);case 17:throw r.prev=17,r.t0=r["catch"](2),new Error(r.t0);case 20:case"end":return r.stop()}},r,this,[[2,17]])}));return t}()};return{method:i}}]),angular.module("cloudshop.money").directive("moneyTimeline",["moneyTimeLineService","db",function(t,e){return{restrict:"E",replace:!0,scope:{config:"=?config",query:"=query",reverse:"@"},templateUrl:"/js/components/money-timeline/_view.html",link:function(n){var r={start:0,end:+moment().endOf("day").format("X")};n.reverse=!!n.reverse,n.add="append";var a={offset:0,limit:10,loaded:0};n.config=Object.assign(a,n.config||{}),n.loadMore=!1,n.config.load=!1,n.historyData=[],n.loadHistory=_asyncToGenerator(regeneratorRuntime.mark(function o(){var a,i;return regeneratorRuntime.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:if(n.config.load=!0,a=_.clone(n.query,!0)){o.next=4;break}return o.abrupt("return",!1);case 4:return a.start||(a.start=r.start),a.end||(a.end=r.end),n.type&&(a.type=n.type),o.prev=7,o.next=10,t.method.load(_.clone(a,!0),n.config);case 10:return i=o.sent,o.next=13,e.method.init("sources");case 13:t.method.config.reverse=!n.reverse,n.historyData=n.historyData.concat(t.method.format(i.data)),n.config.offset+=n.config.limit,n.config.loaded+=i.data.length,n.config.total=n.config.total||i.total,n.config.last_total=i.total,n.config.load=!1,a.contractor&&(n.messageSubText=""),o.next=25;break;case 23:o.prev=23,o.t0=o["catch"](7);case 25:return o.prev=25,n.$apply(),o.finish(25);case 28:case"end":return o.stop()}},o,null,[[7,23,25,28]])})),n.$watch("query",function(t,e){n.config.offset=0,n.config.loaded=0,n.config.last_total=0,n.config.total=0,n.historyData=[],n.loadHistory()},!0),n.$watch("loadMore",function(t,e){t&&(n.loadHistory(),n.loadMore=!t)})}}}]),angular.module("cloudshop.money").service("moneyTableService",["payService","db","$state","docService","$filter",function(t,e,n,r,a){var o={config:{start:0,end:0,reverse:!0},format:function(t){return t=a("orderBy")(t,"date",this.config.reverse),_.map(t,function(t){var o=e.storage.sources.data.find(function(e){return e.id===t.source});o&&o.title||(o=e.storage.sources.deprecated.find(function(e){return e.id===t.source})),t.source=o?o.title:"CATEGORY_DELETED",t.type_name=a("translate")("credit"==t.type?"EXPENSE":"INCOME");var i=e.storage.accounts.data.find(function(e){return e._id===t.store})||{};if(t.store_type=i.type,t.user=e.storage.staff.data.find(function(e){return e._id===t._user}),t.contragent&&t.contragent.type){if("accounts"==t.contragent.type){var c=e.storage.accounts.data.find(function(e){return e._id===t.contragent._id});c&&(t.contragent.sub_type=c.type)}var s=r.clients[t.contragent.type];s&&(t.contragent.name=t.contragent.name||"unknow",t.contragent.go=function(){var e={};e[t.contragent.type+"_id"]=t.contragent._id,n.go(r.clients[t.contragent.type].url,e)})}return t})},load:function(){function t(t,e){return n.apply(this,arguments)}var n=_asyncToGenerator(regeneratorRuntime.mark(function r(t,n){var a,o,i,c;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,a=t.start,o=t.end,i=_objectWithoutProperties(t,["start","end"]),i.start=+a,i.end=+o,this.config.start=t.start,this.config.end=t.end,r.next=8,e.method.init(["accounts","staff","sources"]);case 8:return r.next=10,e.method.query.post("/search/money/:client/"+n.offset+"/"+n.limit,i);case 10:return c=r.sent,r.abrupt("return",c);case 14:throw r.prev=14,r.t0=r["catch"](0),new Error(r.t0);case 17:case"end":return r.stop()}},r,this,[[0,14]])}));return t}()};return{method:o}}]),angular.module("cloudshop.money").directive("moneyTable",["moneyTableService",function(t){return{restrict:"E",replace:!0,scope:{config:"=?config",query:"=query",reverse:"@"},templateUrl:"/js/components/money-table/_view.html",link:function(e,n){e.messageSubText="TO_ADD_A_NEW_ORDER_BR_CLICK_CREATE_DOCUM";var r={start:0,end:+moment().endOf("day").format("X")};e.reverse=!!e.reverse,e.add="append";var a={offset:0,limit:50,loaded:0};e.config=Object.assign(a,e.config||{}),e.loadMore=!1,e.config.load=!1,e.historyData=[],e.loadHistory=function(n){e.config.load=!0;var a=_.clone(e.query,!0);return a?(a.start||(a.start=r.start),a.end||(a.end=r.end),e.type&&(a.type=e.type),"replace"==n&&(e.config.offset=0,e.config.loaded=0,e.config.last_total=0,e.config.total=0),void t.method.load(_.clone(a,!0),e.config).then(function(r){"replace"==n?e.historyData=t.method.format(r.data):e.historyData=e.historyData.concat(t.method.format(r.data)),e.config.offset+=e.config.limit,e.config.loaded+=r.data.length,e.config.total=e.config.total||r.total,e.config.last_total=r.total,e.config.load=!1,a.contractor&&(e.messageSubText=""),e.$apply()})):!1},e.$on("order.delete",function(t,n){var r=n._id;e.historyData=e.historyData.map(function(t){return t._id===r&&(t.deleted=!0),t})}),e.$on("order.restore",function(t,n){var r=n._id;e.historyData=e.historyData.map(function(t){return t._id===r&&(t.deleted=!1),t})}),e.$watch("query",function(t,n){return void 0===t?!1:void e.loadHistory("replace")},!0)}}}]),angular.module("cloudshop").directive("promptModal",["$rootScope","safeApply","$sce","$filter",function(t,e,n,r){return{restrict:"E",replace:!0,template:'\n        <div class="ui modal" ng-class="data.size" id="prompt-modal">\n          <div class="header">\n            {{data.title | translate}}\n          </div>\n          <div class="content">\n            <form class="ui form description">\n							<div class="field">\n								<input placeholder="{{data.placeholder | translate}}" ng-model="text" name="text" type="text" />\n							</div>\n						</form>\n          </div>\n          <div class="actions">\n            <div class="ui cancel basic button">{{(data.cancelText || \'CANCEL\') | translate}}</div>\n            <div class="ui ok right green button">\n							{{(data.successText || \'CREATE\') | translate}}\n						</div>\n          </div>\n        </div>\n      ',link:function(a,o){function i(){$(".field",o).removeClass("error"),a.text=""}function c(){d.modal("hide"),$(document).off("keydown",s),i()}function s(t){switch(t.keyCode){case 13:p();break;case 27:m()}}function u(t,i){a.data=i,a.data.body=n.trustAsHtml(r("translate")(a.data.body)),a.data.size=a.data.size||"tiny",a.text=a.data.value||a.text,e(a),d.modal({closable:!1,keyboardShortcuts:!1,transition:"fade down",duration:l,onDeny:function(){return m(),!1},onApprove:function(){return p(),!1}}).modal("show"),$(document).on("keydown",s),$("input",o).focus()}var d=$("#prompt-modal"),l=150;a.data={},a.text="";var p=function(){var t=a.text;t?(setTimeout(function(){return a.data.resolve(t)},l),c()):($(".field",o).addClass("error"),$("input",o).focus())},m=function(){setTimeout(function(){return a.data.reject("cancel")},l),c()};t.$on("promptModal",u)}}}]),angular.module("cloudshop").factory("promptModal",["$rootScope",function(t){return function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(e){var r;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,new Promise(function(n,r){t.$broadcast("promptModal",_objectSpread({resolve:n,reject:r},e))});case 2:return r=n.sent,n.abrupt("return",r);case 4:case"end":return n.stop()}},n)}));return function(t){return e.apply(this,arguments)}}()}]),angular.module("cloudshop").directive("confirmModal",["$rootScope","safeApply","$sce","$filter",function(t,e,n,r){return{restrict:"E",replace:!0,template:'\n        <div class="ui modal" ng-class="data.size" id="confirm-modal">\n          <div class="header">\n            {{(data.title || \'ATTENTION\') | translate}}\n          </div>\n          <div class="content">\n            <form class="description" ng-bind-html="data.body"></form>\n          </div>\n          <div class="actions">\n            <div class="ui cancel basic button">{{(data.cancelText || \'CANCEL\') | translate}}</div>\n            <div class="ui ok right green button">\n							{{(data.successText || \'YES\') | translate}}\n						</div>\n          </div>\n        </div>\n      ',link:function(a,o){function i(){u.modal("hide"),$(document).off("keydown",c)}function c(t){switch(t.keyCode){case 13:l();break;case 27:p()}}function s(t,o){a.data=o;var i=a.data.body.includes("</")?a.data.body:r("translate")(a.data.body);a.data.body=n.trustAsHtml(i),a.data.size=a.data.size||"tiny",e(a),u.modal({closable:!1,keyboardShortcuts:!1,transition:"fade down",duration:d,onDeny:function(){p()},onApprove:function(){l()}}).modal("show"),$(document).on("keydown",c)}var u=$("#confirm-modal"),d=150;a.data={};var l=function(){var t=$("form.description",o).serializeArray();setTimeout(function(){return a.data.resolve(t)},d),i()},p=function(){setTimeout(function(){return a.data.reject("cancel")},d),i()};t.$on("confirmModal",s)}}}]),angular.module("cloudshop").factory("confirmModal",["$rootScope",function(t){return function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(e,r){var a,o,i=arguments;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return a=i.length>2&&void 0!==i[2]?i[2]:{size:"mini"},n.next=3,new Promise(function(n,o){r?n():t.$broadcast("confirmModal",_objectSpread({resolve:n,reject:o,body:e},a))});case 3:return o=n.sent,n.abrupt("return",o);case 5:case"end":return n.stop()}},n)}));return function(t,n){return e.apply(this,arguments)}}()}]),angular.module("cloudshop").directive("alertModal",["$rootScope","safeApply","$sce","$filter",function(t,e,n,r){return{restrict:"E",replace:!0,template:'\n        <div class="ui modal" ng-class="data.size" id="alert-modal">\n          <div class="header">\n            {{(data.title || \'ATTENTION\') | translate}}\n          </div>\n          <div class="content">\n            <form class="description" ng-bind-html="data.body"></form>\n          </div>\n          <div class="actions">\n            <div class="ui cancel red button">{{(data.cancelText || \'CLOSE\') | translate}}</div>\n          </div>\n        </div>\n      ',link:function(a){function o(){s.modal("hide"),$(document).off("keydown",i)}function i(t){switch(t.keyCode){case 13:case 27:u()}}function c(t,o){a.data=o,a.data.body=n.trustAsHtml(r("translate")(a.data.body)),a.data.size=a.data.size||"tiny",e(a),s.modal({closable:!0,keyboardShortcuts:!0,transition:"fade down",duration:150,onDeny:function(){u()}}).modal("show"),$(document).on("keydown",i)}var s=$("#alert-modal");a.data={};var u=function(){a.data.resolve(),o()};t.$on("alertModal",c)}}}]),angular.module("cloudshop").factory("alertModal",["$rootScope",function(t){return function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(e){var r,a,o=arguments;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return r=o.length>1&&void 0!==o[1]?o[1]:{size:"mini"},n.next=3,new Promise(function(n,a){t.$broadcast("alertModal",_objectSpread({resolve:n,reject:a,body:e},r))});case 3:return a=n.sent,n.abrupt("return",a);case 5:case"end":return n.stop()}},n)}));return function(t){return e.apply(this,arguments)}}()}]),angular.module("cloudshop").directive("body",["$rootScope",function(t){return{restrict:"E",scope:{"class":"@"},link:function(e,n){function r(t){var e=t.settings,n=void 0===e?{}:e,r=_objectWithoutProperties(t,["settings"]),a="#"+r.modal;r.show?($(a).hasClass("showed")||($(a).prepend('<i class="close icon"></i>'),$(a).modal(_objectSpread({duration:0},n)).addClass("showed")),$(a).modal("show")):$(a).modal("destroy")}t.$on("modal",function(t,e){r(e)})}}}]),angular.module("cloudshop").directive("message",["$filter",function(t){return{restrict:"E",replace:!0,transclude:!0,scope:{icon:"@",classes:"@",type:"@",text:"@",subText:"@",style:"@",progress:"=?",total:"=?"},template:'\n        <h1 style="{{style}}" class="_message" ng-class="[classes]" ng-transclude="">\n        </h1>\n      ',link:function(e,n){var r=function(){var r={warning:{title:"ERROR",icon:"undo"},loading:{title:"LOADING",icon:"spinner loading"},404:{title:"NOT_FOUND",icon:"folder open outline"},progress:{}};if(e.type=e.type||"loading",e.title=e.text||r[e.type].title,e.icon="undefined"!=typeof e.icon?e.icon:r[e.type].icon,"progress"===e.type){e.classes="".concat(e.classes||""," progress"),$(n).append('\n              <div class="ui small progress" data-percent="0">\n                <div class="bar">\n                  <div class="progress"></div>\n                </div>\n                <div class="label"></div>\n              </div>\n            ');var a=$(".progress",n[0]);e.$watch("progress",function(t){t&&a.progress("get total")[0]&&a.progress("set progress",t)}),e.$watch("total",function(e){e&&a.progress({total:e,progress:0,text:{active:t("translate")("LOADED_COUNT_OF_COUNT",{value:"{value}",total:"{total}"})}})})}e.icon&&!$(".icon",n)[0]&&$(n).append('<i class="icon"></i>'),$(".text",n)[0]||$(n).append('<div class="text"></div>'),e.subText&&!$(".sub-text",n)[0]&&$(n).append('<div class="sub-text"></div>'),e.el={icon:$(".icon",n),text:$(".text",n),subtext:$(".sub-text",n)},e.el.text.html(t("translate")(e.title)),e.icon&&e.el.icon.addClass(e.icon),e.subText&&e.el.subtext.html(t("translate")(e.subText)),$(n).fadeIn()};r()}}}]),angular.module("cloudshop").directive("inlineFilter",["localStorageService",function(t){return{scope:{filter:"="},replace:!0,templateUrl:"/js/components/inline-filter/_view.html",link:function(e){function n(n,r){return r=r||[],n=_.groupBy(n.filter(function(t){return!!t.value||"text"==t.type&&"undefined"!=typeof t.value}).map(function(t){return{key:t._id,value:t.value,channel:t.channel||"main"}}),"channel"),r=_.groupBy(r.filter(function(t){return!!t.value||"text"==t.type&&"undefined"!=typeof t.value}).map(function(t){return{key:t._id,value:t.value,channel:t.channel||"main"}}),"channel"),0==Object.keys(n).length&&a===!1||0===Object.keys(n).length&&Object.keys(r).length?("function"==typeof e.filter.onChange&&(e.filter.onChange({},"main"),a=!0),e.filter.name&&t.set("inlineFilter."+e.filter.name,{}),!1):void _.forEach(n,function(n,o){if(angular.toJson(n)!=angular.toJson(r[o])){n=angular.fromJson(angular.toJson(n));var i={};_.forEach(n,function(t){"date"==t.key?(i.start=+t.value[0],i.end=+t.value[1]):i[t.key]=t.value}),"function"==typeof e.filter.onChange&&(e.filter.onChange(i,o),a=!0),e.filter.name&&t.set("inlineFilter."+e.filter.name,i)}})}function r(){var r,a;e.filter.name&&(a=t.get("inlineFilter.".concat(e.filter.name))),e.filter.fields=e.filter.fields.map(function(t){return"dropdown"==t.type&&(t.settings.onChange=function(t,e){r=r.map(function(n){return"dropdown"==n.type&&t==n.settings.name&&(n.value=e[n.settings.valueField]),n})}),"date"===t.type&&t.defaultValue&&(t.value=t.defaultValue,c=t),a&&("date"==t._id&&a.start&&a.end,Object.keys(a).filter(function(e){return!["start","end"].includes(t)}).map(function(e){t._id==e&&(t.value=a[e])})),t}),r=e.filter.fields.filter(function(t){return!!t.value||t.show}),e.daterange={settings:_objectSpread({position:"bottom"},(c?c.settings:{})||{})},e.dropdown={filter:function(){return e.filter.fields.filter(function(t){return"undefined"==typeof _.where(e.values,{_id:t._id})[0]})},select:function(t){if("date"==t.type){var n=_.where(e.filter.fields,{_id:t._id})[0];n.value=n.defaultValue||{}}e.values.push(_.where(e.filter.fields,{_id:t._id})[0]),e.dropdown.data=e.dropdown.filter(),setTimeout(function(){"dropdown"==t.type?$(".inline-filter-item:last .value .dropdown").dropdown("show"):"date"==t.type?$(".inline-filter-item:last .value > div > div").click():"text"==t.type&&$('.inline-filter-item:last .value input[type="text"]').focus()},300)},value:""},r.length>0&&n(r),e.values=r,e.dropdown.data=e.dropdown.filter()}var a=!1,o=!1,i=function(t,e){try{o&&deepEqual(_objectSpread({},t.map(function(t){return t.value})),_objectSpread({},e.map(function(t){return t.value})))!==!1||(n(t,e),o=!0)}catch(r){console.warn(r)}};e.$watch("values",_.debounce(i,100),!0),e["delete"]=function(t){e.values=e.values.filter(function(e){return e._id!=t._id}),e.dropdown.data=e.dropdown.filter()};var c;r()}}}]),angular.module("cloudshop").directive("inlineEdit_",["$timeout",function(t){return{restrict:"A",scope:{prop:"@inlineEdit",object:"=inlineEditObject",callback:"&inlineEditCallback"},link:function(e,n,r){var a=function(){var t=$(n),r=t.text().trim();t.prop("contenteditable",!0).blur(function(){var t=$(this).text().trim();a(t)}).keypress(function(t){console.warn({e:t}),13===t.keyCode&&(t.preventDefault(),$(this).blur())});var a=function(n){r!==n&&"—"!==n&&(e.prop&&"function"==typeof e.object.save&&e.object.save(_defineProperty({},e.prop,n)).then(function(){t.addClass("completed"),setTimeout(function(){t.removeClass("completed")},2e3)}),r=n)}};t(a)}}}]),angular.module("cloudshop").directive("imgCloud",["$timeout",function(t){return{restrict:"A",scope:{href:"=imgCloud"},link:function(e,n,r){function a(){if(e.href)if(/^data\:image\//.test(e.href))c(e.href);else{var n={w:(r.width||30)*window.devicePixelRatio,h:(r.height||r.width||30)*window.devicePixelRatio},a="".concat(e.href,"?s=").concat(n.w,",").concat(n.h);t(function(){c(a)})}}var o=void 0,i="/images/placeholder.png";e.href="null"==e.href?void 0:e.href;var c=function(t){n[0].style.backgroundImage="url(".concat(t,")")};c(i),n[0].src="/images/px.gif",n[0].classList.add("cloudImage"),n.bind("error",function(){c(i)}),e.$watch("href",function(t){t&&t!==o&&(a(),o=t)})}}}]),angular.module("cloudshop").directive("imageSlider",["$rootScope",function(t){return{restrict:"E",replace:!0,scope:{visible:"@",slides:"="},template:'\n      <div class="image-slider">\n        <div class="main image-slider-gallery">\n          <div ng-repeat="item in slides">\n            <a ng-href="{{item.url}}" title="{{item.label}}">\n              <img src="/images/px.gif" ng-style="{backgroundImage: \'url(\' + item.url + \')\'}" />\n            </a>\n            <div class="description">\n              <div class="label" ng-bind="item.label" ng-show="item.label"></div>\n              <div class="order" ng-click="showDialog(item)">\n                <a href="">заказать</a>\n              </div>\n            </div>\n          </div>\n        </div>\n        <div class="map" ng-show="slides.length > +visible">\n          <div ng-repeat="item in slides">\n            <img src="/images/px.gif" ng-style="{backgroundImage: \'url(\' + item.url + \')\'}" alt="" />\n          </div>\n          <div class="action">\n            <div class="left"></div>\n            <div class="visible"></div>\n            <div class="right"></div>\n          </div>\n        </div>\n      </div>\n    ',link:function(e,n){var r=this;e.showDialog=function(e){t.$broadcast("MESSENGER_TRACK",{event:"Device Request",data:{model:e.label,image:"https://web.cloudshop.ru".concat(e.url)}})};var a=function(){var t=r.innerWidth/r.showCount;$(r.Main).children().css({flexBasis:t}),r.width=t*r.total,$(r.Main).css({width:r.width})},o=function(){baguetteBox.run(".image-slider-gallery",{captions:!0,animation:"fadeIn"})},i=function(){r.offset=0,r.Map=$(n).children()[1],r.offsetLeft=$(r.Map).offset().left,r.mapWidth=$(r.Map).width(),r.action=$(".action",r.Map),r.left=$(".left",r.action),r.right=$(".right",r.action),r.visible=$(".visible",r.action),r.visibleWidth=210/r.mapWidth,r.active=!1,r.redraw=function(){1-r.visibleWidth<r.offset&&(r.offset=1-r.visibleWidth),r.offset<0&&(r.offset=0),$(r.left).css({width:r.offset*r.mapWidth}),$(r.right).css({left:(r.offset+r.visibleWidth)*r.mapWidth}),$(r.visible).css({left:r.offset*r.mapWidth}),$(r.Main).css({transform:"translateX(-".concat(r.offset*r.width,"px)")})},r.redraw(),$(r.visible).on("mousedown",function(t){r.visibleOffset=t.offsetX/r.mapWidth,r.active=!0}),[r.left,r.right].forEach(function(t){$(t).on("click",function(t){r.offset=(t.pageX-r.offsetLeft)/r.mapWidth-r.visibleWidth/2,r.redraw()})}),r.onMouseMove=function(t){r.active&&(r.offset=(t.pageX-r.offsetLeft)/r.mapWidth-r.visibleOffset,r.redraw(),t.preventDefault())},r.onMouseUp=function(){r.active=!1},$(document).on("mousemove",r.onMouseMove).on("mouseup",r.onMouseUp)},c=function(){r.showCount=parseInt(e.visible||4),r.Main=$(n).children()[0],r.innerWidth=$(n).innerWidth(),r.total=e.slides.length,a(),o(),r.total>r.showCount&&setTimeout(i,300)};e.$on("$destroy",function(){baguetteBox.destroy(),r.onMouseMove&&$(document).off("mousemove",r.onMouseMove).off("mouseup",r.onMouseUp)}),setTimeout(c)}}}]),angular.module("cloudshop").directive("configIf",["CONFIG",function(t){return{restrict:"A",scope:{value:"=?"},link:function(e,n,r){var a=r.configIf,o=r.configValue;["true","false"].includes(o)&&(o="true"===o),t[a]!==o&&(n[0].style.display="none")}}}]).directive("configHref",["CONFIG",function(t){return{restrict:"A",link:function(e,n,r){var a=r.configHref;n[0].href=t[a]}}}]),angular.module("cloudshop").service("globalSearch",["$timeout","$state","db","$filter",function(t,e,n,r){var a=this,o=[];a.search="";var i={"default":[],no_results:[{class_name:"no_results",title:"NO_RESULTS_WERE_FOUND_FOR_YOUR_REQUEST"}],start:[{class_name:"no_results",title:"ENTER_YOUR_SEARCH_TEXT"}]},c=[{name:"catalog",title:"name",category:"PRODUCTS_AND_SERVICES",result:null,limit:3,url:"authenticated.card.catalog.show"},{name:"stores",title:"name",category:"STORES",result:null,limit:3,url:"authenticated.card.store_show"},{name:"suppliers",title:"name",category:"SUPPLIERS",result:null,limit:3,url:"authenticated.card.supplier_show"},{name:"clients",title:"name",category:"CLIENTS",result:null,limit:3,url:"authenticated.card.client_show"}];a.go=function(t){a.search="",e.go(t.url,{id:t.id})},a.searchResult=function(t){var e=[];o.length||(o=_.map(c,function(t){return t.name}),n.method.init(o));for(var a=0;a<c.length;a++){var s=c[a];if(n.storage[s.name].data){var u=n.storage[s.name].data;if(t){var d={};d[s.title]=t,u=r("filter")(u,d)}else u=_.sortByOrder(u,"updated","desc");u=_.map(_.slice(u,0,s.limit),function(t){return{id:t._id,title:t[s.title],url:s.url}}),_.size(u)&&(e=e.concat({title:s.category,divider:!0}),e=e.concat(u))}}return t&&!_.size(e)?e=i.no_results:t||_.size(e)||(e=i.start),e}}]),angular.module("cloudshop").directive("globalSearch",["globalSearch","$rootScope","$timeout",function(t,e,n){return{restrict:"E",replace:!0,templateUrl:"/js/components/globalSearch/_view.html",link:function(n,r){n.service=t,n.menu=$(r).find(".menu"),n.input=$(r).find("input"),n.show=[],n.search=t.search,n.input.bind("focus",function(){$(this).val()&&(n.menu.show(),e.$broadcast("overlay",{delay:0,show:!0}),n.show=t.searchResult($(this).val()),n.$apply())}).bind("blur",function(){n.menu.hide(),e.$broadcast("overlay",!1)}).bind("keyup",function(){$(this).val()?n.menu.is(":hidden")&&(n.menu.show(),e.$broadcast("overlay",{delay:0,show:!0})):(n.menu.hide(),e.$broadcast("overlay",!1)),n.show=t.searchResult($(this).val()),n.$apply()})}}}]),angular.module("cloudshop").directive("galleryPopup",[function(){return{restrict:"E",replace:!0,transclude:!0,template:'<div class="gallery-popup" ng-transclude></div>',scope:{image:"@"},link:function(t,e,n){var r="baguette-box-".concat(String(Math.random()).replace(".",""));$(e).prop("id",r);var a=function(){baguetteBox.run("#".concat(r),{captions:function(){return $("img",e).prop("alt")},animation:"fadeIn"})};setTimeout(a,100),t.$on("$destroy",function(){baguetteBox.destroy()})}}}]),angular.module("cloudshop").directive("fileDropZone",["safeApply","fn",function(t,e){return{restrict:"E",scope:{text:"@",icon:"@",images:"=?",classes:"@",maxImages:"@"},replace:!0,template:'\n      <div class="cs dropzone">\n        <div\n          class="previews"\n          ng-class="{highlight: images.length > 1}"\n        >\n        <div\n          class="preview"\n          ng-repeat="image in images track by $index"\n        >\n          <img\n            width="110"\n            height="110"\n            img-cloud="image"\n          />\n          <div class="ui icon circular mini red button" ng-click="remove($index)">\n            <i class="close icon"></i>\n          </div>\n        </div>\n        </div>\n        <label\n          ng-class="{disable: images.length >= maxImages}"\n          class="fileUpload"\n          ng-class="[classes]"\n        >\n          <div class="no-selected">\n            <div class="title" translate>SELECT_A_PHOTO_TO_UPLOAD</div>\n            <div class="sub-title" translate>OR_DRAG_IT_WITH_THE_MOUSE</div>\n          </div>\n          <div class="selected">\n            <div class="title" translate>LET_GO</div>\n          </div>\n\n          <input type="file" accept="image/jpeg,image/png,image/gif" />\n        </label>\n      </div>',link:function(e,n,r){function a(t){t.preventDefault(),t.stopPropagation()}function o(){$(l).addClass("highlight")}function i(){$(l).removeClass("highlight")}function c(t){var e=t.originalEvent,n=e.dataTransfer,r=n.files;r.length&&s(r)}function s(t){var n=Array.from(t);m(n.slice(0,e.maxImages-e.images.length))}function u(t,e,n){if(n>=t.length)for(var r=n-t.length+1;r--;)t.push(void 0);return t.splice(n,0,t.splice(e,1)[0]),t}var d=this;e.selectIcon=e.icon||"plus",e.maxImages=+e.maxImages||1;var l=$(".fileUpload",n),p=$("input",l);$("input",l).click(function(t){t.stopPropagation()}),$(l).click(function(){$("input",d).trigger("click")}),e.remove=function(t){e.images.splice(t,1),0===e.images.length&&(p.prop("value",null),$(n).removeClass("active"))};var m=function(r){$(n).addClass("active"),f(r),t(e)};p.on("change",function(){var t;if(null===(t=this.files)||void 0===t?void 0:t.length){var n=Array.from(this.files);m(n.slice(0,e.maxImages-e.images.length))}}),e.$watch("images",function(t){var e=t?t.filter(function(t){return!!t}):[];e.length&&$(n).addClass("active")}),["dragenter","dragover","dragleave","drop"].forEach(function(t){$(l).on(t,a)}),["dragenter","dragover"].forEach(function(t){$(l).on(t,o)}),["dragleave","drop"].forEach(function(t){$(l).on(t,i)}),$(l).on("drop",c);var f=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function n(t){var r,a;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return r=[],t.forEach(function(t){if("object"===_typeof(t)){var e=new FileReader;r.push(new Promise(function(t){e.onload=function(e){t(e.target.result)}})),e.readAsDataURL(t)}else"string"==typeof t&&r.push(Promise.resolve(t))}),n.next=4,Promise.all(r);case 4:a=n.sent,e.images=_.uniq(e.images.concat(a)),e.$apply();case 7:case"end":return n.stop()}},n)}));return function(e){return t.apply(this,arguments)}}(),h=function(){if($("input",n).attr("multiple",e.maxImages>1),e.maxImages>1){var t=$(n).find(".previews");Sortable.create(t[0],{animation:150,easing:"cubic-bezier(1, 0, 0, 1)",forceFallback:!0,onStart:function(){t.addClass("sortable")},onEnd:function(n){t.removeClass("sortable"),u(e.images,n.oldIndex,n.newIndex)}})}};setTimeout(h,50)}}}]),angular.module("cloudshop").directive("fileBtn",["$parse",function(t){function e(t){if(t){var e=t.length-20;if(e>0){var n=new RegExp("^.{0,"+e+"}","g");return t.replace(n,"...")}return t}}return{restrict:"E",scope:{select:"=?",text:"@",icon:"@",model:"=?",classes:"@"},replace:!0,template:'\n      <div\n        class="ui icon button button-file"\n        ng-class="[classes, {labeled: !!text}]"\n      >\n        <i class="icon" ng-class="selectIcon"></i><span ng-if="text">{{text}}</span>\n        <input type="file" accept="image/jpeg,image/png,image/gif" />\n      </div>',link:function(t,n,r){function a(n){"undefined"!=typeof r.fileBtnSelect&&(n=n||{},n.name?(t.text&&(t.text=e(n.name)),void 0!==r.model&&(t.model=n)):t.text=o,t.$apply())}var o=t.text;t.selectIcon=t.icon||"plus",$("input",n).on("change",function(){a(this.files[0]),t.select&&t.select(this.files[0])})}}}]),angular.module("cloudshop").directive("dropdownMultiple",["$timeout","safeApply",function(t,e){return{restrict:"E",replace:!0,scope:{data:"=",allowad:"=?",ngModel:"=?",scheme:"=?","class":"@",placeholder:"@",settings:"=?",modelChange:"=?"},template:'\n				<select class="ui fluid search dropdown" ng-class="class" multiple="">\n					<option value="">{{placeholder | translate}}</option>\n					<option ng-repeat="item in data" value="{{item[scheme.value]}}">{{item[scheme.label]}}</option>\n				</select>\n      ',link:function(n,r,a){var o=!1;n.scheme=n.scheme||{label:"label",value:"value"},n.settings=n.settings||{};var i=function(){o=!0,$(r).dropdown(_objectSpread({allowAdditions:n.allowad,keys:{backspace:8,delimiter:13,deleteKey:46,enter:13,escape:27,pageUp:33,pageDown:34,leftArrow:37,upArrow:38,rightArrow:39,downArrow:40},onChange:function(t){void 0!==n.ngModel&&(n.ngModel=t,c(n.ngModel),e(n))},onRemove:function(t){void 0!==n.ngModel&&(n.ngModel=(n.ngModel||[]).filter(function(e){return e!==t}),c(n.ngModel),e(n))}},n.settings))},c=function(t){n.modelChange&&n.modelChange(a.id,t)},s=function(t){$(r).dropdown("change values",t.map(function(t){return{value:t[n.scheme.value],name:t[n.scheme.label]}}))};n.$watchCollection("ngModel",function(t){o&&Array.isArray(t)&&$(r).dropdown("set selected",t)}),n.$watchCollection("data",function(e){if(o&&e&&e.length){s(e);var a=$(r).dropdown("get value");a&&Array.isArray(a)!==!1&&0!==a.length||t(function(){$(r).dropdown("set selected",n.ngModel)})}}),t(i)}}}]),angular.module("cloudshop").directive("itemActionButtons",[function(){return{restrict:"C",transclude:!0,scope:{data:"="},template:'\n      <div ng-show="data">\n        <i\n          ng-repeat="item in data"\n          ng-class="[\'icon\', item.icon]"\n          ng-click="item.onPress($event)"\n        ></i>\n      </div>\n    ',link:function(t){}}}]),angular.module("cloudshop").directive("dropdown2",["$rootScope","db","$state","$filter","safeApply","$timeout",function(t,e,n,r,a,o){return{restrict:"E",replace:!0,controller:["$scope",function(t){this.safeApply=function(e){var n=t.$root.$$phase;"$apply"===n||"$digest"===n?e&&"function"==typeof e&&e():t.$apply(e)}}],scope:{model:"=ngModel",ngClass:"=?myClass",settings:"=",error:"=?",disabled:"=?",uuid:"=?"},templateUrl:"/js/components/dropdown/_view2.html",link:function(i,c,s,u){function d(){$(c).dropdown("clear").find(".text").text(i.set.text).addClass("default")}i.set=_.clone(i.settings,!0)||{},$(c).on("change","input",function(t){t.stopPropagation()}),i.filterFunc=i.settings.filterFunc||function(){return!0};var l="ontouchstart"in document.documentElement,p=l?{}:{transition:"none",duration:0},m={name:"",filter:{},nameField:"name",valueField:"_id",limit:5,order:"updated",text:i.set.placeholder||r("translate")(i.set.search?"WRITE":"SELECT"),icon:null,multiple:!1,search:!1,selectDefault:!1,showDeleted:!1,css:{},onChange:function(){},dropdown:_objectSpread({},p,{on:"click",delay:{hide:0,show:0,search:50,touch:50},action:"activate",forceSelection:!1,allowAdditions:!1,search:!1,onChange:function(t){i.model!==t&&u.safeApply(function(){i.model=t})},onShow:function(){setTimeout(function(){var t=$(c).find(".menu")[0],e=t.getBoundingClientRect(),n=e.top,r=e.bottom,a=e.height;if(0>n||0>r){var o=0>n?n:r;t.style.height="".concat(a+o,"px"),t.style.overflowY="auto"}})},onHide:function(){$(".search",c).val("").keyup(),$(".filtered",c).removeClass("filtered")}})},f=[],h=function(){return i.names.length?(i.names.forEach(function(t){"string"==typeof t&&e.storage[t]?(i.storage[t]={
data:null},f.push(e.method.init(t).then(function(){u.safeApply(function(){if(i.storage[t]=e.storage[t],i.storage[t].promise=e.method.init(t),i.set.selectDefault&&!i.model){var n=r("filter")(i.storage[t].data,_objectSpread({},i.set.filter,{"default":!0}))[0];i.model=n?n._id:null}})})["catch"](function(){u.safeApply(function(){i.storage[t]=e.storage[t],i.storage[t].promise=Promise.resolve([])})}))):(i.storage.d={data:t.map(function(t){return _objectSpread({},t,{itemButtons:g(t)})})},f.push(Promise.resolve([i.storage.d])))}),i.loading=!0,void Promise.all(f).then(function(){i.loading=!1,f=[],i.$apply()})):!1};i.init=function(n){i.set=_objectSpread({},m,{},i.set),"string"==typeof i.set.name?i.names=i.set.name.split(","):i.names=[_.uniq(i.set.name,function(t){return t[i.set.valueField]})],i.storage={},i.showAll="object"==_typeof(i.set.name)&&!e.storage[i.set.name],h(),setTimeout(function(){b(i.model),$(c).dropdown(i.set.dropdown).css(i.set.css).on("keyup",".search",function(){var t=$(this).val();u.safeApply(function(){i.search=t})})},100),n||t.$on("updater",function(t,e){e.type===i.set.name&&u.safeApply()}),a(i)};var g=function(t){return i.set.renderItemButtons?i.set.renderItemButtons(t):void 0},v=[],y=function(t,e,n){return!t||n&&!e._id?[]:(e.itemButtons=g(e),n?v=r("filter")(t,e,n):(e=_objectSpread({},e,{},i.set.filter,_defineProperty({deleted:!1},i.set.nameField,i.search)),v=r("filter")(t,e,n),i.settings.filterFunc&&(v=v.filter(i.settings.filterFunc)),v))};i.filter=y,i.go=function(){switch(_typeof(i.set.create)){case"string":n.go(i.set.create);break;case"function":i.set.create()}$(c).dropdown("hide")},i.subtitle=function(){var t=i.set.subtitle?i.set.subtitle.body:null,e=t?"function"==typeof t?t(this.item):this.item[t]:"";return e};var b=function(t,e){t||t===!1?Promise.all(f).then(function(){setTimeout(function(){$(c).dropdown("set selected",t).dropdown("hide")})}):e&&(i.model=null,d())};i.clear=d;var E=[];E[0]=i.$watch("settings",function(t){t&&o(function(){i.set=t,i.init()})},!0),E[1]=i.$watch("model",b),i.$on("$destroy",function(){$(c).dropdown("destroy"),E.forEach(function(t){return t()})})}}}]),angular.module("cloudshop").directive("dropdown",["$filter",function(t){return{restrict:"E",replace:!0,transclude:!0,controller:["$scope",function(t){this.safeApply=function(e){var n=t.$root.$$phase;"$apply"==n||"$digest"==n?e&&"function"==typeof e&&e():t.$apply(e)}}],scope:{action:"@","class":"@",ngClass:"=?myClass",multiple:"@",model:"=ngModel",items:"=?items",cancelButton:"@",disabled:"=?disabled",multiview:"@",change:"=?",on:"@"},templateUrl:"/js/components/dropdown/_view.html",link:function(e,n,r,a){function o(){var t="ontouchstart"in document.documentElement,o=t?{}:{transition:"none",duration:0},s=_objectSpread({},o,{on:e.on,action:e.action,allowAdditions:"true"==e.multiple,allowReselection:!1,forceSelection:!1,search:e.search,onChange:function(t){a.safeApply(function(){e.multiple?(e.model=t.split(",").filter(function(t){return!!t}),$(n).dropdown("set selected",e.model)):r.ngModel&&t!=e.model&&(e.model=t),e.changed=!0,e.change&&e.change(t),e.cancelButton&&c()})},onAdd:function(t,e,n){},onRemove:function(t,e,n){},onShow:function(){r.name&&"object"==_typeof(e.$parent.form)&&a.safeApply(function(){e.$parent.form[r.name].$dirty=!0}),e.button.addClass("active"),void 0!==r.overlay&&i()},onHide:function(){e.button.removeClass("active"),void 0!==r.overlay&&i()}});s=_objectSpread({},s,{},l),Object.keys(l).length>0&&console.warn("options",s),$(n).dropdown(s),$(".close-dropdown",n).bind("click",function(t){t.preventDefault(),$(n).dropdown("hide")})}function i(){var t=$(".dropdown-overlay");0===t.length&&(t=$('<div class="dropdown-overlay"></div>'),$("body").append(t)),t.toggleClass("active")}function c(){return e.model||e.model===!1?($(n).addClass("labeled icon"),p.exist||(p.el.remove(),p.el=$('<i class="icon" />'),$(n).prepend(p.el)),void p.el.attr("class","").addClass("icon remove").bind("click",function(t){a.safeApply(function(){s(),e.model=""}),t.stopPropagation()})):!1}function s(){p.el.unbind("click"),p.exist?p.el.removeClass("remove").addClass(p.cl):($(n).removeClass("labeled icon"),p.el.remove())}function u(){e.title&&$(n).find(".text").addClass("default").text(e.title),$(n.find("input")[0]).val(""),$(n).dropdown("clear")}function d(){(_.size(e.items)&&e.model||e.multiple&&e.model.length)&&(e.multiview?e.items.map(function(t){return _.sortBy(t,function(t){return t._id==e.model?-1:1})}):e.items=_.sortBy(e.items,function(t){return t._id==e.model?-1:1}),setTimeout(function(){$(n).dropdown("set selected",e.model)},500))}e.multiple=!!e.multiple,e.action=e.action||"activate",e.dropdown_class="ui dropdown action-"+e.action,e.menu=$(n).find(".menu"),e.title=$(n).find(".text").text(),e.cancelButton=!!e.cancelButton,e.button=$(n).find(">.ui.button"),e.search=!!e.search,e.on=e.on||"click";var l=r.settings?JSON.parse(r.settings.replace(/\'/g,'"')):{};e.multiple&&(e.search=!0);var p={el:$(n).find(">i.icon"),cl:$(n).find(">i.icon").attr("class"),exist:!!$(n).find(">i.icon")[0]};"object"==_typeof(e.model)&&e.multiple?$(n.find("input")[0]).val(e.model.join(",")):"string"==typeof e.model&&e.model&&$(n.find("input")[0]).val(e.model),e.$watch("items",function(t,e){return"object"==_typeof(t)&&e&&t.length==e.length?!1:void d()}),e.$watch("model",function(t,n){return t?e.multiple&&!e.changed&&t.length?(d(),!1):(t&&!e.changed?d():void 0===n||e.changed||u(),void(e.changed=!1)):(u(),!1)}),e.multiple&&$(n).on("blur","input",function(){var t=$(this).val();t&&($(n).dropdown("set selected",t),$(this).val(""))}),setTimeout(function(){o()},500),setTimeout(function(){var e=($(n).children(".text").text()||"").trim();e&&$(n).children(".text").text(t("translate")(e))},100)}}}]),angular.module("cloudshop").service("docTimeLineService2",["$filter","docService","db","$state",function(t,e,n,r){function a(t){return t?angular.extend(this,t):void 0}function o(t){return t?angular.extend(this,t):void 0}a.prototype._getType=function(){return e.types["".concat(this.type).concat(this.sub_type||"")]},a.prototype.checkMovAndChang=function(){return["movements"].indexOf(this.type)<0},a.prototype._go=function(t){if(this[t]){var n={};n[this[t].type+"_id"]=this[t]._id,r.go(e.clients[this[t].type].url,n)}},a.prototype._typeText=function(t){return this[t]?e.clients[this[t].type].title:void 0},o.prototype._go=function(){var t={};t[this.contragent.type+"_id"]=this.contragent._id,r.go(e.clients[this.contragent.type].url,t)};var i={format:function(r){return _.map(r,function(r){if(r.sum=Math.abs(r.sum),r.sub=Math.abs(r.sub),r.currency=t("cur")(null),r.dateTime=moment(1e3*r.date).format("D.MM.YYYY HH:mm"),r.doc=e.types[r.type+(r.sub_type||"")],r.discount_percent=r.discount_percent?+r.discount_percent:0,r.comment=r.comment||"",r.commentShort=r.comment.split(" ").slice(0,15).join(" "),r.info.user=n.storage.staff.data.find(function(t){return t._id===r.info.user._id}),("purchases"==r.type||"return_purchases"==r.type)&&(r.price=r.purchase),["movements","changes"].includes(r.type))r.orders="-",["in","out"].includes(r.sub_type)?r.sum=t("number")(r.sum,2):r.sum="-","in"===r.sub_type&&(r.to=r.from,r.from={});else if(r.diff=+(r.sum-r.orders).toFixed(2),r.sum=t("number")(r.sum,2),r.orders=t("number")(r.orders,2),"clients"===r.to.type&&void 0===r.to.name){var o=(n.storage.clients.data.find(function(t){return t._id===r.to._id})||{}).name;r.to.name=o||"noname"}return r.state&&(r.stateObj=e.states.find(function(t){return t._id==r.state})),new a(r)})},load:function(t,r){if(t.v="v3",t.start=+t.start,t.end=+t.end,t.type){var a=e.types[t.type];a.sub_type&&(t.type=t.type.replace(a.sub_type,""),t.sub_type=a.sub_type)}return n.method.query.post("/search/docs2/:client/"+r.offset+"/"+r.limit,t)}};return{method:i}}]),angular.module("cloudshop").directive("docTimeline2",["docTimeLineService2","docService","$filter",function(t,e,n){return{restrict:"E",replace:!0,scope:{config:"=?config",query:"=query"},templateUrl:"/js/components/doc-table/_view.html",link:function(r,a,o){r.messageSubText=n("translate")("TO_ADD_A_NEW_DOCUMENT_BR_CLICK_CREATE_DO");var i={start:0,end:+moment().endOf("day").format("X")},c={offset:0,limit:50,loaded:0,error:!1};r.config=Object.assign(c,r.config||{}),r.types={},c.client&&e.clients[c.client].allow.length?_.forEach(e.clients[c.client].allow,function(t){r.types[t]=e.types[t]}):r.types=e.types,r.Math=window.Math,r.historyData=[],r.loadHistory=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(e){var a,o;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return r.config.load=!0,r.config.error=!1,a=_.clone(r.query,!0),a.start||(a.start=i.start),a.end||(a.end=i.end),r.type&&(a.type=r.type),"replace"===e&&(r.config.offset=0,r.config.loaded=0,r.config.last_total=0,r.config.total=0),n.prev=7,n.next=10,t.method.load(_.clone(a,!0),r.config);case 10:o=n.sent,"replace"===e?r.historyData=t.method.format(o.data):r.historyData=r.historyData.concat(t.method.format(o.data)),r.config.offset+=r.config.limit,r.config.loaded+=o.data.length,r.config.limit!==o.data.length?(r.config.total=r.config.loaded,r.config.last_total=r.config.loaded):(r.config.total=r.config.total||o.total,r.config.last_total=o.total),r.config.load=!1,a.contractor&&(r.messageSubText=""),n.next=23;break;case 19:n.prev=19,n.t0=n["catch"](7),r.config.error=!0,console.log(n.t0);case 23:return n.prev=23,r.$apply(),n.finish(23);case 26:case"end":return n.stop()}},n,null,[[7,19,23,26]])}));return function(t){return e.apply(this,arguments)}}(),r.$on("document.delete",function(t,e){r.historyData=r.historyData.filter(function(t){return t._id!==e})}),r.$on("document.restore",function(t,e){r.historyData=r.historyData.filter(function(t){return t._id!==e})}),r.$watch("query",function(t){return void 0===t?!1:void r.loadHistory("replace")},!0),r.$watch("type",function(t){return void 0===t?!1:void r.loadHistory("replace")})}}}]),angular.module("cloudshop").service("docTimeLineService",["$filter","docService","db","$state","api",function(t,e,n,r,a){function o(t){return t?angular.extend(this,t):void 0}function i(t){return t?angular.extend(this,t):void 0}var c=null;o.prototype._getType=function(){return e.types["".concat(this.type).concat(this.sub_type||"")]},o.prototype.checkMovAndChang=function(){return["movements"].indexOf(this.type)<0},o.prototype._go=function(t){if(this[t]){var n={};n[this[t].type+"_id"]=this[t]._id,r.go(e.clients[this[t].type].url,n)}},o.prototype._typeText=function(t){return this[t]?e.clients[this[t].type].title:void 0},i.prototype._go=function(){var t={};t[this.contragent.type+"_id"]=this.contragent._id,r.go(e.clients[this.contragent.type].url,t)};var s={format:function(r){return _.map(r,function(r){var a=t("dateNice")(r.date);if(a!=c&&(r.day=a,c=a),r.currency=t("cur")(null),r.dateTime=moment(1e3*r.date).format("D.MM.YYYY HH:mm"),r.doc=e.types[r.type+(r.sub_type||"")],r.discount_percent=r.discount_percent?+r.discount_percent:0,r.comment=r.comment||"",r.commentShort=r.comment.split(" ").slice(0,15).join(" "),("purchases"==r.type||"return_purchases"==r.type)&&(r.price=r.purchase),void 0!==r._register&&r.created!==r.updated&&(r.posEdited=!0),["movements"].indexOf(r.type)>-1)r.sum=0,r.products=r.products.map(function(t){return t.price=0,t});else if(["changes"].indexOf(r.type)>-1)"inventory"===r.sub_type&&(r.sum_before=_.sum(r.products.map(function(t){return t.price*t.qty_before})),r.sum_after=_.sum(r.products.map(function(t){return t.price*t.qty_after})),r.sum_diff=_.sum(r.products.map(function(t){return t.price*t.qty})));else try{if(0===r.orders.length)throw new Error("orders array is empty");var s=+_.sum(r.orders.filter(function(t){return t.status}),"sum").toFixed(2),u=parseFloat(r.sum).toFixed(2)!=s?"wait":"check",d=s/r.sum*100,l=Number.isFinite(d)?"(".concat(d.toFixed(2),"%)"):"";r.moneysHelper={icon:u,color:"wait"===u?"yellow":null,text:"wait"===u?"\n									".concat(t("translate")("PAID")," ").concat(t("curr")(s)," ").concat(l,"\n								"):t("translate")("DOCUMENT_PAID")}}catch(p){r.moneysHelper={icon:"exclamation triangle",color:"yellow",text:t("translate")("DOCUMENT_NOT_PAID")}}return"undefined"!=typeof r.state&&(r.stateObj=e.states.find(function(t){return t._id===r.state})),["out","inventory"].includes(r.sub_type)===!1&&(r.sum=Math.abs(r.sum),r.sub=Math.abs(r.sub),r.qty=Math.abs(r.qty)),r.products=r.products.filter(function(t){return!t.product.id_parent}).map(function(t){return t.icon={cube:"inventory"===t.product.type,asterisk:"service"===t.product.type,cubes:"set"===t.product.type},["out","inventory"].includes(r.sub_type)===!1&&(t.qty=Math.abs(t.qty),t.sum=Math.abs(t.sum),t.price=Math.abs(t.price)),t}),"changes"===r.type&&(r.sum=_.sum(r.products,"sum")),r.orders=(r.orders||[]).map(function(t){t.store_name||(t.store_name=(n.storage.accounts.data.find(function(e){return e._id===t.store})||{}).name);var e=["to","from","from","to"][["sales","return_sales","purchases","return_purchases"].indexOf(r.type)];return e&&t.contragent&&t.contragent._id!==r[e]._id&&(r.diffContragents=!0),new i(t)}),new o(r)})},load:function(){function t(t,e){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function a(t,r){var o,i;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return t.start=+t.start,t.end=+t.end,c=null,t.type&&(o=e.types[t.type],o.sub_type&&(t.type=t.type.replace(o.sub_type,""),t.sub_type=o.sub_type)),t.v="v3",a.next=7,window.fn.sleep(r.offset?0:700);case 7:return a.next=9,n.method.init("accounts");case 9:return a.next=11,n.method.query.post("/search/docs/:client/".concat(r.offset,"/").concat(r.limit),t);case 11:return i=a.sent,a.abrupt("return",i);case 13:case"end":return a.stop()}},a)}));return t}(),loadReportHistory:function(){function t(t,n){return e.apply(this,arguments)}var e=_asyncToGenerator(regeneratorRuntime.mark(function r(t,e){var a;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return t.v="v3",r.next=3,n.method.init("accounts");case 3:return r.next=5,n.method.query.post("/report/:client/sales1/docs",_objectSpread({},t,{limit:e.limit,offset:e.offset}));case 5:return a=r.sent,r.abrupt("return",_objectSpread({},a,{total:a.data.length===e.limit?1e10:0}));case 7:case"end":return r.stop()}},r)}));return t}()};return{method:s}}]),angular.module("cloudshop").directive("docTimeline",["docTimeLineService","docService","api",function(t,e,n){return{restrict:"E",replace:!0,scope:{config:"=?config",query:"=query",place:"@"},templateUrl:"/js/components/doc-timeline/_view.html",link:function(r,a,o){r.extended=void 0!==o.extended;var i={start:0,end:+moment().endOf("day").format("X")};r.add="append";var c={offset:0,limit:10,loaded:0};r.config=Object.assign(c,r.config||{}),r.types={},c.client&&e.clients[c.client].allow.length?_.forEach(e.clients[c.client].allow,function(t){r.types[t]=e.types[t]}):r.types=e.types,r.Math=window.Math,r.historyData=[],r.loadHistory=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function n(e){var a,o;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(r.config.load=!0,a=_.clone(r.query,!0),a.start||(a.start=i.start),a.end||(a.end=i.end),r.type&&(a.type=r.type),"replace"===e&&(r.config.offset=0,r.config.loaded=0,r.config.last_total=0,r.config.total=0),"reports"!==r.place){n.next=12;break}return n.next=9,t.method.loadReportHistory(_.clone(a,!0),r.config);case 9:n.t0=n.sent,n.next=15;break;case 12:return n.next=14,t.method.load(_.clone(a,!0),r.config);case 14:n.t0=n.sent;case 15:o=n.t0,"replace"===e?r.historyData=t.method.format(o.data):r.historyData=r.historyData.concat(t.method.format(o.data)),r.config.offset+=r.config.limit,r.config.loaded+=o.data.length,r.config.limit!==o.data.length?(r.config.total=r.config.loaded,r.config.last_total=r.config.loaded):(r.config.total=r.config.total||o.total,r.config.last_total=o.total),r.config.load=!1,a.contractor&&(r.messageSubText=""),r.$apply();case 23:case"end":return n.stop()}},n)}));return function(t){return e.apply(this,arguments)}}(),r.showLikeBox="01/04"===moment().format("DD/MM"),r.like=function(){this.item.like||(this.item.like=0),this.item.like+=1,n.data.get("/like/:client/".concat(this.item._id))},r.$watch("query",function(t,e){return void 0===t?!1:void r.loadHistory("replace")},!0),r.$watch("type",function(t,e){return void 0===t?!1:void r.loadHistory("replace")})}}}]).directive("groupDocLink",["catalogGroupService","db","$state",function(t,e,n){return{restrict:"A",scope:{doc:"=groupDocLink"},link:function(r,a,o){$(a).bind("click",function(a){var i=this;a.preventDefault();var c=o.groupDocType||"price_table";$(this).addClass("loading"),e.method.init(["catalog"]).then(function(e){$(i).removeClass("loading"),t.data.price_table.parseDoc(r.doc),n.go("authenticated.card.catalog.group",{tab:c})})})}}}]).directive("returnDocLink",["$state","docService","$timeout","$filter","db",function(t,e,n,r,a){return{restrict:"A",link:function(o,i){$(i).hide(),$(i).bind("click",function(){var i=_asyncToGenerator(regeneratorRuntime.mark(function c(i){return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return i.preventDefault(),c.next=3,a.method.init("catalog");case 3:t.go(e.types[o.item.type].url.replace(/\.([a-z]+?)$/g,".return_$1"),{fromDoc:!0}),n(function(){e.doc.product.addFromDoc(o.item),e.doc.data.to=o.item.from,e.doc.data.from=o.item.to,"purchases"==o.item.type&&(e.doc.data.status=!1),e.doc.data.comment="Возврат по документу\n"+r("translate")(o.item._getType().title)+" #"+o.item.number+"FROM"+moment(o.item.date,"X").format("DD.MM.YYYY HH:mm")});case 5:case"end":return c.stop()}},c)}));return function(t){return i.apply(this,arguments)}}()),o.$watch("item",function(t){t&&["sales","purchases"].includes(t.type)&&$(i).css({display:"block"})})}}}]),angular.module("cloudshop").service("dateRange",["$filter",function(t){this.date=[{title:t("translate")("TODAY"),range:function(){return{from:moment.utc().startOf("day"),to:moment.utc().endOf("day")}}},{title:t("translate")("YESTERDAY"),range:function(){return{from:moment().utc().subtract(1,"days").startOf("day"),to:moment().utc().subtract(1,"days").endOf("day")}}},{title:t("translate")("7_DAYS"),range:function(){return{from:moment().utc().subtract(6,"days"),to:moment().utc()}}},{title:t("translate")("30_DAYS"),range:function(){return{from:moment().utc().subtract(30,"days"),to:moment().utc()}}},{title:t("translate")("THIS_MONTH"),range:function(){return{from:moment().utc().startOf("month"),to:moment().utc().endOf("month")}}},{title:t("translate")("LAST_MONTH"),range:function(){return{from:moment().utc().subtract(1,"month").startOf("month"),to:moment().utc().subtract(1,"month").endOf("month")}}},{title:t("translate")("FOR_ALL_TIME"),range:function(){return{from:moment(0).utc(),to:moment().utc()}}}]}]),angular.module("cloudshop").directive("contragentStats",["api","$filter",function(t,e){return{restrict:"E",scope:{query:"=query"},template:'\n        <div ng-show="stats.length">\n          <div class="ui horizontal divider" translate>STATISTIC</div>\n          <div class="contragentStats">\n            <div>\n              <div ng-repeat="item in stats | filter:{className:\'first\'}" class="item" ng-class=[item.className]>\n                <div class="value" ng-bind="item.value"></div>\n                <div class="label" ng-bind-html="item.label | translate"></div>\n              </div>\n            </div>\n            <div ng-repeat="item in stats | filter:{className:\'!first\'}" class="item" ng-class=[item.className]>\n              <div class="value" ng-bind="item.value"></div>\n              <div class="label" ng-bind-html="item.label | translate"></div>\n            </div>\n          </div>\n        </div>\n      ',link:function(n){n.stats=[];var r=function(t,n){var r=[{className:"first",label:"AVERAGE_TICKET",value:e("curr")(t.docs.sales.sum/t.docs.sales.count,0)},{label:"COUNT_OF_SALES",value:t.docs.sales.count},{label:"COUNT_OF_SALES_RETURNS",value:t.docs.return_sales.count},{label:"SALES_SUM",value:e("curr")(t.docs.sales.sum,0)},{label:"SUM_OF_RETURNS",value:e("curr")(t.docs.return_sales.sum,0)},{label:"PURCHASES_QTY",value:t.docs.purchases.count},{label:"PURCHASES_REFUND_QTY",value:t.docs.return_purchases.count},{label:"PURCHASES_SUM",value:e("curr")(t.docs.purchases.sum,0)},{label:"PURCHASES_REFUND_SUM",value:e("curr")(t.docs.return_purchases.sum,0)},{id:"credit",label:"EXPENSES_SUM",value:e("curr")(t.money.credit.sum,0)},{id:"debit",label:"INCOMES_SUM",value:e("curr")(t.money.debit.sum,0)}];switch(n){case"clients":r=r.filter(function(t,e){return[5,6,7,8].indexOf(e)<0});var a=t.docs.sales.sum-t.money.debit.sum-t.docs.return_sales.sum+t.money.credit.sum;r.unshift({className:"first",label:"DEBT",value:e("curr")(a>0?a:0,0)}),r=r.sort(function(t,e){return"credit"==t.id?1:"credit"==e.id?-1:0});break;case"suppliers":r=r.filter(function(t,e){return[0,1,2,3,4].indexOf(e)<0});var o=t.docs.purchases.sum-t.money.credit.sum-t.docs.return_purchases.sum+t.money.debit.sum;r.unshift({className:"first",label:"DEBT",value:e("curr")(o>0?o:0,0)})}return r},a=function(){var e=Object.assign({type:"clients",start:3,end:4133980799,v:"v2"},n.query);return t.data.post("/report/:client/statistic/contragents/0/999",e).then(function(t){return t.data.data[0]}).then(function(t){n.stats=t?r(t,e.type):[]})["catch"](function(t){})};n.$watch("query",function(t){t&&t.contragent_id&&a()})}}}]),angular.module("cloudshop").directive("checkbox",["safeApply",function(t){return{restrict:"C",scope:{model:"=ngModel",behavior:"=?behavior"},link:function(e,n){var r=$("input",n),a=!!r.is(":checkbox");$(n).checkbox({onChange:function(){e.model=a?!e.model:r.val(),e.behavior=!1,t(e)}}),$("a",n).click(function(t){t.stopPropagation()}),e.$watch("behavior",function(t){return t&&"undefined"!=t?void $(n).checkbox(e.behavior):!1}),e.$watch("model",function(t){return e.behavior?!1:void(t?$(n).checkbox("set checked"):$(n).checkbox("set unchecked"))})}}}]),angular.module("cloudshop").directive("chat",["api","$rootScope",function(t,e){return{restrict:"E",replace:!0,templateUrl:"/js/components/chat/index.html",link:function(n,r){n.form={subject:null,text:null};var a=$(".overlay",r);$(r).hide(),$(".chat",r).click(function(){o()});var o=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!0;a.toggleClass("active",t)},i=function(e){e.preventDefault(),t.data.post("/support/ticket/:client",_objectSpread({},n.form,{v:"v3"})).then(function(t){var e=t.data;return e.status?e:Promise.reject({status:!1})}).then(function(t){o(!1),n.form={subject:null,text:null}})["catch"](function(){return alert("ERROR_SENDING")})};n.toggle=o;var c=function(){$(r).show()};$(r).on("submit","form",i),e.$on("INIT_CHAT",c)}}}]),angular.module("cloudshop.catalog").service("catalogFilterS",[function(){var t=this;this.query=null;var e=function(e){t.query=e},n=function(e){t.query.push(e)};return{query:this.query,replace:e,push:n}}]).run(["catalogFilterS","$rootScope","$state",function(t,e,n){e.$on("CATALOG_FILTER_PUSH",function(e,r){t.query=_objectSpread({},t.query||{},{},r),n.go("authenticated.card.catalog.list")}),e.$on("CATALOG_FILTER_REPLACE",function(e,r){t.query=_objectSpread({},r),n.go("authenticated.card.catalog.list")})}]).directive("catalogFilter",["db","catalogFilterS","$rootScope","$filter",function(t,e,n,r){return{restrict:"E",replace:!0,scope:{change:"="},templateUrl:"/js/components/catalog-filter2/_view.html",link:function(a,o){a.searchTo="",a.data={},a.service=e,a.params={},a.types=[{name:"inventory",label:"PRODUCT"},{name:"service",label:"SERVICE"},{name:"set",label:"SET"}];var i={_id:"price",name:r("translate")("BASIC"),type:"price",values:{from:null,to:null}},c={_id:"main",name:r("translate")("GENERAL"),type:"main",values:{symbol:">",value:null}},s={value:null,type:1},u={value:null,type:1,time:"d"},d={value:[],title:""},l={types:_toConsumableArray(a.types.map(function(t){return t.name})),categories:[],prices:[_.clone(i,!0)],stocks:[_.clone(c,!0)],expiration:_.clone(s,!0),updated:_.clone(u,!0),ids:_.clone(d,!0)};a.form=_.clone(l,!0),a.adPrices=[{_id:"price",type:"price",name:r("translate")("BASIC")},{_id:"purchase",type:"purchase",name:r("translate")("PURCHASING_PRICE")},{_id:"cost",type:"cost",name:r("translate")("COST")},{_id:"discount",type:"discount",name:r("translate")("DISCOUNT")}],a.selectType=function(t){a.form.types.includes(t)?a.form.types=a.form.types.filter(function(e){return e!==t}):a.form.types.push(t)},a.getTypeValue=function(t){return a.form.types.includes(t)},a.searchCat=function(){a.searchCatsText=this.searchTo},a.filterCats=function(t){return a.form.categories.includes(t)===!1},a.changeCats=function(t){a.form.categories.push(t),a.searchCatsText=""},a.deletaCat=function(){var t=this;a.form.categories=a.form.categories.filter(function(e){return e!==t.item})},a.filterPrices=function(t){return!a.form.prices.find(function(e){return e._id===t._id})},a.changePrice=function(){a.form.prices.push(_.clone(i,!0))},a.delPrice=function(t){a.form.prices.splice(t,1)},a.filterStocks=function(t){return!a.form.stocks.find(function(e){return e._id===t._id})},a.changeStock=function(){a.form.stocks.push(_.clone(c,!0))},a.delStock=function(t){a.form.stocks.splice(t,1)},a.delIds=function(){a.form.ids=_.clone(d,!0)};var p=function(t){var e=_.clone(t,!0);e.types=3===e.types.length?[]:e.types,e.prices=e.prices.filter(function(t){return null!==t.values.from||null!==t.values.to}).map(function(t){return _objectSpread({},t,{type:24===t._id.length?"store":t._id,values:{from:"number"==typeof t.values.from?t.values.from:-1*Math.pow(9,9),to:"number"==typeof t.values.to?t.values.to:Math.pow(9,9)}})}),e.stocks=e.stocks.filter(function(t){return null!==t.values.value||"min_qty"===t.values.symbol}).map(function(t){return _objectSpread({},t,{type:24===t._id.length?"store":t.type})}),e.expiration=1===e.expiration.type&&e.expiration.value?e.expiration:2===e.expiration.type?e.expiration:{},e.updated=e.updated.value?e.updated:{};var n={};return Object.keys(e).map(function(t){["expiration","updated"].includes(t)&&e[t].type?n[t]=e[t]:e[t].length?n[t]=e[t]:"ids"===t&&e[t].value.length&&(n[t]=e[t])}),n},m=function(t){var e=_.clone(l,!0);return Object.keys(t).map(function(n){e[n]=t[n]}),e},f=function(){$(o).hide(),$(document).click()},h=!1;a.submit=_asyncToGenerator(regeneratorRuntime.mark(function y(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if("function"!=typeof a.change){t.next=9;break}return a.loading=!0,h=!0,e.query=p(a.form),a.params=e.query,t.next=7,a.change(a.params);case 7:a.loading=!1,a.$apply();case 9:f();case 10:case"end":return t.stop()}},y)})),a.$watch("service.query",function(t){null!==t&&h===!1&&(a.params=t,a.form=m(t),a.change(a.params)),h=!1}),a.$watch("params",function(t){a.paramsLength=Object.keys(t).length}),a.clear=function(){a.form=_.clone(l,!0),a.submit()},$(o).on("mouseup","label.type-button",function(t){t.preventDefault(),a.selectType(this.dataset.type),a.$apply()}),a.$watch("form.types",function(t,e){t.length!==e.length&&$("label[data-type]").each(function(){$("input",this).prop("checked",t.indexOf($(this).attr("data-type"))>-1)})},!0),$(o).on("click",'input[type="checkbox"]',function(t){return t.preventDefault()});var g=n.$on("WS_UPDATE",function(t,e){"catalog"==e.meta.type&&["created","updated"].includes(e.meta.method)&&(e.meta.data.categories||[]).forEach(function(t){a.categories&&a.categories.includes(t)===!1&&a.categories.push(t)}),a.$apply()});a.$on("$destroy",function(){g()}),t.method.init(["categories","stores"]).then(function(t){a.categories=[r("translate")("WITHOUT_CATEGORY")].concat(_toConsumableArray(t[0].map(function(t){return t.title.toLowerCase()}))),a.stores=t[1];var e=_.clone(a.stores,!0).map(function(t){return _objectSpread({},t,{name:"В «".concat(t.name,"»")})});a.pricesData=[].concat(_toConsumableArray(a.adPrices),_toConsumableArray(e)),a.stocksData=[{_id:"main",name:r("translate")("GENERAL")}].concat(_toConsumableArray(e)),a.$apply()});var v=function(){for(var t=o[0].getElementsByClassName("type-button"),e=0;e<t.length;e++)a.getTypeValue(t[e].dataset.type)&&(t[e].children[0].checked=!0)};setTimeout(v)}}}]).directive("catalogFilterInputs",["$filter",function(t){return{restrict:"E",replace:!0,scope:{item:"=",type:"@",list:"=",onAdd:"=",onDel:"=",index:"@"},template:'\n      <div class="catalog-filter-inputs">\n        <div class="row" ng-if="type === \'price\'">\n          <div class="col-xs-7">\n            <select class="ui dropdown" ng-model="item._id" ng-options="x._id as x.name disable when x.disabled for x in list">\n            </select>\n          </div>\n          <div class="col-xs-7">\n            <input ng-model="item.values.from" placeholder="{{\'FROM\' | translate}}" type="number" />\n          </div>\n          <div class="col-xs-7">\n            <input ng-model="item.values.to" placeholder="{{\'TO\' | translate}}" type="number" />\n          </div>\n          <div class="col-xs-3">\n            <div ng-if="index == 0" class="ui basic mini icon button" ng-click="onAdd()">\n              <i class="ui plus icon"></i>\n            </div>\n            <div ng-if="index > 0" class="ui red basic mini icon button" ng-click="onDel(index)">\n              <i class="ui minus icon"></i>\n            </div>\n          </div>\n        </div>\n        <div class="row" ng-if="type === \'stock\'">\n          <div class="col-xs-7">\n            <select class="ui dropdown" ng-model="item._id" ng-options="x._id as x.name disable when x.disabled for x in list">\n            </select>\n          </div>\n          <div ng-class="{\'col-xs-14\': item.values.symbol === \'min_qty\', \'col-xs-7\': item.values.symbol !== \'min_qty\'}">\n            <select class="ui dropdown" ng-model="item.values.symbol" ng-options="x.value as x.label for x in symbols">\n            </select>\n          </div>\n          <div class="col-xs-7" ng-hide="item.values.symbol === \'min_qty\'">\n            <input ng-model="item.values.value" type="number" />\n          </div>\n          <div class="col-xs-3">\n            <div ng-if="index == 0" class="ui basic mini icon button" ng-click="onAdd()">\n              <i class="ui plus icon"></i>\n            </div>\n            <div ng-if="index > 0" class="ui red basic mini icon button" ng-click="onDel(index)">\n              <i class="ui minus icon"></i>\n            </div>\n          </div>\n        </div>\n        <div class="row" ng-if="type === \'expiration\'">\n          <div class="col-xs-14">\n            <select class="ui dropdown" ng-model="item.type" ng-options="x.value as x.label for x in date">\n            </select>\n          </div>\n          <div class="col-xs-7">\n            <input ng-disabled="item.type == 2" ng-model="item.value" type="number" />\n          </div>\n          <div class="col-xs-3" ng-style="{textAlign: \'right\', color: item.type == 1 ? \'\' : \'#cccccc\'}" translate>\n            DAYS\n          </div>\n        </div>\n        <div class="row" ng-if="type === \'updated\'">\n          <div class="col-xs-14">\n            <select class="ui dropdown" ng-model="item.type" ng-options="x.value as x.label for x in updatedValues">\n            </select>\n          </div>\n          <div class="col-xs-5">\n            <input ng-model="item.value" type="number" />\n          </div>\n          <div class="col-xs-5">\n            <select class="ui dropdown" ng-model="item.time" ng-options="x.value as x.label for x in updatedTimes">\n\n            </select>\n          </div>\n        </div>\n      </div>\n    ',link:function(e){e.symbols=[{value:">",label:t("translate")("GREATER")},{value:">=",label:t("translate")("GREATER_OR_EQUAL")},{value:"=",label:t("translate")("EQUAL")},{value:"<",label:t("translate")("LESS")},{value:"<=",label:t("translate")("LESS_OR_EQUAL")},{value:"min_qty",label:t("translate")("LESS_MINIMAL_STOCK")}],e.date=[{value:1,label:t("translate")("EXPIRE_IN")
},{value:2,label:t("translate")("EXPIRED")}],e.updatedValues=[{value:1,label:t("translate")("CHANGED_OVER")},{value:2,label:t("translate")("NOT_CHANGED_FOR")},{value:3,label:t("translate")("CREATED_IN_THE_LAST")}],e.updatedTimes=[{value:"d",label:t("translate")("DAYS")},{value:"h",label:t("translate")("HOURS")},{value:"m",label:t("translate")("MINUTES")}]}}}]),angular.module("cloudshop").directive("daterange",["$filter","translateService",function(t,e){return{restrict:"C",scope:{model:"=ngModel",settings:"=?",disabled:"=?"},link:function(n,r){function a(){var a=[{label:t("translate")("TODAY"),range:[moment(),moment()]},{label:t("translate")("YESTERDAY"),range:[moment().subtract(1,"days"),moment().subtract(1,"days")]},{label:t("translate")("7_DAYS"),range:[moment().subtract(6,"days"),moment()]},{label:t("translate")("30_DAYS"),range:[moment().subtract(29,"days"),moment()]},{label:t("translate")("THIS_MONTH"),range:[moment().startOf("month"),moment().endOf("month")]},{label:t("translate")("LAST_MONTH"),range:[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")]},{label:t("translate")("QUARTER"),range:[moment().startOf("quarter").startOf("day"),moment().endOf("quarter").endOf("day")]}],o=a.map(function(t){return{name:t.label,dates:function(){return[t.range[0].toDate(),t.range[1].toDate()]}}}),c=_objectSpread({customShortcuts:o,monthSelect:!0,yearSelect:!0,language:e.get(),startOfWeek:"monday",showShortcuts:!0,shortcuts:null,customOpenAnimation:function(t){$(this).fadeIn(200,t)},customCloseAnimation:function(t){$(this).fadeOut(200,t)}},n.settings||{});n.disabled||$(r).dateRangePicker(c).bind("datepicker-apply",function(t,e){var r=e.date1,a=e.date2;r=+moment(r).startOf("day").format("X"),a=+moment(a).endOf("day").format("X"),n.model=[r,a],i(),n.$apply()}).bind("datepicker-close",function(){$(r).removeClass("active")}).bind("datepicker-open",function(){$(r).addClass("active")})}$(r).prepend("<span />");var o=$("> span",r);n.$watch("model",function(t,e){var n,a="object"==_typeof(t)&&t?t:[t,t];(n=$(r).data("dateRangePicker")).setDateRange.apply(n,_toConsumableArray(a.map(function(t){return moment(t,"X").format("YYYY-MM-DD")}))),i()});var i=function(){$(r).toggleClass("disabled",!!n.disabled);var t=[],e=Array.isArray(n.model)===!1?[n.model]:n.model;n.model?(_.forEach(e,function(e){var n="D MMM";moment(e,"X").format("YYYY")!=moment().format("YYYY")&&(n="D MMM, YYYY"),t.push(moment(e,"X").format(n))}),o.html(t.join(" &mdash; "))):o.text("SELECT_DATE")};a(),i()}}}]).directive("datepicker",["translateService",function(t){return{restrict:"C",scope:{model:"=ngModel",settings:"=?",disabled:"=?",daterangeTime:"=?",position:"@"},link:function(e,n){function r(){var r=_objectSpread({monthSelect:!0,yearSelect:!0,language:t.get(),startOfWeek:"monday",singleDate:!0,singleMonth:!0,autoClose:!1,position:e.position||void 0,format:"YYYY-MM-DD HH:mm",time:{enabled:!!e.daterangeTime},customOpenAnimation:function(t){$(this).fadeIn(200,t)},customCloseAnimation:function(t){$(this).fadeOut(200,t)}},e.settings||{});e.disabled||(a=!0,$(n).dateRangePicker(r).bind("datepicker-apply",function(t,n){var r=+moment(n.date1).format("X");e.model=r,i(),e.$apply()}).bind("datepicker-close",function(){$(n).removeClass("active")}).bind("datepicker-open",function(){$(n).addClass("active")}))}var a=!1;$(n).prepend("<span />");var o=$("> span",n);e.$watch("model",function(t,r){!e.disabled&&a&&$(n).data("dateRangePicker").setStart(moment(t,"X").format("YYYY-MM-DD HH:mm")),i()}),e.$watch("disabled",function(t,e){t!==e&&(t===!0?$(n).data("dateRangePicker").destroy():a||r())});var i=function(){if($(n).toggleClass("disabled",!!e.disabled),e.model){var t="D MMMM, dddd";moment(e.model,"X").format("YYYY")!==moment().format("YYYY")&&(t="D MMMM YYYY"),e.daterangeTime&&(t="D MMMM, HH:mm"),o.text(moment(e.model,"X").format(t))}else o.text("SELECT_DATE")};r(),i()}}}]).directive("datepickerInput",["translateService",function(t){return{restrict:"C",scope:{model:"=?datepickerModel",position:"@datepickerPosition",disabled:"=?"},link:function(e,n){function r(){$(n).closest(".field").toggleClass("disabled",!!e.disabled);var r={monthSelect:!0,yearSelect:!0,language:t.get(),startOfWeek:"monday",singleDate:!0,singleMonth:!0,autoClose:!0,position:e.position||void 0,format:a,customOpenAnimation:function(t){$(this).fadeIn(200,t)},customCloseAnimation:function(t){$(this).fadeOut(200,t)}};e.disabled?$(n).data("dateRangePicker"):$(n).dateRangePicker(r).bind("datepicker-change",function(t,n){var r=+moment(n.date1).format("X");e.model=r,e.$apply()}).bind("datepicker-close",function(){$(n).removeClass("active")}).bind("datepicker-open",function(){$(n).addClass("active")})}var a="DD/MM/YYYY";e.$watch("model",function(t){console.log("model $watch",t),t||($(n).val(""),$(n).data("dateRangePicker").clear()),t&&$(n).val(moment(t,"X").format(a))}),e.$watch("disabled",function(t){return t===!0?r():null}),r(),$(n).prop("placeholder")||$(n).prop("placeholder",a),$(n).on("focus",function(){$(this).select()})}}}]),angular.module("cloudshop").directive("autoSumInput",[function(){return{restrict:"A",scope:{ngModel:"="},link:function(t,e){$(e).on("blur",function(){})}}}]),angular.module("cloudshop").constant("defaultState","authenticated.dashboard").constant("loginState","anonymous.login").run(["$rootScope","$state","profile","api","db","localStorageService",function(t,e,n,r,a,o){t.path=[],t.$on("$stateChangeSuccess",function(e,n,a){t.path.push({toState:n,toParams:a}),r.user.data._id&&o.set("referer",{state:n,params:a})}),t.$on("$stateChangeStart",function(){var i=_asyncToGenerator(regeneratorRuntime.mark(function c(i,s,u){var d,l;return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(!s.name||"authenticated"!=s.name.split(".")[0]){c.next=25;break}if(!s.data||!s.data.permission){c.next=6;break}if(!r.user.data._id||n.permission(s.data)){c.next=6;break}return i.preventDefault(),e.go("authenticated.card.permission_denied"),c.abrupt("return",!1);case 6:if(r.user.data._id){c.next=25;break}return i.preventDefault(),c.prev=8,c.next=11,r.user.profile();case 11:if(d=c.sent,!d._id){c.next=19;break}return c.next=15,a.method.init("stores");case 15:s.data&&s.data.permission&&!n.permission(s.data)?(l=s.data.redirectTo||"authenticated.card.permission_denied",e.go(l)):e.go(s,u),t.$broadcast("login"),c.next=20;break;case 19:"authenticated.dashboard"!=s.name&&o.set("referer",{state:s,params:u});case 20:c.next=25;break;case 22:c.prev=22,c.t0=c["catch"](8),e.go("anonymous.login");case 25:case"end":return c.stop()}},c,null,[[8,22]])}));return function(t,e,n){return i.apply(this,arguments)}}())}]).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(t,e,n){e.otherwise(function(t){t.invoke(["$state",function(t){t.go("authenticated.dashboard")}])}),n.html5Mode(!0),t.state("authenticated",{url:"","abstract":!0,views:{"":{templateUrl:"js/pages/authenticated/_view.html",controller:"authenticatedCtrl"},header:{templateUrl:"js/pages/authenticated/_header.html",controller:"HeaderCtrl"},menu:{templateUrl:"js/pages/authenticated/menu/index.html",controller:"MenuCtrl"}}}).state("authenticated.card",{url:"/card","abstract":!0,views:{sidebar_right:{templateUrl:"js/components/state-card/_view.html",controller:"cardCtrl"}}}).state("anonymous",{url:"/anonymous","abstract":!0,views:{login:{templateUrl:"js/pages/anonymous/_view.html",controller:"anonymousCtrl"},"":{template:"&nbsp;"}}}).state("authenticated.modal",{url:"/m","abstract":!0,views:{"modal@":{templateUrl:"js/components/state-modal/_view.html",controller:"modalCtrl"}},onEnter:[function(){$("#carrotquest-messenger-collapsed-container").addClass("closed"),setTimeout(function(){$("#state-modal").addClass("active")},10)}],onExit:[function(){$("#carrotquest-messenger-collapsed-container").removeClass("closed")}]})}]);
//# sourceMappingURL=main.js.map
